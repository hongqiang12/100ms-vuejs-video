(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{405:function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return He})),r.d(t,"b",(function(){return Se})),r.d(t,"c",(function(){return _t})),r.d(t,"d",(function(){return Ht})),r.d(t,"e",(function(){return Te})),r.d(t,"f",(function(){return ht})),r.d(t,"g",(function(){return pt})),r.d(t,"h",(function(){return Rt})),r.d(t,"i",(function(){return jt})),r.d(t,"j",(function(){return Ss})),r.d(t,"k",(function(){return vt})),r.d(t,"l",(function(){return ut})),r.d(t,"m",(function(){return le})),r.d(t,"n",(function(){return oe})),r.d(t,"o",(function(){return gt}));var n,o,l=r(683),d=r(498),c=r(464),h=r(418),v=r.n(h),m=r(500),T=Object.defineProperty,k=Object.defineProperties,f=Object.getOwnPropertyDescriptors,y=Object.getOwnPropertySymbols,S=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable,br=Reflect.get,P=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>{for(var r in t||(t={}))E.call(t,r)&&P(e,r,t[r]);if(y)for(var r of y(t))A.call(t,r)&&P(e,r,t[r]);return e},C=(e,t)=>k(e,f(t)),w=(e,t)=>{var r={};for(var i in e)E.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&y)for(var i of y(e))t.indexOf(i)<0&&A.call(e,i)&&(r[i]=e[i]);return r},_=(e,t,r)=>br(S(e),r,t),R=(e,t,r)=>new Promise(((i,n)=>{var s=e=>{try{o(r.next(e))}catch(e){n(e)}},a=e=>{try{o(r.throw(e))}catch(e){n(e)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,a);o((r=r.apply(e,t)).next())})),M=(n=(e,t)=>{t.exports={name:"@100mslive/hms-video",version:"0.9.18",license:"MIT",main:"dist/index.cjs.js",typings:"dist/index.d.ts",module:"dist/index.js",files:["dist","src"],engines:{node:">=10"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",test:"jest --maxWorkers=1",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",format:"prettier --write src/**/*.ts"},author:"100ms <tech-common@100ms.live>",devDependencies:{"@types/dom-screen-wake-lock":"^1.0.1","@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1",tslib:"^2.2.0"},dependencies:{eventemitter2:"^6.4.7","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0"},gitHead:"b78d4abbfb1bb119dcdd29613484f22fbae5b149"}},()=>(o||n((o={exports:{}}).exports,o),o.exports)),D=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:r,recipientRoles:s,time:a,id:n}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=r,this.recipientRoles=s,this.time=a,this.id=n}toSignalParams(){var e,s;let t=null==(e=this.recipientRoles)?void 0:e.map((a=>a.name)),r=null==(s=this.recipientPeer)?void 0:s.peerId,i={info:{message:this.message,type:this.type}};return null!=t&&t.length&&(i.roles=t),r&&(i.peer_id=r),i}toString(){var e;return`{\n      sender: ${this.sender};\n      recipientPeer: ${this.recipientPeer};\n      recipientRoles: ${null==(e=this.recipientRoles)?void 0:e.map((e=>e.name))};\n      message: ${this.message};\n      time: ${this.time};\n      type: ${this.type};\n      id: ${this.id}\n    }`}},L=class{constructor(e){this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]},this.id=e}},N="renegotiation-callback-id",O="ion-sfu",G="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",F="device-change",x="local-audio-enabled",B="local-video-enabled",$="stats-update",U="track-degraded",V="track-restored",W="track-audio-level-update",H="local-audio-silence",j="analytics",J="audio-plugin-failed",K="policy-change",z="local-role-update",Q="audio-track-update",Y="audio-track-added",Z="audio-track-removed",X="autoplay-error",ee="leave",q="_handraise",te=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:r,metadata:s,role:a,joinedAt:n,groups:o,realtime:p}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=r,this.metadata=s,this.joinedAt=n,this.groups=o,this.realtime=p,a&&(this.role=a)}get isHandRaised(){var e;return!(null==(e=this.groups)||!e.includes(q))}updateRole(e){this.role=e}updateName(e){this.name=e}updateNetworkQuality(e){this.networkQuality=e}updateMetadata(e){this.metadata=e}updateGroups(e){this.groups=e}toString(){var e,t,i,r;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}\n      groups: ${null==(r=this.groups)?void 0:r.join()}\n    }`}},ie=class{};ie.makePeerId=()=>Object(l.a)();var se,i,re=class extends te{constructor(e){super(C(I({},e),{peerId:ie.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[],this.asRole=e.asRole}isInPreview(){return!!this.asRole}toString(){var e,i,t;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.asRole?`asRole: ${this.asRole.name};`:""}\n      ${this.audioTrack?`audioTrack: ${null==(i=this.audioTrack)?void 0:i.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(t=this.videoTrack)?void 0:t.trackId};`:""}\n    }`}},ne=class extends te{constructor(e){super(C(I({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},ae=(e,t)=>new ne({peerId:e.peer_id,name:e.info.name,role:t.getPolicyForRole(e.role),customerUserId:e.info.user_id,metadata:e.info.data,groups:e.groups}),dt=class{constructor(e,t,i){this.transport=e,this.store=t,this.options=i,this.isEnd=!1,this.iterator=null,this.total=0,this.defaultPaginationLimit=10}validateConnection(){if(!this.transport||!this.store)throw Error("Use usePaginatedParticipants or hmsActions.getPeerListIterator after preview or join has happened")}hasNext(){return!this.isEnd}getTotal(){return this.total}findPeers(){return R(this,null,(function*(){var e;this.validateConnection();let t=yield this.transport.findPeers(C(I({},this.options||{}),{limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}));return this.updateState(t),this.processPeers(t.peers)}))}next(){return R(this,null,(function*(){var e;let t;return this.validateConnection(),this.iterator||this.isEnd?this.iterator?(t=yield this.transport.peerIterNext({iterator:this.iterator,limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}),this.updateState(t),this.processPeers(t.peers)):[]:yield this.findPeers()}))}processPeers(e){let t=[];return e.forEach((i=>{let e=ae(i,this.store);t.push(e)})),t}updateState(e){this.isEnd=e.eof,this.total=e.total,e.iterator&&(this.iterator=e.iterator)}},oe=new d.UAParser,le="undefined"!=typeof window,de="undefined"==typeof window&&!(null!=(se=oe.getBrowser().name)&&se.toLowerCase().includes("electron")),ce=((i=ce||{}).PROD="prod",i.QA="qa",i.DEV="dev",i),he=()=>"mobile"===oe.getDevice().type,ue=()=>{var e;return"ios"===(null==(e=oe.getOS().name)?void 0:e.toLowerCase())};var pe,ve=function(){if(le&&window){let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"LOCAL":e.includes("app.100ms.live")?"HMS":"CUSTOM"}return"CUSTOM"}(),ge=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(0===arguments.length)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},me=class{constructor(e){this.key=e,this.storage=null}getStorage(){return le&&!this.storage&&(le&&!localStorage&&(window.localStorage=new ge),this.storage=window.localStorage),this.storage}get(){var i;let e=null==(i=this.getStorage())?void 0:i.getItem(this.key);return e?JSON.parse(e):void 0}set(e){var i;let t=JSON.stringify(e);null==(i=this.getStorage())||i.setItem(this.key,t)}clear(){var e;null==(e=this.getStorage())||e.removeItem(this.key)}},Te=((pe=Te||{})[pe.VERBOSE=0]="VERBOSE",pe[pe.DEBUG=1]="DEBUG",pe[pe.INFO=2]="INFO",pe[pe.WARN=3]="WARN",pe[pe.TIME=4]="TIME",pe[pe.TIMEEND=5]="TIMEEND",pe[pe.ERROR=6]="ERROR",pe[pe.NONE=7]="NONE",pe),ke="undefined"!=typeof window&&void 0!==window.expect,fe=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(t,...i);break;case 1:console.debug(t,...i);break;case 2:console.info(t,...i);break;case 3:console.warn(t,...i);break;case 6:console.error(t,...i);break;case 4:performance.mark(i[0]);break;case 5:{let e=i[0];try{let s=performance.measure(e,e);this.log(1,t,e,null==s?void 0:s.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(r){this.log(1,t,e,r)}break}}}};fe.level=ke?7:0;var ye={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},APIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3004,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011,CURRENT_TAB_NOT_SHARED:3012,AUDIO_PLAYBACK_ERROR:3013,SELECTED_DEVICE_MISSING:3014},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005,ICE_DISCONNECTED:4006,STATS_FAILED:4007},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},Se=class e extends Error{constructor(t,i,r,s,a,n=!1){super(s),this.code=t,this.name=i,this.message=s,this.description=a,this.isTerminal=n,Object.setPrototypeOf(this,e.prototype),this.action=r.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{\n      code: ${this.code};\n      name: ${this.name};\n      action: ${this.action};\n      message: ${this.message};\n      description: ${this.description};\n      isTerminal: ${this.isTerminal};\n      nativeError: ${null==(e=this.nativeError)?void 0:e.message};\n    }`}};function be(e){switch(e){case"join":return"JOIN";case"offer":return"PUBLISH";case"answer":return"SUBSCRIBE";case"track-update":return"TRACK";default:return"NONE"}}var Ee=["join","offer","answer","trickle","on-error","JOIN"],Ae={WebSocketConnectionErrors:{FailedToConnect:(e,t="")=>new Se(ye.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`),WebSocketConnectionLost:(e,t="")=>new Se(ye.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",e,"Network connection lost ",t),AbnormalClose:(e,t="")=>new Se(ye.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",e,"Websocket closed abnormally",t)},APIErrors:{ServerErrors:(e,t,r="",i=!0)=>new Se(e,"ServerErrors",t,`[${t}]: Server error ${r}`,r,i),EndpointUnreachable:(e,t="")=>new Se(ye.APIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",e,`Endpoint is not reachable - ${t}`,t),InvalidTokenFormat:(e,t="")=>new Se(ye.APIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0),InitConfigNotAvailable:(e,t="")=>new Se(ye.APIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`)},TracksErrors:{GenericTrack:(e,t="")=>new Se(ye.TracksErrors.GENERIC_TRACK,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`),CantAccessCaptureDevice:(e,t,r="")=>new Se(ye.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,r),DeviceNotAvailable:(e,t,r="")=>new Se(ye.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,r),DeviceInUse:(e,t,r="")=>new Se(ye.TracksErrors.DEVICE_IN_USE,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,r),DeviceLostMidway:(e,t,r="")=>new Se(ye.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",e,`Lost access to capture device midway - ${t}`,r),NothingToReturn:(e,t="",r="There is no media to return. Please select either video or audio or both.")=>new Se(ye.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",e,r,t),InvalidVideoSettings:(e,t="")=>new Se(ye.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t),AutoplayBlocked:(e,t="")=>new Se(ye.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t),CodecChangeNotPermitted:(e,t="")=>new Se(ye.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",e,"Codec can't be changed mid call.",t),OverConstrained:(e,t,r="")=>new Se(ye.TracksErrors.OVER_CONSTRAINED,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,r),NoAudioDetected:(e,t="Please check the mic or use another audio input")=>new Se(ye.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",e,"No audio input detected from microphone",t),SystemDeniedPermission:(e,t,r="")=>new Se(ye.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,r),CurrentTabNotShared:()=>new Se(ye.TracksErrors.CURRENT_TAB_NOT_SHARED,"CurrentTabNotShared","TRACK","The app requires you to share the current tab","You must screen share the current tab in order to proceed"),AudioPlaybackError:e=>new Se(ye.TracksErrors.AUDIO_PLAYBACK_ERROR,"Audio playback error","TRACK",e,e),SelectedDeviceMissing:e=>new Se(ye.TracksErrors.SELECTED_DEVICE_MISSING,"SelectedDeviceMissing","TRACK",`Could not detect selected ${e} device`,`Please check connection to the ${e} device`,!1)},WebrtcErrors:{CreateOfferFailed:(e,t="")=>new Se(ye.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t),CreateAnswerFailed:(e,t="")=>new Se(ye.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t),SetLocalDescriptionFailed:(e,t="")=>new Se(ye.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t),SetRemoteDescriptionFailed:(e,t="")=>new Se(ye.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t,!0),ICEFailure:(e,t="")=>new Se(ye.WebrtcErrors.ICE_FAILURE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t),ICEDisconnected:(e,t="")=>new Se(ye.WebrtcErrors.ICE_DISCONNECTED,"ICEDisconnected",e,`[${e.toString()}]: Ice connection state DISCONNECTED`,t),StatsFailed:(e,t="")=>new Se(ye.WebrtcErrors.STATS_FAILED,"StatsFailed",e,`Failed to WebRTC get stats - ${t}`,t)},WebsocketMethodErrors:{ServerErrors:(e,t,r)=>new Se(e,"ServerErrors",t,r,r,Ee.includes(t)),AlreadyJoined:(e,t="")=>new Se(ye.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t),CannotJoinPreviewInProgress:(e,t="")=>new Se(ye.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",e,"[JOIN]: Cannot join if preview is in progress",t)},GenericErrors:{NotConnected:(e,t="")=>new Se(ye.GenericErrors.NOT_CONNECTED,"NotConnected",e,"Client is not connected",t),Signalling:(e,t)=>new Se(ye.GenericErrors.SIGNALLING,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t),Unknown:(e,t)=>new Se(ye.GenericErrors.UNKNOWN,"Unknown",e,`Unknown exception: ${t}`,t),NotReady:(e,t="")=>new Se(ye.GenericErrors.NOT_READY,"NotReady",e,t,t),JsonParsingFailed:(e,t,r="")=>new Se(ye.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",e,`Failed to parse JSON message - ${t}`,r),TrackMetadataMissing:(e,t="")=>new Se(ye.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",e,"Track Metadata Missing",t),RTCTrackMissing:(e,t="")=>new Se(ye.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",e,"RTC Track missing",t),PeerMetadataMissing:(e,t="")=>new Se(ye.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",e,"Peer Metadata Missing",t),ValidationFailed:(e,t)=>new Se(ye.GenericErrors.INVALID_ROLE,"ValidationFailed","VALIDATION",e,t?JSON.stringify(t):""),InvalidRole:(e,t)=>new Se(ye.GenericErrors.INVALID_ROLE,"InvalidRole",e,"Invalid role. Join with valid role",t,!0),PreviewAlreadyInProgress:(e,t="")=>new Se(ye.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t),MissingMediaDevices:()=>new Se(ye.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices","JOIN","navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0),MissingRTCPeerConnection:()=>new Se(ye.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection","JOIN","RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)},MediaPluginErrors:{PlatformNotSupported:(e,t="")=>new Se(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t),InitFailed:(e,t="")=>new Se(7002,"InitFailed",e,"Plugin init failed",t),ProcessingFailed:(e,t="")=>new Se(7003,"ProcessingFailed",e,"Plugin processing failed",t),AddAlreadyInProgress:(e,t="")=>new Se(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t),DeviceNotSupported:(e,t="")=>new Se(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t)},PlaylistErrors:{NoEntryToPlay:(e,t)=>new Se(ye.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t),NoEntryPlaying:(e,t)=>new Se(ye.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",e,"No entry is playing at this time",t)}},Pe="[VALIDATIONS]";function Ie(e){return null!=e}var Ce=()=>{if(!Ie(RTCPeerConnection)){let e=Ae.GenericErrors.MissingRTCPeerConnection();throw fe.e(Pe,e),e}},we=()=>{if(!Ie(navigator.mediaDevices)){let e=Ae.GenericErrors.MissingMediaDevices();throw fe.e(Pe,e),e}},_e=M().version;function Re(t="prod",r){let i="LOCAL"!==ve&&"prod"===t?"prod":"debug";if(de)return De({os:"web_nodejs",os_version:e.version,sdk:"web",sdk_version:_e,env:i,domain:ve,is_prebuilt:!(null==r||!r.isPrebuilt),framework:"node",framework_version:e.version,framework_sdk_version:null==r?void 0:r.sdkVersion});let n=oe.getOS(),s=oe.getDevice(),a=oe.getBrowser(),o=Me(`web_${n.name}`),l=n.version||"",p=Me(`${a.name}_${a.version}`),u=p;return s.type&&(u=`${Me(`${s.vendor}_${s.type}`)}/${p}`),De({os:o,os_version:l,sdk:"web",sdk_version:_e,device_model:u,env:i,domain:ve,is_prebuilt:!(null==r||!r.isPrebuilt),framework:null==r?void 0:r.type,framework_version:null==r?void 0:r.version,framework_sdk_version:null==r?void 0:r.sdkVersion})}function Me(e){return e.replace(/ /g,"_")}var De=(e,t=",")=>Object.keys(e).filter((t=>Ie(e[t]))).map((t=>`${t}:${e[t]}`)).join(t),Le=class{constructor({name:e,level:t,properties:i,includesPII:r,timestamp:s}){this.metadata={peer:{},userAgent:Re()},this.name=e,this.level=t,this.includesPII=r||!1,this.properties=i||{},this.timestamp=s||(new Date).getTime(),this.event_id=Object(l.a)(),this.device_id=(()=>{let e,t=new me("hms-analytics-deviceId"),r=t.get();return r?e=r:(e=Object(l.a)(),t.set(e)),e})()}toSignalParams(){return{name:this.name,info:C(I({},this.properties),{timestamp:this.timestamp,domain:ve}),timestamp:(new Date).getTime()}}},Ne=class{static connect(e,t,i=new Date,r=new Date,s){let a=this.eventNameFor("connect",void 0===e),n=e?2:1,o=this.getPropertiesWithError(C(I({},t),{[this.KEY_REQUESTED_AT]:null==i?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:null==r?void 0:r.getTime(),endpoint:s}),e);return new Le({name:a,level:n,properties:o})}static disconnect(e,t){let r=e?2:1,s=this.getPropertiesWithError(t,e);return new Le({name:"disconnected",level:r,properties:s})}static preview(i){var e=i,{error:t}=e,r=w(e,["error"]);let s=this.eventNameFor("preview",void 0===t),a=t?2:1,n=this.getPropertiesWithError(r,t);return new Le({name:s,level:a,properties:n})}static join(i){var e=i,{error:t}=e,r=w(e,["error"]);let s=this.eventNameFor("join",void 0===t),a=t?2:1,n=this.getPropertiesWithError(C(I({},r),{is_preview_called:!!r.is_preview_called}),t);return new Le({name:s,level:a,properties:n})}static publish({devices:e,settings:t,error:i}){let r=this.eventNameFor("publish",void 0===i),s=i?2:1,a=this.getPropertiesWithError({devices:e,audio:null==t?void 0:t.audio,video:null==t?void 0:t.video},i);return new Le({name:r,level:s,properties:a})}static hlsPlayerError(e){return new Le({name:"hlsPlayerError",level:2,properties:this.getErrorProperties(e)})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),r=this.getErrorProperties(e);return new Le({name:t,level:2,properties:r})}static leave(){return new Le({name:"leave",level:1})}static autoplayError(){return new Le({name:"autoplayError",level:2})}static audioPlaybackError(e){return new Le({name:"audioPlaybackError",level:2,properties:this.getErrorProperties(e)})}static deviceChange({selection:e,type:t,devices:i,error:r}){let s=this.eventNameFor(r?"publish":`device.${t}`,void 0===r),a=r?2:1,n=this.getPropertiesWithError({selection:e,devices:i},r);return new Le({name:s,level:a,properties:n})}static performance(e){let t=e.toAnalyticsProperties();return new Le({name:"perf.stats",level:1,properties:t})}static rtcStats(e){let t=e.toAnalyticsProperties();return new Le({name:"rtc.stats",level:1,properties:t})}static rtcStatsFailed(e){return new Le({name:"rtc.stats.failed",level:2,properties:this.getErrorProperties(e)})}static degradationStats(e,t){let s={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let a=new Date,t=a.valueOf()-e.degradedAt.valueOf();s=C(I({},s),{duration:t,restoredAt:a})}return new Le({name:"video.degradation.stats",level:1,properties:s})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e);return new Le({name:"audiopresence.failed",level:2,properties:i})}static previewNetworkQuality(e){return new Le({name:"perf.networkquality.preview",level:e.error?2:1,properties:e})}static publishStats(e){return new Le({name:"publisher.stats",level:1,properties:e})}static subscribeStats(e){return new Le({name:"subscriber.stats",level:1,properties:e})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=I(I({},i),e)}static getErrorProperties(e){return e?e instanceof Se?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};Ne.KEY_REQUESTED_AT="requested_at",Ne.KEY_RESPONDED_AT="responded_at";var Oe=["init_response_time","ws_connect_time","on_policy_change_time","local_audio_track_time","local_video_track_time","peer_list_time","room_state_time","join_response_time"],Ge=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),fe.d("[HMSPerformanceTiming]",e,null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration)}catch(t){fe.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:t})}}getTimeTaken(e){var t;return null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration}getTimes(...e){return[...Oe,...e].reduce(((e,i)=>C(I({},e),{[i]:this.getTimeTaken(i)})),{})}cleanup(){this.eventPerformanceMeasures={}}};function Fe(e,t=""){if("chrome"===c.a.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return Ae.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);if("firefox"===c.a.browserDetails.browser&&"NotFoundError"===e.name){let i=Ae.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return Ae.TracksErrors.OverConstrained("TRACK",t,e.constraint);case"NotAllowedError":return Ae.TracksErrors.CantAccessCaptureDevice("TRACK",t,e.message);case"NotFoundError":return Ae.TracksErrors.DeviceNotAvailable("TRACK",t,e.message);case"NotReadableError":return Ae.TracksErrors.DeviceInUse("TRACK",t,e.message);case"TypeError":return Ae.TracksErrors.NothingToReturn("TRACK",e.message);default:return function(e,t){let r=e.toLowerCase();return r.includes("device not found")?Ae.TracksErrors.DeviceNotAvailable("TRACK",t,e):r.includes("permission denied")?Ae.TracksErrors.CantAccessCaptureDevice("TRACK",t,e):Ae.TracksErrors.GenericTrack("TRACK",e)}(e.message,t)}}function xe(e,t){let r=Fe(e,t);return r.addNativeError(e),r}var Be,$e=class{constructor(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id}updateId(e){this.id=e}},Ue=e=>e?`{\n    trackId: ${e.id};\n    kind: ${e.kind};\n    enabled: ${e.enabled};\n    muted: ${e.muted};\n    readyState: ${e.readyState};\n  }`:"",Ve=class{constructor(e,t,i){this.logIdentifier="",this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return R(this,null,(function*(){this.nativeTrack.enabled=e}))}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;fe.d("[HMSTrack]","Stopping track",this.toString()),null==(e=this.nativeTrack)||e.stop()}toString(){var e;return`{\n      streamId: ${this.stream.id};\n      peerId: ${this.peerId};\n      trackId: ${this.trackId};\n      mid: ${(null==(e=this.transceiver)?void 0:e.mid)||"-"};\n      logIdentifier: ${this.logIdentifier};\n      source: ${this.source};\n      enabled: ${this.enabled};\n      nativeTrack: ${Ue(this.nativeTrack)};\n    }`}},We=((Be=We||{}).AUDIO="audio",Be.VIDEO="video",Be),He=class extends Ve{constructor(e,i,t){if(super(e,i,t),this.type="audio",this.audioElement=null,"audio"!==i.kind)throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?100*this.audioElement.volume:null}setVolume(e){return R(this,null,(function*(){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}))}setAudioElement(e){fe.d("[HMSAudioTrack]",this.logIdentifier,"adding audio element",`${this}`,e),this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return R(this,null,(function*(){var i;if(e){if(!this.audioElement)return fe.d("[HMSAudioTrack]",this.logIdentifier,"no audio element to set output",`${this}`),void(this.outputDevice=e);try{"function"==typeof this.audioElement.setSinkId&&(yield null==(i=this.audioElement)?void 0:i.setSinkId(e.deviceId),this.outputDevice=e)}catch(e){fe.d("[HMSAudioTrack]","error in setSinkId",e)}}else fe.d("[HMSAudioTrack]",this.logIdentifier,"device is null",`${this}`)}))}subscribeToAudio(e){return R(this,null,(function*(){this.stream instanceof Kt&&(yield this.stream.setAudio(e,this.trackId,this.logIdentifier))}))}},je=new class{constructor(){this.storage=new me("hms-device-selection"),this.remember=!1,this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let r=this.devices[e].find((a=>this.isSame({deviceId:t,groupId:i},a)));if(!r)return void fe.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);let s=this.storage.get()||{};s[e]=r,this.storage.set(s)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},qe=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(qe||{}),Je=(e=>(e.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",e.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",e))(Je||{}),Ke=class{static failure(e,t){let s=I({plugin_name:e},t.toAnalyticsProperties());return new Le({name:"mediaPlugin.failed",level:2,properties:s})}static audioPluginFailure(e,t,i){let a=I({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new Le({name:"mediaPlugin.failed",level:2,properties:a})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:r}){return new Le({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,sampleRate:r}})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:r,avgProcessingTime:s,inputFrameRate:a,pluginFrameRate:n}){return new Le({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:r,avg_processing_time:s,input_frame_rate:a,plugin_frame_rate:n}})}},ze=class{constructor(e){this.eventBus=e,this.TAG="[AudioPluginsAnalytics]",this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(Ke.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(Ke.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return R(this,null,(function*(){if(this.initTime[e])return void fe.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),fe.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let s=Ae.MediaPluginErrors.InitFailed("AUDIO_PLUGINS",`failed during initialization of plugin${t.message||t}`);throw fe.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)}))}timeInMs(e){return R(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}},Qe=class{constructor(e,t){this.TAG="[AudioPluginsManager]",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new ze(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return R(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);if(t){if(this.pluginAddInProgress){let e=Ae.MediaPluginErrors.AddAlreadyInProgress("AUDIO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.added(t,this.audioContext.sampleRate),this.analytics.failure(t,e),fe.w("can't add another plugin when previous add is in progress"),e}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}}else fe.w("no name provided by the plugin")}))}addPluginInternal(e){return R(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);if(this.pluginsMap.get(t))fe.w(this.TAG,`plugin - ${t} already added.`);else{yield this.validateAndThrow(t,e);try{0===this.pluginsMap.size?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(t,this.audioContext.sampleRate),yield this.analytics.initWithTime(t,(()=>R(this,null,(function*(){return e.init()})))),this.pluginsMap.set(t,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(e){throw fe.e(this.TAG,"failed to add plugin",e),e}}}))}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return R(this,null,(function*(){let i=this.validatePlugin(t);if(i.isSupported)fe.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{if(this.analytics.added(e,this.audioContext.sampleRate),"PLATFORM_NOT_SUPPORTED"===i.errType){let t=Ae.MediaPluginErrors.PlatformNotSupported("AUDIO_PLUGINS","platform not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}if("DEVICE_NOT_SUPPORTED"===i.errType){let t=Ae.MediaPluginErrors.DeviceNotSupported("AUDIO_PLUGINS","audio device not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}}}))}removePlugin(e){return R(this,null,(function*(){yield this.removePluginInternal(e),0===this.pluginsMap.size?(yield this.cleanup(),fe.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()}))}cleanup(){return R(this,null,(function*(){var e,t,i;for(let e of this.pluginsMap.values())yield this.removePluginInternal(e);yield this.hmsTrack.setProcessedTrack(void 0),null==(e=this.sourceNode)||e.disconnect(),null==(t=this.prevAudioNode)||t.disconnect(),null==(i=this.outputTrack)||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0}))}closeContext(){return R(this,null,(function*(){var e;null==(e=this.audioContext)||e.close(),this.audioContext=void 0}))}reprocessPlugins(){return R(this,null,(function*(){if(0===this.pluginsMap.size||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)}))}initAudioNodes(){return R(this,null,(function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw fe.e(this.TAG,"error in setting processed track",e),e}}}}))}processPlugin(e){return R(this,null,(function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();fe.e(this.TAG,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}}))}connectToDestination(){return R(this,null,(function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){fe.e(this.TAG,"error in connecting to destination node",e)}}))}removePluginInternal(e){return R(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);this.pluginsMap.get(t)?(fe.i(this.TAG,`removing plugin ${t}`),this.pluginsMap.delete(t),e.stop(),this.analytics.removed(t)):fe.w(this.TAG,`plugin - ${t} not found to remove.`)}))}createAudioContext(){this.audioContext||(-1!==navigator.userAgent.indexOf("Firefox")?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:48e3}))}};function Ye(e){return R(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!!e&&e.toConstraints()})).getAudioTracks()[0]}catch(e){throw xe(e,"audio")}}))}function Ze(e){return R(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:!!e&&e.toConstraints()})).getVideoTracks()[0]}catch(e){throw xe(e,"video")}}))}function Xe(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}var et={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){return R(this,null,(function*(){try{return yield this.getAudioContext().resume()}catch(e){fe.e("AudioContext",e)}}))}},tt=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function it(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise((t=>setTimeout(t,e)))}function st(e,t=300){let r;return function(...i){clearTimeout(r),r=void 0;let n=this;r=setTimeout((()=>{e.apply(n,i)}),t)}}var nt,at,ot,a,lt=class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new tt(this.historyInterval/this.interval),this.detectSilence=()=>R(this,null,(function*(){let i=0;for(;this.isMonitored;){if(this.track.enabled){if(!this.isSilentThisInstant())break;if(i++,i>50){this.silenceEvent.publish({track:this.track});break}}yield it(20)}}));try{let e=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(e)}catch(e){fe.w(this.TAG,"Unable to initialize AudioContext",e)}}start(){this.stop(),this.isMonitored=!0,fe.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then((()=>fe.d(this.TAG,"Stopping track Monitor",`${this.track}`)))}stop(){this.analyserNode?(this.sendAudioLevel(0),this.isMonitored=!1):fe.d(this.TAG,"AudioContext not initialized")}loop(){return R(this,null,(function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield it(this.interval)}))}sendAudioLevel(e=0){if(e=e>35?e:0,Math.abs(this.audioLevel-e)>5){this.audioLevel=e;let i={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(i)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode)return void fe.d(this.TAG,"AudioContext not initialized");let e=this.calculateAudioLevel();return void 0!==e&&this.history.enqueue(e),this.history.aggregate((e=>Math.max(...e)))}calculateAudioLevel(){if(!this.analyserNode)return void fe.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let a of e)i=Math.max(i,(a-128)/128);let r=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(100*r,0),100))}isSilentThisInstant(){if(!this.analyserNode)return void fe.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some((e=>128!==e&&0!==e))}createAnalyserNodeForStream(e){let t=et.getAudioContext(),i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}},ct=((a=ct||{}).RECORDING_STATE_UPDATED="RECORDING_STATE_UPDATED",a.BROWSER_RECORDING_STATE_UPDATED="BROWSER_RECORDING_STATE_UPDATED",a.SERVER_RECORDING_STATE_UPDATED="SERVER_RECORDING_STATE_UPDATED",a.RTMP_STREAMING_STATE_UPDATED="RTMP_STREAMING_STATE_UPDATED",a.HLS_STREAMING_STATE_UPDATED="HLS_STREAMING_STATE_UPDATED",a.ROOM_PEER_COUNT_UPDATED="ROOM_PEER_COUNT_UPDATED",a),ht=((ot=ht||{})[ot.PEER_JOINED=0]="PEER_JOINED",ot[ot.PEER_LEFT=1]="PEER_LEFT",ot[ot.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",ot[ot.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",ot[ot.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",ot[ot.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",ot[ot.STARTED_SPEAKING=6]="STARTED_SPEAKING",ot[ot.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",ot[ot.ROLE_UPDATED=8]="ROLE_UPDATED",ot[ot.PEER_LIST=9]="PEER_LIST",ot[ot.NAME_UPDATED=10]="NAME_UPDATED",ot[ot.METADATA_UPDATED=11]="METADATA_UPDATED",ot[ot.HAND_RAISE_CHANGED=12]="HAND_RAISE_CHANGED",ot[ot.PEER_REMOVED=13]="PEER_REMOVED",ot[ot.PEER_ADDED=14]="PEER_ADDED",ot),ut=((at=ut||{})[at.TRACK_ADDED=0]="TRACK_ADDED",at[at.TRACK_REMOVED=1]="TRACK_REMOVED",at[at.TRACK_MUTED=2]="TRACK_MUTED",at[at.TRACK_UNMUTED=3]="TRACK_UNMUTED",at[at.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",at[at.TRACK_DEGRADED=5]="TRACK_DEGRADED",at[at.TRACK_RESTORED=6]="TRACK_RESTORED",at),pt=((nt=pt||{})[nt.POLL_CREATED=0]="POLL_CREATED",nt[nt.POLL_STARTED=1]="POLL_STARTED",nt[nt.POLL_STOPPED=2]="POLL_STOPPED",nt[nt.POLL_STATS_UPDATED=3]="POLL_STATS_UPDATED",nt),vt=(e=>(e.NONE="none",e.LOW="low",e.MEDIUM="medium",e.HIGH="high",e))(vt||{}),gt={f:"high",h:"medium",q:"low"},mt=(i=>(i.VP8="vp8",i.VP9="vp9",i.H264="h264",i))(mt||{}),Tt=(e=>(e.OPUS="opus",e))(Tt||{}),kt=(e=>(e.USER="user",e.ENVIRONMENT="environment",e.LEFT="left",e.RIGHT="right",e))(kt||{}),ft=(i=>(i.videoInput="videoInput",i.audioInput="audioInput",i.audioOutput="audioOutput",i))(ft||{}),yt=(e=>(e.audio="audio",e.video="video",e))(yt||{}),St=(e=>(e.SINGLE_CHOICE="single-choice",e.MULTIPLE_CHOICE="multiple-choice",e.SHORT_ANSWER="short-answer",e.LONG_ANSWER="long-answer",e))(St||{}),bt=class{constructor(){this._volume=1,this._codec="opus",this._maxBitrate=32,this._deviceId="default",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Et(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},Et=class{constructor(e,t,i,r,s){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=r,this.advanced=s}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},At=class{constructor(){this._width=320,this._height=180,this._codec="vp8",this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if("number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}facingMode(e){return this._facingMode=e,this}build(){return new Pt(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate,this._facingMode)}},Pt=class{constructor(e,t,i,r,s,a,n,o){this.width=e,this.height=t,this.codec=i,this.maxFramerate=r,this.maxBitrate=n,this.deviceId=s,this.advanced=a,this.facingMode=o}toConstraints(e){let t="ideal";e&&(t="max");let i=this.improviseConstraintsAspect();return{width:{[t]:i.width},height:{[t]:i.height},frameRate:this.maxFramerate,deviceId:this.deviceId,facingMode:this.facingMode}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec,facingMode:this.facingMode}}improviseConstraintsAspect(){return he()&&this.height&&this.width&&this.height>this.width?{width:this.height,height:this.width}:{width:this.width,height:this.height}}},It=class{constructor(){this._video=(new At).build(),this._audio=(new bt).build(),this._screen=(new At).build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(null===this._audio&&null===this._video)throw Ae.TracksErrors.NothingToReturn("TRACK");if(null===this._video&&this._simulcast)throw Ae.TracksErrors.InvalidVideoSettings("TRACK","Cannot enable simulcast when no video settings are provided");return new Ct(this._video,this._audio,this._simulcast,this._screen||void 0)}},Ct=class{constructor(e,t,i,r=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=r}toAnalyticsProperties(){let e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=I(I({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=I(I({},this.video.toAnalyticsProperties()),e)),e}};function wt(e,t){return function(i){return i in e&&e[i]!==t[i]}}var _t=class e extends He{constructor(e,i,t,s,a=(new bt).build()){super(e,i,t),this.eventBus=s,this.TAG="[HMSLocalAudioTrack]",this.isPublished=!1,this.handleVisibilityChange=()=>R(this,null,(function*(){"visible"===document.visibilityState&&(yield this.replaceTrackWith(this.settings))})),this.handleSettingsChange=e=>R(this,null,(function*(){let i=this.stream,t=wt(e,this.settings);t("maxBitrate")&&e.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),t("advanced")&&(yield this.replaceTrackWith(e))})),this.handleDeviceChange=(e,i=!1)=>R(this,null,(function*(){wt(e,this.settings)("deviceId")&&(yield this.replaceTrackWith(e),i||je.updateSelection("audioInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId}))})),e.tracks.push(this),this.settings=a,a.deviceId!==i.getSettings().deviceId&&!Xe(i)&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new Qe(this,s),this.setFirstTrackId(i.id),ue()&&le&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}replaceTrackWith(e){return R(this,null,(function*(){let i=this.nativeTrack;null==i||i.stop();let t=!!this.audioLevelMonitor;try{let s=yield Ye(e);s.enabled=this.enabled,fe.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",s);let a=this.stream;yield a.replaceSenderTrack(i,this.processedTrack||s),yield a.replaceStreamTrack(i,s),this.nativeTrack=s,t&&this.initAudioLevelMonitor()}catch(e){throw this.isPublished&&this.eventBus.analytics.publish(Ne.publish({error:e})),e}try{yield this.pluginsManager.reprocessPlugins()}catch(e){this.eventBus.audioPluginFailed.publish(e)}}))}setEnabled(t){return R(this,null,(function*(){t!==this.enabled&&(t&&Xe(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield _(e.prototype,this,"setEnabled").call(this,t),t&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:t,track:this}))}))}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,i=!1){return R(this,null,(function*(){let t=this.buildNewSettings(e);Xe(this.nativeTrack)||(yield this.handleDeviceChange(t,i),yield this.handleSettingsChange(t)),this.settings=t}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return R(this,null,(function*(){return this.pluginsManager.addPlugin(e)}))}removePlugin(e){return R(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return R(this,null,(function*(){if(!e)return this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),void(this.processedTrack=void 0);e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)}))}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),fe.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new lt(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0}cleanup(){return R(this,null,(function*(){var t;_(e.prototype,this,"cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),this.transceiver=void 0,null==(t=this.processedTrack)||t.stop(),this.isPublished=!1,this.destroyAudioLevelMonitor(),ue()&&le&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)}))}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:i,codec:t,maxBitrate:s,deviceId:a,advanced:r}=I(I({},this.settings),e);return new Et(i,t,s,a,r)}},Rt=class e extends He{setEnabled(t){return R(this,null,(function*(){t!==this.enabled&&(yield _(e.prototype,this,"setEnabled").call(this,t),yield this.subscribeToAudio(t))}))}},Mt=class extends Ve{constructor(e,i,t){if(super(e,i,t),this.type="video",this.sinkCount=0,"video"!==i.kind)throw new Error("Expected 'track' kind = 'video'")}setVideoHandler(e){this.videoHandler=e}hasSinks(){return this.sinkCount>0}getSinks(){return this.videoHandler.getVideoElements()||[]}attach(e){this.videoHandler.addVideoElement(e)}detach(e){this.videoHandler.removeVideoElement(e)}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){null!==e.srcObject&&(e.srcObject=null,this.reduceSinkCount())}cleanup(){super.cleanup(),this.videoHandler.cleanup()}addSinkInternal(e,i){let t=e.srcObject;if(null!==t&&t instanceof MediaStream){let s=t.getVideoTracks()[0];if((null==s?void 0:s.id)===i.id){if(!s.muted&&"live"===s.readyState)return;this.reduceSinkCount()}else this.reduceSinkCount()}e.srcObject=new MediaStream([i]),this.sinkCount++}reduceSinkCount(){this.sinkCount>0&&this.sinkCount--}},Dt={none:-1,low:0,medium:1,high:2},Lt=(e,t)=>{let r="high",i=t.width>t.height?"width":"height",n=[...e].sort(((a,e)=>Dt[a.layer]-Dt[e.layer])),s=t[i]*((null==window?void 0:window.devicePixelRatio)||1);for(let a=0;a<n.length;a++){let{resolution:e,layer:t}=n[a],p=e[i];if(s<=p){r=t;break}{let u=n[a+1];if((s-p)/((u?u.resolution[i]:Number.POSITIVE_INFINITY)-p)<.5){r=t;break}}}return r},tr=new class{constructor(){this.TAG="[HMSIntersectionObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t)=>{var i;this.createObserver(),this.unobserve(e),null==(i=this.intersectionObserver)||i.observe(e),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.intersectionObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.intersectionObserver&&(this.intersectionObserver=new IntersectionObserver(this.handleIntersection))},this.handleIntersection=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=le&&void 0!==window.IntersectionObserver;return e||fe.w(this.TAG,"IntersectionObserver is not supported, fallback will be used instead"),e}},Nt=new class{constructor(){this.TAG="[HMSResizeObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t,i={box:"border-box"})=>{var r;this.createObserver(),this.unobserve(e),null==(r=this.resizeObserver)||r.observe(e,i),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.resizeObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(st(this.handleResize,300)))},this.handleResize=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=le&&void 0!==window.ResizeObserver;return e||fe.w(this.TAG,"Resize Observer is not supported"),e}},Ot=class{constructor(e){this.track=e,this.TAG="[VideoElementManager]",this.videoElements=new Set,this.entries=new WeakMap,this.handleIntersection=e=>R(this,null,(function*(){let t="visible"===getComputedStyle(e.target).visibility;this.track.enabled&&(e.isIntersecting&&t||!document.contains(e.target))?(fe.d(this.TAG,"add sink intersection",`${this.track}`,this.id),this.entries.set(e.target,e.boundingClientRect),yield this.selectMaxLayer(),yield this.track.addSink(e.target)):(fe.d(this.TAG,"remove sink intersection",`${this.track}`,this.id),yield this.track.removeSink(e.target))})),this.handleResize=e=>R(this,null,(function*(){!this.track.enabled||!(this.track instanceof jt)||(this.entries.set(e.target,e.contentRect),yield this.selectMaxLayer())})),this.cleanup=()=>{this.videoElements.forEach((e=>{var t,i;e.srcObject=null,null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e)})),this.videoElements.clear(),this.resizeObserver=void 0,this.intersectionObserver=void 0},this.init(),this.id=Object(l.a)()}updateSinks(e=!1){for(let t of this.videoElements)this.track.enabled?this.track.addSink(t,e):this.track.removeSink(t,e)}addVideoElement(e){return R(this,null,(function*(){var t;this.videoElements.has(e)||(this.init(),fe.d(this.TAG,`Adding video element for ${this.track}`,this.id),this.videoElements.add(e),this.videoElements.size>=10&&fe.w(this.TAG,`${this.track}`,`the track is added to ${this.videoElements.size} video elements, while this may be intentional, it's likely that there is a bug leading to unnecessary creation of video elements in the UI`),null!=(t=this.intersectionObserver)&&t.isSupported()?this.intersectionObserver.observe(e,this.handleIntersection):le&&(this.isElementInViewport(e)?this.track.addSink(e):this.track.removeSink(e)),this.resizeObserver?this.resizeObserver.observe(e,this.handleResize):this.track instanceof jt&&(yield this.track.setPreferredLayer(this.track.getPreferredLayer())))}))}removeVideoElement(e){var t,i;this.track.removeSink(e),this.videoElements.delete(e),this.entries.delete(e),null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e),fe.d(this.TAG,`Removing video element for ${this.track}`)}getVideoElements(){return Array.from(this.videoElements)}init(){le&&(this.resizeObserver=Nt,this.intersectionObserver=tr)}isElementInViewport(e){let t=e.offsetTop,i=e.offsetLeft,r=e.offsetWidth,s=e.offsetHeight,{hidden:a}=e,{opacity:n,display:o}=getComputedStyle(e);for(;e.offsetParent;)t+=(e=e.offsetParent).offsetTop,i+=e.offsetLeft;return t<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&t+s>window.pageYOffset&&i+r>window.pageXOffset&&!a&&(""===n||parseFloat(n)>0)&&"none"!==o}selectMaxLayer(){return R(this,null,(function*(){if(!(this.track instanceof jt)||0===this.videoElements.size)return;let e;for(let t of this.videoElements){let i=this.entries.get(t);if(!i)continue;let{width:r,height:s}=i;if(0===r||0===s)continue;let a=Lt(this.track.getSimulcastDefinitions(),{width:r,height:s});e=e?Dt[a]>Dt[e]?a:e:a}e&&(fe.d(this.TAG,`selecting max layer ${e} for the track`,`${this.track}`),yield this.track.setPreferredLayer(e))}))}},Gt=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(Gt||{}),Ft=(e=>(e["2D"]="2d",e.WEBGL="webgl",e.WEBGL2="webgl2",e))(Ft||{}),xt=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},Bt=class{constructor(e){this.eventBus=e,this.TAG="[VideoPluginsAnalytics]",this.initTime={},this.preProcessingAvgs=new xt,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new xt,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(Ke.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(Ke.failure(e,t)),this.clean(e))}initWithTime(e,t){return R(this,null,(function*(){if(this.initTime[e])return void fe.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),fe.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let s=Ae.MediaPluginErrors.InitFailed("VIDEO_PLUGINS",`failed during initialization of plugin${t.message||t}`);throw fe.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)}))}preProcessWithTime(e){return R(this,null,(function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)}))}processWithTime(e,t){return R(this,null,(function*(){var r;let i;try{i=yield this.timeInMs(t)}catch(t){let a=Ae.MediaPluginErrors.ProcessingFailed("VIDEO_PLUGINS",`Failed during processing of plugin${t.message||t}`);throw fe.e(this.TAG,a),this.failure(e,a),a}i&&(null==(r=this.processingAvgs[e])||r.add(i))}))}timeInMs(e){return R(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}},$t=320,Ut=240,Vt=class{constructor(e,t){this.TAG="[VideoPluginsManager]",this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new Bt(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return R(this,null,(function*(){var i;if(this.pluginAddInProgress){let t=null==(i=e.getName)?void 0:i.call(e);if(!t||""===t)return void fe.w("no name provided by the plugin");let s=Ae.MediaPluginErrors.AddAlreadyInProgress("VIDEO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.failure(t,s),fe.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}}))}addPluginInternal(e,t){return R(this,null,(function*(){var a,r;let i=null==(a=e.getName)?void 0:a.call(e);if(!i||""===i)return void fe.w("no name provided by the plugin");if(this.pluginsMap.has(i))return void fe.w(this.TAG,`plugin - ${e.getName()} already added.`);let n=this.hmsTrack.getMediaTrackSettings().frameRate||24,s=0;t&&t>0?(fe.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<n&&(s=Math.ceil(n/t)-1),this.analytics.added(i,n,t)):(fe.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(i,n)),fe.i(this.TAG,"numFrames to skip processing",s),this.pluginNumFramesToSkip[i]=s,this.pluginNumFramesSkipped[i]=s,this.validateAndThrow(i,e);try{if(yield this.analytics.initWithTime(i,(()=>R(this,null,(function*(){return yield e.init()})))),this.pluginsMap.set(i,e),this.pluginsMap.size+1>this.canvases.length)for(let e=this.canvases.length;e<=this.pluginsMap.size;e++)this.canvases[e]=document.createElement("canvas");yield this.startPluginsLoop(null==(r=e.getContextType)?void 0:r.call(e))}catch(t){throw fe.e(this.TAG,"failed to add plugin",t),yield this.removePlugin(e),t}}))}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)fe.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let t;switch(i.errType){case"PLATFORM_NOT_SUPPORTED":throw t=Ae.MediaPluginErrors.PlatformNotSupported("VIDEO_PLUGINS","platform not supported, see docs"),this.analytics.failure(e,t),t;case"DEVICE_NOT_SUPPORTED":throw t=Ae.MediaPluginErrors.DeviceNotSupported("VIDEO_PLUGINS","video device not supported, see docs"),this.analytics.failure(e,t),t}}}removePlugin(e){return R(this,null,(function*(){let t=e.getName();this.pluginsMap.get(t)?(fe.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),0===this.pluginsMap.size&&(fe.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)):fe.w(this.TAG,`plugin - ${t} not found to remove.`)}))}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return R(this,null,(function*(){if(this.pluginsLoopRunning&&"running"!==this.pluginsLoopState)for(;"paused"===this.pluginsLoopState;)yield it(100)}))}cleanup(){return R(this,null,(function*(){var e;for(let e of this.pluginsMap.values())yield this.removePlugin(e);null==(e=this.outputTrack)||e.stop()}))}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||"2d");let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return R(this,null,(function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw this.pluginsLoopRunning=!1,fe.e(this.TAG,"error in setting processed track",e),e}this.pluginsLoop().then((()=>{fe.d(this.TAG,"processLoop stopped")}))}}))}stopPluginsLoop(){return R(this,null,(function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),null==(e=this.outputTrack)||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)}))}pluginsLoop(){return R(this,null,(function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||24,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||"ended"===this.hmsTrack.nativeTrack.readyState){"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",yield it(t);continue}let i=0;try{yield this.analytics.preProcessWithTime((()=>R(this,null,(function*(){return yield this.doPreProcessing()}))));let e=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-e),i>t&&(i=t)}catch(e){fe.e(this.TAG,"error in plugins loop",e)}this.pluginsLoopState="running",yield it(t-i)}}))}doPreProcessing(){return R(this,null,(function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()}))}processFramesThroughPlugins(){return R(this,null,(function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let r=this.checkIfSkipRequired(i);if("TRANSFORM"===t.getPluginType()){let s=(a,e)=>R(this,null,(function*(){try{yield t.processVideoFrame(a,e,r)}catch(e){fe.e(this.TAG,`error in processing plugin ${i}`,e)}}));if(r)e===this.pluginsMap.size-1?yield s(this.canvases[e],this.outputCanvas):yield s(this.canvases[e],this.canvases[e+1]);else{let a=this.canvases[e],t=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,(()=>R(this,null,(function*(){return s(a,this.outputCanvas)})))):yield this.analytics.processWithTime(i,(()=>R(this,null,(function*(){return s(a,t)}))))}}else"ANALYZE"===t.getPluginType()&&!r&&(yield this.analytics.processWithTime(i,(()=>R(this,null,(function*(){return yield t.processVideoFrame(this.inputCanvas)})))))}catch(e){fe.e(this.TAG,`error in processing plugin ${i}`,e),yield this.removePlugin(t)}e++}}}))}addTrackToVideo(){return R(this,null,(function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;null!==t&&t instanceof MediaStream&&(null==(e=t.getVideoTracks()[0])?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())}))}updateInputCanvas(){return R(this,null,(function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=$t,height:t=Ut}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)}))}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}};function Wt(e,t){return function(i){return i in e&&e[i]!==t[i]}}var Ht=class e extends Mt{constructor(e,i,t,s,a=(new At).build()){super(e,i,t),this.eventBus=s,this._layerDefinitions=[],this.TAG="[HMSLocalVideoTrack]",this.isCurrentTab=!1,this.isPublished=!1,this.buildNewSettings=e=>{let{width:i,height:t,codec:s,maxFramerate:a,maxBitrate:r,deviceId:n,advanced:p,facingMode:u}=I(I({},this.settings),e);return new Pt(i,t,s,a,n,p,r,u)},this.handleSettingsChange=e=>R(this,null,(function*(){let i=this.stream,t=Wt(e,this.settings);if(t("maxBitrate")&&e.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),t("width")||t("height")||t("advanced"))if("video"===this.source){let s=yield this.replaceTrackWith(e);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}else yield this.nativeTrack.applyConstraints(e.toConstraints())})),this.handleDeviceChange=(e,i=!1)=>R(this,null,(function*(){if(Wt(e,this.settings)("deviceId")&&"regular"===this.source){if(this.enabled){delete e.facingMode;let s=yield this.replaceTrackWith(e);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}i||je.updateSelection("videoInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId})}})),this.removeOrReplaceProcessedTrack=e=>R(this,null,(function*(){e?e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e):(this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0)})),e.tracks.push(this),this.setVideoHandler(new Ot(this)),this.settings=a,a.deviceId!==i.getSettings().deviceId&&i.enabled&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new Vt(this,s),this.setFirstTrackId(this.trackId)}setSimulcastDefinitons(e){this._layerDefinitions=e}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(t){return R(this,null,(function*(){var i;if(t!==this.enabled){if("regular"===this.source){let r;r=t?yield this.replaceTrackWith(this.settings):yield this.replaceTrackWithBlank(),yield this.replaceSender(r,t),null==(i=this.nativeTrack)||i.stop(),this.nativeTrack=r,yield _(e.prototype,this,"setEnabled").call(this,t),t&&(yield this.pluginsManager.waitForRestart(),this.settings=this.buildNewSettings({deviceId:r.getSettings().deviceId})),this.videoHandler.updateSinks()}this.eventBus.localVideoEnabled.publish({enabled:t,track:this})}}))}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,i=!1){return R(this,null,(function*(){let t=this.buildNewSettings(e);yield this.handleDeviceChange(t,i),this.enabled&&!Xe(this.nativeTrack)?(yield this.handleSettingsChange(t),this.settings=t):this.settings=t}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,i){return R(this,null,(function*(){return this.pluginsManager.addPlugin(e,i)}))}removePlugin(e){return R(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){return R(this,null,(function*(){var t;_(e.prototype,this,"cleanup").call(this),this.transceiver=void 0,yield this.pluginsManager.cleanup(),null==(t=this.processedTrack)||t.stop(),this.isPublished=!1}))}cropTo(e){return R(this,null,(function*(){if(e&&"screen"===this.source)try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(e))}catch(e){throw fe.e(this.TAG,"failed to crop screenshare capture - ",e),Ae.TracksErrors.GenericTrack("TRACK","failed to crop screenshare capture")}}))}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(e){return R(this,null,(function*(){this.nativeTrack.enabled?(yield this.removeOrReplaceProcessedTrack(e),this.videoHandler.updateSinks()):this.processedTrack=e}))}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled&&this.processedTrack||this.nativeTrack}switchCamera(){return R(this,null,(function*(){var s;let e=this.getMediaTrackSettings().facingMode;if(!e||"regular"!==this.source)return void fe.d(this.TAG,"facingMode not supported");let i="environment"===e?"user":"environment";null==(s=this.nativeTrack)||s.stop();let t=yield this.replaceTrackWith(this.buildNewSettings({facingMode:i,deviceId:void 0}));yield this.replaceSender(t,this.enabled),this.nativeTrack=t,this.videoHandler.updateSinks(),this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId,facingMode:i}),je.updateSelection("videoInput",{deviceId:this.settings.deviceId,groupId:this.nativeTrack.getSettings().groupId})}))}replaceTrackWith(e){return R(this,null,(function*(){let i=this.nativeTrack;null==i||i.stop();try{let t=yield Ze(e);return fe.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",t),"default"===this.settings.deviceId&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),t}catch(e){throw this.isPublished&&this.eventBus.analytics.publish(Ne.publish({error:e})),e}}))}replaceTrackWithBlank(){return R(this,null,(function*(){let e=this.nativeTrack,i=ci.getEmptyVideoTrack(e);return null==e||e.stop(),fe.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",e,"newTrack",i),i}))}replaceSender(e,i){return R(this,null,(function*(){let t=this.stream;i?yield t.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield t.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield t.replaceStreamTrack(this.nativeTrack,e)}))}},jt=class e extends Mt{constructor(e,i,t){super(e,i,t),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new qt,this.preferredLayer="high",this.setVideoHandler(new Ot(this))}setTrackId(e){this.bizTrackId=e}get trackId(){return this.bizTrackId||super.trackId}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(t){return R(this,null,(function*(){t!==this.enabled&&(_(e.prototype,this,"setEnabled").call(this,t),this.videoHandler.updateSinks(!0))}))}setPreferredLayer(e){return R(this,null,(function*(){if("none"!==e){if(this.preferredLayer=e,this.shouldSendVideoLayer(e,"preferLayer")){if(!this.hasSinks())return void fe.d(`[Remote Track] ${this.logIdentifier}\n        streamId=${this.stream.id} \n        trackId=${this.trackId}\n        saving ${e}, source=${this.source}\n        Track does not have any sink`);yield this.requestLayer(e,"preferLayer"),this.pushInHistory(`uiPreferLayer-${e}`)}}else fe.w("layer none will be ignored")}))}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}replaceTrack(e){this.nativeTrack=e.nativeTrack,e.transceiver&&(this.transceiver=e.transceiver,this.stream.updateId(e.stream.id)),this.videoHandler.updateSinks()}addSink(t,i=!0){return R(this,null,(function*(){Xe(this.nativeTrack)?yield this.requestLayer(this.preferredLayer,"addSink"):(_(e.prototype,this,"addSink").call(this,t),i&&(yield this.updateLayer("addSink"))),this.pushInHistory("uiSetLayer-high")}))}removeSink(t,i=!0){return R(this,null,(function*(){_(e.prototype,this,"removeSink").call(this,t),i&&(yield this.updateLayer("removeSink")),this._degraded=!1,this.pushInHistory("uiSetLayer-none")}))}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e){this._degraded=this.enabled&&(e.publisher_degraded||e.subscriber_degraded)&&"none"===e.current_layer,this._degradedAt=this._degraded?new Date:this._degradedAt;let i=e.current_layer;return fe.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id} \n      trackId=${this.trackId}\n      layer update from sfu\n      currLayer=${e.current_layer}\n      preferredLayer=${e.expected_layer}\n      sub_degraded=${e.subscriber_degraded}\n      pub_degraded=${e.publisher_degraded}\n      isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(i,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${i}`),this._degraded}updateLayer(e){return R(this,null,(function*(){let i=!this.degraded&&this.enabled&&this.hasSinks()?this.preferredLayer:"none";this.shouldSendVideoLayer(i,e)&&(yield this.requestLayer(i,e))}))}pushInHistory(e){}requestLayer(e,i){return R(this,null,(function*(){try{let t=yield this.stream.setVideoLayer(e,this.trackId,this.logIdentifier,i);return fe.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Requested layer ${e}, source=${i}`),t}catch(t){throw fe.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Failed to set layer ${e}, source=${i}\n      error=${t.message}`),t}}))}shouldSendVideoLayer(e,i){let t=this.getLayer();return!(!this.degraded||"none"!==e)||(t!==e||(fe.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${i}`),!1))}},qt=class{constructor(){this.history=[]}push(e){e.time=(new Date).toISOString().split("T")[1],this.history.push(e)}},Jt=class extends $e{constructor(){super(...arguments),this.TAG="[HMSLocalStream]",this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,i){let t=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:this.getTrackEncodings(e,i)});return this.setPreferredCodec(t,e.nativeTrack.kind),e.transceiver=t,t}setMaxBitrateAndFramerate(e){return R(this,null,(function*(){var i;yield null==(i=this.connection)?void 0:i.setMaxBitrateAndFramerate(e)}))}setPreferredCodec(e,i){}replaceStreamTrack(e,i){this.nativeStream.addTrack(i),this.nativeStream.removeTrack(e),fe.d(this.TAG,"Native stream tracks after replace",this.nativeStream.getAudioTracks().map(Ue),`prev Track - ${Ue(e)}`,`new Track - ${Ue(i)}`)}replaceSenderTrack(e,i){return R(this,null,(function*(){if(!this.connection||"closed"===this.connection.connectionState)return void fe.d(this.TAG,"publish connection is not initialised or closed");let t=this.connection.getSenders().find((s=>s.track&&s.track.id===e.id));void 0!==t?yield t.replaceTrack(i):fe.w(this.TAG,`No sender found for trackId=${e.id}`)}))}removeSender(e){var s,a;if(!this.connection||"closed"===this.connection.connectionState)return void fe.d(this.TAG,"publish connection is not initialised or closed");let i=null==(s=e.transceiver)?void 0:s.sender;if(!i)return void fe.w(this.TAG,`No sender found for trackId=${e.trackId}`);null==(a=this.connection)||a.removeTrack(i);let t=this.tracks.indexOf(e);-1!==t?this.tracks.splice(t,1):fe.w(this.TAG,`Cannot find ${e.trackId} in locally stored tracks`)}getTrackEncodings(e,i){let t=[];if(e instanceof Ht)if(i.length>0)fe.d(this.TAG,"Simulcast enabled with layers",i),t.push(...i);else{let s={active:this.nativeStream.active};e.settings.maxBitrate&&!de&&(s.maxBitrate=e.settings.maxBitrate),t.push(s)}return t}},Kt=class extends $e{constructor(e,i){super(e),this.audio=!0,this.video="none",this.connection=i}setAudio(e,i,t){return R(this,null,(function*(){this.audio!==e&&(this.audio=e,fe.d(`[Remote stream] ${t||""} \n    streamId=${this.id}\n    trackId=${i}\n    subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:i},method:"prefer-audio-track-state"}))}))}setVideoLayerLocally(e,i,t){this.video=e,fe.d(`[Remote stream] ${i}\n    streamId=${this.id}\n    source: ${t}\n    Setting layer field to=${e}`)}setVideoLayer(e,i,t,s){return fe.d(`[Remote stream] ${t} \n      streamId=${this.id}\n      trackId=${i} \n      source: ${s} request ${e} layer`),this.setVideoLayerLocally(e,t,s),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:i},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}};var zt=(e,t,r,i)=>R(void 0,null,(function*(){var a;let n,s={};if(null!=(a=t.transceiver)&&a.sender.track){try{n=yield t.transceiver.sender.getStats();let e={},o={},p={};null==n||n.forEach((u=>{switch(u.type){case"outbound-rtp":o[u.id]=u;break;case"remote-inbound-rtp":p[u.ssrc]=u;break;case"codec":e[u.id]=u.mimeType}})),Object.keys(I({},o)).forEach((u=>{var n,l;let d,g=null==(n=o[u])?void 0:n.codecId,c=g?e[g]:void 0;c&&(d=c.substring(c.indexOf("/")+1));let h=C(I({},o[u]),{rid:null==(l=o[u])?void 0:l.rid}),v=p[h.ssrc];s[u]=C(I({},h),{bitrate:ei("bytesSent",h,null==i?void 0:i[u]),packetsLost:null==v?void 0:v.packetsLost,jitter:null==v?void 0:v.jitter,roundTripTime:null==v?void 0:v.roundTripTime,totalRoundTripTime:null==v?void 0:v.totalRoundTripTime,peerName:r,peerID:t.peerId,enabled:t.enabled,codec:d})}))}catch(r){e.analytics.publish(Ne.rtcStatsFailed(Ae.WebrtcErrors.StatsFailed("TRACK",`Error getting local track stats ${t.trackId} - ${r.message}`))),fe.w("[HMSWebrtcStats]","Error in getting local track stats",t,r,r.name)}return s}})),Qt=(e,t,r,i)=>R(void 0,null,(function*(){var n;let o;try{o=yield null==(n=t.transceiver)?void 0:n.receiver.getStats()}catch(r){e.analytics.publish(Ne.rtcStatsFailed(Ae.WebrtcErrors.StatsFailed("TRACK",`Error getting remote track stats ${t.trackId} - ${r.message}`))),fe.w("[HMSWebrtcStats]","Error in getting remote track stats",t,r)}let s=Yt(o),a=ei("bytesReceived",s,i),l=ti("packetsLost",s,i);return null!=s&&s.remote&&Object.assign(s.remote,{packetsLostRate:ti("packetsLost",s.remote,null==i?void 0:i.remote)}),s&&Object.assign(s,{bitrate:a,packetsLostRate:l,peerId:t.peerId,enabled:t.enabled,peerName:r,codec:s.codec})})),Yt=e=>{let t,r,i={};null==e||e.forEach((a=>{switch(a.type){case"inbound-rtp":case"outbound-rtp":t=a;break;case"remote-inbound-rtp":r=a;break;case"codec":i[a.id]=a.mimeType}}));let s,n=null!=t&&t.codecId?i[t.codecId]:void 0;return n&&(s=n.substring(n.indexOf("/")+1)),t&&Object.assign(t,{remote:r,codec:s})},Zt=(e,t,r)=>{let i=Xt(t),n=ei("publish"===e?"bytesSent":"bytesReceived",i,r&&r[e]);return i&&Object.assign(i,{bitrate:n})},Xt=e=>{let t;return null==e||e.forEach((r=>{"transport"===r.type&&(t=null==e?void 0:e.get(r.selectedCandidatePairId))})),t||null==e||e.forEach((e=>{"candidate-pair"===e.type&&e.selected&&(t=e)})),t},ei=(e,t,r)=>8*ti(e,t,r),ti=(e,t,r)=>{let i=t&&t[e],n=r?r[e]:null;return[t,r,Ie(i),Ie(n)].every((a=>!!a))?1e3*ii(i,n,null==t?void 0:t.timestamp,null==r?void 0:r.timestamp):0},ii=(e,t,r,i)=>Ie(e)&&Ie(t)&&r&&i?(e-t)/(r-i):0,si=class{constructor(e,t,i){var r;this.getStats=e,this.store=t,this.eventBus=i,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.remoteTrackStats={},this.localTrackStats={},this.getLocalPeerStats=()=>this.peerStats[this.localPeerID],this.getRemoteTrackStats=e=>this.remoteTrackStats[e],this.getAllRemoteTracksStats=()=>this.remoteTrackStats,this.getLocalTrackStats=()=>this.localTrackStats,this.updateStats=()=>R(this,null,(function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()})),this.updateLocalPeerStats=()=>R(this,null,(function*(){var u,g,e,t,r,n;let o,l=this.getLocalPeerStats();try{o=yield null==(g=(u=this.getStats).publish)?void 0:g.call(u)}catch(e){this.eventBus.analytics.publish(Ne.rtcStatsFailed(Ae.WebrtcErrors.StatsFailed("PUBLISH",e.message))),fe.w(this.TAG,"Error in getting publish stats",e)}let d,i=o&&Zt("publish",o,l);try{d=yield null==(t=(e=this.getStats).subscribe)?void 0:t.call(e)}catch(e){this.eventBus.analytics.publish(Ne.rtcStatsFailed(Ae.WebrtcErrors.StatsFailed("SUBSCRIBE",e.message))),fe.w(this.TAG,"Error in getting subscribe stats",e)}let s=d&&Zt("subscribe",d,l),{packetsLost:a,jitter:c}=(e=>{let t={packetsLost:0,jitter:0};return null==e||e.forEach((e=>{e.packetsLost&&(t.packetsLost+=e.packetsLost),e.jitter>t.jitter&&(t.jitter=e.jitter)})),t})(d),h=ii(a,null==(r=null==l?void 0:l.subscribe)?void 0:r.packetsLost,null==s?void 0:s.timestamp,null==(n=null==l?void 0:l.subscribe)?void 0:n.timestamp),p=s&&Object.assign(s,{packetsLostRate:h,jitter:c,packetsLost:a});this.peerStats[this.localPeerID]={publish:i,subscribe:p}})),this.updateRemoteTrackStats=()=>R(this,null,(function*(){var i;let e=Array.from(this.store.getTracksMap().values()).filter((e=>e instanceof jt||e instanceof Rt)),t=e.map((e=>e.trackId));Object.keys(this.remoteTrackStats).forEach((e=>{t.includes(e)||delete this.remoteTrackStats[e]}));for(let t of e){let s=t.peerId&&(null==(i=this.store.getPeerById(t.peerId))?void 0:i.name),a=this.getRemoteTrackStats(t.trackId),e=yield Qt(this.eventBus,t,s,a);e&&(this.remoteTrackStats[t.trackId]=e)}})),this.updateLocalTrackStats=()=>R(this,null,(function*(){var i;let e=this.store.getLocalPeerTracks().reduce(((e,s)=>(e[s.getTrackIDBeingSent()]=s,e)),{}),t=((e,t)=>Array.from(new Set(e.concat(t))))(Object.keys(this.localTrackStats),Object.keys(e));for(let r of t){let s=e[r];if(s){let a=null==(i=this.store.getLocalPeer())?void 0:i.name,e=yield zt(this.eventBus,s,a,this.localTrackStats[r]);e&&(this.localTrackStats[r]=e)}else delete this.localTrackStats[r]}})),this.localPeerID=null==(r=this.store.getLocalPeer())?void 0:r.peerId}},ri=class{constructor(e,t,i,r){this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=r,this.TAG="[HMSWebrtcInternals]",this.interval=1e3,this.isMonitored=!1,this.handleStatsUpdate=()=>R(this,null,(function*(){var e;yield null==(e=this.hmsStats)?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)}))}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,r;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new si({publish:null==(i=this.publishConnection)?void 0:i.getStats.bind(this.publishConnection),subscribe:null==(r=this.subscribeConnection)?void 0:r.getStats.bind(this.subscribeConnection)},this.store,this.eventBus)}start(){return R(this,null,(function*(){this.isMonitored?fe.d(this.TAG,"Already started"):(this.stop(),this.isMonitored=!0,fe.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then((()=>fe.d(this.TAG,"Stopping Webrtc Stats Monitor"))).catch((e=>{this.eventBus.analytics.publish(Ne.rtcStatsFailed(Ae.WebrtcErrors.StatsFailed("PUBLISH",e.message))),fe.e(this.TAG,e.message)})))}))}stop(){this.isMonitored=!1}startLoop(){return R(this,null,(function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield it(this.interval)}))}cleanup(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}},ni=M().version;fe.d("adapter",`${c.a.browserDetails.browser} v${c.a.browserDetails.version}`),fe.d("sdk version",ni);var ai,oi,s,di={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},ci=class e{constructor(e,t,i,r,s){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=r,this.analyticsTimer=s,this.TAG="[LocalTrackManager]",this.setScreenCaptureHandleConfig()}getTracksToPublish(){return R(this,arguments,(function*(e=di){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,r=!!t.video,s=[],{videoTrack:a,audioTrack:n}=yield this.updateCurrentLocalTrackSettings(t),o=(null==a?void 0:a.stream)||(null==n?void 0:n.stream),p=!(!a||!this.store.getTrackById(a.trackId)),u=!(!n||!this.store.getTrackById(n.trackId));if(p&&u)return[];let g={audio:i&&!n&&(!e.isAudioMuted||"empty"),video:r&&!a&&(!e.isVideoMuted||"empty")};g.audio&&this.analyticsTimer.start("local_audio_track_time"),g.video&&this.analyticsTimer.start("local_video_track_time");try{fe.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:g}),s=yield this.getLocalTracks(g,t,o)}catch(e){s=yield this.retryGetLocalTracks(e,t,g,o)}return g.audio&&this.analyticsTimer.end("local_audio_track_time"),g.video&&this.analyticsTimer.end("local_video_track_time"),a&&r&&!p&&s.push(a),n&&i&&!u&&s.push(n),s}))}getLocalTracks(){return R(this,arguments,(function*(e={audio:!0,video:!0},t,i){try{let r=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(r,t,i)}catch(e){throw this.eventBus.analytics.publish(Ne.publish({devices:this.deviceManager.getDevices(),error:e,settings:t})),e}}))}getNativeLocalTracks(){return R(this,arguments,(function*(e={audio:!1,video:!1},t){let i=new Ct(!0===e.video?t.video:null,!0===e.audio?t.audio:null,t.simulcast),r=[];return(i.audio||i.video)&&r.push(...yield this.getAVTracks(i)),r.push(...this.getEmptyTracks(e)),r}))}getLocalScreen(e){return R(this,null,(function*(){var g;let s,t=yield this.getOrDefaultScreenshareConfig(e),i=this.getScreenshareSettings(t.videoOnly),r={video:C(I({},null==i?void 0:i.video.toConstraints(!0)),{displaySurface:t.displaySurface}),preferCurrentTab:t.preferCurrentTab,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio};if(null!=i&&i.audio){let e=null==(g=null==i?void 0:i.audio)?void 0:g.toConstraints();delete e.advanced,r.audio=C(I({},e),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}try{fe.d("retrieving screenshare with ",{config:t},{constraints:r}),s=yield navigator.mediaDevices.getDisplayMedia(r)}catch(e){fe.w(this.TAG,"error in getting screenshare - ",e);let t=xe(e,"screen");throw this.eventBus.analytics.publish(Ne.publish({error:t,devices:this.deviceManager.getDevices(),settings:new Ct(null==i?void 0:i.video,null==i?void 0:i.audio,!1)})),t}let a=[],n=new Jt(s),o=s.getVideoTracks()[0],p=new Ht(n,o,"screen",this.eventBus,null==i?void 0:i.video);p.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let e=this.validateCurrentTabCapture(p,t.forceCurrentTab);p.isCurrentTab=e,yield p.cropTo(t.cropTarget)}catch(e){throw s.getTracks().forEach((e=>e.stop())),e}a.push(p);let u=s.getAudioTracks()[0];if(u){let e=new _t(n,u,"screen",this.eventBus,null==i?void 0:i.audio);a.push(e)}return fe.v(this.TAG,"getLocalScreen",a),a}))}setScreenCaptureHandleConfig(e){var t;null==(t=navigator.mediaDevices)||!t.setCaptureHandleConfig||this.isInIframe()||(e=e||{},Object.assign(e,{handle:Object(l.a)(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),fe.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),r=!(!this.captureHandleIdentifier||(null==i?void 0:i.handle)!==this.captureHandleIdentifier);if(t&&!r)throw fe.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),Ae.TracksErrors.CurrentTabNotShared();return r}requestPermissions(){return R(this,null,(function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach((e=>e.stop()))}catch(e){fe.e(this.TAG,e)}}))}static getEmptyVideoTrack(e){var t,r,p;let n=(null==(t=null==e?void 0:e.getSettings())?void 0:t.width)||320,i=(null==(r=null==e?void 0:e.getSettings())?void 0:r.height)||240;ai||((ai=document.createElement("canvas")).width=n,ai.height=i,null==(p=ai.getContext("2d"))||p.fillRect(0,0,n,i)),oi||(oi=setInterval((()=>{let u=null==ai?void 0:ai.getContext("2d");u&&u.fillRect(0,0,1,1)}),1e3));let a=ai.captureStream(1).getVideoTracks()[0];return a.enabled=!1,a}static getEmptyAudioTrack(){let e=et.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let r=i.stream.getAudioTracks()[0];return r.enabled=!1,r}static cleanup(){clearInterval(oi),oi=void 0,ai=void 0}getAVTracks(e){return R(this,null,(function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:!!e.audio&&e.audio.toConstraints(),video:!!e.video&&e.video.toConstraints()});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!(this.deviceManager.hasWebcamPermission||!e.video),r=!(this.deviceManager.hasMicrophonePermission||!e.audio);throw xe(t,this.getErrorType(i,r))}}))}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return t||i?(new It).video(i).audio(t).build():null}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,r){return R(this,null,(function*(){if(!(e instanceof Se&&"TRACK"===e.action))return fe.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[];{this.observer.onFailure(e);let s=e.code===ye.TracksErrors.OVER_CONSTRAINED,a=e.message.includes("audio"),n=e.message.includes("video");if(s){let n=(new It).video(new Pt).audio(new Et).build();fe.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,n,r)}catch(e){let u=e instanceof Se?e.nativeError:e,g=e;if("OverconstrainedError"===(null==u?void 0:u.name)){let e=Ae.TracksErrors.GenericTrack("TRACK","Overconstrained error after dropping all constraints");e.addNativeError(u),g=e}return yield this.retryGetLocalTracks(g,t,i,r)}}i.audio=a?"empty":i.audio,i.video=n?"empty":i.video,fe.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,r)}catch(e){return fe.w(this.TAG,"Fetch empty tacks failed",e),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(e),yield this.getLocalTracks(i,t,r)}}}))}getErrorType(e,t){return e&&t?"audio, video":e?"video":t?"audio":"unknown(video or audio)"}getEmptyTracks(t){let r=[];return"empty"===t.audio&&r.push(e.getEmptyAudioTrack()),"empty"===t.video&&r.push(e.getEmptyVideoTrack()),r}updateCurrentLocalTrackSettings(e){return R(this,null,(function*(){let t=this.store.getLocalPeerTracks(),i=t.find((e=>"video"===e.type&&"regular"===e.source)),r=t.find((e=>"audio"===e.type&&"regular"===e.source)),s=t.find((e=>"video"===e.type&&"screen"===e.source));null!=e&&e.video&&(yield null==i?void 0:i.setSettings(e.video)),null!=e&&e.audio&&(yield null==r?void 0:r.setSettings(e.audio));let a=this.getScreenshareSettings(!0);return null!=a&&a.video&&(yield null==s?void 0:s.setSettings(null==a?void 0:a.video)),{videoTrack:i,audioTrack:r}}))}getAudioSettings(e){var a;let t=this.store.getPublishParams();if(!t||null==(a=t.allowed)||!a.includes("audio"))return null;let i=this.store.getLocalPeer(),r=null==i?void 0:i.audioTrack,s=(null==r?void 0:r.settings.deviceId)||e.audioInputDeviceId;return(new bt).codec(t.audio.codec).maxBitrate(t.audio.bitRate).deviceId(s||di.audioInputDeviceId).build()}getVideoSettings(e){var t;let r=this.store.getPublishParams();if(!r||null==(t=r.allowed)||!t.includes("video"))return null;let i=this.store.getLocalPeer(),n=null==i?void 0:i.videoTrack,s=(null==n?void 0:n.settings.deviceId)||e.videoDeviceId,a=r.video;return(new At).codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(a.width).setHeight(a.height).deviceId(s||di.videoDeviceId).build()}getScreenshareSettings(e=!1){var t;let r=this.store.getPublishParams();if(!r||null==(t=r.allowed)||!t.includes("screen"))return null;let i=r.screen;return{video:(new At).maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(i.width).setHeight(i.height).build(),audio:e?void 0:(new bt).build()}}getOrDefaultScreenshareConfig(e){return R(this,null,(function*(){var i;let t=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return t.forceCurrentTab&&(t.videoOnly=!0,t.preferCurrentTab=!0,t.selfBrowserSurface="include",t.surfaceSwitching="exclude"),t.preferCurrentTab&&(t.selfBrowserSurface="include",t.displaySurface=void 0),t.cropElement&&null!=(i=window.CropTarget)&&i.fromElement&&(t.cropTarget=yield window.CropTarget.fromElement(t.cropElement)),t}))}createHMSLocalTracks(e,t,i){let r=e.find((e=>"video"===e.kind)),s=e.find((e=>"audio"===e.kind));i?e.forEach((e=>null==i?void 0:i.nativeStream.addTrack(e))):i=new Jt(new MediaStream(e));let a=[];if(s&&null!=t&&t.audio){let e=new _t(i,s,"regular",this.eventBus,t.audio);a.push(e)}if(r&&null!=t&&t.video){let e=new Ht(i,r,"regular",this.eventBus,t.video);e.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),a.push(e)}return a}},hi=class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="[NetworkTestManager]",this.controller=new AbortController,this.start=e=>R(this,null,(function*(){var p;if(!e)return;let{url:t,timeout:i,scoreMap:r}=e,s=this.controller.signal,a=Date.now(),n=0,o=it(i).then((()=>{this.controller.abort()}));try{let g=null==(p=(yield fetch(`${t}?${Date.now()}`,{signal:s})).body)?void 0:p.getReader();if(!g)throw Error("unable to process request");let e=()=>R(this,null,(function*(){if(g)try{let e=!1;for(;!e;){let{value:t,done:o}=yield g.read();e=o,t&&(n+=t.byteLength,this.sendScore({scoreMap:r,downloadedSize:n,startTime:a}))}}catch(e){"AbortError"!==e.name&&fe.d(this.TAG,e)}}));return Promise.race([e(),o]).then((()=>{this.sendScore({scoreMap:r,downloadedSize:n,startTime:a,finished:!0})})).catch((e=>{fe.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(Ne.previewNetworkQuality({error:e.message}))}))}catch(e){"AbortError"!==e.name?(fe.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(Ne.previewNetworkQuality({error:e.message}))):fe.d(this.TAG,e)}})),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:r=!1})=>{let n=t/1024/((Date.now()-i)/1e3)*8,o=-1;for(let p in e){let u=e[p];n>=u.low&&(!u.high||n<=u.high)&&(o=Number(p))}this.updateScoreToListener(o),r&&this.eventBus.analytics.publish(Ne.previewNetworkQuality({score:o,downLink:n.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,null==(i=null==(t=this.listener)?void 0:t.onNetworkQuality)||i.call(t,e))}},ui=class{constructor(e,t,i,r,s,a){this.store=e,this.transport=t,this.deviceManager=i,this.publish=r,this.removeAuxiliaryTrack=s,this.listener=a,this.handleLocalPeerRoleUpdate=i=>R(this,[i],(function*({oldRole:e,newRole:t}){var s;let r=this.store.getLocalPeer();r&&(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),null==(s=this.listener)||s.onPeerUpdate(8,r))})),this.diffRolesAndPublishTracks=i=>R(this,[i],(function*({oldRole:e,newRole:t}){var r,n,o,l,d,c,h;let v=new Set(e.publishParams.allowed),s=new Set(t.publishParams.allowed),a=this.removeTrack(v,s,"video"),m=this.removeTrack(v,s,"audio"),T=this.removeTrack(v,s,"screen"),p=this.hasSimulcastDifference(null==(r=e.publishParams.simulcast)?void 0:r.video,null==(n=t.publishParams.simulcast)?void 0:n.video),u=this.hasSimulcastDifference(null==(o=e.publishParams.simulcast)?void 0:o.screen,null==(l=t.publishParams.simulcast)?void 0:l.screen),g=null==(c=null==(d=this.store.getLocalPeer())?void 0:d.videoTrack)?void 0:c.enabled;yield this.removeAudioTrack(m),yield this.removeVideoTracks(a||p),yield this.removeScreenTracks(T||u);let k=(null==(h=this.store.getConfig())?void 0:h.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};p&&(k.isVideoMuted=!g),yield this.publish(k),yield this.syncDevices(k,t)}))}syncDevices(e,t){return R(this,null,(function*(){(!e.isAudioMuted||!e.isVideoMuted)&&t.publishParams.allowed.length>0&&(yield this.deviceManager.init(!0))}))}removeVideoTracks(e){return R(this,null,(function*(){var i;if(!e)return;let t=this.store.getLocalPeer();null!=t&&t.videoTrack&&(t.videoTrack.isPublished?yield this.transport.unpublish([t.videoTrack]):yield t.videoTrack.cleanup(),null==(i=this.listener)||i.onTrackUpdate(1,t.videoTrack,t),t.videoTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"video"===e.type))}))}removeAudioTrack(e){return R(this,null,(function*(){var i;if(!e)return;let t=this.store.getLocalPeer();null!=t&&t.audioTrack&&(t.audioTrack.isPublished?yield this.transport.unpublish([t.audioTrack]):yield t.audioTrack.cleanup(),null==(i=this.listener)||i.onTrackUpdate(1,t.audioTrack,t),t.audioTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"audio"===e.type))}))}removeScreenTracks(e){return R(this,null,(function*(){e&&(yield this.removeAuxTracks((e=>"screen"===e.source)))}))}removeAuxTracks(e){return R(this,null,(function*(){let t=this.store.getLocalPeer();if(null!=t&&t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let t of i)e(t)&&(yield this.removeAuxiliaryTrack(t.trackId))}}))}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,r,s;return!(!e&&!t)&&((null==(i=null==e?void 0:e.layers)?void 0:i.length)!==(null==(r=null==t?void 0:t.layers)?void 0:r.length)||!(null==(s=null==e?void 0:e.layers)||!s.some((a=>{var e;let r=null==(e=null==t?void 0:t.layers)?void 0:e.find((p=>p.rid===a.rid));return(null==r?void 0:r.maxBitrate)!==a.maxBitrate||(null==r?void 0:r.maxFramerate)!==a.maxFramerate}))))}},pi=new class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new me("client-events"),this.isConnected=!0,this.env=null,this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env)return void this.addEventToStorage(e);let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}},i="prod"===this.env?"https://event.100ms.live/v2/client/report":"https://event-nonprod.100ms.live/v2/client/report";fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then((t=>{if(401!==t.status){if(200!==t.status)throw Error(t.statusText);this.removeFromStorage(e)}else this.removeFromStorage(e)})).catch((t=>{fe.v(this.TAG,"Failed to send event",t,e),this.addEventToStorage(e)}))}flushFailedEvents(){let e=this.failedEvents.get();null==e||e.forEach((e=>this.sendEvent(e)))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find((i=>i.timestamp===e.timestamp))||(100===t.length&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex((t=>t.timestamp===e.timestamp));i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},vi=class{constructor(){this.knownRoles={},this.peers={},this.tracks=new Map,this.peerTrackStates={},this.speakers=[],this.roleDetailsArrived=!1,this.env="prod",this.simulcastEnabled=!1,this.userAgent=Re(this.env),this.polls=new Map}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(null==e?void 0:e.asRole)||(null==e?void 0:e.role);return null==t?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getTemplateAppData(){return this.templateAppData}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter((e=>!e.isLocal))}getPeers(){return Object.values(this.peers)}getPeerMap(){return this.peers}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Array.from(this.tracks.values())}getVideoTracks(){return this.getTracks().filter((e=>"video"===e.type))}getRemoteVideoTracks(){return this.getTracks().filter((e=>e instanceof jt))}getAudioTracks(){return this.getTracks().filter((e=>"audio"===e.type))}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return null!=t&&t.videoTrack&&i.push(t.videoTrack),null!=t&&t.audioTrack&&i.push(t.audioTrack),i.concat((null==t?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}hasTrack(e){return this.tracks.has(e)}getTrackById(e){var t,s;let r=Array.from(this.tracks.values()).find((a=>a.trackId===e));if(r)return r;let i=this.getLocalPeer();if(i){if(null!=(t=i.audioTrack)&&t.isPublishedTrackId(e))return i.audioTrack;if(null!=(s=i.videoTrack)&&s.isPublishedTrackId(e))return i.videoTrack}}getPeerByTrackId(e){let t=Array.from(this.tracks.values()).find((i=>i.trackId===e));return null!=t&&t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map((e=>e.peer))}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=Re(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var i,t;if(this.knownRoles=e.known_roles,this.roleDetailsArrived=!0,this.templateAppData=e.app_data,!this.simulcastEnabled)return;let r=null==(i=this.knownRoles[e.name])?void 0:i.publishParams;this.videoLayers=this.convertSimulcastLayers(null==(t=r.simulcast)?void 0:t.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,r;if(je.rememberDevices(!!e.rememberDeviceSelection),e.rememberDeviceSelection){let s=je.getSelection();s&&(e.settings||(e.settings={}),null!=(t=s.audioInput)&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||s.audioInput.deviceId),null!=(i=s.audioOutput)&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||s.audioOutput.deviceId),null!=(r=s.videoInput)&&r.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||s.videoInput.deviceId))}e.autoManageVideo=!1!==e.autoManageVideo,e.autoManageWakeLock=!1!==e.autoManageWakeLock,this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks.set(e,e)}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){this.tracks.delete(e)}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return R(this,null,(function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)}))}updateAudioOutputDevice(e){return R(this,null,(function*(){let t=[];this.getAudioTracks().forEach((i=>{i instanceof Rt&&t.push(i.setOutputDevice(e))})),yield Promise.all(t)}))}getSimulcastLayers(e){var t;return this.simulcastEnabled&&["screen","regular"].includes(e)?"screen"===e?[]:(null==(t=this.videoLayers)?void 0:t.layers)||[]:[]}convertSimulcastLayers(e){if(e)return C(I({},e),{layers:(e.layers||[]).map((e=>C(I({},e),{maxBitrate:1e3*e.maxBitrate})))})}getSimulcastDefinitionsForPeer(e,t){var r,n,p;if([!e||!e.role,"screen"===t,!this.simulcastEnabled].some((u=>!!u)))return[];let o,s,a,i=this.getPolicyForRole(e.role.name).publishParams;return"regular"===t?(o=null==(r=i.simulcast)?void 0:r.video,s=i.video.width,a=i.video.height):"screen"===t&&(o=null==(n=i.simulcast)?void 0:n.screen,s=i.screen.width,a=i.screen.height),(null==(p=null==o?void 0:o.layers)?void 0:p.map((u=>({layer:gt[u.rid],resolution:{width:Math.floor(s/u.scaleResolutionDownBy),height:Math.floor(a/u.scaleResolutionDownBy)}}))))||[]}setPoll(e){this.polls.set(e.id,e)}getPoll(e){return this.polls.get(e)}getErrorListener(){return this.errorListener}cleanup(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach((e=>{var t;e.role?e.role=this.getPolicyForRole(e.role.name):null==(t=this.errorListener)||t.onError(Ae.GenericErrors.InvalidRole("VALIDATION",""))}))}setEnv(){var e;let t=(null==(e=this.config)?void 0:e.initEndpoint).split("https://")[1],i="prod";t.startsWith("prod")?i="prod":t.startsWith("qa")?i="qa":t.startsWith("dev")&&(i="dev"),this.env=i,pi.setEnv(i)}},gi=class{constructor(){this.TAG="[WakeLockManager]",this.wakeLock=null,this.acquireLock=()=>R(this,null,(function*(){yield this.requestWakeLock(),null==document||document.addEventListener("visibilitychange",this.visibilityHandler)})),this.cleanup=()=>R(this,null,(function*(){if(this.wakeLock&&!this.wakeLock.released)try{yield this.wakeLock.release(),fe.d(this.TAG,"Wake lock released")}catch(e){let t=e;fe.w(this.TAG,"Error while releasing wake lock",`name=${t.name}, message=${t.message}`)}this.wakeLock=null})),this.visibilityHandler=()=>R(this,null,(function*(){"visible"===(null==document?void 0:document.visibilityState)&&(!this.wakeLock||this.wakeLock.released)&&(fe.d(this.TAG,"Re-acquiring wake lock due to visibility change"),yield this.requestWakeLock())})),this.requestWakeLock=()=>R(this,null,(function*(){try{if(!("wakeLock"in navigator))return void fe.d(this.TAG,"Wake lock feature not supported");this.wakeLock=yield navigator.wakeLock.request("screen"),fe.d(this.TAG,"Wake lock acquired")}catch(e){let t=e;fe.w(this.TAG,"Error acquiring wake lock",`name=${t.name}, message=${t.message}`)}}))}},mi=class{constructor(e){this.store=e,this.bufferSize=100,this.TAG="[AnalyticsEventsService]",this.transport=null,this.pendingEvents=[],this.level=1}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let e=this.pendingEvents.shift();fe.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",e)}return this}flushFailedClientEvents(){pi.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=null==(e=this.store.getLocalPeer())?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(e){fe.w(this.TAG,"Flush Failed",e)}}sendClientEventOnHTTP(e){var t,s,a,r;let n=this.store.getRoom(),i=this.store.getLocalPeer();e.metadata.token=null==(t=this.store.getConfig())?void 0:t.authToken,e.metadata.peer={session_id:null==n?void 0:n.sessionId,room_id:null==n?void 0:n.id,room_name:null==n?void 0:n.name,template_id:null==n?void 0:n.templateId,joined_at:null==(s=null==n?void 0:n.joinedAt)?void 0:s.getTime(),session_started_at:null==(a=null==n?void 0:n.startedAt)?void 0:a.getTime(),role:null==(r=null==i?void 0:i.role)?void 0:r.name,user_name:null==i?void 0:i.name,user_data:null==i?void 0:i.metadata,peer_id:null==i?void 0:i.peerId},pi.sendEvent(e)}},Ti={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},ki=class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=I({},Ti),this.handleAudioPaused=e=>R(this,null,(function*(){var s;let i=null==(s=e.target.srcObject)?void 0:s.getAudioTracks()[0];if(null==i||!i.enabled)return;fe.d(this.TAG,"Audio Paused",e.target.id);let t=this.store.getTrackById(e.target.id);t&&(he()?(yield it(500),this.playAudioFor(t)):this.autoPausedTracks.add(t))})),this.handleTrackUpdate=({track:e})=>{fe.d(this.TAG,"Track updated",`${e}`)},this.handleTrackAdd=e=>R(this,[e],(function*({track:e,peer:t,callListener:i=!0}){var a,r;let s=document.createElement("audio");s.style.display="none",s.id=e.trackId,s.addEventListener("pause",this.handleAudioPaused),s.onerror=()=>R(this,null,(function*(){var p,u;fe.e(this.TAG,"error on audio element",s.error);let r=Ae.TracksErrors.AudioPlaybackError(`Audio playback error for track - ${e.trackId} code - ${null==(p=null==s?void 0:s.error)?void 0:p.code}`);this.eventBus.analytics.publish(Ne.audioPlaybackError(r)),(null==(u=null==s?void 0:s.error)?void 0:u.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(s,e),yield it(500),yield this.handleTrackAdd({track:e,peer:t,callListener:!1}))})),e.setAudioElement(s),e.setVolume(this.volume),fe.d(this.TAG,"Audio track added",`${e}`),this.init(),null==(a=this.audioSink)||a.append(s),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),s.srcObject=new MediaStream([e.nativeTrack]),i&&(null==(r=this.listener)||r.onTrackUpdate(0,e,t)),yield this.handleAutoplayError(e)})),this.handleAutoplayError=e=>R(this,null,(function*(){void 0===this.state.autoplayFailed&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise((t=>{this.playAudioFor(e).then(t)}))),yield this.state.autoplayCheckPromise),this.state.autoplayFailed?this.autoPausedTracks.add(e):yield this.playAudioFor(e)})),this.handleAudioDeviceChange=e=>{e.error||!e.selection||"video"===e.type||this.unpauseAudioTracks()},this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&0===this.audioSink.childElementCount&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),fe.d(this.TAG,"Audio track removed",`${e}`)},this.unpauseAudioTracks=()=>R(this,null,(function*(){let e=[];this.autoPausedTracks.forEach((t=>{e.push(this.playAudioFor(t))})),yield Promise.all(e)})),this.removeAudioElement=(e,t)=>{e&&(fe.d(this.TAG,"removing audio element",`${t}`),e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))},this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return R(this,null,(function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e}))}unblockAutoplay(){return R(this,null,(function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()}))}init(e){if(this.state.initialized||this.audioSink)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${Object(l.a)()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t,fe.d(this.TAG,"audio sink created",this.audioSink)}cleanup(){var e;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=I({},Ti)}playAudioFor(e){return R(this,null,(function*(){let t=e.getAudioElement();if(t)try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),fe.d(this.TAG,"Played track",`${e}`)}catch(r){this.autoPausedTracks.add(e),fe.w(this.TAG,"Failed to play track",`${e}`,r);let t=r;if(!this.state.autoplayFailed&&"NotAllowedError"===t.name){this.state.autoplayFailed=!0;let s=Ae.TracksErrors.AutoplayBlocked("AUTOPLAY","");s.addNativeError(t),this.eventBus.analytics.publish(Ne.autoplayError()),this.eventBus.autoplayError.publish(s)}}else fe.w(this.TAG,"No audio element found on track",e.trackId)}))}},fi=class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.updateOutputDevice=e=>R(this,null,(function*(){let t=this.audioOutput.find((i=>i.deviceId===e));return t&&(this.outputDevice=t,yield this.store.updateAudioOutputDevice(t),je.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t})),this.getCurrentSelection=()=>{var a,e;let t=this.store.getLocalPeer(),r=this.createIdentifier(null==(a=null==t?void 0:t.audioTrack)?void 0:a.getMediaTrackSettings()),i=this.createIdentifier(null==(e=null==t?void 0:t.videoTrack)?void 0:e.getMediaTrackSettings()),n=this.audioInput.find((e=>this.createIdentifier(e)===r)),s=this.videoInput.find((e=>this.createIdentifier(e)===i));return{audioInput:n,videoInput:s,audioOutput:this.outputDevice}},this.computeChange=(e,t)=>e.length!==t.length||t.some((i=>!e.includes(this.createIdentifier(i)))),this.enumerateDevices=()=>R(this,null,(function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach((e=>{"audioinput"===e.kind&&e.label?(this.hasMicrophonePermission=!0,this.audioInput.push(e)):"audiooutput"===e.kind?this.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(this.hasWebcamPermission=!0,this.videoInput.push(e))})),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),je.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){fe.e(this.TAG,"Failed enumerating devices",e)}})),this.handleDeviceChange=st((()=>R(this,null,(function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(null==e?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(null==e?void 0:e.videoTrack),this.eventBus.analytics.publish(Ne.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}))),500).bind(this),this.handleAudioInputDeviceChange=e=>R(this,null,(function*(){if(!e)return void fe.d(this.TAG,"No Audio track on local peer");if(!this.audioInputChanged)return void fe.d(this.TAG,"No Change in AudioInput Device");let t=this.getNewAudioInputDevice();if(!t||!t.deviceId)return this.eventBus.analytics.publish(Ne.deviceChange({selection:{audioInput:t},error:Ae.TracksErrors.SelectedDeviceMissing("audio"),devices:this.getDevices(),type:"audioInput"})),void fe.e(this.TAG,"Audio device not found");let{settings:i}=e,r=(new bt).codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(e){fe.e(this.TAG,"[Audio Device Change]",e),this.eventBus.analytics.publish(Ne.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:e})),this.eventBus.deviceChange.publish({error:e,selection:t,type:"audioInput",devices:this.getDevices()})}})),this.handleVideoInputDeviceChange=e=>R(this,null,(function*(){if(!e)return void fe.d(this.TAG,"No video track on local peer");if(!this.videoInputChanged)return void fe.d(this.TAG,"No Change in VideoInput Device");let t=this.videoInput[0];if(!t||!t.deviceId)return this.eventBus.analytics.publish(Ne.deviceChange({selection:{videoInput:t},error:Ae.TracksErrors.SelectedDeviceMissing("video"),devices:this.getDevices(),type:"video"})),void fe.e(this.TAG,"Video device not found");let{settings:i}=e,r=(new At).codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(e){fe.e(this.TAG,"[Video Device Change]",e),this.eventBus.analytics.publish(Ne.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:e})),this.eventBus.deviceChange.publish({error:e,type:"video",selection:t,devices:this.getDevices()})}}));let i=({enabled:e,track:s})=>e&&"regular"===s.source;this.eventBus.localVideoEnabled.waitFor(i).then((()=>R(this,null,(function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})))),this.eventBus.localAudioEnabled.waitFor(i).then((()=>R(this,null,(function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))))}init(e=!1){return R(this,null,(function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(Ne.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))}))}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanup(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find((e=>"default"===e.deviceId));return e?this.audioInput.find((i=>"default"!==i.deviceId&&e.label.includes(i.label))):this.audioInput[0]}setOutputDevice(e=!1){return R(this,null,(function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>this.createIdentifier(e)===i)),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>"default"===e.deviceId))||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(Ne.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))}))}getAudioOutputDeviceMatchingInput(e){var t,s;let r=(null==(s=null==(t=this.store.getConfig())?void 0:t.settings)?void 0:s.speakerAutoSelectionBlacklist)||[];if("all"===r)return;let i=(null==e?void 0:e.label.toLowerCase())||"";return!r.some((a=>i.includes(a.toLowerCase())))&&null!=e&&e.groupId?this.audioOutput.find((a=>"default"!==e.deviceId&&a.label===e.label)):void 0}logDevices(e=""){fe.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}},yi=class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return R(this,null,(function*(){yield this.audioSinkManager.unblockAutoplay(),yield et.resumeContext()}))}},Si=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=e=>{this.eventEmitter.emit(this.eventName,e)},this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)},this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)},this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)},this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},bi=class{constructor(){this.eventEmitter=new h.EventEmitter2,this.deviceChange=new Si(F,this.eventEmitter),this.localAudioEnabled=new Si(x,this.eventEmitter),this.localVideoEnabled=new Si(B,this.eventEmitter),this.statsUpdate=new Si($,this.eventEmitter),this.trackDegraded=new Si(U,this.eventEmitter),this.trackRestored=new Si(V,this.eventEmitter),this.trackAudioLevelUpdate=new Si(W,this.eventEmitter),this.audioPluginFailed=new Si(J,this.eventEmitter),this.localAudioSilence=new Si(H,this.eventEmitter),this.analytics=new Si(j,this.eventEmitter),this.policyChange=new Si(K,this.eventEmitter),this.localRoleUpdate=new Si(z,this.eventEmitter),this.audioTrackUpdate=new Si(Q,this.eventEmitter),this.audioTrackAdded=new Si(Y,this.eventEmitter),this.audioTrackRemoved=new Si(Z,this.eventEmitter),this.autoplayError=new Si(X,this.eventEmitter),this.leave=new Si(ee,this.eventEmitter)}},Ei=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof Ve?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}},Ai=class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var s,a,t;let r=e["speaker-list"],i=r.map((e=>({audioLevel:e.level,peer:this.store.getPeerById(e.peer_id),track:this.store.getTrackById(e.track_id)})));null==(s=this.audioListener)||s.onAudioLevelUpdate(i),this.store.updateSpeakers(i);let n=r[0];if(n){let e=this.store.getPeerById(n.peer_id);null==(a=this.listener)||a.onPeerUpdate(4,e)}else null==(t=this.listener)||t.onPeerUpdate(5,null)}},Pi=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[BroadcastManager]"}handleNotification(e,t){"on-broadcast"===e&&this.handleBroadcast(t)}handleBroadcast(e){var p;let t=e.peer,i=e.info,r=e.roles,s=this.getSender(t),a=e.private?this.store.getLocalPeer():void 0,n=[];if(null!=r&&r.length){let u=this.store.getKnownRoles();for(let g of r)u[g]&&n.push(u[g])}let o=new D(C(I({},i),{sender:s,recipientRoles:n,recipientPeer:a,time:new Date(e.timestamp),id:e.message_id}));fe.d(this.TAG,`Received Message from sender=${null==t?void 0:t.peer_id}: ${o}`),null==(p=this.listener)||p.onMessageReceived(o)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=ae(e,this.store)),t}},Ii=class{constructor(e,t){this.store=e,this.listener=t}handleQualityUpdate(e){var t;let i=e.peers.map((s=>{let a=this.store.getPeerById(s.peer_id);return a&&a.updateNetworkQuality(s.downlink_score),{peerID:s.peer_id,downlinkQuality:s.downlink_score}}));null==(t=this.listener)||t.onConnectionQualityUpdate(i)}},Ci=class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.TAG="[TrackManager]",this.tracksToProcess=new Map,this.handleTrackAdd=e=>{fe.d(this.TAG,"ONTRACKADD",`${e}`),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()},this.handleTrackRemovedPermanently=e=>{fe.d(this.TAG,"ONTRACKREMOVE",e),Object.keys(e.tracks).forEach((i=>{var e;let t=this.store.getTrackState(i);if(!t)return;let s=this.store.getTrackById(i);if(!s)return void fe.d(this.TAG,"Track not found in store");"audio"===s.type&&this.eventBus.audioTrackRemoved.publish(s),this.store.removeTrack(s);let a=this.store.getPeerById(t.peerId);a&&(this.removePeerTracks(a,s),null==(e=this.listener)||e.onTrackUpdate(1,s,a))}))},this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],r=this.store.getTrackById(t);!r||!this.store.getPeerByTrackId(t)||r instanceof jt&&this.setLayer(r,i)}},this.handleTrackUpdate=(e,t=!0)=>{var s,a;let i=this.store.getPeerById(e.peer.peer_id),r=e.peer;if(i||r){i||(i=ae(r,this.store),this.store.addPeer(i));for(let r in e.tracks){let n=Object.assign({},null==(s=this.store.getTrackState(r))?void 0:s.trackInfo),p=e.tracks[r],u=this.store.getTrackById(r);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:I(I({},n),p)}),!u||this.tracksToProcess.has(r))this.processTrackInfo(p,e.peer.peer_id,t),this.processPendingTracks();else{u.setEnabled(!p.mute);let g=this.processTrackUpdate(u,n,p);g&&(null==(a=this.listener)||a.onTrackUpdate(g,u,i))}}}else fe.d(this.TAG,"Track Update ignored - Peer not added to store")},this.processTrackInfo=(e,t,i)=>{},this.processPendingTracks=()=>{new Map(this.tracksToProcess).forEach((e=>{var s;let i=this.store.getTrackState(e.trackId);if(!i)return void fe.d(this.TAG,"TrackState not added to store",`peerId - ${e.peerId}`,`trackId -${e.trackId}`);let t=this.store.getPeerById(i.peerId);t?(e.source=i.trackInfo.source,e.peerId=t.peerId,e.logIdentifier=t.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(t,e),this.addVideoTrack(t,e),"audio"===e.type?this.eventBus.audioTrackAdded.publish({track:e,peer:t}):null==(s=this.listener)||s.onTrackUpdate(0,e,t),this.tracksToProcess.delete(e.trackId)):fe.d(this.TAG,"Peer not added to store, peerId",i.peerId)}))}}handleTrackMetadataAdd(e){fe.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks){let i=e.tracks[t];this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:i})}this.processPendingTracks()}handleTrackRemove(e,t=!0){var s;fe.d(this.TAG,"ONTRACKREMOVE",`${e}`);let i=this.store.getTrackState(e.trackId);if(i)if(this.store.hasTrack(e)){if(t){this.store.removeTrack(e);let a=this.store.getPeerById(i.peerId);if(!a)return;this.removePeerTracks(a,e),null==(s=this.listener)||s.onTrackUpdate(1,e,a),"audio"===e.type&&this.eventBus.audioTrackRemoved.publish(e)}}else fe.d(this.TAG,"Track not found in store")}setLayer(e,t){var s,a;let i=this.store.getPeerByTrackId(e.trackId);i&&(e.setLayerFromServer(t)?null==(s=this.listener)||s.onTrackUpdate(5,e,i):null==(a=this.listener)||a.onTrackUpdate(6,e,i))}removePeerTracks(e,t){let i=e.auxiliaryTracks.indexOf(t);i>-1?(e.auxiliaryTracks.splice(i,1),fe.d(this.TAG,"auxiliary track removed",`${t}`)):"audio"===t.type&&e.audioTrack===t?(e.audioTrack=void 0,fe.d(this.TAG,"audio track removed",`${t}`)):"video"===t.type&&e.videoTrack===t&&(e.videoTrack=void 0,fe.d(this.TAG,"video track removed",`${t}`))}addAudioTrack(e,t){var i;"audio"===t.type&&("regular"!==t.source||e.audioTrack&&(null==(i=e.audioTrack)?void 0:i.trackId)!==t.trackId?e.auxiliaryTracks.push(t):e.audioTrack=t,this.store.addTrack(t),fe.d(this.TAG,"audio track added",`${t}`))}addVideoTrack(e,t){if("video"!==t.type)return;let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);if(i.setSimulcastDefinitons(r),this.addAsPrimaryVideoTrack(e,i))e.videoTrack?e.videoTrack.replaceTrack(i):e.videoTrack=i,this.store.addTrack(e.videoTrack);else{let s=e.auxiliaryTracks.findIndex((a=>a.trackId===i.trackId));-1===s?(e.auxiliaryTracks.push(i),this.store.addTrack(i)):(e.auxiliaryTracks[s].replaceTrack(i),this.store.addTrack(e.auxiliaryTracks[s]))}fe.d(this.TAG,"video track added",`${t}`)}addAsPrimaryVideoTrack(e,t){var i;return"regular"===t.source&&(!e.videoTrack||(null==(i=e.videoTrack)?void 0:i.trackId)===t.trackId)}processTrackUpdate(e,t,i){let r;return t.mute!==i.mute?(r=i.mute?2:3,"audio"===e.type&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(r=4),r}},wi=class extends Ci{constructor(e,i,t,s){super(e,i,s),this.transport=t,this.TAG="[OnDemandTrackManager]",this.processTrackInfo=(e,i,t=!0)=>{var p;if("video"!==e.type)return;let s=this.store.getPeerById(i);if(!s||!this.isPeerRoleSubscribed(i))return void fe.d(this.TAG,`no peer in store for peerId: ${i}`);let a=new Kt(new MediaStream,this.transport.getSubscribeConnection()),r=ci.getEmptyVideoTrack();r.enabled=!e.mute;let n=new jt(a,r,e.source);n.setTrackId(e.track_id),n.peerId=s.peerId,n.logIdentifier=s.name,this.addVideoTrack(s,n),t&&(null==(p=this.listener)||p.onTrackUpdate(0,s.videoTrack,s))}}handleTrackMetadataAdd(e){super.handleTrackMetadataAdd(e);for(let i in e.tracks)"video"===e.tracks[i].type&&this.processTrackInfo(e.tracks[i],e.peer.peer_id)}handleTrackRemove(e){let i="video"===e.type&&"regular"===e.source;super.handleTrackRemove(e,!i),i&&this.processTrackInfo({track_id:e.trackId,mute:!e.enabled,type:e.type,source:e.source,stream_id:e.stream.id},e.peerId,!1)}addAsPrimaryVideoTrack(e,i){return"regular"===i.source&&(!e.videoTrack||e.videoTrack.trackId===i.trackId||e.videoTrack.enabled&&Xe(e.videoTrack.nativeTrack))}isPeerRoleSubscribed(e){var s,a,t,r;if(!e)return!0;let i=this.store.getLocalPeer(),n=this.store.getPeerById(e);return n&&(null==(r=null==(a=null==(s=null==i?void 0:i.role)?void 0:s.subscribeParams)?void 0:a.subscribeToRoles)?void 0:r.includes(null==(t=n.role)?void 0:t.name))}},_i=class{constructor(e,t,i,r){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=r,this.TAG="[PeerListManager]",this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)},this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)},this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;null!=t?(Object.keys(t).forEach((i=>{t[i].tracks={},t[i].is_from_room_state=!0})),this.handleRepeatedPeerList(t)):0===e.peer_count&&this.handleRepeatedPeerList({})},this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),r=t.filter((a=>!e[a.peerId]));r.length>0&&fe.d(this.TAG,`${r}`),r.forEach((a=>{var e;let t={peer_id:a.peerId,role:(null==(e=a.role)?void 0:e.name)||"",info:{name:a.name,data:a.metadata||"",user_id:a.customerUserId||""},tracks:{},groups:[],realtime:a.realtime};this.peerManager.handlePeerLeave(t)}));let s=[];i.forEach((a=>{let e=this.store.getPeerById(a.peer_id),t=Object.values(a.tracks);e&&(this.store.getPeerTracks(e.peerId).forEach((u=>{var g;a.tracks[u.trackId]||(this.removePeerTrack(e,u.trackId),null==(g=this.listener)||g.onTrackUpdate(1,u,e))})),t.forEach((u=>{this.store.getTrackById(u.track_id)||this.store.setTrackState({peerId:e.peerId,trackInfo:u})})),this.trackManager.handleTrackUpdate({peer:a,tracks:a.tracks},!1),this.peerManager.handlePeerUpdate(a)),s.push(a)})),s.length>0&&this.peerManager.handlePeerList(s)}}handleNotification(e,t,i){if("peer-list"===e){let e=t;i?(fe.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(e,null,2)),this.handleReconnectPeerList(e)):(fe.d(this.TAG,"PEER_LIST event",JSON.stringify(e,null,2)),this.handleInitialPeerList(e))}else if("room-state"===e){let e=t;this.handlePreviewRoomState(e)}}removePeerTrack(e,t){var i,r;if(fe.d(this.TAG,`removing track - ${t} from ${e}`),(null==(i=e.audioTrack)?void 0:i.trackId)===t)e.audioTrack=void 0;else if((null==(r=e.videoTrack)?void 0:r.trackId)===t)e.videoTrack=void 0;else{let s=e.auxiliaryTracks.findIndex((a=>a.trackId===t));s>=0&&e.auxiliaryTracks.splice(s,1)}}},b=e=>e?new Date(e):void 0,Ri=class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.TAG="[PeerManager]",this.handlePeerList=e=>{var t,s;if(0===e.length)return void(null==(t=this.listener)||t.onPeerUpdate(9,[]));let r=[],i=new Set(e.map((a=>a.peer_id)));this.store.getRemotePeers().forEach((({peerId:a,fromRoomState:e})=>{!i.has(a)&&e&&this.store.removePeer(a)}));for(let a of e)r.push(this.makePeer(a));null==(s=this.listener)||s.onPeerUpdate(9,r),this.trackManager.processPendingTracks()},this.handlePeerJoin=e=>{var i;let t=this.makePeer(e);null==(i=this.listener)||i.onPeerUpdate(0,t),this.trackManager.processPendingTracks()},this.handlePeerLeave=e=>{var i,t,s,a;let r=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),fe.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),r&&(r.audioTrack&&(null==(i=this.listener)||i.onTrackUpdate(1,r.audioTrack,r)),r.videoTrack&&(null==(t=this.listener)||t.onTrackUpdate(1,r.videoTrack,r)),null==(s=r.auxiliaryTracks)||s.forEach((e=>{var t;null==(t=this.listener)||t.onTrackUpdate(1,e,r)})),null==(a=this.listener)||a.onPeerUpdate(1,r))}}handleNotification(e,t){switch(e){case"on-peer-join":{let i=t;this.handlePeerJoin(i);break}case"on-peer-leave":{let i=t;this.handlePeerLeave(i);break}case"on-peer-update":this.handlePeerUpdate(t)}}handlePeerUpdate(e){var s,a,t,r,p;let n=this.store.getPeerById(e.peer_id);if(!n&&e.realtime)return n=this.makePeer(e),void(null==(s=this.listener)||s.onPeerUpdate(n.isHandRaised?12:14,n));if(n&&!n.isLocal&&!e.realtime)return this.store.removePeer(n.peerId),void(null==(a=this.listener)||a.onPeerUpdate(13,n));if(!n)return void fe.d(this.TAG,`peer ${e.peer_id} not found`);if(n.role&&n.role.name!==e.role){let u=this.store.getPolicyForRole(e.role);n.updateRole(u),this.updateSimulcastLayersForPeer(n),null==(t=this.listener)||t.onPeerUpdate(8,n)}let i=n.isHandRaised;n.updateGroups(e.groups),i!==(null==(r=e.groups)?void 0:r.includes(q))&&(null==(p=this.listener)||p.onPeerUpdate(12,n)),this.handlePeerInfoUpdate(I({peer:n},e.info))}handlePeerInfoUpdate({peer:e,name:t,data:i}){var r,s;e&&(t&&e.name!==t&&(e.updateName(t),null==(r=this.listener)||r.onPeerUpdate(10,e)),i&&e.metadata!==i&&(e.updateMetadata(i),null==(s=this.listener)||s.onPeerUpdate(11,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);t||(t=ae(e,this.store),t.realtime=e.realtime,t.joinedAt=b(e.joined_at),t.fromRoomState=!!e.is_from_room_state,this.store.addPeer(t),fe.d(this.TAG,"adding to the peerList",`${t}`));for(let i in e.tracks){let t=e.tracks[i];this.store.setTrackState({peerId:e.peer_id,trackInfo:t}),"video"===t.type&&this.trackManager.processTrackInfo(t,e.peer_id,!1)}return t}updateSimulcastLayersForPeer(e){this.store.getPeerTracks(e.peerId).forEach((t=>{if("video"===t.type&&["regular","screen"].includes(t.source)){let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(r)}}))}},Mi=class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let r=e.known_roles[e.name];t.updateRole(r)}this.store.setKnownRoles(e);let i=this.store.getRoom();i?i.templateId=e.template_id:fe.w("[PolicyChangeManager]","on policy change - room not present"),this.updateLocalPeerRole(e),this.eventBus.policyChange.publish(e)}updateLocalPeerRole(e){var i;let t=this.store.getLocalPeer();if(null!=t&&t.role&&t.role.name!==e.name){let r=this.store.getPolicyForRole(e.name),s=t.role;t.updateRole(r),r.name===(null==(i=t.asRole)?void 0:i.name)&&delete t.asRole,this.eventBus.localRoleUpdate.publish({oldRole:s,newRole:r})}}},Di=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){switch(e){case"on-poll-start":this.handlePollStart(t);break;case"on-poll-stop":this.handlePollStop(t);break;case"on-poll-stats":this.handlePollStats(t)}}handlePollStart(e){return R(this,null,(function*(){var i;let t=[];for(let r of e.polls){if(this.store.getPoll(r.poll_id))return;let s=yield this.transport.getPollQuestions({poll_id:r.poll_id,index:0,count:50}),a={id:r.poll_id,title:r.title,startedBy:r.started_by,createdBy:r.created_by,anonymous:r.anonymous,type:r.type,duration:r.duration,locked:r.locked,mode:r.mode,visibility:r.visibility,rolesThatCanVote:r.vote||[],rolesThatCanViewResponses:r.responses||[],state:r.state,stoppedBy:r.stopped_by,startedAt:b(r.started_at),stoppedAt:b(r.stopped_at),createdAt:b(r.created_at),questions:s.questions.map((({question:e,options:t,answer:p})=>C(I({},e),{options:t,answer:p})))};t.push(a),this.store.setPoll(a)}null==(i=this.listener)||i.onPollsUpdate(1,t)}))}handlePollStop(e){return R(this,null,(function*(){var i;let t=[];for(let r of e.polls){let s=this.store.getPoll(r.poll_id);if(s){s.state="stopped",s.stoppedAt=b(r.stopped_at),s.stoppedBy=r.stopped_by;let a=yield this.transport.getPollResult({poll_id:r.poll_id});this.updatePollResult(s,a),t.push(s)}}t.length>0&&(null==(i=this.listener)||i.onPollsUpdate(2,t))}))}handlePollStats(e){return R(this,null,(function*(){var i,t;let r=[];for(let s of e.polls){let a=this.store.getPoll(s.poll_id);if(!a)return;this.updatePollResult(a,s),null==(i=(yield this.transport.getPollResponses({poll_id:s.poll_id,index:0,count:50,self:!1})).responses)||i.forEach((({response:e,peer:p,final:u})=>{var t;let g=null==(t=null==a?void 0:a.questions)?void 0:t.find((t=>t.index===e.question));if(!g)return;let r={id:e.response_id,questionIndex:e.question,option:e.option,options:e.options,text:e.text,responseFinal:u,peer:{peerid:p.peerid,userHash:p.hash,userid:p.userid,username:p.username},skipped:e.skipped,type:e.type,update:e.update};Array.isArray(g.responses)&&g.responses.length>0?g.responses.find((({id:e})=>e===r.id))||g.responses.push(r):g.responses=[r]})),r.push(a)}r.length>0&&(null==(t=this.listener)||t.onPollsUpdate(3,r))}))}updatePollResult(e,t){var i;e.result=I({},e.result),e.result.totalUsers=t.user_count,e.result.maxUsers=t.max_user,e.result.totalResponses=t.total_response,null==(i=t.questions)||i.forEach((t=>{var a,r;let s=null==(a=e.questions)?void 0:a.find((e=>e.index===t.question));s&&(s.result=I({},s.result),s.result.correctResponses=t.correct,s.result.skippedCount=t.skipped,s.result.totalResponses=t.total,null==(r=t.options)||r.forEach(((e,p)=>{var g;let u=null==(g=s.options)?void 0:g[p];u&&u.voteCount!==e&&(u.voteCount=e)})))}))}},Li=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case"on-role-change-request":this.handleRoleChangeRequest(t);break;case"on-track-update-request":this.handleTrackUpdateRequest(t);break;case"on-change-track-mute-state-request":this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var i;let t={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};null==(i=this.listener)||i.onRoleChangeRequest(t)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:r}=e,s=t?this.store.getPeerById(t):void 0,a=this.store.getLocalPeerTracks().find((e=>e.publishedTrackId===i));if(!a)return;let n=()=>{var e;null==(e=this.listener)||e.onChangeTrackStateRequest({requestedBy:s,track:a,enabled:!r})};if(r){if(a.enabled===!r)return;a.setEnabled(!r).then(n)}else n()}handleChangeTrackStateRequest(e){var p;let{type:t,source:i,value:r,requested_by:s}=e,a=s?this.store.getPeerById(s):void 0,n=!r,o=this.getTracksToBeUpdated({type:t,source:i,enabled:n});if(0!==o.length)if(n)null==(p=this.listener)||p.onChangeMultiTrackStateRequest({requestedBy:a,tracks:o,type:t,source:i,enabled:!0});else{let u=[];for(let g of o)u.push(g.setEnabled(!1));Promise.all(u).then((()=>{var g;null==(g=this.listener)||g.onChangeMultiTrackStateRequest({requestedBy:a,tracks:o,enabled:!1})}))}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter((a=>a.type===e))),t&&(s=s.filter((a=>a.source===t))),s.filter((a=>a.enabled!==i))}},Ni=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case"peer-list":this.onRoomState(t.room);break;case"on-rtmp-start":this.onRTMPStart(t);break;case"on-rtmp-stop":this.onRTMPStop(t);break;case"on-record-start":this.onRecordingStart(t);break;case"on-record-stop":this.onRecordingStop(t);break;case"room-state":this.handlePreviewRoomState(t);break;case"room-info":this.handleRoomInfo(t);break;case"session-info":this.handleSessionInfo(t);break;case"on-hls-init":this.InitHLS(t);break;default:this.onHLS(e,t)}}handleRoomInfo(e){let t=this.store.getRoom();t?(t.description=e.description,t.large_room_optimization=e.large_room_optimization,t.max_size=e.max_size,t.name=e.name):fe.w(this.TAG,"on session info - room not present")}handleSessionInfo(e){var i;let t=this.store.getRoom();t?(t.sessionId=e.session_id,t.peerCount!==e.peer_count&&(t.peerCount=e.peer_count,null==(i=this.listener)||i.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",t))):fe.w(this.TAG,"on session info - room not present")}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t)}onRoomState(e){var p,u,g,t,r;let{recording:n,streaming:i,session_id:o,started_at:s,name:a}=e,l=this.store.getRoom();if(!l)return void fe.w(this.TAG,"on room state - room not present");l.name=a,l.recording.server.running=!(null==n||!n.sfu.enabled),l.recording.browser.running=!(null==n||!n.browser.enabled),l.rtmp.running=!(null==(p=null==i?void 0:i.rtmp)||!p.enabled),l.rtmp.startedAt=b(null==(u=null==i?void 0:i.rtmp)?void 0:u.started_at),l.recording.server.startedAt=b(null==n?void 0:n.sfu.started_at),l.recording.browser.startedAt=b(null==n?void 0:n.browser.started_at),l.recording.hls=this.getPeerListHLSRecording(n);let d=(null==(t=null==(g=null==i?void 0:i.hls)?void 0:g.variants)?void 0:t.map((e=>C(I({},e),{initialisedAt:b(e.initialised_at)}))))||[];l.hls=this.convertHls(null==i?void 0:i.hls,d),l.sessionId=o,l.startedAt=b(s),null==(r=this.listener)||r.onRoomUpdate("RECORDING_STATE_UPDATED",l)}onRTMPStart(e){var t;this.setRTMPStatus(!(null!=(t=e.error)&&t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!(null!=(t=e.error)&&t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}InitHLS(e){var i;let t=this.store.getRoom();t?null!=e&&e.variants&&(t.hls.running=!0,t.hls.variants=[],e.variants.forEach(((r,s)=>{var a;t.hls.variants.push({initialisedAt:b(null==(a=null==e?void 0:e.variants)?void 0:a[s].initialised_at),url:""})})),null==(i=this.listener)||i.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",t)):fe.w(this.TAG,"on hls - room not present")}onHLS(e,t){var r,s;if(!["on-hls-init","on-hls-start","on-hls-stop"].includes(e))return;let i=this.store.getRoom();i?(t.enabled=["on-hls-init","on-hls-start"].includes(e)&&!(null!=(r=t.error)&&r.code),i.hls=this.convertHls(t,i.hls.variants),i.recording.hls=this.getHLSRecording(t),null==(s=this.listener)||s.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",i)):fe.w(this.TAG,"on hls - room not present")}convertHls(e,t){var r;let i={running:!(null==e||!e.enabled),variants:[],error:this.toSdkError(null==e?void 0:e.error)};return null==(r=null==e?void 0:e.variants)||r.forEach(((s,a)=>{var e;let r=null==(e=null==t?void 0:t[a])?void 0:e.initialisedAt;i.variants.push({meetingURL:s.meeting_url,url:s.url,metadata:s.metadata,startedAt:b(s.started_at),initialisedAt:r})})),i}getHLSRecording(e){var i,t,s;let r={running:!1};return null!=e&&e.hls_recording&&(r={running:!(null==e||!e.enabled),singleFilePerLayer:!(null==(i=e.hls_recording)||!i.single_file_per_layer),hlsVod:!(null==(t=e.hls_recording)||!t.hls_vod),startedAt:b(null==(s=null==e?void 0:e.variants)?void 0:s[0].started_at),error:this.toSdkError(e.error)}),r}getPeerListHLSRecording(e){var i,t;let r=null==e?void 0:e.hls;return{running:!(null==r||!r.enabled),startedAt:b(null==r?void 0:r.started_at),singleFilePerLayer:!(null==(i=null==r?void 0:r.config)||!i.single_file_per_layer),hlsVod:!(null==(t=null==r?void 0:r.config)||!t.hls_vod)}}setRecordingStatus(e,t){var s;let r,i=this.store.getRoom();i?("sfu"===t.type?(i.recording.server={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},r="SERVER_RECORDING_STATE_UPDATED"):(i.recording.browser={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},r="BROWSER_RECORDING_STATE_UPDATED"),null==(s=this.listener)||s.onRoomUpdate(r,i)):fe.w(this.TAG,`set recording status running=${e} - room not present`)}setRTMPStatus(e,t){var r;let i=this.store.getRoom();i?(i.rtmp={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},null==(r=this.listener)||r.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",i)):fe.w(this.TAG,"on policy change - room not present")}toSdkError(e){if(null==e||!e.code)return;let t=e.message||"error in streaming/recording",i=new Se(e.code,"ServerErrors","NONE",t,t);return fe.e(this.TAG,"error in streaming/recording",i),i}},Oi=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){"on-metadata-change"===e&&this.handleMetadataChange(t)}handleMetadataChange(e){var i;let t=e.values.map((e=>({key:e.key,value:e.data,updatedAt:b(e.updated_at),updatedBy:e.updated_by?this.store.getPeerById(e.updated_by):void 0})));null==(i=this.listener)||i.onSessionStoreUpdate(t)}},Gi=class{constructor(e,t,i,r,s,a){this.store=e,this.transport=i,this.listener=r,this.audioListener=s,this.connectionQualityListener=a,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=e=>{if("peer-list"===e)this.hasConsistentRoomStateArrived=!0;else if("room-state"===e)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)},this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)},this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};let n=this.transport.isFlagEnabled("onDemandTracks");this.trackManager=n?new wi(this.store,t,this.transport,this.listener):new Ci(this.store,t,this.listener),this.peerManager=new Ri(this.store,this.trackManager,this.listener),this.peerListManager=new _i(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new Pi(this.store,this.listener),this.policyChangeManager=new Mi(this.store,t),this.requestManager=new Li(this.store,this.listener),this.activeSpeakerManager=new Ai(this.store,this.listener,this.audioListener),this.connectionQualityManager=new Ii(this.store,this.connectionQualityListener),this.roomUpdateManager=new Ni(this.store,this.listener),this.sessionMetadataManager=new Oi(this.store,this.listener),this.pollsManager=new Di(this.store,this.transport,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e,this.sessionMetadataManager.listener=e,this.pollsManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var s,a;let i=e.method,r=e.params;["active-speakers","sfu-stats","on-connection-quality-update",void 0].includes(i)||fe.d(this.TAG,`Received notification - ${i}`,{notification:r}),"sfu-stats"===i&&null!=(s=window.HMS)&&s.ON_SFU_STATS&&"function"==typeof(null==(a=window.HMS)?void 0:a.ON_SFU_STATS)&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(i)&&(this.roomUpdateManager.handleNotification(i,r),this.peerManager.handleNotification(i,r),this.requestManager.handleNotification(i,r),this.peerListManager.handleNotification(i,r,t),this.broadcastManager.handleNotification(i,r),this.sessionMetadataManager.handleNotification(i,r),this.pollsManager.handleNotification(i,r),this.handleIsolatedMethods(i,r))}handleIsolatedMethods(e,t){switch(e){case"on-track-add":this.trackManager.handleTrackMetadataAdd(t);break;case"on-track-update":this.trackManager.handleTrackUpdate(t);break;case"on-track-remove":if(!t.peer)return void fe.d(this.TAG,`Ignoring sfu notification - ${e}`,{notification:t});this.trackManager.handleTrackRemovedPermanently(t);break;case"on-track-layer-update":this.trackManager.handleTrackLayerUpdate(t);break;case"active-speakers":this.activeSpeakerManager.handleActiveSpeakers(t);break;case"on-connection-quality-update":this.connectionQualityManager.handleQualityUpdate(t);break;case"on-policy-change":this.policyChangeManager.handlePolicyChange(t)}}},Fi=class{constructor(e){this.TAG="[AudioContextManager]",this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){return R(this,null,(function*(){"suspended"===this.audioContext.state&&(yield this.audioContext.resume(),fe.d(this.TAG,"AudioContext is resumed"))}))}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){"closed"!==this.audioContext.state&&this.audioContext.close().catch((e=>{fe.d(this.TAG,"AudioContext close error",e.message)}))}},xi=class extends h.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},Bi=class extends xi{constructor(){super(...arguments),this.audioElement=null,this.TAG="[PlaylistAudioManager]",this.seeked=!1}play(e){return R(this,null,(function*(){return this.audioElement=this.getAudioElement(),new Promise(((i,t)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let s=`Error loading ${e}`;fe.e(this.TAG,s),this.stop(),t(s)},this.audioElement.oncanplaythrough=()=>R(this,null,(function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),i([this.track]));else{yield this.audioElement.play();let s=this.audioContextManager.getAudioTrack();this.track=s,i([s])}}catch(r){fe.e(this.TAG,"Error playing audio",e,r.message),t(r)}})),this.audioElement.onseeked=()=>{this.seeked=!0}}))}))}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement||(this.audioElement=this.getAudioElement()),this.audioElement}stop(){var e,i,t;null==(e=this.audioElement)||e.pause(),null==(i=this.audioElement)||i.removeAttribute("src"),this.audioElement=null,null==(t=this.audioContextManager)||t.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(i=>this.emit("progress",i))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Fi(e),e}},$i=class extends xi{constructor(){super(...arguments),this.TAG="[PlaylistVideoManager]",this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,i,t;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&(null==(t=this.canvasContext)||t.drawImage(this.videoElement,0,0,null==(e=this.canvas)?void 0:e.width,null==(i=this.canvas)?void 0:i.height),this.timer=setTimeout((()=>{this.drawImage()}),1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise(((i,t)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let s=`Error loading ${e}`;fe.e(this.TAG,s),this.stop(),t(s)},this.videoElement.oncanplaythrough=()=>R(this,null,(function*(){var s,a,r;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,0===this.tracks.length){this.clearCanvasAndTracks();let e=this.canvas.captureStream();if(!e)return void fe.e(this.TAG,"Browser does not support captureStream");this.videoElement.onplay=this.drawImage,yield this.audioContextManager.resumeContext(),yield this.videoElement.play();let p=this.audioContextManager.getAudioTrack();e.addTrack(p),e.getTracks().forEach((u=>{this.tracks.push(u)})),i(this.tracks)}else this.seeked?(this.seeked=!1,null==(r=this.canvasContext)||r.drawImage(this.videoElement,0,0,null==(s=this.canvas)?void 0:s.width,null==(a=this.canvas)?void 0:a.height)):(yield this.videoElement.play(),i(this.tracks))}catch(r){fe.e(this.TAG,"Error playing video",e,r.message),t(r)}})),this.videoElement.onseeked=()=>{this.seeked=!0}}))}getTracks(){return this.tracks.map((e=>e.id))}getElement(){return this.videoElement||(this.videoElement=this.getVideoElement()),this.videoElement}stop(){var e,i,t;null==(e=this.videoElement)||e.pause(),null==(i=this.videoElement)||i.removeAttribute("src"),this.videoElement=null,null==(t=this.audioContextManager)||t.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(i=>this.emit("progress",i))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Fi(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}},Ui={list:[],currentIndex:-1,isAutoplayOn:!0},Vi={list:[],currentIndex:-1,isAutoplayOn:!0},Wi=class extends xi{constructor(e,i){super(),this.sdk=e,this.eventBus=i,this.state={audio:I({},Ui),video:I({},Vi)},this.TAG="[PlaylistManager]",this.handlePausePlaylist=e=>R(this,[e],(function*({enabled:e,track:i}){var a;if(e)return;let s;"audioplaylist"===i.source&&(s="audio"),"videoplaylist"===i.source&&(s="video"),s&&(null==(a=this.getElement(s))||a.pause())})),this.addTrack=(e,i)=>R(this,null,(function*(){yield this.sdk.addTrack(e,i),fe.d(this.TAG,"Playlist track added",Ue(e))})),this.removeTrack=e=>R(this,null,(function*(){yield this.sdk.removeTrack(e,!0),fe.d(this.TAG,"Playlist track removed",e)})),this.audioManager=new Bi,this.videoManager=new $i,this.addListeners()}getList(e="audio"){return this.state[e].list}setList(e){e&&0!==e.length?e.forEach((i=>{this.state[i.type].list.find((e=>e.id===i.id))||this.state[i.type].list.push(i)})):fe.w(this.TAG,"Please pass in a list of HMSPlaylistItem's")}clearList(e){return R(this,null,(function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]}))}removeItem(e,i){return R(this,null,(function*(){let{list:t,currentIndex:s}=this.state[i],a=t.findIndex((t=>e===t.id));return a>-1&&(s===a&&this.isPlaying(i)&&(yield this.stop(i)),t.splice(a,1),!0)}))}seek(e,i="audio"){let{currentIndex:t}=this.state[i];if(-1===t)throw Ae.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");let s=this.getElement(i);if(s){let a=Math.max(s.currentTime+e,0);s.currentTime=Math.min(a,s.duration)}}seekTo(e,i="audio"){let{currentIndex:t}=this.state[i];if(-1===t)throw Ae.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");if(e<0)throw Error("value cannot be negative");let s=this.getElement(i);s&&(s.currentTime=Math.min(e,s.duration))}setVolume(e,i="audio"){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let t=this.getElement(i);t&&(t.volume=.01*e)}getVolume(e="audio"){let i=this.getElement(e);return i?Math.floor(100*i.volume):0}getCurrentTime(e="audio"){let i=this.getElement(e);return(null==i?void 0:i.currentTime)||0}getCurrentIndex(e="audio"){return this.state[e].currentIndex}getCurrentProgress(e="audio"){var t;let{list:i,currentIndex:r}=this.state[e],s=null==(t=i[r])?void 0:t.url,a=this.getElement(e);return s&&a?Math.floor(a.currentTime/a.duration*100):0}getCurrentSelection(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(-1!==t)return i[t]}isPlaying(e="audio"){let i=this.getElement(e);return!!i&&!i.paused}setIsAutoplayOn(e="audio",i){this.state[e].isAutoplayOn=i}getPlaybackRate(e="audio"){let i=this.getElement(e);return i?i.playbackRate:1}setPlaybackRate(e="audio",i){if(i<.25||i>2)throw Error("Please pass a value between 0.25 and 2.0");let t=this.getElement(e);t&&(t.playbackRate=i)}setEnabled(s,a){return R(this,arguments,(function*(e,{id:i,type:t="audio"}){let r=this.state[t].list.findIndex((u=>u.id===i));if(!i||-1===r)return void fe.w(this.TAG,"Pass a valid id");let p=this.state[t].list[r].url;e?yield this.play(p,t):yield this.pause(p,t),this.state[t].currentIndex=r,this.setDuration(t)}))}playNext(){return R(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(t>=i.length-1)throw Ae.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached end of playlist");yield this.play(i[t+1].url,e),this.state[e].currentIndex=t+1,this.setDuration(e)}))}playPrevious(){return R(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(t<=0)throw Ae.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached start of playlist");yield this.play(i[t-1].url,e),this.state[e].currentIndex=t-1,this.setDuration(e)}))}stop(){return R(this,arguments,(function*(e="audio"){var t;let i="audio"===e?this.audioManager:this.videoManager;null==(t=i.getElement())||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1}))}cleanup(){this.state={audio:I({},Ui),video:I({},Vi)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",(()=>{try{e({type:"video",progress:this.getCurrentProgress("video")})}catch(e){fe.e(this.TAG,"Error in onProgress callback")}})),this.audioManager.on("progress",(()=>{try{e({type:"audio",progress:this.getCurrentProgress("audio")})}catch(e){fe.e(this.TAG,"Error in onProgress callback")}}))}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e="audio"){return"audio"===e?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return R(this,arguments,(function*(e="audio"){let t=("audio"===e?this.audioManager:this.videoManager).getTracks();for(let s of t)yield this.removeTrack(s)}))}play(e){return R(this,arguments,(function*(e,i="audio"){let s="audio"===i?this.audioManager:this.videoManager,a=s.getElement();if(this.isItemCurrentlyPlaying(e,i))fe.w(this.TAG,`The ${i} is currently playing`);else if(null!=a&&a.src.includes(e))yield a.play();else{null==a||a.pause();let t=yield s.play(e);for(let e of t)yield this.addTrack(e,"audio"===i?"audioplaylist":"videoplaylist")}}))}isItemCurrentlyPlaying(e,i){let t=this.getElement(i);return!(!t||t.paused||!t.src.includes(e))}setDuration(e="audio"){let i=this.getElement(e),{list:t,currentIndex:s}=this.state[e];t[s]&&(t[s].duration=(null==i?void 0:i.duration)||0),this.emit("newTrackStart",t[s])}pause(e){return R(this,arguments,(function*(e,i="audio"){let s=this.getElement(i);s&&!s.paused&&s.src.includes(e)?(s.pause(),fe.d(this.TAG,"paused url",e)):fe.w(this.TAG,"The passed in url is not currently playing")}))}addListeners(){this.audioManager.on("ended",(()=>this.handleEnded("audio"))),this.videoManager.on("ended",(()=>this.handleEnded("video"))),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return R(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t,isAutoplayOn:s}=this.state[e];t===i.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):s?this.playNext(e):yield this.pause(i[t].url,e),this.emit("currentTrackEnded",i[t])}))}},Hi=class{constructor(e){this.transport=e,this.observedKeys=new Set}get(e){return R(this,null,(function*(){let{data:t,updated_at:i}=yield this.transport.getSessionMetadata(e);return{value:t,updatedAt:b(i)}}))}set(e,t){return R(this,null,(function*(){let{data:i,updated_at:r}=yield this.transport.setSessionMetadata({key:e,data:t});return{value:i,updatedAt:b(r)}}))}observe(e){return R(this,null,(function*(){let t=new Set(this.observedKeys);if(e.forEach((i=>this.observedKeys.add(i))),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}}))}unobserve(e){return R(this,null,(function*(){let t=new Set(this.observedKeys);if(this.observedKeys=new Set([...this.observedKeys].filter((i=>!e.includes(i)))),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}}))}},ji=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i}setListener(e){this.listener=e}createPoll(e){return R(this,null,(function*(){var s,a;let{poll_id:t}=yield this.transport.setPollInfo(C(I({},e),{poll_id:e.id,vote:e.rolesThatCanVote,responses:e.rolesThatCanViewResponses}));e.id||(e.id=t),Array.isArray(e.questions)&&(yield this.addQuestionsToPoll(e.id,e.questions));let i=yield this.transport.getPollQuestions({poll_id:e.id,index:0,count:50}),r={id:e.id,title:e.title,anonymous:e.anonymous,type:e.type,duration:e.duration,locked:e.locked,mode:e.mode,visibility:e.visibility,rolesThatCanVote:e.rolesThatCanVote||[],rolesThatCanViewResponses:e.rolesThatCanViewResponses||[],state:"created",createdBy:null==(s=this.store.getLocalPeer())?void 0:s.peerId,questions:i.questions.map((({question:e,options:t,answer:p})=>C(I({},e),{options:t,answer:p})))};null==(a=this.listener)||a.onPollsUpdate(0,[r])}))}startPoll(e){return R(this,null,(function*(){"string"==typeof e?yield this.transport.startPoll({poll_id:e}):(yield this.createPoll(e),yield this.transport.startPoll({poll_id:e.id}))}))}addQuestionsToPoll(e,t){return R(this,null,(function*(){t.length>0&&(yield this.transport.setPollQuestions({poll_id:e,questions:t.map(((i,e)=>this.createQuestionSetParams(i,e)))}))}))}stopPoll(e){return R(this,null,(function*(){yield this.transport.stopPoll({poll_id:e})}))}addResponsesToPoll(e,t){return R(this,null,(function*(){let i=this.store.getPoll(e);if(!i)throw new Error("Invalid poll ID - Poll not found");let r=t.map((s=>{var e,t;let a=this.getQuestionInPoll(i,s.questionIndex);return"single-choice"===a.type?(s.option=s.option||(null==(e=s.options)?void 0:e[0])||-1,delete s.text,delete s.options):"multiple-choice"===a.type?(null==(t=s.options)||t.sort(),delete s.text,delete s.option):(delete s.option,delete s.options),s.skipped&&(delete s.option,delete s.options,delete s.text),I({duration:0,type:a.type,question:s.questionIndex},s)}));yield this.transport.setPollResponses({poll_id:e,responses:r})}))}getPolls(){return R(this,null,(function*(){let e=yield this.transport.getPollsList({count:50}),t=[];for(let i of e.polls){let e=yield this.transport.getPollQuestions({poll_id:i.poll_id,index:0,count:50}),s={id:i.poll_id,title:i.title,startedBy:i.started_by,createdBy:i.created_by,anonymous:i.anonymous,type:i.type,duration:i.duration,locked:i.locked,mode:i.mode,visibility:i.visibility,rolesThatCanVote:i.vote||[],rolesThatCanViewResponses:i.responses||[],state:i.state,stoppedBy:i.stopped_by,startedAt:b(i.started_at),stoppedAt:b(i.stopped_at),createdAt:b(i.created_at),questions:e.questions.map((({question:a,options:e,answer:t})=>C(I({},a),{options:e,answer:t})))};t.push(s),this.store.setPoll(s)}return t}))}getResponses(e){throw new Error("Method not implemented.")}createQuestionSetParams(e,t){var a;let r,i=C(I({},e),{index:t+1}),s=e.answer||{hidden:!1};return Array.isArray(e.options)&&["single-choice","multiple-choice"].includes(e.type)?(r=null==(a=e.options)?void 0:a.map(((e,t)=>({index:t+1,text:e.text,weight:e.weight}))),null==s||delete s.text,"single-choice"===e.type?s.option=e.options.findIndex((e=>e.isCorrectAnswer))+1||void 0:s.options=e.options.map(((e,t)=>e.isCorrectAnswer?t+1:void 0)).filter((e=>!!e))):(null==s||delete s.options,null==s||delete s.option),{question:i,options:r,answer:s}}getQuestionInPoll(e,t){var r;let i=null==(r=null==e?void 0:e.questions)?void 0:r.find((s=>s.index===t));if(!i)throw new Error("Invalid question index - Question not found in poll");return i}},qi=class{constructor(e,t,i="",r="",s="https://prod-init.100ms.live/init",a=!1){this.authToken=e,this.peerId=t,this.peerName=i,this.data=r,this.endpoint=s,this.autoSubscribeVideo=a}},Ji=((s=Ji||{})[s.ConnectFailed=0]="ConnectFailed",s[s.SignalDisconnect=1]="SignalDisconnect",s[s.JoinWSMessageFailed=2]="JoinWSMessageFailed",s[s.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",s[s.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed",s),hr={0:[],1:[],2:[1],3:[1],4:[1]},Ki=(e=>(e.Disconnected="Disconnected",e.Connecting="Connecting",e.Joined="Joined",e.Preview="Preview",e.Failed="Failed",e.Reconnecting="Reconnecting",e.Leaving="Leaving",e))(Ki||{}),zi=class{constructor(e){this.promise=new Promise(((t,i)=>{this.resolve=t,this.reject=i,e(t,i)}))}},Qi=class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.TAG="[RetryScheduler]",this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return R(this,arguments,(function*({category:e,error:t,task:i,originalState:r,maxFailedRetries:s=5,changeState:a=!0}){yield this.scheduleTask({category:e,error:t,changeState:a,task:i,originalState:r,maxFailedRetries:s})}))}reset(){this.retryTaskIds.forEach((e=>clearTimeout(e))),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(e){return R(this,arguments,(function*({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a=5,failedRetryCount:n=0}){if(fe.d(this.TAG,"schedule: ",{category:Ji[e],error:t}),0===n){let r=this.inProgress.get(e);if(r)return fe.d(this.TAG,`schedule: Already a task for ${Ji[e]} scheduled, waiting for its completion`),void(yield r.promise);let n=new zi(((e,t)=>{}));this.inProgress.set(e,n),this.sendEvent(t,e)}let p=!1,u=hr[e];for(let t in u){let r=u[parseInt(t)];try{let t=this.inProgress.get(r);t&&(fe.d(this.TAG,`schedule: Suspending retry task of ${Ji[e]}, waiting for ${Ji[r]} to recover`),yield t.promise,fe.d(this.TAG,`schedule: Resuming retry task ${Ji[e]} as it's dependency ${Ji[r]} is recovered`))}catch(t){fe.d(this.TAG,`schedule: Stopping retry task of ${Ji[e]} as it's dependency ${Ji[r]} failed to recover`),p=!0;break}}if(n>=a||p){if(t.description+=`. [${Ji[e]}] Could not recover after ${n} tries`,p&&(t.description+=` Could not recover all of it's required dependencies - [${u.map((e=>Ji[e])).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),!i)throw t;return void this.onStateChange("Failed",t)}i&&this.onStateChange("Reconnecting",t);let o,g=this.getDelayForRetryCount(e,n);fe.d(this.TAG,`schedule: [${Ji[e]}] [failedRetryCount=${n}] Scheduling retry task in ${g}ms`);try{o=yield this.setTimeoutPromise(r,g)}catch(t){o=!1,fe.w(this.TAG,`[${Ji[e]}] Un-caught exception ${t.name} in retry-task, initiating retry`,t)}if(o){let t=this.inProgress.get(e);this.inProgress.delete(e),null==t||t.resolve(n),i&&0===this.inProgress.size&&this.onStateChange(s),fe.d(this.TAG,`schedule: [${Ji[e]}] [failedRetryCount=${n}] Recovered ♻️`)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a,failedRetryCount:n+1})}))}getBaseDelayForTask(e,t){return 2===e?2:Math.pow(2,t)}getDelayForRetryCount(e,t){let i=this.getBaseDelayForTask(e,t),r=2===e?2*Math.random():Math.random();return Math.round(1e3*Math.min(i+r,60))}setTimeoutPromise(e,t){return R(this,null,(function*(){return new Promise(((i,r)=>{let s=window.setTimeout((()=>R(this,null,(function*(){try{let a=yield e();a&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(s),1),i(a)}catch(e){r(e)}}))),t);this.retryTaskIds.push(s)}))}))}},Yi=class extends tt{constructor(){super(100),this.localStorage=new me("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;null==(e=this.localStorage.get())||e.forEach((i=>{let e=new Le(i);super.enqueue(e)}))}},Zi=class{constructor(){this.TAG="[AnalyticsTransport]"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(e){fe.w(this.TAG,"sendEvent failed",e)}}flushFailedEvents(e){var t;try{for(fe.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&((null==(t=i.metadata)?void 0:t.peer.peer_id)!==e&&i.metadata.peer.peer_id?pi.sendEvent(i):this.sendSingleEvent(i))}}catch(e){fe.w(this.TAG,"flushFailedEvents failed",e)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),fe.d(this.TAG,"Sent event",e.name,e)}catch(t){throw fe.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}},Xi=class extends Zi{constructor(e){super(),this.transportProvider=e,this.failedEvents=new Yi}},es=class{constructor(e,t,i,r){this.store=e,this.eventBus=t,this.sampleWindowSize=i,this.pushInterval=r,this.shouldSendEvent=!1,this.sequenceNum=1,this.stop=()=>{this.shouldSendEvent&&this.sendEvent(),this.eventBus.statsUpdate.unsubscribe(this.handleStatsUpdate.bind(this)),this.shouldSendEvent=!1},this.start()}start(){this.shouldSendEvent||(this.stop(),this.shouldSendEvent=!0,this.eventBus.statsUpdate.subscribe(this.handleStatsUpdate.bind(this)),this.startLoop().catch((e=>fe.e("[StatsAnanlytics]",e.message))))}startLoop(){return R(this,null,(function*(){for(;this.shouldSendEvent;)yield it(1e3*this.pushInterval),this.sendEvent()}))}},ts=class{constructor({track:e,ssrc:t,rid:i,kind:r,sampleWindowSize:s}){this.samples=[],this.tempStats=[],this.track=e,this.ssrc=t,this.rid=i,this.kind=r,this.track_id=this.track.trackId,this.source=this.track.source,this.sampleWindowSize=s}push(e){this.tempStats.push(e),this.shouldCreateSample()&&(this.samples.push(this.createSample()),this.tempStats.length=0)}getLatestStat(){return this.tempStats[this.tempStats.length-1]}getFirstStat(){return this.tempStats[0]}calculateSum(e){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce(((i,t)=>i+(t[e]||0)),0)}calculateAverage(e,t=!0){let i=this.calculateSum(e),r=void 0!==i?i/this.tempStats.length:void 0;return r?t?Math.round(r):r:void 0}calculateDifferenceForSample(e){let t=Number(this.tempStats[0][e])||0;return(Number(this.getLatestStat()[e])||0)-t}calculateInstancesOfHigh(e,t){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce(((r,s)=>r+((s[e]||0)>t?1:0)),0)}},is=(e,t)=>e&&t&&(e.frameWidth!==t.frameWidth||e.frameHeight!==t.frameHeight),ss=(e,t)=>e&&t&&e.enabled!==t.enabled,rs=e=>Object.entries(e).filter((([,e])=>void 0!==e)).reduce(((e,[t,i])=>(e[t]=i,e)),{}),ns=class extends es{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,s;let t=[],i=[];return this.trackAnalytics.forEach((a=>{"audio"===a.track.type?t.push(a.toAnalytics()):"video"===a.track.type&&i.push(a.toAnalytics())})),{audio:t,video:i,joined_at:null==(s=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:s.getTime(),sequence_num:this.sequenceNum++,max_window_sec:30}}sendEvent(){this.eventBus.analytics.publish(Ne.publishStats(this.toAnalytics()))}handleStatsUpdate(e){let i=e.getLocalTrackStats();Object.keys(i).forEach((t=>{let s=i[t],a=this.store.getLocalPeerTracks().find((e=>e.getTrackIDBeingSent()===t));Object.keys(s).forEach((t=>{var u,g,r,n,o;let l=s[t],p=a&&this.getTrackIdentifier(null==a?void 0:a.trackId,l);if(p&&this.trackAnalytics.has(p))null==(r=this.trackAnalytics.get(p))||r.push(C(I({},l),{availableOutgoingBitrate:null==(g=null==(u=e.getLocalPeerStats())?void 0:u.publish)?void 0:g.availableOutgoingBitrate}));else if(a){let t=new as({track:a,sampleWindowSize:this.sampleWindowSize,rid:l.rid,ssrc:l.ssrc.toString(),kind:l.kind});t.push(C(I({},l),{availableOutgoingBitrate:null==(o=null==(n=e.getLocalPeerStats())?void 0:n.publish)?void 0:o.availableOutgoingBitrate})),this.trackAnalytics.set(this.getTrackIdentifier(null==a?void 0:a.trackId,l),t)}}))}))}getTrackIdentifier(e,i){return i.rid?`${e}:${i.rid}`:e}},as=class extends ts{constructor(){super(...arguments),this.samples=[],this.createSample=()=>{let e=this.getLatestStat(),i=e.qualityLimitationDurations,t=i&&{bandwidth_sec:i.bandwidth,cpu_sec:i.cpu,other_sec:i.other},s=e.frameHeight?{height_px:this.getLatestStat().frameHeight,width_px:this.getLatestStat().frameWidth}:void 0,a=this.calculateAverage("jitter",!1),r=a?Math.round(1e3*a):void 0,n=this.calculateAverage("roundTripTime",!1),p=n?Math.round(1e3*n):void 0;return rs({timestamp:Date.now(),avg_available_outgoing_bitrate_bps:this.calculateAverage("availableOutgoingBitrate"),avg_bitrate_bps:this.calculateAverage("bitrate"),avg_fps:this.calculateAverage("framesPerSecond"),total_packets_lost:this.calculateDifferenceForSample("packetsLost"),total_packets_sent:this.calculateDifferenceForSample("packetsSent"),total_packet_sent_delay_sec:parseFloat(this.calculateDifferenceForSample("totalPacketSendDelay").toFixed(4)),total_fir_count:this.calculateDifferenceForSample("firCount"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_ms:r,avg_round_trip_time_ms:p,total_quality_limitation:t,resolution:s})},this.shouldCreateSample=()=>{let e=this.tempStats.length,i=this.tempStats[e-1],t=this.tempStats[e-2];return 30===e||ss(i,t)||"video"===i.kind&&is(i,t)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}},os=class extends es{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,s;let t=[],i=[];return this.trackAnalytics.forEach((a=>{"audio"===a.track.type?t.push(a.toAnalytics()):"video"===a.track.type&&i.push(a.toAnalytics())})),{audio:t,video:i,joined_at:null==(s=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:s.getTime(),sequence_num:this.sequenceNum++,max_window_sec:10}}sendEvent(){this.eventBus.analytics.publish(Ne.subscribeStats(this.toAnalytics()))}handleStatsUpdate(e){let i=e.getAllRemoteTracksStats();Object.keys(i).forEach((e=>{var t;let s=i[e],a=this.store.getTrackById(e);if(this.trackAnalytics.has(e))null==(t=this.trackAnalytics.get(e))||t.push(I({},s));else if(a){let t=new ls({track:a,sampleWindowSize:this.sampleWindowSize,ssrc:s.ssrc.toString(),kind:s.kind});t.push(I({},s)),this.trackAnalytics.set(e,t)}}))}},ls=class extends ts{constructor(){super(...arguments),this.samples=[],this.createSample=()=>{let e=this.getLatestStat(),i=this.getFirstStat(),t=(e.concealedSamples||0)-(e.silentConcealedSamples||0)-((i.concealedSamples||0)-(i.silentConcealedSamples||0));return rs({timestamp:Date.now(),audio_concealed_samples:t,audio_level:this.calculateInstancesOfHigh("audioLevel",.05),audio_total_samples_received:this.calculateDifferenceForSample("totalSamplesReceived"),audio_concealment_events:this.calculateDifferenceForSample("concealmentEvents"),fec_packets_discarded:this.calculateDifferenceForSample("fecPacketsDiscarded"),fec_packets_received:this.calculateDifferenceForSample("fecPacketsReceived"),total_samples_duration:this.calculateDifferenceForSample("totalSamplesDuration"),total_packets_received:this.calculateDifferenceForSample("packetsReceived"),total_packets_lost:this.calculateDifferenceForSample("packetsLost"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount")})},this.shouldCreateSample=()=>{let e=this.tempStats.length,i=this.tempStats[e-1],t=this.tempStats[e-2];return 10===e||ss(i,t)||"video"===i.kind&&is(i,t)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}},ds=(e=>(e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe",e))(ds||{});var cs="[HMSConnection]",hs=class{constructor(e,t){this.candidates=new Array,this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return 0===this.role?"PUBLISH":"SUBSCRIBE"}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return R(this,null,(function*(){try{let i=yield this.nativeConnection.createOffer(t);return fe.d(cs,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),function(e){return e.sdp.includes("usedtx=1")?e:{type:e.type,sdp:e.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}(function(e,t){var r;let n=m.parse(e.sdp);if(null==(r=n.origin)||!r.username.startsWith("mozilla"))return e;let i=t?Array.from(t.values()):[];return n.media.forEach((s=>{var e,p,u;let a=null==(e=s.msid)?void 0:e.split(" ")[0],t=null==(p=i.find((g=>g.type===s.type&&g.stream_id===a)))?void 0:p.track_id;t&&(s.msid=null==(u=s.msid)?void 0:u.replace(/\s(.+)/,` ${t}`))})),{type:e.type,sdp:m.write(n)}}(i,e))}catch(e){throw Ae.WebrtcErrors.CreateOfferFailed(this.action,e.message)}}))}createAnswer(e=void 0){return R(this,null,(function*(){try{let t=yield this.nativeConnection.createAnswer(e);return fe.d(cs,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(e){throw Ae.WebrtcErrors.CreateAnswerFailed(this.action,e.message)}}))}setLocalDescription(e){return R(this,null,(function*(){try{fe.d(cs,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(e){throw Ae.WebrtcErrors.SetLocalDescriptionFailed(this.action,e.message)}}))}setRemoteDescription(e){return R(this,null,(function*(){try{fe.d(cs,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(e){throw Ae.WebrtcErrors.SetRemoteDescriptionFailed(this.action,e.message)}}))}addIceCandidate(e){return R(this,null,(function*(){"closed"!==this.nativeConnection.signalingState?(fe.d(cs,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)):fe.d(cs,`[role=${this.role}] addIceCandidate signalling state closed`)}))}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}logSelectedIceCandidatePairs(){try{(0===this.role?this.getSenders():this.getReceivers()).forEach((e=>{var t;let i=null==(t=e.track)?void 0:t.kind;if(e.transport){let s=e.transport.iceTransport,a=()=>{"function"==typeof s.getSelectedCandidatePair&&(this.selectedCandidatePair=s.getSelectedCandidatePair(),fe.d(cs,`${ds[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2)))};"function"==typeof s.onselectedcandidatepairchange&&(s.onselectedcandidatepairchange=a),a()}}))}catch(e){fe.w(cs,`Error in logging selected ice candidate pair for ${ds[this.role]} connection`,e)}}removeTrack(e){"closed"!==this.nativeConnection.signalingState&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e){return R(this,null,(function*(){let t=e.settings.maxBitrate,i=e instanceof Ht&&e.settings.maxFramerate,r=this.getSenders().find((s=>{var a;return(null==(a=null==s?void 0:s.track)?void 0:a.id)===e.getTrackIDBeingSent()}));if(r){let s=r.getParameters();1===s.encodings.length&&(t&&(s.encodings[0].maxBitrate=1e3*t),i&&(s.encodings[0].maxFramerate=i)),yield r.setParameters(s)}else fe.w(cs,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)}))}getStats(){return R(this,null,(function*(){return yield this.nativeConnection.getStats()}))}close(){return R(this,null,(function*(){this.nativeConnection.close()}))}getReceivers(){return this.nativeConnection.getReceivers()}},us=class extends hs{constructor(e,i,t){super(0,e),this.TAG="[HMSPublishConnection]",this.observer=t,this.nativeConnection=new RTCPeerConnection(i),this.nativeConnection.createDataChannel(O,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:s})=>{s&&e.trickle(this.role,s)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>R(this,null,(function*(){fe.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()}))}},ps=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=e=>{this.observer.onMessage(e.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){fe.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}},rt=class e extends hs{constructor(e,i,t,s){super(1,e),this.isFlagEnabled=t,this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.MAX_RETRIES=3,this.pendingMessageQueue=[],this.eventEmitter=new v.a({maxListeners:60}),this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(fe.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach((e=>this.sendOverApiDataChannel(e))),this.pendingMessageQueue.length=0)},this.sendMessage=(e,i)=>R(this,null,(function*(){var s;let t;"open"!==(null==(s=this.apiChannel)?void 0:s.readyState)&&(yield this.eventEmitter.waitFor("open"));for(let a=0;a<this.MAX_RETRIES;a++){this.apiChannel.send(e),t=yield this.waitForResponse(i);let r=t.error;if(!r)break;{if(404===r.code){fe.d(this.TAG,`Track not found ${i}`,{request:e,try:a+1,error:r});break}if(fe.d(this.TAG,`Failed sending ${i}`,{request:e,try:a+1,error:r}),r.code/100!=5&&429!==r.code)throw Error(`code=${r.code}, message=${r.message}`);let p=1e3*(2+2*Math.random());yield it(p)}}return t})),this.waitForResponse=e=>R(this,null,(function*(){let i=yield this.eventEmitter.waitFor("message",(function(s){return s.includes(e)})),t=JSON.parse(i[0]);return fe.d(this.TAG,`response for ${e} -`,JSON.stringify(t,null,2)),t})),this.observer=s,this.nativeConnection=new RTCPeerConnection(i),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===O&&(this.apiChannel=new ps(e.channel,{onMessage:i=>{this.eventEmitter.emit("message",i),this.observer.onApiChannelMessage(i)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{null!==e.candidate&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var p;let i=e.streams[0],t=i.id;if(!this.remoteStreams.has(t)){let u=new Kt(i,this);this.remoteStreams.set(t,u)}i.addEventListener("removetrack",(u=>{if(u.track.id!==e.track.id)return;let g=s.tracks.findIndex((t=>{var r;return t.nativeTrack.id===u.track.id&&e.transceiver.mid===(null==(r=t.transceiver)?void 0:r.mid)}));if(g>=0){let e=s.tracks[g];this.observer.onTrackRemove(e),s.tracks.splice(g,1),0===s.tracks.length&&this.remoteStreams.delete(t)}}));let s=this.remoteStreams.get(t),r=new("audio"===e.track.kind?Rt:jt)(s,e.track);"video"===e.track.kind&&s.setVideoLayerLocally("none","addTrack","subscribeConnection"),r.transceiver=e.transceiver;let n=function(e,t){var s;if(null==e||!e.sdp||!t)return;let i=m.parse(e.sdp).media.find((a=>Ie(a.mid)&&parseInt(a.mid)===parseInt(t)));return null==(s=null==i?void 0:i.msid)?void 0:s.split(" ")[1]}(this.remoteDescription,null==(p=e.transceiver)?void 0:p.mid);n&&r.setSdpTrackId(n),s.tracks.push(r),this.observer.onTrackAdd(r)}}sendOverApiDataChannel(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(fe.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}sendOverApiDataChannelWithResponse(e,i){return R(this,null,(function*(){let t=Object(l.a)();if("prefer-video-track-state"===e.method&&this.isFlagEnabled("disableVideoTrackAutoUnsubscribe")&&"none"===e.params.max_spatial_layer)return fe.d(this.TAG,"video auto unsubscribe is disabled, request is ignored"),{id:t};let s=JSON.stringify(I({id:i||t,jsonrpc:"2.0"},e));return this.sendMessage(s,t)}))}close(){return R(this,null,(function*(){var t;yield _(e.prototype,this,"close").call(this),null==(t=this.apiChannel)||t.close()}))}},vs="[InitService]",gs=class{static handleError(e,t){switch(e.status){case 404:throw Ae.APIErrors.EndpointUnreachable("INIT",t.message||e.statusText);case 200:break;default:throw Ae.APIErrors.ServerErrors(t.code||e.status,"INIT",t.message||(null==e?void 0:e.statusText))}}static fetchInitConfig(a){return R(this,arguments,(function*({token:e,peerId:t,userAgent:i,initEndpoint:r="https://prod-init.100ms.live",region:s=""}){fe.d(vs,`fetchInitConfig: initEndpoint=${r} token=${e} peerId=${t} region=${s} `);let n=function(e,t,r,i){try{let n=new URL("/init",e);return i&&i.trim().length>0&&n.searchParams.set("region",i.trim()),n.searchParams.set("peer_id",t),n.searchParams.set("user_agent_v2",r),n.toString()}catch(e){let s=e;throw fe.e(vs,s.name,s.message),s}}(r,t,i,s);try{let t=yield fetch(n,{headers:{Authorization:`Bearer ${e}`}});try{let p=yield t.clone().json();return this.handleError(t,p),fe.d(vs,`config is ${JSON.stringify(p,null,2)}`),function(e){var t;return C(I({},e),{rtcConfiguration:C(I({},e.rtcConfiguration),{iceServers:null==(t=e.rtcConfiguration)?void 0:t.ice_servers})})}(p)}catch(e){let u=yield t.text();throw fe.e(vs,"json error",e.message,u),Ae.APIErrors.ServerErrors(t.status,"INIT",u)}}catch(e){let p=e;throw["Failed to fetch","NetworkError","ECONNRESET"].some((u=>p.message.includes(u)))?Ae.APIErrors.EndpointUnreachable("INIT",p.message):p}}))}};var ms=class{constructor(e){this.TAG="[SIGNAL]: ",this.pongResponseTimes=new tt(5),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.onCloseHandler=()=>{},this.resolvePingOnAnyResponse=()=>{this.callbacks.forEach(((e,t)=>{var i;"ping"===(null==(i=e.metadata)?void 0:i.method)&&(e.resolve({timestamp:Date.now()}),this.callbacks.delete(t))}))},this.offlineListener=()=>{fe.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")},this.onlineListener=()=>{fe.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()},this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){fe.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return R(this,null,(function*(){var s;let i=Object(l.a)(),r={method:e,params:t,id:i,jsonrpc:"2.0"};null==(s=this.socket)||s.send(JSON.stringify(r));try{return yield new Promise(((t,r)=>{this.callbacks.set(i,{resolve:t,reject:r,metadata:{method:e}})}))}catch(r){if(r instanceof Se)throw r;let t=r;throw Ae.WebsocketMethodErrors.ServerErrors(Number(t.code),be(e),t.message)}}))}notify(e,t){var r,s;let i={method:e,params:t};(null==(r=this.socket)?void 0:r.readyState)===WebSocket.OPEN&&(null==(s=this.socket)||s.send(JSON.stringify(i)))}open(e){return new Promise(((t,i)=>{let r=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let s=()=>{fe.e(this.TAG,"Error from websocket"),r=!0,i(Ae.WebSocketConnectionErrors.FailedToConnect("JOIN","Error opening websocket connection"))};this.onCloseHandler=e=>{fe.w(`Websocket closed code=${e.code}`),r?this.setIsConnected(!1,`code: ${e.code}${1e3!==e.code?", unexpected websocket close":""}`):(r=!0,i(Ae.WebSocketConnectionErrors.AbnormalClose("JOIN",`Error opening websocket connection - websocket closed unexpectedly with code=${e.code}`)))},this.socket.addEventListener("error",s);let a=()=>{var e,n;r=!0,t(),this.setIsConnected(!0),this.id++,null==(e=this.socket)||e.removeEventListener("open",a),null==(n=this.socket)||n.removeEventListener("error",s),this.pingPongLoop(this.id)};this.socket.addEventListener("open",a),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)}))}close(){return R(this,null,(function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")}))}join(e,t,i,r,s,a,n){return R(this,null,(function*(){if(!this.isConnected)throw Ae.WebSocketConnectionErrors.WebSocketConnectionLost("JOIN","Failed to send join over WS connection");let o={name:e,disableVidAutoSub:i,data:t,offer:n,server_sub_degrade:r,simulcast:s,onDemandTracks:a},p=yield this.internalCall("join",o);return this.isJoinCompleted=!0,this.pendingTrickle.forEach((({target:u,candidate:g})=>this.trickle(u,g))),this.pendingTrickle.length=0,fe.d(this.TAG,`join: response=${JSON.stringify(p,null,1)}`),p}))}trickle(e,t){this.isJoinCompleted?this.notify("trickle",{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return R(this,null,(function*(){return yield this.call("offer",{desc:e,tracks:Object.fromEntries(t)})}))}answer(e){this.notify("answer",{desc:e})}trackUpdate(e){this.notify("track-update",{tracks:Object.fromEntries(e)})}broadcast(e){return R(this,null,(function*(){return yield this.call("broadcast",e.toSignalParams())}))}leave(){this.notify("leave",{})}endRoom(e,t){return R(this,null,(function*(){yield this.call("end-room",{lock:e,reason:t})}))}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify("analytics",e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise((s=>{setTimeout((()=>{s(Date.now()-t)}),e+1)})),r=this.internalCall("ping",{timestamp:t}).then((()=>Date.now()-t)).catch((()=>Date.now()-t));return Promise.race([i,r])}requestRoleChange(e){return R(this,null,(function*(){yield this.call("role-change-request",e)}))}requestBulkRoleChange(e){return R(this,null,(function*(){yield this.call("role-change-request",e)}))}acceptRoleChangeRequest(e){return R(this,null,(function*(){yield this.call("role-change",e)}))}requestTrackStateChange(e){return R(this,null,(function*(){yield this.call("track-update-request",e)}))}requestMultiTrackStateChange(e){return R(this,null,(function*(){yield this.call("change-track-mute-state-request",e)}))}removePeer(e){return R(this,null,(function*(){yield this.call("peer-leave-request",e)}))}startRTMPOrRecording(e){return R(this,null,(function*(){yield this.call("rtmp-start",I({},e))}))}stopRTMPAndRecording(){return R(this,null,(function*(){yield this.call("rtmp-stop",{})}))}startHLSStreaming(e){return R(this,null,(function*(){yield this.call("hls-start",I({},e))}))}stopHLSStreaming(e){return R(this,null,(function*(){yield this.call("hls-stop",I({},e))}))}sendHLSTimedMetadata(e){return R(this,null,(function*(){yield this.call("hls-timed-metadata",I({},e))}))}updatePeer(e){return R(this,null,(function*(){yield this.call("peer-update",I({},e))}))}getPeer(e){return R(this,null,(function*(){yield this.call("get-peer",I({},e))}))}joinGroup(e){return R(this,null,(function*(){return yield this.call("group-join",{name:e})}))}leaveGroup(e){return R(this,null,(function*(){return yield this.call("group-leave",{name:e})}))}addToGroup(e,t){return R(this,null,(function*(){yield this.call("group-add",{name:t,peer_id:e})}))}removeFromGroup(e,t){return R(this,null,(function*(){yield this.call("group-leave",{name:t,peer_id:e})}))}peerIterNext(e){return R(this,null,(function*(){return yield this.call("peer-iter-next",e)}))}findPeers(e){return R(this,null,(function*(){return yield this.call("find-peer",e)}))}setSessionMetadata(e){if(!this.isConnected)throw Ae.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("set-metadata",I({},e))}listenMetadataChange(e){if(!this.isConnected)throw Ae.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to observe session store key due to network disconnection");return this.call("listen-metadata-change",{keys:e})}getSessionMetadata(e){if(!this.isConnected)throw Ae.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("get-metadata",{key:e})}setPollInfo(e){return this.valiateConnection(),this.call("poll-info-set",I({},e))}getPollInfo(e){return this.valiateConnection(),this.call("poll-info-get",I({},e))}setPollQuestions(e){return this.valiateConnection(),this.call("poll-questions-set",I({},e))}startPoll(e){return this.valiateConnection(),this.call("poll-start",I({},e))}stopPoll(e){return this.valiateConnection(),this.call("poll-stop",I({},e))}getPollQuestions(e){return this.valiateConnection(),this.call("poll-questions-get",I({},e))}setPollResponses(e){return this.valiateConnection(),this.call("poll-response",I({},e))}getPollResponses(e){return this.valiateConnection(),this.call("poll-responses",I({},e))}getPollsList(e){return this.valiateConnection(),this.call("poll-list",I({},e))}getPollResult(e){return this.valiateConnection(),this.call("poll-result",I({},e))}valiateConnection(){if(!this.isConnected)throw Ae.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to send message due to network disconnection")}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(this.resolvePingOnAnyResponse(),i.id)this.handleResponseWithId(i);else{if(!i.method)throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`);this.handleResponseWithMethod(i)}}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let e=this.callbacks.get(i);this.callbacks.delete(i),t.result?e.resolve(t.result):e.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case"offer":this.observer.onOffer(e.params);break;case"trickle":this.observer.onTrickle(e.params);break;case"on-error":this.observer.onServerError(Ae.WebsocketMethodErrors.ServerErrors(Number(e.params.code),"on-error",e.params.message));break;case"on-warning":fe.w(this.TAG,e.params);break;default:this.observer.onNotification(e)}}rejectPendingCalls(e=""){this.callbacks.forEach(((t,i)=>{var r,s,a,n;"ping"!==(null==(r=t.metadata)?void 0:r.method)&&(fe.e(this.TAG,`rejecting pending callback ${null==(s=t.metadata)?void 0:s.method}, id=${i}`),t.reject(Ae.WebSocketConnectionErrors.WebSocketConnectionLost(null!=(a=t.metadata)&&a.method?be(null==(n=t.metadata)?void 0:n.method):"RECONNECT_SIGNAL",e)),this.callbacks.delete(i))}))}pingPongLoop(e){return R(this,null,(function*(){var i,t;let r=(null==(i=window.HMS)?void 0:i.PING_TIMEOUT)||12e3;if(this.isConnected){let s=yield this.ping(r);this.pongResponseTimes.enqueue(s),s>r?(fe.d(this.TAG,`Pong timeout ${e}, pageHidden=${"undefined"!=typeof document&&document.hidden}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout((()=>this.pingPongLoop(e)),(null==(t=window.HMS)?void 0:t.PING_INTERVAL)||3e3)}}))}call(e,t){return R(this,null,(function*(){let s,r=Ae.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);for(s=1;s<=3;s++)try{return fe.d(this.TAG,`Try number ${s} sending ${e}`,t),yield this.internalCall(e,t)}catch(o){if(r=o,fe.e(this.TAG,`Failed sending ${e} try: ${s}`,{method:e,params:t,error:r}),5!==parseInt(""+r.code/100)&&429!==r.code)break;let n=1e3*(2+2*Math.random());yield it(n)}throw fe.e(`Sending ${e} over WS failed after ${Math.min(s,3)} retries`,{method:e,params:t,error:r}),r}))}},Ts="[HMSTransport]:",ks=class{constructor(e,t,i,r,s,a){var n,p;this.observer=e,this.deviceManager=t,this.store=i,this.eventBus=r,this.analyticsEventsService=s,this.analyticsTimer=a,this.state="Disconnected",this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.joinRetryCount=0,this.callbacks=new Map,this.signalObserver={onOffer:e=>R(this,null,(function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(e),fe.d(Ts,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let i of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(i);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),fe.d(Ts,"[role=SUBSCRIBE] onOffer renegotiation DONE ✅")}catch(e){let i;fe.d(Ts,"[role=SUBSCRIBE] onOffer renegotiation FAILED ❌",e),this.state="Failed",i=e instanceof Se?e:Ae.GenericErrors.Unknown("PUBLISH",e.message),this.observer.onFailure(i),this.eventBus.analytics.publish(Ne.subscribeFail(i))}})),onTrickle:e=>R(this,null,(function*(){let t=0===e.target?this.publishConnection:this.subscribeConnection;null!=t&&t.remoteDescription?yield t.addIceCandidate(e.candidate):null==t||t.candidates.push(e.candidate)})),onNotification:e=>this.observer.onNotification(e),onServerError:e=>R(this,null,(function*(){yield this.observer.onStateChange("Failed",e)})),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:1,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>R(this,null,(function*(){fe.d(Ts,"socket offline",Ki[this.state]);try{"Leaving"!==this.state&&this.joinParameters&&this.retryScheduler.schedule({category:1,error:Ae.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL",e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(e){console.error(e)}})),onOnline:()=>{var e;fe.d(Ts,"socket online",Ki[this.state]),this.analyticsSignalTransport.flushFailedEvents(null==(e=this.store.getLocalPeer())?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new ms(this.signalObserver),this.analyticsSignalTransport=new Xi(this.signal),this.publishConnectionObserver={onRenegotiationNeeded:()=>R(this,null,(function*(){yield this.performPublishRenegotiation()})),onIceConnectionChange:e=>R(this,null,(function*(){("disconnected"===e?fe.w.bind(fe):fe.d.bind(fe))(Ts,`Publish ice connection state change: ${e}`)})),onConnectionStateChange:e=>R(this,null,(function*(){var i,t,s,a,r;("disconnected"===e?fe.w.bind(fe):fe.d.bind(fe))(Ts,`Publish connection state change: ${e}`),"connected"===e&&(null==(i=this.publishConnection)||i.logSelectedIceCandidatePairs()),"disconnected"===e&&setTimeout((()=>{var e,p,u,g,t;"disconnected"===(null==(e=this.publishConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(0,Ae.WebrtcErrors.ICEDisconnected("PUBLISH",`local candidate - ${null==(u=null==(p=this.publishConnection)?void 0:p.selectedCandidatePair)?void 0:u.local.candidate}; remote candidate - ${null==(t=null==(g=this.publishConnection)?void 0:g.selectedCandidatePair)?void 0:t.remote.candidate}`))}),5e3),"failed"===e&&(yield this.handleIceConnectionFailure(0,Ae.WebrtcErrors.ICEFailure("PUBLISH",`local candidate - ${null==(s=null==(t=this.publishConnection)?void 0:t.selectedCandidatePair)?void 0:s.local.candidate}; remote candidate - ${null==(r=null==(a=this.publishConnection)?void 0:a.selectedCandidatePair)?void 0:r.remote.candidate}`)))}))},this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{fe.d(Ts,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{fe.d(Ts,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>R(this,null,(function*(){if(("disconnected"===e?fe.w.bind(fe):fe.d.bind(fe))(Ts,`Subscribe ice connection state change: ${e}`),"connected"===e){let i=this.callbacks.get(G);this.callbacks.delete(G),i&&i.promise.resolve(!0)}})),onConnectionStateChange:e=>R(this,null,(function*(){var i,t,s,a;("disconnected"===e?fe.w.bind(fe):fe.d.bind(fe))(Ts,`Subscribe connection state change: ${e}`),"failed"===e&&(yield this.handleIceConnectionFailure(1,Ae.WebrtcErrors.ICEFailure("SUBSCRIBE",`local candidate - ${null==(t=null==(i=this.subscribeConnection)?void 0:i.selectedCandidatePair)?void 0:t.local.candidate}; remote candidate - ${null==(a=null==(s=this.subscribeConnection)?void 0:s.selectedCandidatePair)?void 0:a.remote.candidate}`))),"disconnected"===e&&setTimeout((()=>{var e,t,p,u,g;"disconnected"===(null==(e=this.subscribeConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(1,Ae.WebrtcErrors.ICEDisconnected("SUBSCRIBE",`local candidate - ${null==(p=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:p.local.candidate}; remote candidate - ${null==(g=null==(u=this.subscribeConnection)?void 0:u.selectedCandidatePair)?void 0:g.remote.candidate}`))}),5e3),"connected"===e&&this.handleSubscribeConnectionConnected()}))},this.handleLocalRoleUpdate=i=>R(this,[i],(function*({oldRole:e,newRole:t}){!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t)&&(fe.d(Ts,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation ⏳"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())})),this.retryPublishIceFailedTask=()=>R(this,null,(function*(){if(this.publishConnection){let e=new Promise(((e,i)=>{this.callbacks.set(N,{promise:{resolve:e,reject:i},action:"RESTART_ICE",extra:{}})}));yield this.performPublishRenegotiation({iceRestart:"connected"!==this.publishConnection.connectionState}),yield e}return!0})),this.retrySubscribeIceFailedTask=()=>R(this,null,(function*(){if(this.subscribeConnection&&"connected"!==this.subscribeConnection.connectionState){let e=new Promise(((i,e)=>{this.callbacks.set(G,{promise:{resolve:i,reject:e},action:"RESTART_ICE",extra:{}})})),t=new Promise((i=>{setTimeout(i,6e4,!1)}));return Promise.race([e,t])}return!0})),this.retrySignalDisconnectTask=()=>R(this,null,(function*(){var e;fe.d(Ts,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),this.signal.isConnected||(yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId));let t=null!=(e=this.store.getRoom())&&e.joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),t})),this.webrtcInternals=new ri(this.store,this.eventBus,null==(n=this.publishConnection)?void 0:n.nativeConnection,null==(p=this.subscribeConnection)?void 0:p.nativeConnection);this.retryScheduler=new Qi(((u,g)=>R(this,null,(function*(){u!==this.state&&(this.state=u,yield this.observer.onStateChange(this.state,g))}))),this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe((u=>{var e,t;let g=(null==(t=null==(e=u.getLocalPeerStats())?void 0:e.subscribe)?void 0:t.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,g)})),this.eventBus.localAudioEnabled.subscribe((({track:u})=>this.trackUpdate(u))),this.eventBus.localVideoEnabled.subscribe((({track:u})=>this.trackUpdate(u)))}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let r=null==(t=this.initConfig)?void 0:t.config;return((null==r?void 0:r.enabledFlags)||[]).includes(e)}preview(e,t,i,r,s=!1){return R(this,null,(function*(){let a=yield this.connect(e,t,i,r,s);return this.state="Preview",this.observer.onStateChange(this.state),a}))}join(e,t,i,r,s=!1){return R(this,null,(function*(){fe.d(Ts,"join: started ⏰");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,r,t,i,s)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,s),yield this.initRtcStatsMonitor(),fe.d(Ts,"✅ join: Negotiated over PUBLISH connection"))}catch(r){fe.e(Ts,`join: failed ❌ [token=${e}]`,r),this.state="Failed";let t=r;throw t.isTerminal=t.isTerminal||500===t.code,yield this.observer.onStateChange(this.state,t),t}fe.d(Ts,"✅ join: successful"),this.state="Joined",this.observer.onStateChange(this.state)}))}connect(e,t,i,r,s=!1){return R(this,null,(function*(){this.setTransportStateForConnect(),this.joinParameters=new qi(e,i,r.name,r.metaData,t,s);try{return yield this.internalConnect(e,t,i)}catch(r){if(!(r instanceof Se&&([ye.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,ye.WebSocketConnectionErrors.FAILED_TO_CONNECT,ye.WebSocketConnectionErrors.ABNORMAL_CLOSE,ye.APIErrors.ENDPOINT_UNREACHABLE].includes(r.code)||r.code.toString().startsWith("5")||r.code.toString().startsWith("429"))))throw r;{let n=()=>R(this,null,(function*(){return yield this.internalConnect(e,t,i),!(!this.initConfig||!this.initConfig.endpoint)}));yield this.retryScheduler.schedule({category:0,error:r,task:n,originalState:this.state,maxFailedRetries:5,changeState:!1})}}}))}leave(e){return R(this,null,(function*(){var t,i,r,s,a;this.retryScheduler.reset(),this.joinParameters=void 0,fe.d(Ts,"leaving in transport");try{if(this.state="Leaving",null==(t=this.publishStatsAnalytics)||t.stop(),null==(i=this.subscribeStatsAnalytics)||i.stop(),null==(r=this.webrtcInternals)||r.cleanup(),yield null==(s=this.publishConnection)?void 0:s.close(),yield null==(a=this.subscribeConnection)?void 0:a.close(),e)try{this.signal.leave(),fe.d(Ts,"signal leave done")}catch(e){fe.w(Ts,"failed to send leave on websocket to server",e)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(e){this.eventBus.analytics.publish(Ne.disconnect(e)),fe.e(Ts,"leave: FAILED ❌",e)}finally{this.state="Disconnected",this.observer.onStateChange(this.state)}}))}publish(e){return R(this,null,(function*(){for(let t of e)try{yield this.publishTrack(t)}catch(e){this.eventBus.analytics.publish(Ne.publish({devices:this.deviceManager.getDevices(),error:e}))}}))}unpublish(e){return R(this,null,(function*(){for(let t of e)yield this.unpublishTrack(t)}))}sendMessage(e){return R(this,null,(function*(){return yield this.signal.broadcast(e)}))}trackUpdate(e){let i=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));if(i){let t=new Ei(C(I({},i),{mute:!e.enabled}));this.trackStates.set(i.track_id,t),fe.d(Ts,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[i.track_id,t]]))}}changeRole(e,t,i=!1){return R(this,null,(function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeer(e,t,i){return R(this,null,(function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeersWithRoles(e,t){return R(this,null,(function*(){yield this.signal.requestBulkRoleChange({roles:e.map((i=>i.name)),role:t,force:!0})}))}acceptRoleChange(e){return R(this,null,(function*(){var t;yield this.signal.acceptRoleChangeRequest({requested_by:null==(t=e.requestedBy)?void 0:t.peerId,role:e.role.name,token:e.token})}))}endRoom(e,t){return R(this,null,(function*(){yield this.signal.endRoom(e,t)}))}removePeer(e,t){return R(this,null,(function*(){yield this.signal.removePeer({requested_for:e,reason:t})}))}startRTMPOrRecording(e){return R(this,null,(function*(){var i;let t={meeting_url:e.meetingURL,record:e.record};null!=(i=e.rtmpURLs)&&i.length&&(t.rtmp_urls=e.rtmpURLs),e.resolution&&(t.resolution=e.resolution),yield this.signal.startRTMPOrRecording(t)}))}stopRTMPOrRecording(){return R(this,null,(function*(){yield this.signal.stopRTMPAndRecording()}))}startHLSStreaming(e){return R(this,null,(function*(){let t={};e&&e.variants&&e.variants.length>0&&(t.variants=e.variants.map((i=>{let e={meeting_url:i.meetingURL};return i.metadata&&(e.metadata=i.metadata),e}))),null!=e&&e.recording&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)}))}stopHLSStreaming(e){return R(this,null,(function*(){var t;if(e){let i={variants:null==(t=null==e?void 0:e.variants)?void 0:t.map((e=>{let s={meeting_url:e.meetingURL};return e.metadata&&(s.metadata=e.metadata),s}))};yield this.signal.stopHLSStreaming(i)}yield this.signal.stopHLSStreaming()}))}sendHLSTimedMetadata(e){return R(this,null,(function*(){if(e.length>0){let t={metadata_objs:e};yield this.signal.sendHLSTimedMetadata(t)}}))}changeName(e){return R(this,null,(function*(){let t=this.store.getLocalPeer();t&&t.name!==e&&(yield this.signal.updatePeer({name:e}))}))}changeMetadata(e){return R(this,null,(function*(){yield this.signal.updatePeer({data:e})}))}getSessionMetadata(e){return this.signal.getSessionMetadata(e)}setSessionMetadata(e){return this.signal.setSessionMetadata(e)}listenMetadataChange(e){return this.signal.listenMetadataChange(e)}setPollInfo(e){return this.signal.setPollInfo(e)}getPollInfo(e){return this.signal.getPollInfo(e)}setPollQuestions(e){return this.signal.setPollQuestions(e)}getPollQuestions(e){return this.signal.getPollQuestions(e)}startPoll(e){return this.signal.startPoll(e)}stopPoll(e){return this.signal.stopPoll(e)}setPollResponses(e){return this.signal.setPollResponses(e)}getPollResponses(e){return this.signal.getPollResponses(e)}getPollsList(e){return this.signal.getPollsList(e)}getPollResult(e){return this.signal.getPollResult(e)}joinGroup(e){return R(this,null,(function*(){return this.signal.joinGroup(e)}))}leaveGroup(e){return R(this,null,(function*(){return this.signal.leaveGroup(e)}))}addToGroup(e,t){return R(this,null,(function*(){this.signal.addToGroup(e,t)}))}removeFromGroup(e,t){return R(this,null,(function*(){this.signal.removeFromGroup(e,t)}))}findPeers(e){return this.signal.findPeers(e)}peerIterNext(e){return this.signal.peerIterNext(e)}changeTrackState(e){return R(this,null,(function*(){yield this.signal.requestTrackStateChange(e)}))}changeMultiTrackState(e){return R(this,null,(function*(){yield this.signal.requestMultiTrackStateChange(e)}))}publishTrack(e){return R(this,null,(function*(){e.publishedTrackId=e.getTrackIDBeingSent(),fe.d(Ts,`⏳ publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new Ei(e));let t=new Promise(((s,a)=>{this.callbacks.set(N,{promise:{resolve:s,reject:a},action:"PUBLISH",extra:{}})})),i=e.stream;i.setConnection(this.publishConnection);let r=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,r),fe.time(`publish-${e.trackId}-${e.type}`),yield t,fe.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then((()=>{fe.d(Ts,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof Ht?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)})).catch((s=>fe.w(Ts,"Failed setting maxBitrate and maxFramerate",s))),e.isPublished=!0,fe.d(Ts,`✅ publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)}))}unpublishTrack(e){return R(this,null,(function*(){if(fe.d(Ts,`⏳ unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let s=Array.from(this.trackStates.values()).find((a=>e.type===a.type&&e.source===a.source));s&&this.trackStates.delete(s.track_id)}let t=new Promise(((e,s)=>{this.callbacks.set(N,{promise:{resolve:e,reject:s},action:"UNPUBLISH",extra:{}})}));e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e),fe.d(Ts,`✅ unpublishTrack: trackId=${e.trackId}`,this.callbacks)}))}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise((e=>{this.eventBus.policyChange.subscribeOnce((()=>e()))}))}createConnectionsAndNegotiateJoin(e,t=!1){return R(this,null,(function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start("join_response_time"),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end("join_response_time")}))}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new us(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver)),this.subscribeConnection||(this.subscribeConnection=new rt(this.signal,this.initConfig.rtcConfiguration,this.isFlagEnabled.bind(this),this.subscribeConnectionObserver)))}negotiateJoinWithRetry(s){return R(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}catch(l){fe.e(Ts,"Join negotiation failed ❌",l);let n=l instanceof Se?l:Ae.WebsocketMethodErrors.ServerErrors(500,"JOIN",`Websocket join error - ${l.message}`),o=5===parseInt(""+n.code/100)||[ye.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,429].includes(n.code);if(410===n.code&&(n.isTerminal=!0),!o)throw l;{this.joinRetryCount=0,n.isTerminal=!1;let p=()=>R(this,null,(function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}));yield this.retryScheduler.schedule({category:2,error:n,task:p,originalState:"Joined",maxFailedRetries:3,changeState:!1})}}}))}negotiateJoin(s){return R(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){return r?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})}))}negotiateJoinWebRTC(e){return R(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){if(fe.d(Ts,"⏳ join: Negotiating over PUBLISH connection"),!this.publishConnection)return fe.e(Ts,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let a=this.isFlagEnabled("subscribeDegradation"),r=this.isFlagEnabled("simulcast"),n=this.isFlagEnabled("onDemandTracks"),p=yield this.signal.join(e,t,!i,a,r,n,s);yield this.publishConnection.setRemoteDescription(p);for(let u of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(u);return this.publishConnection.initAfterJoin(),!!p}))}negotiateJoinNonWebRTC(e){return R(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){fe.d(Ts,"⏳ join: Negotiating Non-WebRTC");let s=this.isFlagEnabled("subscribeDegradation"),a=this.isFlagEnabled("simulcast"),r=this.isFlagEnabled("onDemandTracks");return!!(yield this.signal.join(e,t,!i,s,a,r))}))}negotiateOnFirstPublish(){return R(this,null,(function*(){if(fe.d(Ts,"⏳ Negotiating offer over PUBLISH connection"),!this.publishConnection)return fe.e(Ts,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t}))}performPublishRenegotiation(e){return R(this,null,(function*(){fe.d(Ts,"⏳ [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(N);if(t){if(!this.publishConnection)return void fe.e(Ts,"Publish peer connection not found, cannot renegotiate");try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),fe.time("renegotiation-offer-exchange");let r=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(N),fe.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(r),t.promise.resolve(!0),fe.d(Ts,"[role=PUBLISH] onRenegotiationNeeded DONE ✅")}catch(r){let e;e=r instanceof Se?r:Ae.GenericErrors.Unknown("PUBLISH",r.message),t.promise.reject(e),fe.d(Ts,"[role=PUBLISH] onRenegotiationNeeded FAILED ❌")}}}))}handleIceConnectionFailure(e,t){return R(this,null,(function*(){this.retryScheduler.isTaskInProgress(4)||(0===e?this.retryScheduler.schedule({category:3,error:t,task:this.retryPublishIceFailedTask,originalState:"Joined"}):this.retryScheduler.schedule({category:4,error:t,task:this.retrySubscribeIceFailedTask,originalState:"Joined",maxFailedRetries:1}))}))}internalConnect(e,t,i){return R(this,null,(function*(){fe.d(Ts,"connect: started ⏰");let r=new Date;try{return this.analyticsTimer.start("init_response_time"),this.initConfig=yield gs.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t}),this.analyticsTimer.end("init_response_time"),pi.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.observer.onConnected(),this.store.setSimulcastEnabled(this.isFlagEnabled("simulcast")),fe.d(Ts,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(e){throw"Reconnecting"!==this.state&&this.eventBus.analytics.publish(Ne.connect(e,this.getAdditionalAnalyticsProperties(),r,new Date,t)),fe.e(Ts,"❌ internal connect: failed",e),e}}))}validateNotDisconnected(e){if("Disconnected"===this.state)throw fe.w(Ts,"aborting join as transport state is disconnected"),Ae.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return R(this,null,(function*(){if(!this.initConfig)throw Ae.APIErrors.InitConfigNotAvailable("INIT","Init Config not found");fe.d(Ts,"⏳ internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),i.searchParams.set("protocol_version","2.5"),i.searchParams.set("protocol_spec","20230919"),this.endpoint=i.toString(),this.analyticsTimer.start("ws_connect_time"),yield this.signal.open(this.endpoint),this.analyticsTimer.end("ws_connect_time"),this.analyticsTimer.start("on_policy_change_time"),this.analyticsTimer.start("room_state_time"),fe.d(Ts,"✅ internal connect: connected to ws endpoint")}))}initRtcStatsMonitor(){return R(this,null,(function*(){var e,t,i;null==(i=this.webrtcInternals)||i.setPeerConnections({publish:null==(e=this.publishConnection)?void 0:e.nativeConnection,subscribe:null==(t=this.subscribeConnection)?void 0:t.nativeConnection}),this.initStatsAnalytics()}))}initStatsAnalytics(){var e,t;this.isFlagEnabled("publishStats")&&(this.publishStatsAnalytics=new ns(this.store,this.eventBus,this.getValueFromInitConfig("publishStats","maxSampleWindowSize",30),this.getValueFromInitConfig("publishStats","maxSamplePushInterval",300)),null==(e=this.getWebrtcInternals())||e.start()),this.isFlagEnabled("subscribeStats")&&(this.subscribeStatsAnalytics=new os(this.store,this.eventBus,this.getValueFromInitConfig("subscribeStats","maxSampleWindowSize",10),this.getValueFromInitConfig("subscribeStats","maxSamplePushInterval",60)),null==(t=this.getWebrtcInternals())||t.start())}getValueFromInitConfig(e,t,i){var r,s;return(null==(s=null==(r=this.initConfig)?void 0:r.config[e])?void 0:s[t])||i}doesRoleNeedWebRTC(e){var t,s;if(!this.isFlagEnabled("nonWebRTCDisableOffer"))return!0;let r=!!(e.publishParams.allowed&&(null==(t=e.publishParams.allowed)?void 0:t.length)>0),i=!!(e.subscribeParams.subscribeToRoles&&(null==(s=e.subscribeParams.subscribeToRoles)?void 0:s.length)>0);return r||i}doesLocalPeerNeedWebRTC(){var e;let t=null==(e=this.store.getLocalPeer())?void 0:e.role;return!t||this.doesRoleNeedWebRTC(t)}handleSubscribeConnectionConnected(){var e;null==(e=this.subscribeConnection)||e.logSelectedIceCandidatePairs();let t=this.callbacks.get(G);this.callbacks.delete(G),t&&t.promise.resolve(!0)}setTransportStateForConnect(){if("Failed"===this.state&&(this.state="Disconnected"),"Disconnected"!==this.state&&"Reconnecting"!==this.state)throw Ae.WebsocketMethodErrors.AlreadyJoined("JOIN",`Cannot join a meeting in ${this.state} state`);"Disconnected"===this.state&&(this.state="Connecting",this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let r,i=this.getAdditionalAnalyticsProperties();switch(t){case 0:r=Ne.connect(e,i);break;case 1:r=Ne.disconnect(e,i);break;case 2:r=Ne.join({error:e,time:this.analyticsTimer.getTimeTaken("join_time"),init_response_time:this.analyticsTimer.getTimeTaken("init_response_time"),ws_connect_time:this.analyticsTimer.getTimeTaken("ws_connect_time"),on_policy_change_time:this.analyticsTimer.getTimeTaken("on_policy_change_time"),local_audio_track_time:this.analyticsTimer.getTimeTaken("local_audio_track_time"),local_video_track_time:this.analyticsTimer.getTimeTaken("local_video_track_time"),retries_join:this.joinRetryCount});break;case 3:r=Ne.publish({error:e});break;case 4:r=Ne.subscribeFail(e)}this.eventBus.analytics.publish(r)}getSubscribeConnection(){return this.subscribeConnection}getAdditionalAnalyticsProperties(){var a,e,t,p,u,g,r,n;let o=(()=>{if(!le||void 0===navigator.connection)return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}})();return{network_info:o,document_hidden:"undefined"!=typeof document&&document.hidden,num_degraded_tracks:this.store.getRemoteVideoTracks().filter((e=>e.degraded)).length,bitrate:{publish:null==(p=null==(t=null==(e=null==(a=this.getWebrtcInternals())?void 0:a.getCurrentStats())?void 0:e.getLocalPeerStats())?void 0:t.publish)?void 0:p.bitrate,subscribe:null==(n=null==(r=null==(g=null==(u=this.getWebrtcInternals())?void 0:u.getCurrentStats())?void 0:g.getLocalPeerStats())?void 0:r.subscribe)?void 0:n.bitrate},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function fs(e){if(!e||0===e.length)throw Ae.APIErrors.InvalidTokenFormat("INIT","Token cannot be an empty string or undefined or null");let t=e.split(".");if(3!==t.length)throw Ae.APIErrors.InvalidTokenFormat("INIT","Expected 3 '.' separate fields - header, payload and signature respectively");let r=atob(t[1]);try{let i=JSON.parse(r);return{roomId:i.room_id,userId:i.user_id,role:i.role}}catch(e){throw Ae.APIErrors.InvalidTokenFormat("INIT",`couldn't parse to json - ${e.message}`)}}var ys={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isPreviewCalled:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},Ss=class{constructor(){this.TAG="[HMSSdk]:",this.transportState="Disconnected",this.analyticsTimer=new Ge,this.sdkState=I({},ys),this.handleAutoplayError=e=>{var t,i;null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)},this.observer={onNotification:e=>{var t;if("on-peer-leave-request"!==e.method){switch(e.method){case"on-policy-change":this.analyticsTimer.end("on_policy_change_time");break;case"peer-list":this.analyticsTimer.end("peer_list_time"),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled);break;case"room-state":this.analyticsTimer.end("room_state_time")}null==(t=this.notificationManager)||t.handleNotification(e,this.sdkState.isReconnecting)}else this.handlePeerLeaveRequest(e.params)},onConnected:()=>{this.initNotificationManager()},onTrackAdd:e=>{var t;null==(t=this.notificationManager)||t.handleTrackAdd(e)},onTrackRemove:e=>{var t;null==(t=this.notificationManager)||t.handleTrackRemove(e)},onFailure:e=>{var t;null==(t=this.errorListener)||t.onError(e)},onStateChange:(e,t)=>R(this,null,(function*(){var r,s;let i=a=>R(this,null,(function*(){var e,t;yield this.internalLeave(!0,a),!this.sdkState.isPreviewInProgress&&!this.sdkState.isJoinInProgress&&(null==(t=null==(e=this.errorListener)?void 0:e.onError)||t.call(e,a)),this.sdkState.isReconnecting=!1}));switch(e){case"Preview":case"Joined":this.initNotificationManager(),"Reconnecting"===this.transportState&&(null==(r=this.listener)||r.onReconnected());break;case"Failed":yield i(t);break;case"Reconnecting":this.sdkState.isReconnecting=!0,null==(s=this.listener)||s.onReconnecting(t)}this.transportState=e,fe.d(this.TAG,"Transport State Change",this.transportState)}))},this.handlePeerLeaveRequest=e=>{var t;let r=e.requested_by?this.store.getPeerById(e.requested_by):void 0,i={roomEnded:e.room_end,reason:e.reason,requestedBy:r};null==(t=this.listener)||t.onRemovedFromRoom(i),this.internalLeave(!1)},this.handleDeviceChange=e=>{var t,i,r,s,a,n;if(fe.d(this.TAG,"Device Change event",e),null==(i=null==(t=this.deviceChangeListener)?void 0:t.onDeviceChange)||i.call(t,e),e.error&&e.type){let t=e.type.includes("audio")?null==(r=this.localPeer)?void 0:r.audioTrack:null==(s=this.localPeer)?void 0:s.videoTrack;null==(a=this.errorListener)||a.onError(e.error),[ye.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,ye.TracksErrors.DEVICE_IN_USE,ye.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&t&&(t.setEnabled(!1),null==(n=this.listener)||n.onTrackUpdate(2,t,this.localPeer))}},this.handleAudioPluginError=e=>{var t;fe.e(this.TAG,"Audio Plugin Error event",e),null==(t=this.errorListener)||t.onError(e)},this.handleLocalRoleUpdate=i=>R(this,[i],(function*({oldRole:e,newRole:t}){var r;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield null==(r=this.roleChangeManager)?void 0:r.handleLocalPeerRoleUpdate({oldRole:e,newRole:t})})),this.sendAudioPresenceFailed=()=>{let e=Ae.TracksErrors.NoAudioDetected("PREVIEW");fe.w(this.TAG,"Audio Presence Failure",this.transportState,e)},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(Ne.join(C(I({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("join_time"),is_preview_called:e,retries_join:this.transport.joinRetryCount})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(Ne.preview(C(I({error:e},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("preview_time")})))},this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initNotificationManager(){this.notificationManager||(this.notificationManager=new Gi(this.store,this.eventBus,this.transport,this.listener,this.audioListener))}initStoreAndManagers(){var e;if(this.sdkState.isInitialised)return null==(e=this.notificationManager)||e.setListener(this.listener),this.audioSinkManager.setListener(this.listener),void this.interactivityCenter.setListener(this.listener);this.sdkState.isInitialised=!0,this.store=new vi,this.eventBus=new bi,this.wakeLockManager=new gi,this.networkTestManager=new hi(this.eventBus,this.listener),this.playlistManager=new Wi(this,this.eventBus),this.deviceManager=new fi(this.store,this.eventBus),this.audioSinkManager=new ki(this.store,this.deviceManager,this.eventBus),this.audioOutput=new yi(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new ci(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new mi(this.store),this.transport=new ks(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.sessionStore=new Hi(this.transport),this.interactivityCenter=new ji(this.transport,this.store,this.listener),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION",`Not connected - ${e}`)}sendHLSAnalytics(e){this.sendAnalyticsEvent(Ne.hlsPlayerError(e))}refreshDevices(){return R(this,null,(function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)}))}getWebrtcInternals(){var e;return null==(e=this.transport)?void 0:e.getWebrtcInternals()}getSessionStore(){return this.sessionStore}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return null==(e=this.store.getRoom())?void 0:e.recording}getRTMPState(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp}getHLSState(){var e;return null==(e=this.store.getRoom())?void 0:e.hls}getTemplateAppData(){return this.store.getTemplateAppData()}getInteractivityCenter(){return this.interactivityCenter}getPeerListIterator(e){return new dt(this.transport,this.store,e)}get localPeer(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}preview(e,t){return R(this,null,(function*(){if(we(),Ce(),this.sdkState.isPreviewInProgress)return Promise.reject(Ae.GenericErrors.PreviewAlreadyInProgress("PREVIEW","Preview already called"));if(["Joined","Reconnecting"].includes(this.transportState))return this.midCallPreview(e.asRole,e.settings);this.analyticsTimer.start("preview_time"),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then((()=>R(this,null,(function*(){yield this.initDeviceManagers()}))));let i=!1,r=!1,s=setTimeout((()=>{var a,e;(!i||!r)&&(null==(e=null==(a=this.listener)?void 0:a.onNetworkQuality)||e.call(a,-1))}),3e3);return new Promise(((a,n)=>{let p=u=>{var g;this.analyticsTimer.end("preview_time"),u&&(null==(g=this.errorListener)||g.onError(u)),this.sendPreviewAnalyticsEvent(u),this.sdkState.isPreviewInProgress=!1,n(u)};this.eventBus.policyChange.subscribeOnce((()=>R(this,null,(function*(){var r;if(this.localPeer){let t=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=t||this.localPeer.role}let u=yield this.localTrackManager.getTracksToPublish(e.settings);u.forEach((e=>this.setLocalPeerTrack(e))),null!=(r=this.localPeer)&&r.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end("preview_time");let g=this.store.getRoom();g&&t.onPreview(g,u),this.sendPreviewAnalyticsEvent(),a()})))),this.eventBus.leave.subscribeOnce(p),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then((u=>{var g;i=!0,clearTimeout(s),u&&e.captureNetworkQualityInPreview&&this.networkTestManager.start(null==(g=u.config)?void 0:g.networkHealth).then((()=>{r=!0}))})).catch(p)}))}))}midCallPreview(e,t){return R(this,null,(function*(){var s,a;if(!this.localPeer||"Joined"!==this.transportState)throw Ae.GenericErrors.NotConnected("VALIDATION","Not connected - midCallPreview");let i=e&&this.store.getPolicyForRole(e);if(!i)throw Ae.GenericErrors.InvalidRole("PREVIEW",`role ${e} does not exist in policy`);this.localPeer.asRole=i;let r=yield this.localTrackManager.getTracksToPublish(t);r.forEach((e=>this.setLocalPeerTrack(e))),null!=(s=this.localPeer)&&s.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),null==(a=this.listener)||a.onPreview(this.store.getRoom(),r)}))}cancelMidCallPreview(){return R(this,null,(function*(){var e,t,i;if((!this.localPeer||!this.localPeer.isInPreview())&&fe.w(this.TAG,"Cannot cancel mid call preview as preview is not in progress"),null!=(e=this.localPeer)&&e.asRole&&this.localPeer.role){let e=this.localPeer.asRole,s=this.localPeer.role;delete this.localPeer.asRole,yield null==(t=this.roleChangeManager)?void 0:t.diffRolesAndPublishTracks({oldRole:e,newRole:s}),null==(i=this.listener)||i.onPeerUpdate(8,this.localPeer)}}))}join(e,t){return R(this,null,(function*(){var r,p,u,g,n,o;if(we(),Ce(),this.sdkState.isPreviewInProgress)throw Ae.GenericErrors.NotReady("JOIN","Preview is in progress, can't join");this.analyticsTimer.start("join_time"),this.sdkState.isJoinInProgress=!0;let{roomId:i,userId:l,role:s}=fs(e.authToken),a=(null==(p=null==(r=this.localPeer)?void 0:r.asRole)?void 0:p.name)||(null==(g=null==(u=this.localPeer)?void 0:u.role)?void 0:g.name);null==(n=this.networkTestManager)||n.stop(),this.listener=t,this.commonSetup(e,i,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),et.resumeContext();let d=this.store.getConfig();null!=d&&d.autoManageWakeLock&&this.wakeLockManager.acquireLock(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(s),this.localPeer.customerUserId=l,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,s,l),this.roleChangeManager=new ui(this.store,this.transport,this.deviceManager,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),fe.d(this.TAG,`⏳ Joining room ${i}`),fe.time(`join-room-${i}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe),fe.d(this.TAG,`✅ Joined room ${i}`),this.analyticsTimer.start("peer_list_time"),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,yield this.publish(e.settings,a)}catch(e){throw this.analyticsTimer.end("join_time"),this.sdkState.isJoinInProgress=!1,null==(o=this.listener)||o.onError(e),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled,e),fe.e(this.TAG,"Unable to join room",e),e}fe.timeEnd(`join-room-${i}`)}))}stringifyMetadata(e){e.metaData&&"string"!=typeof e.metaData?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanup(){var e,t,i;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanup(),je.cleanup(),this.playlistManager.cleanup(),null==(e=this.wakeLockManager)||e.cleanup(),ci.cleanup(),this.notificationManager=void 0,fe.cleanup(),this.sdkState=I({},ys),this.localPeer&&(null==(t=this.localPeer.audioTrack)||t.cleanup(),this.localPeer.audioTrack=void 0,null==(i=this.localPeer.videoTrack)||i.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanup(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return R(this,null,(function*(){var r,s,a;let i=null==(r=this.store)?void 0:r.getRoom();if(i){let r=i.id;null==(s=this.networkTestManager)||s.stop(),this.eventBus.leave.publish(t),fe.d(this.TAG,`⏳ Leaving room ${r}`),yield null==(a=this.transport)?void 0:a.leave(e),this.cleanup(),fe.d(this.TAG,`✅ Left room ${r}`)}}))}getAuthTokenByRoomCode(e,t){return R(this,null,(function*(){let i=(t||{}).endpoint||"https://auth.100ms.live/v2/token";this.analyticsTimer.start("GET_TOKEN");let r=yield((e,t,r)=>R(void 0,null,(function*(){let n=Error("something went wrong during fetch");for(let s=0;s<4;s++)try{let a=yield fetch(e,t),n=yield a.clone().json();if(r&&r.length&&!a.ok&&r.includes(n.code))throw Ae.APIErrors.ServerErrors(n.code,"GET_TOKEN",n.message,!1);return a}catch(e){n=e}throw["Failed to fetch","NetworkError"].some((s=>n.message.includes(s)))?Ae.APIErrors.EndpointUnreachable("GET_TOKEN",n.message):n})))(i,{method:"POST",body:JSON.stringify({code:e.roomCode,user_id:e.userId})},[429,500,501,502,503,504,505,506,507,508,509,510,511]),s=yield r.json();if(this.analyticsTimer.end("GET_TOKEN"),!r.ok)throw Ae.APIErrors.ServerErrors(s.code,"GET_TOKEN",s.message,!1);let{token:a}=s;if(!a)throw Error(s.message);return a}))}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){return this.store.getPeers()}getPeerMap(){return this.store.getPeerMap()}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return R(this,null,(function*(){return yield this.sendMessageInternal({message:e,type:t})}))}sendGroupMessage(e,t,i){return R(this,null,(function*(){let r=this.store.getKnownRoles();if(0===(t.filter((a=>r[a.name]))||[]).length)throw Ae.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return R(this,null,(function*(){var s;if(!this.store.getPeerById(t.peerId))throw Ae.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);if((null==(s=this.localPeer)?void 0:s.peerId)===t.peerId)throw Ae.GenericErrors.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:i})}))}sendMessageInternal(s){return R(this,arguments,(function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:r}){if(""===r.replace(/\u200b/g," ").trim())throw fe.w(this.TAG,"sendMessage","Ignoring empty message send"),Ae.GenericErrors.ValidationFailed("Empty message not allowed");let a=new D({sender:this.localPeer,type:i,message:r,recipientPeer:t,recipientRoles:e,time:new Date});fe.d(this.TAG,"Sending Message: ",a);let n=yield this.transport.sendMessage(a);return a.time=new Date(n.timestamp),a.id=n.message_id,a}))}startScreenShare(e,t){return R(this,null,(function*(){var r,n,p;let i=this.store.getPublishParams();if(!i)return;let{allowed:o}=i;if(!o||!o.includes("screen"))return void fe.e(this.TAG,`Role ${null==(r=this.localPeer)?void 0:r.role} cannot share screen`);if(null!=(p=null==(n=this.localPeer)?void 0:n.auxiliaryTracks)&&p.find((u=>"screen"===u.source)))throw Error("Cannot share multiple screens");let a=yield this.getScreenshareTracks(e,t);if(!this.localPeer)return fe.d(this.TAG,"Screenshared when not connected"),void a.forEach((u=>{u.cleanup()}));yield this.transport.publish(a),a.forEach((u=>{var g,e,t;u.peerId=null==(g=this.localPeer)?void 0:g.peerId,null==(e=this.localPeer)||e.auxiliaryTracks.push(u),null==(t=this.listener)||t.onTrackUpdate(0,u,this.localPeer)}))}))}stopEndedScreenshare(e){return R(this,null,(function*(){fe.d(this.TAG,"✅ Screenshare ended natively"),yield this.stopScreenShare(),e()}))}stopScreenShare(){return R(this,null,(function*(){var e;fe.d(this.TAG,"✅ Screenshare ended from app");let t=null==(e=this.localPeer)?void 0:e.auxiliaryTracks.filter((i=>"screen"===i.source));if(t)for(let i of t)yield this.removeTrack(i.trackId)}))}addTrack(e,t="regular"){return R(this,null,(function*(){var p,u,g,r;if(!e)return void fe.w(this.TAG,"Please pass a valid MediaStreamTrack");if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find((t=>t.trackId===e.id)))return;let n=e.kind,s=new MediaStream([e]),a=new Jt(s),o=new("audio"===n?_t:Ht)(a,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:o,source:t}),yield null==(p=this.transport)?void 0:p.publish([o]),o.peerId=null==(u=this.localPeer)?void 0:u.peerId,null==(g=this.localPeer)||g.auxiliaryTracks.push(o),null==(r=this.listener)||r.onTrackUpdate(0,o,this.localPeer)}))}removeTrack(e,t=!1){return R(this,null,(function*(){var r;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex((s=>s.trackId===e));if(i>-1){let s=this.localPeer.auxiliaryTracks[i];s.isPublished?yield this.transport.unpublish([s]):yield s.cleanup(),t||this.stopPlaylist(s),this.localPeer.auxiliaryTracks.splice(i,1),null==(r=this.listener)||r.onTrackUpdate(1,s,this.localPeer)}else fe.w(this.TAG,`No track found for ${e}`)}))}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){fe.level=e}addAudioListener(e){var t;this.audioListener=e,null==(t=this.notificationManager)||t.setAudioListener(e)}addConnectionQualityListener(e){var t;null==(t=this.notificationManager)||t.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return R(this,null,(function*(){var r;yield null==(r=this.transport)?void 0:r.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeer(e,t,i=!1){return R(this,null,(function*(){var r;yield null==(r=this.transport)?void 0:r.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeersWithRoles(e,t){return R(this,null,(function*(){var i;e.length<=0||!t||(yield null==(i=this.transport)?void 0:i.changeRoleOfPeersWithRoles(e,t))}))}acceptChangeRole(e){return R(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.acceptRoleChange(e)}))}endRoom(e,t){return R(this,null,(function*(){var i;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot end room");yield null==(i=this.transport)?void 0:i.endRoom(e,t),yield this.leave()}))}removePeer(e,t){return R(this,null,(function*(){var i;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot remove peer");yield null==(i=this.transport)?void 0:i.removePeer(e,t)}))}startRTMPOrRecording(e){return R(this,null,(function*(){var t;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start streaming or recording");yield null==(t=this.transport)?void 0:t.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return R(this,null,(function*(){var e;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop streaming or recording");yield null==(e=this.transport)?void 0:e.stopRTMPOrRecording()}))}startHLSStreaming(e){return R(this,null,(function*(){var t;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start HLS streaming");yield null==(t=this.transport)?void 0:t.startHLSStreaming(e)}))}stopHLSStreaming(e){return R(this,null,(function*(){var t;if(!this.localPeer)throw Ae.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop HLS streaming");yield null==(t=this.transport)?void 0:t.stopHLSStreaming(e)}))}sendHLSTimedMetadata(e){return R(this,null,(function*(){var t;this.validateJoined("sendHLSTimedMetadata"),yield null==(t=this.transport)?void 0:t.sendHLSTimedMetadata(e)}))}changeName(e){return R(this,null,(function*(){var t,i;this.validateJoined("changeName"),yield null==(t=this.transport)?void 0:t.changeName(e),null==(i=this.notificationManager)||i.updateLocalPeer({name:e})}))}changeMetadata(e){return R(this,null,(function*(){var t,i;this.validateJoined("changeMetadata"),yield null==(t=this.transport)?void 0:t.changeMetadata(e),null==(i=this.notificationManager)||i.updateLocalPeer({metadata:e})}))}setSessionMetadata(e){return R(this,null,(function*(){yield this.transport.setSessionMetadata({key:"default",data:e})}))}getSessionMetadata(){return R(this,null,(function*(){return(yield this.transport.getSessionMetadata("default")).data}))}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return R(this,null,(function*(){var r;if("video"===e.type&&"regular"!==e.source)return void fe.w(this.TAG,"Muting non-regular video tracks is currently not supported");if(e.enabled===t)return void fe.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);if(!this.store.getTrackById(e.trackId))throw Ae.GenericErrors.ValidationFailed("No track found for change track state",e);let i=this.store.getPeerByTrackId(e.trackId);if(!i)throw Ae.GenericErrors.ValidationFailed("No peer found for change track state",e);yield null==(r=this.transport)?void 0:r.changeTrackState({requested_for:i.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})}))}changeMultiTrackState(e){return R(this,null,(function*(){var a;if("boolean"!=typeof e.enabled)throw Ae.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:t,roles:i,type:r,source:s}=e;yield null==(a=this.transport)?void 0:a.changeMultiTrackState({value:!t,type:r,source:s,roles:null==i?void 0:i.map((e=>null==e?void 0:e.name))})}))}raiseLocalPeerHand(){return R(this,null,(function*(){this.validateJoined("raiseLocalPeerHand"),yield this.transport.joinGroup(q)}))}lowerLocalPeerHand(){return R(this,null,(function*(){this.validateJoined("lowerLocalPeerHand"),yield this.transport.leaveGroup(q)}))}raiseRemotePeerHand(e){return R(this,null,(function*(){yield this.transport.addToGroup(e,q)}))}lowerRemotePeerHand(e){return R(this,null,(function*(){yield this.transport.addToGroup(e,q)}))}setFrameworkInfo(e){this.frameworkInfo=I(I({},this.frameworkInfo),e)}attachVideo(e,t){return R(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.attach(t):yield e.addSink(t)}))}detachVideo(e,t){return R(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.detach(t):yield e.removeSink(t)}))}publish(e,t){return R(this,null,(function*(){var i,r,s;if([this.store.getPublishParams(),!this.sdkState.published,!de].every((a=>!!a))){let a=t&&t!==(null==(r=null==(i=this.localPeer)?void 0:i.role)?void 0:r.name)?()=>{var e;return null==(e=this.roleChangeManager)?void 0:e.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield null==(s=null==a?void 0:a())?void 0:s.catch((e=>{var t;fe.e(this.TAG,"Error in publish",e),null==(t=this.listener)||t.onError(e)}))}}))}getAndPublishTracks(e){return R(this,null,(function*(){var i,t;let r=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(r),null==(t=null==(i=this.localPeer)?void 0:i.audioTrack)||t.initAudioLevelMonitor(),this.sdkState.published=!0}))}setAndPublishTracks(e){return R(this,null,(function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),null==(t=this.listener)||t.onTrackUpdate(0,i,this.localPeer);yield this.initDeviceManagers()}))}setLocalPeerTrack(e){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case"audio":this.localPeer.audioTrack=e;break;case"video":this.localPeer.videoTrack=e}}initDeviceManagers(){return R(this,null,(function*(){var e,t,i,r,s;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice(null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice(null==(r=null==(i=je.getSelection())?void 0:i.audioOutput)?void 0:r.deviceId)),this.audioSinkManager.init(null==(s=this.store.getConfig())?void 0:s.audioSinkElementId))}))}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanup(),this.audioSinkManager.cleanup()}initPreviewTrackAudioLevelMonitor(){var e;let t=null==(e=this.localPeer)?void 0:e.audioTrack;null==t||t.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe((i=>{var s;let e=i&&i.track.trackId===(null==t?void 0:t.trackId)?[{audioLevel:i.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(e),null==(s=this.audioListener)||s.onAudioLevelUpdate(e)})),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var i;let e=this.store.getLocalPeer(),t=this.store.getRoom();if(t)return t.joinedAt=new Date,e&&(e.joinedAt=t.joinedAt),null!=e&&e.role?(this.analyticsTimer.end("join_time"),void(null==(i=this.listener)||i.onJoin(t))):new Promise(((e,s)=>{this.eventBus.policyChange.subscribeOnce((()=>{var a;this.analyticsTimer.end("join_time"),null==(a=this.listener)||a.onJoin(t),e()})),this.eventBus.leave.subscribeOnce((a=>{s(a)}))}));fe.w(this.TAG,"notify join - room not present")}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewCalled=!0,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:r,role:s}=fs(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,s,r,e.asRole)}setPlaylistSettings(e){return R(this,arguments,(function*({track:e,hmsTrack:t,source:i}){if("videoplaylist"===i){let s={};if("audio"===e.kind)s.maxBitrate=64;else{s.maxBitrate=1e3;let{width:a,height:t}=e.getSettings();s.width=a,s.height=t}yield t.setSettings(s)}else"audioplaylist"===i&&(yield t.setSettings({maxBitrate:64}))}))}createAndAddLocalPeerToStore(e,t,i,r){let s=this.store.getPolicyForRole(t),a=r?this.store.getPolicyForRole(r):void 0,n=new re({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:s,asRole:a||s});this.store.addPeer(n)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new L(t))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return R(this,null,(function*(){let[i,r]=yield this.localTrackManager.getLocalScreen(t),s=()=>{this.stopEndedScreenshare(e)},a=[];if(null!=t&&t.audioOnly){if(i.nativeTrack.stop(),!r)throw Ae.TracksErrors.NothingToReturn("TRACK","Select share audio when sharing screen","No audio found");a.push(r),r.nativeTrack.addEventListener("ended",s)}else a.push(i),i.nativeTrack.addEventListener("ended",s),r&&a.push(r);return a}))}stopPlaylist(e){"audioplaylist"===e.source?this.playlistManager.stop("audio"):"videoplaylist"===e.source&&this.playlistManager.stop("video")}}}).call(this,r(263))}}]);