(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{407:function(e,t,r){"use strict";r.d(t,"a",(function(){return U})),r.d(t,"b",(function(){return Kt})),r.d(t,"c",(function(){return ut})),r.d(t,"d",(function(){return Ee})),r.d(t,"e",(function(){return it})),r.d(t,"f",(function(){return se})),r.d(t,"g",(function(){return Re})),r.d(t,"h",(function(){return ye})),r.d(t,"i",(function(){return yt})),r.d(t,"j",(function(){return he})),r.d(t,"k",(function(){return Et})),r.d(t,"l",(function(){return ge})),r.d(t,"m",(function(){return pe})),r.d(t,"n",(function(){return bt})),r.d(t,"o",(function(){return ot})),r.d(t,"p",(function(){return lt})),r.d(t,"q",(function(){return fe})),r.d(t,"r",(function(){return te})),r.d(t,"s",(function(){return ae})),r.d(t,"t",(function(){return oe})),r.d(t,"u",(function(){return le})),r.d(t,"v",(function(){return b})),r.d(t,"w",(function(){return tt})),r.d(t,"x",(function(){return ft})),r.d(t,"y",(function(){return me})),r.d(t,"z",(function(){return re})),r.d(t,"A",(function(){return kt})),r.d(t,"B",(function(){return we})),r.d(t,"C",(function(){return Ce})),r.d(t,"D",(function(){return Se})),r.d(t,"E",(function(){return ke})),r.d(t,"F",(function(){return nt}));var s,n,o,l,d,c=r(408),h=r(412),v=r(449),m=r(665),f=r.n(m),y=r(664),k=r.n(y),T=r(418),S=Object.defineProperty,E=Object.defineProperties,P=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable,R=(s,e,t)=>e in s?S(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,w=(s,e)=>{for(var t in e||(e={}))I.call(e,t)&&R(s,t,e[t]);if(A)for(var t of A(e))C.call(e,t)&&R(s,t,e[t]);return s},_=(s,e)=>E(s,P(e)),D=(s,e,t)=>new Promise(((i,r)=>{var n=e=>{try{o(t.next(e))}catch(e){r(e)}},a=e=>{try{o(t.throw(e))}catch(e){r(e)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(n,a);o((t=t.apply(s,e)).next())})),O=(s=(e,t)=>{t.exports={version:"0.10.17",license:"MIT",main:"dist/index.cjs.js",module:"dist/index.js",typings:"dist/index.d.ts",files:["dist","src"],engines:{node:">=12"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",format:"prettier --write src/**/*.ts",test:"jest --maxWorkers=1","test:watch":"jest --watch","test:coverage":"jest --coverage",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",docs:"rm -rf ./docs && typedoc && rm -f ./docs/README.md && mkdir ./docs/home &&mv ./docs/modules.md ./docs/home/content.md && node ../../scripts/docs-store && npx prettier --write './docs/**/*'"},name:"@100mslive/hms-video-store",author:"100ms",sideEffects:!1,dependencies:{"@100mslive/hms-video":"0.9.17",eventemitter2:"^6.4.7",immer:"^9.0.6",reselect:"4.0.0",zustand:"3.5.7"},devDependencies:{"ts-node":"^10.4.0",tslib:"^2.2.0"},description:"This is an addon to the core sdk provided by 100ms. It abstracts away the intricacies of data management and provides a flux based reactive data store where data flows in only one direction.",repository:{type:"git",url:"git+https://github.com/100mslive/hms-video-store.git"},keywords:["video","webrtc","conferencing","100ms"],bugs:{url:"https://github.com/100mslive/hms-video-store/issues"},homepage:"https://github.com/100mslive/hms-video-store#readme",gitHead:"966ed9ffac3d55586196ad0b738eb1977dfc2ff7"}},()=>(n||s((n={exports:{}}).exports,n),n.exports)),M=((o=M||{}).Disconnected="Disconnected",o.Preview="Preview",o.Connecting="Connecting",o.Connected="Connected",o.Reconnecting="Reconnecting",o.Disconnecting="Disconnecting",o.Failed="Failed",o),L=()=>({room:{id:"",isConnected:!1,name:"",peers:[],localPeer:"",roomState:"Disconnected",recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[],sessionStore:{},templateAppData:{},polls:{},hideLocalPeer:!1}),N=()=>({peerStats:{},remoteTrackStats:{},localTrackStats:{},localPeer:{id:""}}),G=(e=>(e.CHAT="chat",e))(G||{}),x=((d=x||{}).INFO="info",d.ERROR="error",d),U=((l=U||{}).PEER_JOINED="PEER_JOINED",l.PEER_LEFT="PEER_LEFT",l.PEER_LIST="PEER_LIST",l.NEW_MESSAGE="NEW_MESSAGE",l.ERROR="ERROR",l.RECONNECTING="RECONNECTING",l.RECONNECTED="RECONNECTED",l.TRACK_ADDED="TRACK_ADDED",l.TRACK_REMOVED="TRACK_REMOVED",l.TRACK_MUTED="TRACK_MUTED",l.TRACK_UNMUTED="TRACK_UNMUTED",l.TRACK_DEGRADED="TRACK_DEGRADED",l.TRACK_RESTORED="TRACK_RESTORED",l.TRACK_DESCRIPTION_CHANGED="TRACK_DESCRIPTION_CHANGED",l.ROLE_UPDATED="ROLE_UPDATED",l.CHANGE_TRACK_STATE_REQUEST="CHANGE_TRACK_STATE_REQUEST",l.CHANGE_MULTI_TRACK_STATE_REQUEST="CHANGE_MULTI_TRACK_STATE_REQUEST",l.ROOM_ENDED="ROOM_ENDED",l.REMOVED_FROM_ROOM="REMOVED_FROM_ROOM",l.DEVICE_CHANGE_UPDATE="DEVICE_CHANGE_UPDATE",l.PLAYLIST_TRACK_ENDED="PLAYLIST_TRACK_ENDED",l.NAME_UPDATED="NAME_UPDATED",l.METADATA_UPDATED="METADATA_UPDATED",l.POLL_CREATED="POLL_CREATED",l.POLL_STARTED="POLL_STARTED",l.POLL_STOPPED="POLL_STOPPED",l.POLL_VOTES_UPDATED="POLL_VOTES_UPDATED",l.HAND_RAISE_CHANGED="HAND_RAISE_CHANGED",l),F=(e=>(e.audio="audio",e.video="video",e))(F||{});function $(s,e){let t,i;if(e)for(let r of e.auxiliaryTracks){let e=s[r];V(e)&&(i=j(e)?e:i,t=B(e)?e:t)}return{video:t,audio:i}}function j(s){return s&&"audio"===s.type}function B(s){return s&&"video"===s.type}function V(s){return s&&"screen"===s.source}function W(s){return s&&"audioplaylist"===s.source}function H(s){return s&&"videoplaylist"===s.source}function K(s){return!!s&&!(null==s||!s.degraded)}function J(s,e){return!(!e||!s.tracks[e])&&s.tracks[e].enabled}function z(s){var e;let t=!1,r=!1,i=!1;return null!=(e=null==s?void 0:s.publishParams)&&e.allowed&&(t=s.publishParams.allowed.includes("video"),r=s.publishParams.allowed.includes("audio"),i=s.publishParams.allowed.includes("screen")),{video:t,audio:r,screen:i}}var Q=s=>s.room,Y=(Object(c.a)((s=>s.errors),(s=>0===s.length?null:s.at(-1))),Object(c.a)(Q,(s=>s.id)),s=>s.peers),X=s=>s.messages.byID,Z=s=>s.messages.allIDs,ee=s=>s.tracks,te=s=>s.settings,ie=s=>s.appData,se=s=>s.devices,q=Object(c.a)([Q],(s=>s&&s.isConnected)),re=(Object(c.a)([q,Q],((s,e)=>s?void 0!==e.peerCount?e.peerCount||1:e.peers.length:Math.max(void 0!==e.peerCount?e.peerCount:e.peers.length-1,0))),Object(c.a)([Q,Y,s=>s.hideLocalPeer],((s,e,t)=>t?s.peers.filter((i=>s.localPeer!==i)).map((i=>e[i])):s.peers.map((i=>e[i]))))),ne=Object(c.a)(ee,(s=>Object.values(s))),ae=Object(c.a)(Q,Y,((s,e)=>e[s.localPeer])),oe=Object(c.a)(Q,(s=>s.localPeer)),le=(Object(c.a)(ae,(s=>null==s?void 0:s.name)),Object(c.a)(ae,(s=>null==s?void 0:s.roleName))),de=Object(c.a)(ae,(s=>null==s?void 0:s.audioTrack)),b=Object(c.a)(ae,(s=>null==s?void 0:s.videoTrack)),ce=Object(c.a)(ae,(s=>null==s?void 0:s.auxiliaryTracks)),ue=Object(c.a)([de,b,ce],((s,e,t)=>{let i=t?[...t]:[];return s&&i.unshift(s),e&&i.unshift(e),i})),he=(Object(c.a)(re,(s=>s.filter((e=>!e.isLocal)))),Object(c.a)(Y,(s=>s.speakers),((s,e)=>{let t=Object.entries(e).sort(((i,e)=>{var t,r;let n=(null==(t=i[1])?void 0:t.audioLevel)||0;return((null==(r=e[1])?void 0:r.audioLevel)||0)>n?1:-1}));if(t.length>0&&t[0][1].audioLevel&&t[0][1].audioLevel>0){let i=t[0][1].peerID;if(i in s)return s[i]}return null})),s=>{let e=ae(s);return J(s,null==e?void 0:e.audioTrack)}),pe=s=>{let e=ae(s);return J(s,null==e?void 0:e.videoTrack)},ve=s=>{let e=ae(s);return function(s,e){return!(!e||!s.tracks[e])&&s.tracks[e].displayEnabled}(s,null==e?void 0:e.videoTrack)},ge=Object(c.a)(ae,ee,((s,e)=>{let{video:t,audio:i}=$(e,s);return!(!t&&!i)})),me=Object(c.a)(Y,ee,((s,e)=>{let t;for(let i in s){let r=s[i],{video:n,audio:a}=$(e,r);if(n)return r;a&&!t&&(t=r)}return t})),fe=Object(c.a)(me,(s=>!!s)),ye=(Object(c.a)(Y,ee,((s,e)=>{for(let t in s){let i=s[t],{audio:r,video:n}=$(e,i);if(!n&&r)return i}})),Object(c.a)(Y,ee,((s,e)=>{let t=[],i=[];for(let r in s){let n=s[r],{video:a,audio:o}=$(e,n);a?t.push(n):o&&i.push(n)}return t.concat(i)})),Object(c.a)(Y,ee,((s,e)=>{for(let t in e){let i=e[t];if(H(i)&&B(i)&&i.peerId)return s[i.peerId]}})),Object(c.a)(Y,ee,((s,e)=>{for(let t in e){let i=e[t];if(W(i)&&i.peerId)return s[i.peerId]}})),Object(c.a)(ne,(s=>s.filter(K))),Object(c.a)(Z,(s=>s.length)),Object(c.a)(X,(s=>Object.values(s).filter((e=>!e.read)).length)),Object(c.a)(Z,X,((s,e)=>{let t=[];return s.forEach((i=>{t.push(e[i])})),t}))),ke=Object(c.a)([Q],(s=>s&&s.roomState)),Te=Object(c.a)(ke,(s=>"Preview"===s)),Se=Object(c.a)(Q,(s=>"Disconnected"!==s.roomState)),be=s=>s.roles,Ee=Object(c.a)([be],(s=>Object.keys(s))),Pe=Object(c.a)([ae,be],((s,e)=>null!=s&&s.roleName?e[s.roleName]:null)),Ae=Object(c.a)([s=>{var e;return null==(e=s.preview)?void 0:e.asRole},be],((s,e)=>s?e[s]:null)),Ie=(Object(c.a)([Pe],(s=>{var e;return!(null==(e=null==s?void 0:s.subscribeParams)||!e.subscribeToRoles)&&s.subscribeParams.subscribeToRoles.length>0})),Object(c.a)(Pe,(s=>null==s?void 0:s.permissions))),Ce=Object(c.a)(Q,(s=>s.recording)),Re=(Object(c.a)(Q,(s=>s.rtmp)),Object(c.a)(Q,(s=>s.hls))),we=(Object(c.a)(Q,(s=>s.sessionId)),Object(c.a)(Q,(s=>s.startedAt)),Object(c.a)(Q,(s=>!!s.isLargeRoom)),s=>Object.values(s.polls)),_e=(Object(c.a)(re,(s=>s.filter((e=>e.isHandRaised)))),(s="audio")=>e=>e.playlist[s].list),De=(s="audio")=>e=>e.playlist[s].selection,Oe=(s="audio")=>e=>e.playlist[s].progress,rt=(s="audio")=>e=>e.playlist[s].currentTime,Me=(s="audio")=>e=>e.playlist[s].playbackRate,Le=(s="audio")=>e=>e.playlist[s].volume,Ne=(s="audio")=>Object(c.a)(_e(s),(e=>Object.values(e))),Ge=(s="audio")=>Object(c.a)(_e(s),De(s),((e,t)=>{if(t.id)return e[t.id]})),xe={selection:De("audio"),progress:Oe("audio"),currentTime:rt("audio"),playbackRate:Me("audio"),volume:Le("audio"),list:Ne("audio"),selectedItem:Ge("audio")},dt={selection:De("video"),progress:Oe("video"),currentTime:rt("video"),playbackRate:Me("video"),volume:Le("video"),list:Ne("video"),selectedItem:Ge("video")};function u(s){return e=>t=>s(t,e)}var Ue="HMS-Store:",Fe=class{static v(e,...t){this.log(h.e.VERBOSE,e,...t)}static d(...e){this.log(h.e.DEBUG,...e)}static i(...e){this.log(h.e.INFO,...e)}static w(...e){this.log(h.e.WARN,...e)}static e(...e){this.log(h.e.ERROR,...e)}static time(e){this.log(h.e.TIME,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(h.e.TIMEEND,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,...t){if(!(this.level.valueOf()>e.valueOf()))switch(e){case h.e.VERBOSE:console.log(Ue,...t);break;case h.e.DEBUG:console.debug(Ue,...t);break;case h.e.INFO:console.info(Ue,...t);break;case h.e.WARN:console.warn(Ue,...t);break;case h.e.ERROR:console.error(Ue,...t);break;case h.e.TIME:performance.mark(t[1]);break;case h.e.TIMEEND:{let i=t[0],e=t[1];try{let t=performance.measure(e,e);this.log(h.e.DEBUG,i,e,null==t?void 0:t.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(t){this.log(h.e.DEBUG,i,e,t)}break}}}};Fe.level=h.e.VERBOSE;var $e=(s,e)=>e,je=(s,e)=>e,Be=(s,e)=>e,Ve=Object(c.a)([Y,$e],((s,e)=>e?s[e]:null)),We=Object(c.a)([ee,je],((s,e)=>e?s[e]:null)),He=Object(c.a)([ee,je],((s,e)=>{if(!e)return null;let t=s[e];return"video"===(null==t?void 0:t.type)?t:null})),qe=Object(c.a)([ee,je],((s,e)=>{if(!e)return null;let t=s[e];return"audio"===(null==t?void 0:t.type)?t:null})),Ke=Object(c.a)([ee,je],((s,e)=>{if(!e)return null;let t=s[e];return"audio"===(null==t?void 0:t.type)&&"screen"===(null==t?void 0:t.source)?t:null})),Je=Object(c.a)([ee,je],((s,e)=>{if(!e)return null;let t=s[e];return"video"===(null==t?void 0:t.type)&&"screen"===(null==t?void 0:t.source)?t:null})),ze=Object(c.a)([s=>s.polls,(s,e)=>e],((s,e)=>e?s[e]:null)),Qe=u(Ve);u(Object(c.a)([ie,(s,e)=>e],((s,e)=>{if(s)return e?s[e]:s})));u(Object(c.a)(Ve,(s=>null==s?void 0:s.name)));var Ye=u(We),Xe=u(He),Ze=(u(qe),u(Ke),u(Je),u(((s,e)=>{let t=Ve(s,e);if(t&&t.videoTrack&&""!==t.videoTrack)return s.tracks[t.videoTrack]})),u(((s,e)=>{let t=Ve(s,e);if(t&&t.audioTrack&&""!==t.audioTrack)return s.tracks[t.audioTrack]}))),et=(u(((s,e)=>{let t=Ve(s,e);return(null==t?void 0:t.auxiliaryTracks.map((i=>s.tracks[i])))||[]})),(s,e)=>e?s.speakers[e]:null),tt=(u(Object(c.a)(et,(s=>(null==s?void 0:s.audioLevel)||0))),u(Object(c.a)(((s,e)=>{let t=Ze(e)(s);return et(s,null==t?void 0:t.id)}),(s=>(null==s?void 0:s.audioLevel)||0)))),it=u(((s,e)=>{if(e)return s.connectionQualities[e]})),st=(u(((s,e)=>{let t=Ve(s,e);if(t){let i=null==t?void 0:t.auxiliaryTracks.find((e=>j(s.tracks[e])));return i?s.tracks[i]:void 0}})),u(Object(c.a)(ee,Ve,((s,e)=>{let t=null==e?void 0:e.auxiliaryTracks.find((i=>{let e=s[i];return H(e)&&B(e)}));return t?s[t]:void 0}))),u(Object(c.a)(ee,Ve,((s,e)=>{let t=null==e?void 0:e.auxiliaryTracks.find((i=>{let e=s[i];return H(e)&&j(e)}));return t?s[t]:void 0}))),u(Object(c.a)(ee,Ve,((s,e)=>{let t=null==e?void 0:e.auxiliaryTracks.find((i=>{let e=s[i];return W(e)&&j(e)}));return t?s[t]:void 0}))),u(Object(c.a)(ee,Ve,((s,e)=>$(s,e))))),nt=s=>Object(c.a)(st(s),(e=>e.video)),at=s=>Object(c.a)(st(s),(e=>e.audio)),ot=u(((s,e)=>{let t=Ve(s,e);return J(s,null==t?void 0:t.audioTrack)})),lt=u(((s,e)=>{let t=Ve(s,e);return J(s,null==t?void 0:t.videoTrack)})),ct=u(((s,e)=>{if(e&&s.tracks[e])return 0===s.tracks[e].volume})),ut=(u(((s,e)=>{let t=Ve(s,e);return ct(null==t?void 0:t.audioTrack)(s)})),u(((s,e)=>{let t=at(e)(s);return ct(null==t?void 0:t.id)(s)})),u(((s,e)=>{let t=We(s,e);if(t)return"audio"!==t.type?void Fe.w("Please pass audio track here"):t.volume}))),ht=(u(((s,e)=>{let t=Ve(s,e);return ut(null==t?void 0:t.audioTrack)(s)})),u(((s,e)=>{let t=at(e)(s);return ut(null==t?void 0:t.id)(s)})),u(((s,e)=>{let t=We(s,e);if(t)return"video"!==t.type?void Fe.w("Please pass video track here"):t.layer})),Object(c.a)([ye,oe,$e],((s,e,t)=>{if(t)return s.filter((i=>{var r;return!(!(i.recipientPeer||null!=(r=i.recipientRoles)&&r.length)||i.sender&&![e,t].includes(i.sender))&&[e,t].includes(i.recipientPeer)}))}))),pt=Object(c.a)([ye,Be],((s,e)=>{if(e)return s.filter((t=>{var i,r;return!(null==(i=t.recipientRoles)||!i.length)&&(null==(r=t.recipientRoles)?void 0:r.includes(e))}))})),vt=Object(c.a)(ye,(s=>s.filter((e=>{var t;return!(e.recipientPeer||null!=(t=e.recipientRoles)&&t.length)})))),gt=Object(c.a)([pt,Be],(s=>s?s.filter((e=>!e.read)).length:0)),mt=Object(c.a)([ht,$e],(s=>s?s.filter((e=>!e.read)).length:0)),ft=(Object(c.a)(vt,(s=>s.filter((e=>!e.read)).length)),u(ht),u(pt),u(gt),u(mt),s=>Object(c.a)(Qe(s),(e=>{try{return null!=e&&e.metadata&&""!==e.metadata?JSON.parse(e.metadata):{}}catch(e){return console.error("cannot parse peer metadata",e),{}}}))),yt=s=>Object(c.a)(Qe(s),(e=>!(null==e||!e.isHandRaised))),kt=u(ze),Tt=(Object(c.a)([Y,ee],((s,e)=>Object.values(s).map((i=>{var t;return{peer:i,isAudioEnabled:!!i.audioTrack&&(null==(t=e[i.audioTrack])?void 0:t.enabled)}})))),Object(c.a)([s=>s.roleChangeRequests[0]||null,Y,be],((s,e,t)=>s?{requestedBy:s.requestedBy?e[s.requestedBy]:void 0,role:t[s.roleName],token:s.token}:null)),Object(c.a)([Pe],(s=>z(s))),Object(c.a)([Ae],(s=>z(s))),Object(c.a)([b,ee],((s,e)=>{let t=null;return s&&(t=e[s]),(null==t?void 0:t.plugins)||[]}))),St=Object(c.a)([de,ee],((s,e)=>{let t=null;return s&&(t=e[s]),(null==t?void 0:t.plugins)||[]})),bt=s=>Object(c.a)([Tt],(e=>e.includes(s))),Et=s=>Object(c.a)([St],(e=>e.includes(s))),Pt=(s,e)=>{let t=_t(Object.keys(s),Object.keys(e));for(let i of t){let t=s[i],r=e[i];It(t,r)?Object.assign(t,r):Ct(t,r)?delete s[i]:Rt(t,r)&&(s[i]=r)}},At=(s,e)=>{s.plugins&&wt(s.plugins,e.plugins)&&(e.plugins=s.plugins),"video"===s.type&&s.layerDefinitions&&wt(s.layerDefinitions,e.layerDefinitions)&&(e.layerDefinitions=s.layerDefinitions)},It=(s,e)=>s&&e,Ct=(s,e)=>s&&!e,Rt=(s,e)=>!s&&e,wt=(s,e)=>{if(s===e||0===s.length&&0===(null==e?void 0:e.length))return!0;if(!s||!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0},_t=(s,e)=>{let t=new Set;for(let i of s)t.add(i);for(let i of e)t.add(i);return Array.from(t)},Dt=(s,e,t)=>{var r,a;let i=Ot(t,e);null==(r=s.getWebrtcInternals())||r.start();let n=null==(a=s.getWebrtcInternals())?void 0:a.onStatsChange((r=>Mt(e,r,t,s)));return()=>{i(),n&&n()}},Ot=(s,e)=>{let t,i,r;return s.getState(oe)?e.namedSetState((e=>{e.localPeer.id=s.getState(oe)}),"localpeer-id"):t=s.subscribe((t=>{t&&e.namedSetState((a=>{a.localPeer.id=t}),"localpeer-id")}),oe),s.getState(b)?e.namedSetState((e=>{e.localPeer.videoTrack=s.getState(b)}),"localpeer-videotrack-id"):i=s.subscribe((t=>{t&&e.namedSetState((a=>{a.localPeer.videoTrack=t}),"localpeer-videotrack-id")}),b),s.getState(de)?e.namedSetState((e=>{e.localPeer.audioTrack=s.getState(de)}),"localpeer-audiotrack-id"):r=s.subscribe((t=>{t&&e.namedSetState((a=>{a.localPeer.audioTrack=t}),"localpeer-audiotrack-id")}),de),()=>{null==t||t(),null==i||i(),null==r||r()}},Mt=(s,e,t,i)=>{let r=t.getState(ee);s.namedSetState((n=>{let a=t.getState(oe),o={},l=Object.keys(r).filter((e=>r[e].peerId!==a));for(let t of l){let r=e.getRemoteTrackStats(t);r&&(o[t]=r)}Pt(n.remoteTrackStats,o);let d={[a]:e.getLocalPeerStats()};Pt(n.peerStats,d),((s,e,t)=>{let i=t.reduce(((t,a)=>(t[a.firstTrackId]=Object.values(e[a.getTrackIDBeingSent()]||{}).sort(((e,t)=>e.rid&&t.rid?e.rid<t.rid?-1:1:0)),t)),{}),r=_t(Object.keys(s),Object.keys(i));for(let e of r)i[e]?s[e]=i[e]:delete s[e]})(n.localTrackStats,e.getLocalTrackStats(),i.store.getLocalPeerTracks())}),"webrtc-stats")},Lt=(s,e="resetState")=>{s.namedSetState((e=>{Object.assign(e,{peerStats:{},remoteTrackStats:{},localTrackStats:{},localPeer:{id:""}})}),e)},Nt=s=>h.o?`${s} ${document.title}`:s,Gt={[h.f.PEER_JOINED]:"PEER_JOINED",[h.f.PEER_LEFT]:"PEER_LEFT",[h.f.ROLE_UPDATED]:"ROLE_UPDATED",[h.f.NAME_UPDATED]:"NAME_UPDATED",[h.f.METADATA_UPDATED]:"METADATA_UPDATED",[h.f.HAND_RAISE_CHANGED]:"HAND_RAISE_CHANGED"},xt={[h.m.TRACK_ADDED]:"TRACK_ADDED",[h.m.TRACK_REMOVED]:"TRACK_REMOVED",[h.m.TRACK_MUTED]:"TRACK_MUTED",[h.m.TRACK_UNMUTED]:"TRACK_UNMUTED",[h.m.TRACK_DEGRADED]:"TRACK_DEGRADED",[h.m.TRACK_RESTORED]:"TRACK_RESTORED",[h.m.TRACK_DESCRIPTION_CHANGED]:"TRACK_DESCRIPTION_CHANGED"},Ut={[h.h.POLL_CREATED]:"POLL_CREATED",[h.h.POLL_STARTED]:"POLL_STARTED",[h.h.POLL_STOPPED]:"POLL_STOPPED",[h.h.POLL_STATS_UPDATED]:"POLL_VOTES_UPDATED"},Ft="hmsNotification",$t=class{constructor(e){this.id=0,this.onNotification=(e,t)=>{let i=r=>{if(t){let e;if(e=Array.isArray(t)?t.includes(r.type):t===r.type,!e)return}e(r)};return this.eventEmitter.addListener(Ft,i),()=>{this.eventEmitter.removeListener(Ft,i)}},this.store=e,this.eventEmitter=new T.EventEmitter2({maxListeners:Object.keys(U).length})}sendPlaylistTrackEnded(e){let t=this.createNotification("PLAYLIST_TRACK_ENDED",e,"info");this.emitEvent(t)}sendDeviceChange(e){var i;let t=this.createNotification("DEVICE_CHANGE_UPDATE",e,e.error?"error":"info",`Selected ${e.type} device - ${null==(i=e.selection)?void 0:i.label}`);this.emitEvent(t)}sendLeaveRoom(e){var t;let r=null==(t=e.requestedBy)?void 0:t.name,i=this.createNotification(e.roomEnded||!r?"ROOM_ENDED":"REMOVED_FROM_ROOM",e,"info",`${e.roomEnded?"Room ended":"Removed from room"} ${r?`by ${r}`:""}`);this.emitEvent(i)}sendPeerList(e){if(0===e.length)return;let t=this.createNotification("PEER_LIST",e,"info");this.emitEvent(t)}sendPeerUpdate(e,t){let i=this.store.getState(Qe(null==t?void 0:t.id))||t,r=Gt[e];if(r&&i){let e=this.createNotification(r,i,"info");this.emitEvent(e)}}sendTrackUpdate(e,t){let i=this.store.getState(Ye(t)),r=xt[e];if(r){let e=this.createNotification(r,i,"info");this.emitEvent(e)}}sendMessageReceived(e){let t=this.createNotification("NEW_MESSAGE",e,"info");this.emitEvent(t)}sendError(e){let t=this.createNotification("ERROR",e,"error");this.emitEvent(t)}sendReconnecting(e){let t=this.createNotification("RECONNECTING",e,"error");this.emitEvent(t)}sendReconnected(){let e=this.createNotification("RECONNECTED",null,"info");this.emitEvent(e)}sendChangeTrackStateRequest(e){let t=this.createNotification("CHANGE_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendChangeMultiTrackStateRequest(e){let t=this.createNotification("CHANGE_MULTI_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendPollUpdate(e,t){let i=Ut[e],r=this.store.getState(kt(t));if(i){let e=this.createNotification(i,r,"info");this.emitEvent(e)}}emitEvent(e){this.eventEmitter.emit(Ft,e)}createNotification(e,t,i,r=""){return this.id++,{id:this.id,type:e,message:r,data:t,severity:i}}};var jt=class s{static convertPeer(e){var t,i,r;return{id:e.peerId,name:e.name,roleName:null==(t=e.role)?void 0:t.name,isLocal:e.isLocal,videoTrack:null==(i=e.videoTrack)?void 0:i.trackId,audioTrack:null==(r=e.audioTrack)?void 0:r.trackId,auxiliaryTracks:e.auxiliaryTracks.map((e=>e.trackId)),customerUserId:e.customerUserId,metadata:e.metadata,joinedAt:e.joinedAt,groups:e.groups,isHandRaised:e.isHandRaised}}static convertTrack(e,t){let i={id:e.trackId,source:e.source,type:e.type,enabled:e.enabled,displayEnabled:e.enabled,peerId:e.peerId||t};return this.enrichTrack(i,e),i}static enrichTrack(e,t){let i=t.getMediaTrackSettings();t instanceof h.i&&(e.volume=t.getVolume()||0),s.updateDeviceID(e,t),s.enrichLocalTrack(e,t),"video"===e.type&&("screen"===e.source?(e.displaySurface=i.displaySurface,s.enrichScreenTrack(e,t)):"regular"===e.source&&(e.facingMode=i.facingMode),e.height=i.height,e.width=i.width,s.enrichVideoTrack(e,t)),s.enrichPluginsDetails(e,t)}static enrichLocalTrack(e,t){(t instanceof h.d||t instanceof h.c)&&(e.isPublished=t.isPublished)}static updateDeviceID(e,t){var i;t instanceof h.d||t instanceof h.c?e.deviceID=t.settings.deviceId:e.deviceID=null==(i=t.getMediaTrackSettings())?void 0:i.deviceId}static enrichVideoTrack(e,t){t instanceof h.j&&(e.layer=t.getLayer(),e.preferredLayer=t.getPreferredLayer(),e.degraded=t.degraded),(t instanceof h.j||t instanceof h.d)&&(wt(t.getSimulcastDefinitions(),e.layerDefinitions)||(e.layerDefinitions=t.getSimulcastDefinitions()))}static enrichScreenTrack(e,t){var i,r;if(t instanceof h.d){let n=null==(i=t.getCaptureHandle)?void 0:i.call(t);(null==n?void 0:n.handle)!==(null==(r=e.captureHandle)?void 0:r.handle)&&(e.captureHandle=n),t.isCurrentTab&&(e.displaySurface="selfBrowser")}}static enrichPluginsDetails(e,t){(t instanceof h.d||t instanceof h.c)&&(wt(t.getPlugins(),e.plugins)||(e.plugins=t.getPlugins()))}static convertRoom(e,t){let{recording:i,rtmp:r,hls:n}=s.convertRecordingStreamingState(null==e?void 0:e.recording,null==e?void 0:e.rtmp,null==e?void 0:e.hls);return{id:e.id,name:e.name,localPeer:t,recording:i,rtmp:r,hls:n,sessionId:e.sessionId,startedAt:e.startedAt,joinedAt:e.joinedAt,peerCount:e.peerCount,isLargeRoom:e.large_room_optimization}}static convertMessage(e){var t,i,r,n,a,o,l;return{sender:null==(t=e.sender)?void 0:t.peerId,senderName:null==(i=e.sender)?void 0:i.name,senderRole:null==(n=null==(r=e.sender)?void 0:r.role)?void 0:n.name,senderUserId:null==(a=e.sender)?void 0:a.customerUserId,recipientPeer:null==(o=e.recipientPeer)?void 0:o.peerId,recipientRoles:null==(l=e.recipientRoles)?void 0:l.map((e=>e.name)),time:e.time,type:e.type,message:e.message,id:e.id}}static convertRoles(e){let t={};return e&&e.forEach((i=>{t[i.name]=i})),t}static convertRoleChangeRequest(e){var t;return{requestedBy:null==(t=e.requestedBy)?void 0:t.peerId,roleName:e.role.name,token:e.token}}static convertException(e){return{code:e.code,action:e.action,name:e.name,message:e.message,description:e.description,isTerminal:e.isTerminal,nativeError:e.nativeError,timestamp:new Date}}static convertDeviceChangeUpdate(e){let t={devices:e.devices,selection:e.selection,type:e.type};return e.error&&(t.error=this.convertException(e.error)),t}static convertPlaylist(e){return{audio:this.getConvertedPlaylistType(e,"audio"),video:this.getConvertedPlaylistType(e,"video")}}static convertPlaylistItem(e,t){let i=t.type,r=e.getCurrentSelection(i),n=e.isPlaying(i),a=t.url===(null==r?void 0:r.url);return _(w({},t),{type:t.type,selected:a,playing:a&&n})}static getConvertedPlaylistType(e,t){let i={},r=e.getCurrentSelection(t),n=e.getCurrentProgress(t),a=e.getVolume(t),o=e.getList(t),l=e.getCurrentIndex(t);return e.getList(t).forEach((t=>{i[t.id]=s.convertPlaylistItem(e,t)})),{list:i,selection:{id:null==r?void 0:r.id,hasPrevious:l>0,hasNext:l<o.length-1},progress:n,volume:a,currentTime:e.getCurrentTime(t),playbackRate:e.getPlaybackRate(t)}}static convertRecordingStreamingState(e,t,i){var r;return{recording:{browser:w({running:!1},null==e?void 0:e.browser),server:w({running:!1},null==e?void 0:e.server),hls:w({running:!1},null==e?void 0:e.hls)},rtmp:w({running:!1},t),hls:{variants:(null==(r=null==i?void 0:i.variants)?void 0:r.map((e=>e)))||[],running:!(null==i||!i.running),error:null==i?void 0:i.error}}}},Bt=class{constructor(e){this.sdk=e}get sdkInteractivityCenter(){return this.sdk.getInteractivityCenter()}createPoll(e){return this.sdkInteractivityCenter.createPoll(e)}startPoll(e){return this.sdkInteractivityCenter.startPoll(e)}stopPoll(e){return this.sdkInteractivityCenter.stopPoll(e)}addQuestionsToPoll(e,t){return this.sdkInteractivityCenter.addQuestionsToPoll(e,t)}addResponsesToPoll(e,t){return this.sdkInteractivityCenter.addResponsesToPoll(e,t)}},Vt=class{constructor(e,t,i,r){this.playlistManager=e,this.syncPlaylistState=i,this.store=r,this.type=t}play(e){return D(this,null,(function*(){e?yield this.playlistManager.setEnabled(!0,{id:e,type:this.type}):Fe.w("Please pass id to play")}))}pause(){return D(this,null,(function*(){let e="audio"===this.type?xe:dt,t=this.store.getState(e.selection);t.id?yield this.playlistManager.setEnabled(!1,{id:t.id,type:this.type}):Fe.w("No item is currently playing to pause")}))}playNext(){return D(this,null,(function*(){yield this.playlistManager.playNext(this.type)}))}playPrevious(){return D(this,null,(function*(){yield this.playlistManager.playPrevious(this.type)}))}seek(e){this.playlistManager.seek(e,this.type),this.syncPlaylistState(`seekOn${this.type}Playlist`)}seekTo(e){this.playlistManager.seekTo(e,this.type),this.syncPlaylistState(`seekToOn${this.type}Playlist`)}setVolume(e){this.playlistManager.setVolume(e,this.type),this.syncPlaylistState(`setVolumeOn${this.type}Playlist`)}setList(e){this.playlistManager.setList(e),this.syncPlaylistState(`setListOn${this.type}Playlist`)}stop(){return D(this,null,(function*(){yield this.playlistManager.stop(this.type),this.syncPlaylistState(`stop${this.type}Playlist`)}))}setIsAutoplayOn(e){this.playlistManager.setIsAutoplayOn(this.type,e)}setPlaybackRate(e){this.playlistManager.setPlaybackRate(this.type,e),this.syncPlaylistState(`set${this.type}PlaybackRate`)}removeItem(e){return D(this,null,(function*(){let t=yield this.playlistManager.removeItem(e,this.type);return t&&this.syncPlaylistState(`remove${this.type}PlaylistItem`),t}))}clearList(){return D(this,null,(function*(){yield this.playlistManager.clearList(this.type),this.syncPlaylistState(`clear${this.type}Playlist`)}))}},Wt=class{constructor(e,t){this.sdk=e,this.setLocally=t}get sdkSessionStore(){return this.sdk.getSessionStore()}set(e,t){return D(this,null,(function*(){let{value:i}=yield this.sdkSessionStore.set(String(e),t);this.setLocally({key:e,value:i})}))}observe(e){return D(this,null,(function*(){let t=Array.isArray(e)?e.map((i=>String(i))):[String(e)];yield this.sdkSessionStore.observe(t)}))}unobserve(e){return D(this,null,(function*(){let t=Array.isArray(e)?e.map((i=>String(i))):[String(e)];yield this.sdkSessionStore.unobserve(t)}))}},Ht=class{constructor(e,t){this.intervalMs=100,this.shouldMonitor=!1,this.hasStarted=!1,this.unsubs=[],this.analysers={},this.store=e,this.actions=t}start(){return D(this,null,(function*(){if(this.hasStarted)return;this.hasStarted=!0,Fe.d("starting audio level monitor for remote peers",this.store);let e=this.store.getState(q);Fe.d("starting audio levels is connected to room",e),e&&(yield this.monitorAudioLevels());let t=this.store.subscribe(this.monitorAudioLevels.bind(this),q);this.unsubs.push(t)}))}stop(){return D(this,null,(function*(){this.hasStarted&&(this.hasStarted=!1,this.shouldMonitor=!1,this.unsubs.forEach((e=>e())),Fe.d("stopped audio level monitor for remote peers"))}))}monitorAudioLevels(){return D(this,null,(function*(){if(!this.store.getState(q))return void(this.shouldMonitor&&(Fe.i("room no longer connected, stopping audio level monitoring for remote"),this.shouldMonitor=!1));if(this.shouldMonitor)return;Fe.i("monitoring audio levels"),this.shouldMonitor=!0;let e=()=>{this.shouldMonitor?(this.logAllPeersAudioLevels(),setTimeout(e,this.intervalMs)):Fe.i("stopped monitoring audio levels")};setTimeout(e,1e3)}))}logAllPeersAudioLevels(){return D(this,null,(function*(){var e;if(!window.__triggerBeamEvent__)return;let t=this.store.getState(re).filter((e=>!!e.audioTrack)),i=[];for(let r of t){let a=this.actions.hmsSDKTracks[r.audioTrack],t=null==(e=null==a?void 0:a.stream)?void 0:e.nativeStream;if(r.joinedAt&&t){let e=yield this.getAudioLevel(r,t);e.level>0&&i.push(e)}}if(i.length>0){let e={event:"app-audio-level",data:i};window.__triggerBeamEvent__(JSON.stringify(e))}}))}getAudioLevel(e,t){return D(this,null,(function*(){this.analysers[t.id]||(this.analysers[t.id]=this.createAnalyserNode(t));let i=this.analysers[t.id],r=this.calculateAudioLevel(i);return{peerId:e.id,peerName:e.name,level:r}}))}createAnalyserNode(e){this.audioContext||(this.audioContext=new AudioContext);let t=this.audioContext.createAnalyser();return this.audioContext.createMediaStreamSource(e).connect(t),t}calculateAudioLevel(e){let t=new Uint8Array(e.fftSize);e.getByteTimeDomainData(t);let i=.009,r=i;for(let e of t)r=Math.max(r,(e-128)/128);let n=(Math.log(i)-Math.log(r))/Math.log(i);return Math.ceil(Math.min(Math.max(100*n,0),100))}},qt=class{constructor(e,t,i){this.hmsSDKTracks={},this.isRoomJoinCalled=!1,this.ignoredMessageTypes=[],this.setProgress=({type:e,progress:t})=>{this.setState((i=>{i.playlist[e].progress=t,i.playlist[e].currentTime=this.sdk.getPlaylistManager().getCurrentTime(e)}),"playlistProgress")},this.syncPlaylistState=e=>{this.setState((e=>{Object.assign(e.playlist,jt.convertPlaylist(this.sdk.getPlaylistManager()))}),e)},this.sendPeerUpdateNotification=(e,t)=>{let i=this.store.getState(Qe(t.peerId)),r=Gt[e]||"peerUpdate";if(e===h.f.ROLE_UPDATED)this.syncRoomState(r),this.updateMidCallPreviewRoomState(e,t);else if([h.f.PEER_JOINED,h.f.PEER_LEFT].includes(e))this.syncRoomState(r),i||(i=this.store.getState(Qe(t.peerId)));else if([h.f.HAND_RAISE_CHANGED,h.f.PEER_REMOVED,h.f.PEER_ADDED].includes(e))this.syncRoomState(r),i||(i=this.store.getState(Qe(t.peerId)));else{let e=jt.convertPeer(t);this.setState((a=>{let t=a.peers[e.id];It(t,e)&&(wt(t.auxiliaryTracks,e.auxiliaryTracks)&&(t.auxiliaryTracks=e.auxiliaryTracks),Object.assign(t,e)),i=e}),r)}this.hmsNotifications.sendPeerUpdate(e,i)},this.getSDKHMSPeer=e=>this.sdk.getPeerMap()[e],this.setState=(e,t)=>this.store.namedSetState(e,t),this.store=e,this.sdk=t,this.hmsNotifications=i,this.sessionStore=new Wt(this.sdk,this.setSessionStoreValueLocally.bind(this)),this.interactivityCenter=new Bt(this.sdk)}refreshDevices(){return D(this,null,(function*(){yield this.sdk.refreshDevices()}))}unblockAudio(){return D(this,null,(function*(){yield this.sdk.getAudioOutput().unblockAutoplay()}))}setVolume(e,t){return D(this,null,(function*(){t?yield this.setTrackVolume(e,t):(yield this.sdk.getAudioOutput().setVolume(e),this.syncRoomState("setOutputVolume"))}))}setAudioOutputDevice(e){return D(this,null,(function*(){(yield this.sdk.getAudioOutput().setDevice(e))&&this.setState((i=>{i.settings.audioOutputDeviceId=e}),"setAudioOutputDevice")}))}setPreferredLayer(e,t){return D(this,null,(function*(){var r;let i=this.hmsSDKTracks[e];if(i)if(i instanceof h.j){if(t===h.l.NONE)return void Fe.d(`layer ${h.l.NONE} will be ignored`);if((null==(r=this.store.getState(Xe(e)))?void 0:r.preferredLayer)===t)return void Fe.d(`preferred layer is already ${t}`);this.setState((a=>{let r=a.tracks[e];r&&(r.preferredLayer=t)}),"setPreferredLayer"),yield i.setPreferredLayer(t)}else Fe.d(`track ${e} is not a remote video track`);else this.logPossibleInconsistency(`track ${e} not present, unable to set preffer layer`)}))}getAuthTokenByRoomCode(e,t){return this.sdk.getAuthTokenByRoomCode(e,t)}preview(e){return D(this,null,(function*(){let t=this.store.getState(ke);if("Preview"!==t&&"Connecting"!==t)try{"Connected"!==t&&this.setState((i=>{i.room.roomState="Connecting"}),"connecting"),yield this.sdkPreviewWithListeners(e)}catch(e){throw Fe.e("Cannot show preview. Failed to connect to room - ",e),e}else this.logPossibleInconsistency("attempting to call preview while room is in preview/connecting")}))}cancelMidCallPreview(){return D(this,null,(function*(){return this.sdk.cancelMidCallPreview()}))}join(e){return D(this,null,(function*(){if(this.isRoomJoinCalled)this.logPossibleInconsistency("room join is called again");else try{this.isRoomJoinCalled=!0,this.setState((e=>{e.room.roomState="Connecting"}),"join"),yield this.sdkJoinWithListeners(e)}catch(e){throw this.isRoomJoinCalled=!1,Fe.e("Failed to connect to room - ",e),e}}))}leave(){return D(this,null,(function*(){let e=!0;this.store.getState(q)||(e=!1,this.logPossibleInconsistency("room leave is called when no room is connected"));let i=this.store.getState(ke);return this.setState((e=>{e.room.roomState="Disconnecting"}),"leaving"),this.sdk.leave(e).then((()=>{this.resetState("leave"),this.beamSpeakerLabelsLogger&&this.beamSpeakerLabelsLogger.stop().catch(Fe.e),Fe.i("left room")})).catch((e=>{Fe.e("error in leaving room - ",e),this.setState((e=>{e.room.roomState=i}),"revertLeave")}))}))}setScreenShareEnabled(e,t){return D(this,null,(function*(){"boolean"==typeof t&&(t={audioOnly:t});try{e?yield this.startScreenShare(t):yield this.stopScreenShare()}catch(e){throw this.hmsNotifications.sendError(jt.convertException(e)),e}}))}addTrack(e,t="regular"){return D(this,null,(function*(){yield this.sdk.addTrack(e,t),this.syncRoomState("addTrack")}))}removeTrack(e){return D(this,null,(function*(){yield this.sdk.removeTrack(e),this.syncRoomState("removeTrack")}))}setLocalAudioEnabled(e){return D(this,null,(function*(){let t=this.store.getState(de);t&&(yield this.setEnabledTrack(t,e))}))}setLocalVideoEnabled(e){return D(this,null,(function*(){let t=this.store.getState(b);t&&(yield this.setEnabledTrack(t,e))}))}setEnabledTrack(e,t){return D(this,null,(function*(){var r;if((null==(r=this.store.getState().tracks[e])?void 0:r.enabled)===t)return void this.logPossibleInconsistency(`local track[${e}] enabled state - ${t}`);this.setState((a=>{a.tracks[e]?a.tracks[e].displayEnabled=t:this.logPossibleInconsistency("track id not found for setEnabled")}),"displayEnabled");try{yield this.setEnabledSDKTrack(e,t),this.syncRoomState("setEnabled")}catch(r){throw this.setState((r=>{r.tracks[e].displayEnabled=!t}),"rollbackDisplayEnabled"),this.hmsNotifications.sendError(jt.convertException(r)),r}let n=t?h.m.TRACK_UNMUTED:h.m.TRACK_MUTED;this.hmsNotifications.sendTrackUpdate(n,e)}))}setAudioSettings(e){return D(this,null,(function*(){let t=this.store.getState(de);t&&(yield this.setSDKLocalAudioTrackSettings(t,e),this.syncRoomState("setAudioSettings"))}))}setVideoSettings(e){return D(this,null,(function*(){let t=this.store.getState(b);t&&(yield this.setSDKLocalVideoTrackSettings(t,e),this.syncRoomState("setVideoSettings"))}))}switchCamera(){return D(this,null,(function*(){let e=this.store.getState(b);if(e){let t=this.hmsSDKTracks[e];t&&(yield t.switchCamera(),this.syncRoomState("switchCamera"))}}))}sendMessage(e){this.sendBroadcastMessage(e)}sendBroadcastMessage(e,t){return D(this,null,(function*(){let i=yield this.sdk.sendBroadcastMessage(e,t);this.updateMessageInStore(i,{message:e,type:t})}))}sendGroupMessage(e,t,i){return D(this,null,(function*(){let r=this.store.getState(be),n=t.map((e=>r[e])),a=yield this.sdk.sendGroupMessage(e,n,i);this.updateMessageInStore(a,{message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return D(this,null,(function*(){let r=this.getSDKHMSPeer(t);if(!r)throw Fe.w("sendMessage","Failed to send message"),Error(`sendMessage Failed - peer ${t} not found`);let n=yield this.sdk.sendDirectMessage(e,r,i);this.updateMessageInStore(n,{message:e,recipientPeer:r.peerId,type:i})}))}updateMessageInStore(e,t){if(!e)throw Fe.w("sendMessage","Failed to send message",t),Error(`sendMessage Failed - ${JSON.stringify(t)}`);let i=jt.convertMessage(e);return i.read=!0,i.senderName="You",i.ignored=this.ignoredMessageTypes.includes(i.type),this.putMessageInStore(i),i}setMessageRead(e,t){this.setState((i=>{t?i.messages.byID[t]?i.messages.byID[t].read=e:this.logPossibleInconsistency("no message with id is found"):i.messages.allIDs.forEach((t=>{i.messages.byID[t].read=e}))}),"setMessageRead")}attachVideo(e,t){return D(this,null,(function*(){if(this.localAndVideoUnmuting(e))return new Promise((i=>{let r=this.store.subscribe((n=>D(this,null,(function*(){n&&(yield this.attachVideoInternal(e,t),r(),i())}))),pe)}));yield this.attachVideoInternal(e,t)}))}detachVideo(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[e];"video"===(null==i?void 0:i.type)?yield this.sdk.detachVideo(i,t):(t&&(t.srcObject=null),Fe.d("possible inconsistency detected - no video track found to remove sink"))}))}addPluginToVideoTrack(e,t){return D(this,null,(function*(){return this.addRemoveVideoPlugin(e,"add",t)}))}addPluginToAudioTrack(e){return D(this,null,(function*(){return this.addRemoveAudioPlugin(e,"add")}))}validateVideoPluginSupport(e){let t={isSupported:!1};if(!e)return Fe.w("no plugin passed in for checking support"),t.errMsg="no plugin passed in for checking support",t;let i=this.store.getState(b);if(!i)return Fe.w("video Track not added to local peer yet"),t.errMsg="call this function only after local peer has video track",t;let r=this.hmsSDKTracks[i];return r?t=r.validatePlugin(e):(Fe.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}validateAudioPluginSupport(e){let t={isSupported:!1};if(!e)return Fe.w('no plugin passed in for checking support"'),t.errMsg='no plugin passed in for checking support"',t;let i=this.store.getState(de);if(!i)return Fe.w("audio track not added to local peer yet"),t.errMsg="call this function only after local peer has audio track",t;let r=this.hmsSDKTracks[i];return r?t=r.validatePlugin(e):(Fe.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}removePluginFromVideoTrack(e){return D(this,null,(function*(){return this.addRemoveVideoPlugin(e,"remove")}))}removePluginFromAudioTrack(e){return D(this,null,(function*(){return this.addRemoveAudioPlugin(e,"remove")}))}changeRole(e,t,i=!1){return D(this,null,(function*(){yield this.sdk.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeer(e,t,i=!1){return D(this,null,(function*(){yield this.sdk.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeersWithRoles(e,t){return D(this,null,(function*(){let i=this.sdk.getRoles().filter((t=>e.includes(t.name)));yield this.sdk.changeRoleOfPeersWithRoles(i,t)}))}acceptChangeRole(e){return D(this,null,(function*(){let t=e.requestedBy?this.getSDKHMSPeer(e.requestedBy.id):void 0;t||Fe.w(`peer for which role change is requested no longer available - ${e.requestedBy}`);let i={requestedBy:t,role:e.role,token:e.token};yield this.sdk.acceptChangeRole(i),this.removeRoleChangeRequest(e)}))}raiseLocalPeerHand(){return D(this,null,(function*(){yield this.sdk.raiseLocalPeerHand()}))}lowerLocalPeerHand(){return D(this,null,(function*(){yield this.sdk.lowerLocalPeerHand()}))}raiseRemotePeerHand(e){return D(this,null,(function*(){yield this.sdk.raiseRemotePeerHand(e)}))}lowerRemotePeerHand(e){return D(this,null,(function*(){yield this.sdk.lowerRemotePeerHand(e)}))}getPeerListIterator(e){let t=this.sdk.getPeerListIterator(e);return{hasNext:()=>t.hasNext(),next:()=>D(this,null,(function*(){return(yield t.next()).map((e=>jt.convertPeer(e)))})),findPeers:()=>D(this,null,(function*(){return(yield t.findPeers()).map((e=>jt.convertPeer(e)))})),getTotal:()=>t.getTotal()}}initAppData(e){this.setState((t=>{t.appData=e}),"initAppData")}setAppData(e,t,i){let r="Object"===(null==t?void 0:t.constructor.name);this.setState((n=>{if(n.appData)i&&r?Object.assign(n.appData[e],t):n.appData[e]=t;else{let a={[e]:t};n.appData=a}}),`setAppData-${e}`)}rejectChangeRole(e){this.removeRoleChangeRequest(e)}endRoom(e,t){return D(this,null,(function*(){let i=this.store.getState(Ie);if(null==i||!i.endRoom)return void Fe.w("You are not allowed to perform this action - endRoom");let r=this.store.getState(ke);this.setState((e=>{e.room.roomState="Disconnecting"}),"endingRoom");try{yield this.sdk.endRoom(e,t),this.resetState("endRoom")}catch(e){Fe.e("error in ending room - ",e),this.setState((a=>{a.room.roomState=r}),"revertEndRoom")}}))}removePeer(e,t){return D(this,null,(function*(){var r;let i=null==(r=this.sdk.getLocalPeer())?void 0:r.peerId;e!==i&&(yield this.sdk.removePeer(e,t))}))}startRTMPOrRecording(e){return D(this,null,(function*(){yield this.sdk.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return D(this,null,(function*(){yield this.sdk.stopRTMPAndRecording()}))}startHLSStreaming(e){return D(this,null,(function*(){yield this.sdk.startHLSStreaming(e)}))}stopHLSStreaming(e){return D(this,null,(function*(){yield this.sdk.stopHLSStreaming(e)}))}sendHLSTimedMetadata(e){return D(this,null,(function*(){yield this.sdk.sendHLSTimedMetadata(e)}))}changeName(e){return D(this,null,(function*(){yield this.sdk.changeName(e)}))}changeMetadata(e){return D(this,null,(function*(){"string"!=typeof e&&(e=JSON.stringify(e)),yield this.sdk.changeMetadata(e)}))}setSessionMetadata(e){return D(this,null,(function*(){yield this.sdk.setSessionMetadata(e),this.setState((t=>{t.sessionMetadata=e}),"setSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"setSessionMetadata")}))}populateSessionMetadata(){return D(this,null,(function*(){let e=yield this.sdk.getSessionMetadata();this.setState((t=>{t.sessionMetadata=e}),"populateSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"populateSessionmetadata")}))}setRemoteTrackEnabled(e,t){return D(this,null,(function*(){if("string"==typeof e){let i=this.hmsSDKTracks[e];i&&function(s){return s instanceof h.i||s instanceof h.j}(i)?yield this.sdk.changeTrackState(i,t):this.logPossibleInconsistency(`No remote track with ID ${e} found for change track state`)}else Array.isArray(e)&&e.forEach((i=>this.setRemoteTrackEnabled(i,t)))}))}setRemoteTracksEnabled(e){return D(this,null,(function*(){let t={enabled:e.enabled,type:e.type,source:e.source};if(e.roles){let i=this.store.getState(be);t.roles=e.roles.map((e=>i[e]))}yield this.sdk.changeMultiTrackState(t)}))}setLogLevel(e){Fe.level=e,this.sdk.setLogLevel(e)}setFrameworkInfo(e){this.sdk.setFrameworkInfo(e)}ignoreMessageTypes(e,t=!1){if(t)this.ignoredMessageTypes=e;else for(let i of e)this.ignoredMessageTypes.includes(i)||this.ignoredMessageTypes.push(i)}enableBeamSpeakerLabelsLogging(){return D(this,null,(function*(){this.beamSpeakerLabelsLogger||(Fe.i("enabling beam speaker labels logging"),this.beamSpeakerLabelsLogger=new Ht(this.store,this),yield this.beamSpeakerLabelsLogger.start())}))}resetState(e="resetState"){this.isRoomJoinCalled=!1,this.hmsSDKTracks={},Fe.cleanup(),this.setState((e=>{Object.assign(e,{room:{id:"",isConnected:!1,name:"",peers:[],localPeer:"",roomState:"Disconnected",recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[],sessionStore:{},templateAppData:{},polls:{},hideLocalPeer:!1})}),e)}sdkJoinWithListeners(e){return D(this,null,(function*(){yield this.sdk.join(e,{onJoin:this.onJoin.bind(this),onPreview:this.onPreview.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onSessionStoreUpdate:this.onSessionStoreUpdate.bind(this),onPollsUpdate:this.onPollsUpdate.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)})}))}onRemovedFromRoom(e){var t;let r=this.store.getState(Qe(null==(t=e.requestedBy)?void 0:t.peerId));this.hmsNotifications.sendLeaveRoom(_(w({},e),{requestedBy:r||void 0}));let i=e.roomEnded||!r?"roomEnded":"removedFromRoom";Fe.i(`resetting state after peer removed ${i}`,e),this.resetState(i)}onDeviceChange(e){let t=e.devices;if(!t)return;let i=this.store.getState(ae);if(this.setState((e=>{wt(e.devices.audioInput,t.audioInput)||(e.devices.audioInput=t.audioInput),wt(e.devices.videoInput,t.videoInput)||(e.devices.videoInput=t.videoInput),wt(e.devices.audioOutput,t.audioOutput)||(e.devices.audioOutput=t.audioOutput);let r=this.sdk.getLocalPeer();null!=i&&i.id&&r&&Object.assign(e.settings,this.getMediaSettings(r))}),"deviceChange"),e.selection){let t=jt.convertDeviceChangeUpdate(e);this.hmsNotifications.sendDeviceChange(t)}}sdkPreviewWithListeners(e){return D(this,null,(function*(){yield this.sdk.preview(e,{onPreview:this.onPreview.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)})}))}onNetworkQuality(e){this.setState((t=>{var r;let i=t.room.localPeer||(null==(r=this.sdk.getLocalPeer())?void 0:r.peerId);i&&(t.connectionQualities[i]={peerID:i,downlinkQuality:e})}),"ConnectionQuality")}onSessionStoreUpdate(e){this.setSessionStoreValueLocally(e,"sessionStoreUpdate")}onPollsUpdate(e,t){let i=Ut[e];this.setState((e=>{let r=t.reduce(((a,e)=>{var t;return a[e.id]=_(w({},e),{questions:null==(t=e.questions)?void 0:t.map((e=>{var t,r;return _(w({},e),{answer:e.answer?w({},e.answer):void 0,options:null==(t=e.options)?void 0:t.map((e=>w({},e))),responses:null==(r=e.responses)?void 0:r.map((e=>w({},e)))})}))}),a}),{});((s,e)=>{let t=_t(Object.keys(s),Object.keys(e));for(let i of t){let t=s[i],r=e[i];It(t,r)?(t.questions&&wt(t.questions,r.questions)&&(r.questions=t.questions),Object.assign(t,r)):Rt(t,r)&&(s[i]=r)}})(e.polls,r)}),i),t.forEach((t=>this.hmsNotifications.sendPollUpdate(e,t.id)))}startScreenShare(e){return D(this,null,(function*(){this.store.getState(ge)?this.logPossibleInconsistency("start screenshare is called while it's on"):(yield this.sdk.startScreenShare((()=>this.syncRoomState("screenshareStopped")),e),this.syncRoomState("startScreenShare"))}))}stopScreenShare(){return D(this,null,(function*(){this.store.getState(ge)?(yield this.sdk.stopScreenShare(),this.syncRoomState("stopScreenShare")):this.logPossibleInconsistency("stop screenshare is called while it's not on")}))}attachVideoInternal(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[e];i&&"video"===i.type?yield this.sdk.attachVideo(i,t):this.logPossibleInconsistency("no video track found to add sink")}))}syncRoomState(e){e=`${e}_fullSync`,Fe.time(`store-sync-${e}`);let t,r={},i=[],n={},o={},a={},l={},d=this.sdk.getPeers();for(let e of d){let d=jt.convertPeer(e);r[d.id]=d,i.push(d.id),l[d.id]={peerID:d.id,downlinkQuality:e.networkQuality||-1};let c=[e.audioTrack,e.videoTrack,...e.auxiliaryTracks];for(let e of c){if(!e)continue;let t=jt.convertTrack(e);n[t.id]=t,o[e.trackId]=e}if(e.isLocal){let r=e;t=this.getPreviewFields(r),Object.assign(a,this.getMediaSettings(r))}}let c=this.sdk.getRecordingState(),h=this.sdk.getRTMPState(),v=this.sdk.getHLSState();this.setState((e=>{var d;e.room.peers=i;let m=e.peers,f=e.tracks;((s,e)=>{let t=_t(Object.keys(s),Object.keys(e));for(let i of t){let t=s[i],r=e[i];It(t,r)?(wt(t.auxiliaryTracks,r.auxiliaryTracks)&&(r.auxiliaryTracks=t.auxiliaryTracks),t.groups&&wt(t.groups,r.groups)&&(r.groups=t.groups),Object.assign(t,r)):Ct(t,r)?delete s[i]:Rt(t,r)&&(s[i]=r)}})(m,r),((s,e)=>{let t=_t(Object.keys(s),Object.keys(e));for(let i of t){let t=s[i],r=e[i];It(t,r)?(At(t,r),Object.assign(t,r)):Ct(t,r)?delete s[i]:Rt(t,r)&&(s[i]=r)}})(f,n),Object.assign(e.settings,a),Object.assign(e.connectionQualities,l),this.hmsSDKTracks=o,null!=(d=e.preview)&&d.localPeer&&null!=t&&t.localPeer?Object.assign(e.preview,t):e.preview=t,Object.assign(e.roles,jt.convertRoles(this.sdk.getRoles())),Object.assign(e.playlist,jt.convertPlaylist(this.sdk.getPlaylistManager())),Object.assign(e.room,jt.convertRecordingStreamingState(c,h,v)),Object.assign(e.templateAppData,this.sdk.getTemplateAppData())}),e),Fe.timeEnd(`store-sync-${e}`)}onPreview(e){this.setState((t=>{var i;Object.assign(t.room,jt.convertRoom(e,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)),t.room.roomState="Preview"}),"previewStart"),this.syncRoomState("previewSync")}onJoin(e){let t=this.sdk.getPlaylistManager();this.audioPlaylist=new Vt(t,"audio",this.syncPlaylistState.bind(this),this.store),this.videoPlaylist=new Vt(t,"video",this.syncRoomState.bind(this),this.store),this.syncRoomState("joinSync"),this.setState((i=>{var t;Object.assign(i.room,jt.convertRoom(e,null==(t=this.sdk.getLocalPeer())?void 0:t.peerId)),i.room.isConnected=!0,i.room.roomState="Connected"}),"joined"),t.onProgress(this.setProgress),t.onNewTrackStart((i=>{this.syncPlaylistState(`${i.type}PlaylistUpdate`)})),t.onPlaylistEnded((i=>{this.syncPlaylistState(`${i}PlaylistEnded`)})),t.onCurrentTrackEnded((i=>{this.hmsNotifications.sendPlaylistTrackEnded(jt.convertPlaylistItem(t,i)),this.syncPlaylistState(`${i.type}PlaylistItemEnded`)}))}onRoomUpdate(e,t){this.setState((i=>{var e;Object.assign(i.room,jt.convertRoom(t,null==(e=this.sdk.getLocalPeer())?void 0:e.peerId))}),e)}onPeerUpdate(e,t){if(![h.f.BECAME_DOMINANT_SPEAKER,h.f.RESIGNED_DOMINANT_SPEAKER].includes(e)){if(Array.isArray(t)){let i=this.store.getState(Y),e=t.filter((a=>!i[a.peerId]));if(this.syncRoomState("peersJoined"),this.store.getState(q)){let a=[];for(let e of t){let t=this.store.getState(Qe(e.peerId));t&&a.push(t)}this.hmsNotifications.sendPeerList(a)}else e.forEach((a=>{let e=this.store.getState(Qe(a.peerId));e&&this.hmsNotifications.sendPeerUpdate(h.f.PEER_JOINED,e)}));return}this.sendPeerUpdateNotification(e,t)}}onTrackUpdate(e,t,i){if(e===h.m.TRACK_REMOVED)this.hmsNotifications.sendTrackUpdate(e,t.trackId),this.handleTrackRemove(t,i);else if([h.m.TRACK_ADDED,h.m.TRACK_REMOVED].includes(e)){let r=xt[e];this.syncRoomState(r),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}else{let r=xt[e]||"trackUpdate",n=jt.convertTrack(t);this.setState((a=>{let e=a.tracks[n.id];It(e,n)&&(At(e,n),Object.assign(e,n))}),r),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}}onMessageReceived(e){let t=jt.convertMessage(e);t.read=!1,t.ignored=this.ignoredMessageTypes.includes(t.type),this.putMessageInStore(t),this.hmsNotifications.sendMessageReceived(t)}putMessageInStore(e){e.ignored||this.setState((t=>{t.messages.byID[e.id]=e,t.messages.allIDs.push(e.id)}),"newMessage")}onAudioLevelUpdate(e){this.setState((t=>{let i={};e.forEach((e=>{if(!e.track||!e.peer)return;let a=e.track.trackId;i[a]=e.audioLevel,t.speakers[a]||(t.speakers[a]={audioLevel:e.audioLevel,peerID:e.peer.peerId,trackID:a})}));let r=Object.entries(t.speakers);for(let[e,a]of r)a.audioLevel=i[e]||0,0===a.audioLevel&&delete t.speakers[e]}),"audioLevel")}onConnectionQualityUpdate(e){this.setState((t=>{e.forEach((i=>{let e=i.peerID;e&&(t.connectionQualities[e]?Object.assign(t.connectionQualities[e],i):t.connectionQualities[e]=i)}))}),"connectionQuality")}onChangeTrackStateRequest(e){var t;let r=this.store.getState(Qe(null==(t=e.requestedBy)?void 0:t.peerId)),i=this.getStoreLocalTrackIDfromSDKTrack(e.track),n=this.store.getState(Ye(i));if(!n)return this.logPossibleInconsistency(`Not found track for which track state change was requested, ${e.track}`);e.enabled||this.syncRoomState("changeTrackStateRequest"),this.hmsNotifications.sendChangeTrackStateRequest({requestedBy:r||void 0,track:n,enabled:e.enabled})}onChangeMultiTrackStateRequest(e){var t;let r=this.store.getState(Qe(null==(t=e.requestedBy)?void 0:t.peerId));e.enabled||this.syncRoomState("changeMultiTrackStateRequest");let i=[],n=this.store.getState(ee);for(let a of e.tracks){let e=this.getStoreLocalTrackIDfromSDKTrack(a);e&&n[e]&&i.push(n[e])}this.hmsNotifications.sendChangeMultiTrackStateRequest({requestedBy:r||void 0,tracks:i,enabled:e.enabled,type:e.type,source:e.source})}onReconnected(){this.syncRoomState("reconnectedSync"),this.hmsNotifications.sendReconnected(),this.setState((e=>{e.room.roomState=e.room.isConnected?"Connected":"Preview"}),"reconnected")}onReconnecting(e){let t=jt.convertException(e);Fe.e("Reconnection: received error from sdk",t),this.hmsNotifications.sendReconnecting(t),this.setState((i=>{i.room.roomState="Reconnecting",i.errors.push(t)}),"reconnecting")}onError(e){let t=jt.convertException(e);t.isTerminal?(this.leave().then((()=>Fe.e("error from SDK, left room."))),this.setState((i=>{i.room.roomState="Failed",i.errors.push(t)}),"errorTerminal")):this.store.getState().errors.length<50&&this.setState((e=>{e.errors.push(t)}),"error"),this.syncRoomState("errorSync"),this.hmsNotifications.sendError(t),Fe.e("received error from sdk",t instanceof h.b?`${t}`:t)}handleTrackRemove(e,t){this.setState((i=>{let r=i.peers[t.peerId],n=i.tracks,a=e.trackId;if(this.isSameStoreSDKTrack(a,null==r?void 0:r.audioTrack))null==r||delete r.audioTrack;else if(this.isSameStoreSDKTrack(a,null==r?void 0:r.videoTrack))null==r||delete r.videoTrack;else{let e=null==r?void 0:r.auxiliaryTracks.indexOf(a);e>-1&&this.isSameStoreSDKTrack(a,null==r?void 0:r.auxiliaryTracks[e])&&(null==r||r.auxiliaryTracks.splice(e,1))}delete n[a],delete this.hmsSDKTracks[a]}),"trackRemoved")}setEnabledSDKTrack(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setEnabled(t):this.logPossibleInconsistency(`track ${e} not present, unable to enabled/disable`)}))}setSDKLocalVideoTrackSettings(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}setSDKLocalAudioTrackSettings(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}getMediaSettings(e){var t;let r=this.store.getState(te),i=e.audioTrack,n=e.videoTrack;return{audioInputDeviceId:(null==i?void 0:i.settings.deviceId)||r.audioInputDeviceId,videoInputDeviceId:(null==n?void 0:n.settings.deviceId)||r.videoInputDeviceId,audioOutputDeviceId:null==(t=this.sdk.getAudioOutput().getDevice())?void 0:t.deviceId}}getPreviewFields(e){var i,t;if(!e.isInPreview())return;let r=jt.convertPeer(e);return{localPeer:r.id,audioTrack:r.audioTrack,videoTrack:r.videoTrack,asRole:(null==(i=e.asRole)?void 0:i.name)||(null==(t=e.role)?void 0:t.name)}}setTrackVolume(e,t){return D(this,null,(function*(){let i=this.hmsSDKTracks[t];i?i instanceof h.a?(yield i.setVolume(e),this.setState((r=>{let n=r.tracks[t];n&&"audio"===n.type&&(n.volume=e)}),"trackVolume")):Fe.w(`track ${t} is not an audio track`):this.logPossibleInconsistency(`track ${t} not present, unable to set volume`)}))}localAndVideoUnmuting(e){let t=this.store.getState(ae);if((null==t?void 0:t.videoTrack)!==e)return!1;let i=this.store.getState(ve),r=this.store.getState(pe);return i&&!r}logPossibleInconsistency(e){Fe.w("possible inconsistency detected - ",e)}addRemoveVideoPlugin(e,t,i){return D(this,null,(function*(){if(!e)return void Fe.w("Invalid plugin received in store");let r=this.store.getState(b);if(r){let n=this.hmsSDKTracks[r];n?("add"===t?yield n.addPlugin(e,i):"remove"===t&&(yield n.removePlugin(e)),this.syncRoomState(`${t}VideoPlugin`)):this.logPossibleInconsistency(`track ${r} not present, unable to remove plugin`)}}))}addRemoveAudioPlugin(e,t){return D(this,null,(function*(){if(!e)return void Fe.w("Invalid plugin received in store");let i=this.store.getState(de);if(i){let r=this.hmsSDKTracks[i];r?("add"===t?yield r.addPlugin(e):"remove"===t&&(yield r.removePlugin(e)),this.syncRoomState(`${t}AudioPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to remove plugin`)}}))}isSameStoreSDKTrack(e,t){var i;return!!t&&(null==(i=this.hmsSDKTracks[t])?void 0:i.trackId)===e}onRoleChangeRequest(e){this.setState((t=>{0===t.roleChangeRequests.length&&t.roleChangeRequests.push(jt.convertRoleChangeRequest(e))}),"roleChangeRequest")}removeRoleChangeRequest(e){this.setState((t=>{let i=t.roleChangeRequests.findIndex((t=>t.token===e.token));-1!==i&&t.roleChangeRequests.splice(i,1)}),"removeRoleChangeRequest")}onRoleUpdate(){this.syncRoomState("roleUpdate")}getStoreLocalTrackIDfromSDKTrack(e){return this.store.getState(ue).find((i=>this.hmsSDKTracks[i].trackId===e.trackId))}updateMidCallPreviewRoomState(e,t){t.isLocal&&e===h.f.ROLE_UPDATED&&this.store.getState(Te)&&this.setState((i=>{i.room.roomState="Connected"}),"midCallPreviewCompleted")}setSessionStoreValueLocally(e,t="setSessionStore"){let i=Array.isArray(e)?e:[e];this.setState((e=>{i.forEach((t=>{e.sessionStore[t.key]=t.value}))}),t)}},Kt=class s{constructor(e,t,i){this.getStats=()=>(this.stats||(this.stats=new Jt(this.store,this.sdk)),this.stats),this.store=e||s.createNewHMSStore(Nt("HMSStore"),L),this.notifications=i||new $t(this.store),t?this.actions=t:(this.sdk=new h.k,this.actions=new qt(this.store,this.sdk,this.notifications)),this.actions.setFrameworkInfo({type:"js",sdkVersion:O().version}),this.initialTriggerOnSubscribe=!1,h.o&&(window.__hms=this)}triggerOnSubscribe(){this.initialTriggerOnSubscribe||(s.makeStoreTriggerOnSubscribe(this.store),this.initialTriggerOnSubscribe=!0)}getStore(){return this.store}getHMSActions(){return this.actions}getActions(){return this.actions}getNotifications(){return{onNotification:this.notifications.onNotification}}static createNewHMSStore(e,t){let i=k()((()=>t())),r=i.setState;i.setState=e=>{let t="function"==typeof e?Object(v.a)(e):e;r(t)};let n=i.getState;i.getState=e=>e?e(n()):n(),s.compareWithShallowCheckInSubscribe(i);let a=s.setUpDevtools(i,e);return _(w({},i),{namedSetState:a})}static makeStoreTriggerOnSubscribe(e){let t=e.subscribe;e.subscribe=(i,r,n)=>(i(e.getState(r),void 0),t(i,r,n))}static compareWithShallowCheckInSubscribe(e){let t=e.subscribe;e.subscribe=(i,e,r)=>(e||(e=a=>a),r=r||f.a,t(i,e,r))}static setUpDevtools(e,t){let i;try{i=window.__REDUX_DEVTOOLS_EXTENSION__||window.top.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!i)return a=>{e.setState(a)};let r=i.connect(s.devtoolsOptions(t));r.prefix=t?`${t} > `:"";let n=e.setState;return e.setState=a=>{n(a),r.send(`${r.prefix}setState`,e.getState())},r.subscribe(s.devtoolsSubscribe(r,e,n)),r.send("setUpStore",e.getState()),(a,t)=>{n(a);let o=t||`${r.prefix}action`;r.send(o,e.getState())}}static devtoolsOptions(e){return{name:e,actionsBlacklist:["audioLevel","playlistProgress","connectionQuality"]}}static devtoolsSubscribe(e,t,i){return r=>{var n,a,o,l;if("DISPATCH"===r.type&&r.state)["JUMP_TO_ACTION","JUMP_TO_STATE"].includes(r.payload.type)?i(JSON.parse(r.state)):t.setState(JSON.parse(r.state));else if("DISPATCH"===r.type&&"COMMIT"===(null==(n=r.payload)?void 0:n.type))e.init(t.getState());else if("DISPATCH"===r.type&&"IMPORT_STATE"===(null==(a=r.payload)?void 0:a.type)){let n=null==(o=r.payload.nextLiftedState)?void 0:o.actionsById;((null==(l=r.payload.nextLiftedState)?void 0:l.computedStates)||[]).forEach((({state:r},o)=>{let l=n[o]||`${e.prefix}setState`;0===o?e.init(r):(i(r),e.send(l,t.getState()))}))}}}},Jt=class{constructor(e,t){this.hmsStore=e,this.sdk=t,this.store=Kt.createNewHMSStore(Nt("HMSStatsStore"),N),this.getState=this.store.getState,this.subscribe=this.store.subscribe,this.getPublishPeerConnection=()=>new Promise((i=>{var e,t;"Connected"===this.hmsStore.getState(ke)?i(null==(t=null==(e=this.sdk)?void 0:e.getWebrtcInternals())?void 0:t.getPublishPeerConnection()):this.hmsStore.subscribe((a=>{var e,t;"Connected"===a&&i(null==(t=null==(e=this.sdk)?void 0:e.getWebrtcInternals())?void 0:t.getPublishPeerConnection())}),ke)})),this.getSubscribePeerConnection=()=>new Promise((i=>{var e,t;"Connected"===this.hmsStore.getState(ke)?i(null==(t=null==(e=this.sdk)?void 0:e.getWebrtcInternals())?void 0:t.getSubscribePeerConnection()):this.hmsStore.subscribe((a=>{var e,t;"Connected"===a&&i(null==(t=null==(e=this.sdk)?void 0:e.getWebrtcInternals())?void 0:t.getSubscribePeerConnection())}),ke)})),this.sdk&&((s,e,t)=>{let i;"Connected"===t.getState(ke)&&(i=Dt(s,e,t)),t.subscribe((r=>{["Connected","Reconnecting"].includes(r)?i||(i=Dt(s,e,t)):["Disconnected","Failed"].includes(r)&&i&&(Lt(e,r),i(),i=void 0)}),ke)})(this.sdk,this.store,this.hmsStore)}},zt=(s,e)=>e,Qt=s=>s.peerStats,Yt=s=>s.localTrackStats,Xt=Object(c.a)([Qt,s=>s.localPeer.id],((s,e)=>s[e])),Zt=(Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.subscribe)?void 0:e.packetsLost})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.subscribe)?void 0:e.jitter})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.publish)?void 0:e.bitrate})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.subscribe)?void 0:e.bitrate})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.publish)?void 0:e.availableOutgoingBitrate})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.subscribe)?void 0:e.availableIncomingBitrate})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.publish)?void 0:e.bytesSent})),Object(c.a)(Xt,(s=>{var e;return null==(e=null==s?void 0:s.subscribe)?void 0:e.bytesReceived})),Object(c.a)([Qt,(s,e)=>e],((s,e)=>e?s[e]:void 0))),ei=Object(c.a)([s=>s.remoteTrackStats,zt],((s,e)=>e?s[e]:void 0)),ti=Object(c.a)([Yt,zt],((s,e)=>e?s[e]:void 0));u(Zt),u(ei),Object(c.a)([Yt,s=>s.localPeer.audioTrack],((s,e)=>{var t;return e?null==(t=s[e])?void 0:t[0]:void 0})),u(Object(c.a)(ti,(s=>null==s?void 0:s[0]))),Object(c.a)([Yt,s=>s.localPeer.videoTrack],((s,e)=>{var t;return e?null==(t=s[e])?void 0:t[0]:void 0})),u(Object(c.a)(ti,(s=>s)))},408:function(e,t,r){"use strict";function n(a,b){return a===b}r.d(t,"a",(function(){return o}));var o=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return function(){for(var t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o];var l=0,d=n.pop(),c=function(e){var t=Array.isArray(e[0])?e[0]:e;if(!t.every((function(e){return"function"==typeof e}))){var r=t.map((function(e){return typeof e})).join(", ");throw new Error("Selector creators expect all input-selectors to be functions, instead received the following types: ["+r+"]")}return t}(n),h=e.apply(void 0,[function(){return l++,d.apply(null,arguments)}].concat(r)),v=e((function(){for(var e=[],t=c.length,i=0;i<t;i++)e.push(c[i].apply(null,arguments));return h.apply(null,e)}));return v.resultFunc=d,v.dependencies=c,v.recomputations=function(){return l},v.resetRecomputations=function(){return l=0},v}}((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n,r=null,o=null;return function(){return function(e,t,r){if(null===t||null===r||t.length!==r.length)return!1;for(var n=t.length,i=0;i<n;i++)if(!e(t[i],r[i]))return!1;return!0}(t,r,arguments)||(o=e.apply(null,arguments)),r=arguments,o}}))},412:function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return Be})),r.d(t,"b",(function(){return Te})),r.d(t,"c",(function(){return It})),r.d(t,"d",(function(){return Bt})),r.d(t,"e",(function(){return br})),r.d(t,"f",(function(){return ot})),r.d(t,"g",(function(){return He})),r.d(t,"h",(function(){return ct})),r.d(t,"i",(function(){return Ct})),r.d(t,"j",(function(){return Vt})),r.d(t,"k",(function(){return gs})),r.d(t,"l",(function(){return ut})),r.d(t,"m",(function(){return lt})),r.d(t,"n",(function(){return Lt})),r.d(t,"o",(function(){return le})),r.d(t,"p",(function(){return ht}));var n,o,l=r(684),d=r(499),c=r(466),h=r(418),v=r.n(h),m=r(501),f=Object.defineProperty,y=Object.defineProperties,k=Object.getOwnPropertyDescriptors,T=Object.getOwnPropertySymbols,S=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable,A=Reflect.get,I=(e,t,r)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,g=(e,t)=>{for(var r in t||(t={}))E.call(t,r)&&I(e,r,t[r]);if(T)for(var r of T(t))P.call(t,r)&&I(e,r,t[r]);return e},C=(e,t)=>y(e,k(t)),R=(e,t)=>{var r={};for(var i in e)E.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&T)for(var i of T(e))t.indexOf(i)<0&&P.call(e,i)&&(r[i]=e[i]);return r},w=(e,t,r)=>A(S(e),r,t),_=(e,t,r)=>new Promise(((i,n)=>{var s=e=>{try{o(r.next(e))}catch(e){n(e)}},a=e=>{try{o(r.throw(e))}catch(e){n(e)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,a);o((r=r.apply(e,t)).next())})),D=(n=(e,t)=>{t.exports={name:"@100mslive/hms-video",version:"0.9.17",license:"MIT",main:"dist/index.cjs.js",typings:"dist/index.d.ts",module:"dist/index.js",files:["dist","src"],engines:{node:">=10"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",test:"jest --maxWorkers=1",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",format:"prettier --write src/**/*.ts"},author:"100ms <tech-common@100ms.live>",devDependencies:{"@types/dom-screen-wake-lock":"^1.0.1","@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1",tslib:"^2.2.0"},dependencies:{eventemitter2:"^6.4.7","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0"},gitHead:"966ed9ffac3d55586196ad0b738eb1977dfc2ff7"}},()=>(o||n((o={exports:{}}).exports,o),o.exports)),O=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:r,recipientRoles:s,time:a,id:n}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=r,this.recipientRoles=s,this.time=a,this.id=n}toSignalParams(){var e,s;let t=null==(e=this.recipientRoles)?void 0:e.map((a=>a.name)),r=null==(s=this.recipientPeer)?void 0:s.peerId,i={info:{message:this.message,type:this.type}};return null!=t&&t.length&&(i.roles=t),r&&(i.peer_id=r),i}toString(){var e;return`{\n      sender: ${this.sender};\n      recipientPeer: ${this.recipientPeer};\n      recipientRoles: ${null==(e=this.recipientRoles)?void 0:e.map((e=>e.name))};\n      message: ${this.message};\n      time: ${this.time};\n      type: ${this.type};\n      id: ${this.id}\n    }`}},M=class{constructor(e){this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]},this.id=e}},L="renegotiation-callback-id",rt="ion-sfu",N="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",G="device-change",x="local-audio-enabled",U="local-video-enabled",F="stats-update",$="track-degraded",j="track-restored",B="track-audio-level-update",V="local-audio-silence",W="analytics",H="audio-plugin-failed",K="policy-change",J="local-role-update",z="audio-track-update",Q="audio-track-added",Y="audio-track-removed",X="autoplay-error",Z="leave",q="_handraise",ee=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:r,metadata:s,role:a,joinedAt:n,groups:o,realtime:l}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=r,this.metadata=s,this.joinedAt=n,this.groups=o,this.realtime=l,a&&(this.role=a)}get isHandRaised(){var e;return!(null==(e=this.groups)||!e.includes(q))}updateRole(e){this.role=e}updateName(e){this.name=e}updateNetworkQuality(e){this.networkQuality=e}updateMetadata(e){this.metadata=e}updateGroups(e){this.groups=e}toString(){var e,t,i,r;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}\n      groups: ${null==(r=this.groups)?void 0:r.join()}\n    }`}},te=class{};te.makePeerId=()=>Object(l.a)();var ie,i,se=class extends ee{constructor(e){super(C(g({},e),{peerId:te.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[],this.asRole=e.asRole}isInPreview(){return!!this.asRole}toString(){var e,i,t;return`{\n      name: ${this.name};\n      role: ${null==(e=this.role)?void 0:e.name};\n      peerId: ${this.peerId};\n      customerUserId: ${this.customerUserId};\n      ${this.asRole?`asRole: ${this.asRole.name};`:""}\n      ${this.audioTrack?`audioTrack: ${null==(i=this.audioTrack)?void 0:i.trackId};`:""}\n      ${this.videoTrack?`videoTrack: ${null==(t=this.videoTrack)?void 0:t.trackId};`:""}\n    }`}},re=class extends ee{constructor(e){super(C(g({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},ne=(e,t)=>new re({peerId:e.peer_id,name:e.info.name,role:t.getPolicyForRole(e.role),customerUserId:e.info.user_id,metadata:e.info.data,groups:e.groups}),ae=class{constructor(e,t,i){this.transport=e,this.store=t,this.options=i,this.isEnd=!1,this.iterator=null,this.total=0,this.defaultPaginationLimit=10}hasNext(){return!this.isEnd}getTotal(){return this.total}findPeers(){return _(this,null,(function*(){var e;let t=yield this.transport.findPeers(C(g({},this.options||{}),{limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}));return this.updateState(t),this.processPeers(t.peers)}))}next(){return _(this,null,(function*(){var e;let t;return this.iterator||this.isEnd?this.iterator?(t=yield this.transport.peerIterNext({iterator:this.iterator,limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}),this.updateState(t),this.processPeers(t.peers)):[]:yield this.findPeers()}))}processPeers(e){let t=[];return e.forEach((i=>{let e=ne(i,this.store);t.push(e)})),t}updateState(e){this.isEnd=e.eof,this.total=e.total,e.iterator&&(this.iterator=e.iterator)}},oe=new d.UAParser,le="undefined"!=typeof window,de="undefined"==typeof window&&!(null!=(ie=oe.getBrowser().name)&&ie.toLowerCase().includes("electron")),ce=((i=ce||{}).PROD="prod",i.QA="qa",i.DEV="dev",i),ue=()=>"mobile"===oe.getDevice().type,he=()=>{var e;return"ios"===(null==(e=oe.getOS().name)?void 0:e.toLowerCase())};var pe,ve=function(){if(le&&window){let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"LOCAL":e.includes("app.100ms.live")?"HMS":"CUSTOM"}return"CUSTOM"}(),ge=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(0===arguments.length)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},me=class{constructor(e){this.key=e,this.storage=null}getStorage(){return le&&!this.storage&&(le&&!localStorage&&(window.localStorage=new ge),this.storage=window.localStorage),this.storage}get(){var i;let e=null==(i=this.getStorage())?void 0:i.getItem(this.key);return e?JSON.parse(e):void 0}set(e){var i;let t=JSON.stringify(e);null==(i=this.getStorage())||i.setItem(this.key,t)}clear(){var e;null==(e=this.getStorage())||e.removeItem(this.key)}},br=((pe=br||{})[pe.VERBOSE=0]="VERBOSE",pe[pe.DEBUG=1]="DEBUG",pe[pe.INFO=2]="INFO",pe[pe.WARN=3]="WARN",pe[pe.TIME=4]="TIME",pe[pe.TIMEEND=5]="TIMEEND",pe[pe.ERROR=6]="ERROR",pe[pe.NONE=7]="NONE",pe),fe="undefined"!=typeof window&&void 0!==window.expect,ye=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(t,...i);break;case 1:console.debug(t,...i);break;case 2:console.info(t,...i);break;case 3:console.warn(t,...i);break;case 6:console.error(t,...i);break;case 4:performance.mark(i[0]);break;case 5:{let e=i[0];try{let s=performance.measure(e,e);this.log(1,t,e,null==s?void 0:s.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(r){this.log(1,t,e,r)}break}}}};ye.level=fe?7:0;var ke={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},APIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011,CURRENT_TAB_NOT_SHARED:3012,AUDIO_PLAYBACK_ERROR:3013,SELECTED_DEVICE_MISSING:3014},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005,ICE_DISCONNECTED:4006,STATS_FAILED:4007},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},Te=class e extends Error{constructor(t,i,r,s,a,n=!1){super(s),this.code=t,this.name=i,this.message=s,this.description=a,this.isTerminal=n,Object.setPrototypeOf(this,e.prototype),this.action=r.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{\n      code: ${this.code};\n      name: ${this.name};\n      action: ${this.action};\n      message: ${this.message};\n      description: ${this.description};\n      isTerminal: ${this.isTerminal};\n      nativeError: ${null==(e=this.nativeError)?void 0:e.message};\n    }`}};function Se(e){switch(e){case"join":return"JOIN";case"offer":return"PUBLISH";case"answer":return"SUBSCRIBE";case"track-update":return"TRACK";default:return"NONE"}}var be=["join","offer","answer","trickle","on-error","JOIN"],p={WebSocketConnectionErrors:{FailedToConnect:(e,t="")=>new Te(ke.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`),WebSocketConnectionLost:(e,t="")=>new Te(ke.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",e,"Network connection lost ",t),AbnormalClose:(e,t="")=>new Te(ke.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",e,"Websocket closed abnormally",t)},APIErrors:{ServerErrors:(e,t,r="",i=!0)=>new Te(e,"ServerErrors",t,`[${t}]: Server error ${r}`,r,i),EndpointUnreachable:(e,t="")=>new Te(ke.APIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",e,`Endpoint is not reachable - ${t}`,t),InvalidTokenFormat:(e,t="")=>new Te(ke.APIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0),InitConfigNotAvailable:(e,t="")=>new Te(ke.APIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`)},TracksErrors:{GenericTrack:(e,t="")=>new Te(ke.TracksErrors.GENERIC_TRACK,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`),CantAccessCaptureDevice:(e,t,r="")=>new Te(ke.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,r),DeviceNotAvailable:(e,t,r="")=>new Te(ke.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,r),DeviceInUse:(e,t,r="")=>new Te(ke.TracksErrors.DEVICE_IN_USE,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,r),DeviceLostMidway:(e,t,r="")=>new Te(ke.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",e,`Lost access to capture device midway - ${t}`,r),NothingToReturn:(e,t="",r="There is no media to return. Please select either video or audio or both.")=>new Te(ke.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",e,r,t),InvalidVideoSettings:(e,t="")=>new Te(ke.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t),AutoplayBlocked:(e,t="")=>new Te(ke.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t),CodecChangeNotPermitted:(e,t="")=>new Te(ke.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",e,"Codec can't be changed mid call.",t),OverConstrained:(e,t,r="")=>new Te(ke.TracksErrors.OVER_CONSTRAINED,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,r),NoAudioDetected:(e,t="Please check the mic or use another audio input")=>new Te(ke.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",e,"No audio input detected from microphone",t),SystemDeniedPermission:(e,t,r="")=>new Te(ke.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,r),CurrentTabNotShared:()=>new Te(ke.TracksErrors.CURRENT_TAB_NOT_SHARED,"CurrentTabNotShared","TRACK","The app requires you to share the current tab","You must screen share the current tab in order to proceed"),AudioPlaybackError:e=>new Te(ke.TracksErrors.AUDIO_PLAYBACK_ERROR,"Audio playback error","TRACK",e,e),SelectedDeviceMissing:e=>new Te(ke.TracksErrors.SELECTED_DEVICE_MISSING,"SelectedDeviceMissing","TRACK",`Could not detect selected ${e} device`,`Please check connection to the ${e} device`,!1)},WebrtcErrors:{CreateOfferFailed:(e,t="")=>new Te(ke.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t),CreateAnswerFailed:(e,t="")=>new Te(ke.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t),SetLocalDescriptionFailed:(e,t="")=>new Te(ke.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t),SetRemoteDescriptionFailed:(e,t="")=>new Te(ke.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t,!0),ICEFailure:(e,t="")=>new Te(ke.WebrtcErrors.ICE_FAILURE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t),ICEDisconnected:(e,t="")=>new Te(ke.WebrtcErrors.ICE_DISCONNECTED,"ICEDisconnected",e,`[${e.toString()}]: Ice connection state DISCONNECTED`,t),StatsFailed:(e,t="")=>new Te(ke.WebrtcErrors.STATS_FAILED,"StatsFailed",e,`Failed to WebRTC get stats - ${t}`,t)},WebsocketMethodErrors:{ServerErrors:(e,t,r)=>new Te(e,"ServerErrors",t,r,r,be.includes(t)),AlreadyJoined:(e,t="")=>new Te(ke.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t),CannotJoinPreviewInProgress:(e,t="")=>new Te(ke.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",e,"[JOIN]: Cannot join if preview is in progress",t)},GenericErrors:{NotConnected:(e,t="")=>new Te(ke.GenericErrors.NOT_CONNECTED,"NotConnected",e,"Client is not connected",t),Signalling:(e,t)=>new Te(ke.GenericErrors.SIGNALLING,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t),Unknown:(e,t)=>new Te(ke.GenericErrors.UNKNOWN,"Unknown",e,`Unknown exception: ${t}`,t),NotReady:(e,t="")=>new Te(ke.GenericErrors.NOT_READY,"NotReady",e,t,t),JsonParsingFailed:(e,t,r="")=>new Te(ke.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",e,`Failed to parse JSON message - ${t}`,r),TrackMetadataMissing:(e,t="")=>new Te(ke.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",e,"Track Metadata Missing",t),RTCTrackMissing:(e,t="")=>new Te(ke.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",e,"RTC Track missing",t),PeerMetadataMissing:(e,t="")=>new Te(ke.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",e,"Peer Metadata Missing",t),ValidationFailed:(e,t)=>new Te(ke.GenericErrors.INVALID_ROLE,"ValidationFailed","VALIDATION",e,t?JSON.stringify(t):""),InvalidRole:(e,t)=>new Te(ke.GenericErrors.INVALID_ROLE,"InvalidRole",e,"Invalid role. Join with valid role",t,!0),PreviewAlreadyInProgress:(e,t="")=>new Te(ke.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t),MissingMediaDevices:()=>new Te(ke.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices","JOIN","navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0),MissingRTCPeerConnection:()=>new Te(ke.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection","JOIN","RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)},MediaPluginErrors:{PlatformNotSupported:(e,t="")=>new Te(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t),InitFailed:(e,t="")=>new Te(7002,"InitFailed",e,"Plugin init failed",t),ProcessingFailed:(e,t="")=>new Te(7003,"ProcessingFailed",e,"Plugin processing failed",t),AddAlreadyInProgress:(e,t="")=>new Te(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t),DeviceNotSupported:(e,t="")=>new Te(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t)},PlaylistErrors:{NoEntryToPlay:(e,t)=>new Te(ke.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t),NoEntryPlaying:(e,t)=>new Te(ke.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",e,"No entry is playing at this time",t)}},Ee="[VALIDATIONS]";function Pe(e){return null!=e}var Ae=()=>{if(!Pe(RTCPeerConnection)){let e=p.GenericErrors.MissingRTCPeerConnection();throw ye.e(Ee,e),e}},Ie=()=>{if(!Pe(navigator.mediaDevices)){let e=p.GenericErrors.MissingMediaDevices();throw ye.e(Ee,e),e}},Ce=D().version;function Re(t="prod",r){let i="LOCAL"!==ve&&"prod"===t?"prod":"debug";if(de)return _e({os:"web_nodejs",os_version:e.version,sdk:"web",sdk_version:Ce,env:i,domain:ve,is_prebuilt:!(null==r||!r.isPrebuilt),framework:"node",framework_version:e.version,framework_sdk_version:null==r?void 0:r.sdkVersion});let n=oe.getOS(),s=oe.getDevice(),a=oe.getBrowser(),o=we(`web_${n.name}`),l=n.version||"",d=we(`${a.name}_${a.version}`),u=d;return s.type&&(u=`${we(`${s.vendor}_${s.type}`)}/${d}`),_e({os:o,os_version:l,sdk:"web",sdk_version:Ce,device_model:u,env:i,domain:ve,is_prebuilt:!(null==r||!r.isPrebuilt),framework:null==r?void 0:r.type,framework_version:null==r?void 0:r.version,framework_sdk_version:null==r?void 0:r.sdkVersion})}function we(e){return e.replace(/ /g,"_")}var _e=(e,t=",")=>Object.keys(e).filter((t=>Pe(e[t]))).map((t=>`${t}:${e[t]}`)).join(t),De=class{constructor({name:e,level:t,properties:i,includesPII:r,timestamp:s}){this.metadata={peer:{},userAgent:Re()},this.name=e,this.level=t,this.includesPII=r||!1,this.properties=i||{},this.timestamp=s||(new Date).getTime(),this.event_id=Object(l.a)(),this.device_id=(()=>{let e,t=new me("hms-analytics-deviceId"),r=t.get();return r?e=r:(e=Object(l.a)(),t.set(e)),e})()}toSignalParams(){return{name:this.name,info:C(g({},this.properties),{timestamp:this.timestamp,domain:ve}),timestamp:(new Date).getTime()}}},Oe=class{static connect(e,t,i=new Date,r=new Date,s){let a=this.eventNameFor("connect",void 0===e),n=e?2:1,o=this.getPropertiesWithError(C(g({},t),{[this.KEY_REQUESTED_AT]:null==i?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:null==r?void 0:r.getTime(),endpoint:s}),e);return new De({name:a,level:n,properties:o})}static disconnect(e,t){let r=e?2:1,s=this.getPropertiesWithError(t,e);return new De({name:"disconnected",level:r,properties:s})}static preview(i){var e=i,{error:t}=e,r=R(e,["error"]);let s=this.eventNameFor("preview",void 0===t),a=t?2:1,n=this.getPropertiesWithError(r,t);return new De({name:s,level:a,properties:n})}static join(i){var e=i,{error:t}=e,r=R(e,["error"]);let s=this.eventNameFor("join",void 0===t),a=t?2:1,n=this.getPropertiesWithError(C(g({},r),{is_preview_called:!!r.is_preview_called}),t);return new De({name:s,level:a,properties:n})}static publish({devices:e,settings:t,error:i}){let r=this.eventNameFor("publish",void 0===i),s=i?2:1,a=this.getPropertiesWithError({devices:e,audio:null==t?void 0:t.audio,video:null==t?void 0:t.video},i);return new De({name:r,level:s,properties:a})}static hlsPlayerError(e){return new De({name:"hlsPlayerError",level:2,properties:this.getErrorProperties(e)})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),r=this.getErrorProperties(e);return new De({name:t,level:2,properties:r})}static leave(){return new De({name:"leave",level:1})}static autoplayError(){return new De({name:"autoplayError",level:2})}static audioPlaybackError(e){return new De({name:"audioPlaybackError",level:2,properties:this.getErrorProperties(e)})}static deviceChange({selection:e,type:t,devices:i,error:r}){let s=this.eventNameFor(r?"publish":`device.${t}`,void 0===r),a=r?2:1,n=this.getPropertiesWithError({selection:e,devices:i},r);return new De({name:s,level:a,properties:n})}static performance(e){let t=e.toAnalyticsProperties();return new De({name:"perf.stats",level:1,properties:t})}static rtcStats(e){let t=e.toAnalyticsProperties();return new De({name:"rtc.stats",level:1,properties:t})}static rtcStatsFailed(e){return new De({name:"rtc.stats.failed",level:2,properties:this.getErrorProperties(e)})}static degradationStats(e,t){let s={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let a=new Date,t=a.valueOf()-e.degradedAt.valueOf();s=C(g({},s),{duration:t,restoredAt:a})}return new De({name:"video.degradation.stats",level:1,properties:s})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e);return new De({name:"audiopresence.failed",level:2,properties:i})}static previewNetworkQuality(e){return new De({name:"perf.networkquality.preview",level:e.error?2:1,properties:e})}static publishStats(e){return new De({name:"publisher.stats",level:1,properties:e})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=g(g({},i),e)}static getErrorProperties(e){return e?e instanceof Te?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};Oe.KEY_REQUESTED_AT="requested_at",Oe.KEY_RESPONDED_AT="responded_at";var Me=["init_response_time","ws_connect_time","on_policy_change_time","local_audio_track_time","local_video_track_time","peer_list_time","room_state_time","join_response_time"],Le=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),ye.d("[HMSPerformanceTiming]",e,null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration)}catch(t){ye.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:t})}}getTimeTaken(e){var t;return null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration}getTimes(...e){return[...Me,...e].reduce(((e,i)=>C(g({},e),{[i]:this.getTimeTaken(i)})),{})}cleanup(){this.eventPerformanceMeasures={}}};function Ne(e,t=""){if("chrome"===c.a.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return p.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);if("firefox"===c.a.browserDetails.browser&&"NotFoundError"===e.name){let i=p.TracksErrors.SystemDeniedPermission("TRACK",t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return p.TracksErrors.OverConstrained("TRACK",t,e.constraint);case"NotAllowedError":return p.TracksErrors.CantAccessCaptureDevice("TRACK",t,e.message);case"NotFoundError":return p.TracksErrors.DeviceNotAvailable("TRACK",t,e.message);case"NotReadableError":return p.TracksErrors.DeviceInUse("TRACK",t,e.message);case"TypeError":return p.TracksErrors.NothingToReturn("TRACK",e.message);default:return function(e,t){let r=e.toLowerCase();return r.includes("device not found")?p.TracksErrors.DeviceNotAvailable("TRACK",t,e):r.includes("permission denied")?p.TracksErrors.CantAccessCaptureDevice("TRACK",t,e):p.TracksErrors.GenericTrack("TRACK",e)}(e.message,t)}}function Ge(e,t){let r=Ne(e,t);return r.addNativeError(e),r}var xe,Ue=class{constructor(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id}updateId(e){this.id=e}},Fe=e=>e?`{\n    trackId: ${e.id};\n    kind: ${e.kind};\n    enabled: ${e.enabled};\n    muted: ${e.muted};\n    readyState: ${e.readyState};\n  }`:"",$e=class{constructor(e,t,i){this.logIdentifier="",this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return _(this,null,(function*(){this.nativeTrack.enabled=e}))}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;ye.d("[HMSTrack]","Stopping track",this.toString()),null==(e=this.nativeTrack)||e.stop()}toString(){var e;return`{\n      streamId: ${this.stream.id};\n      peerId: ${this.peerId};\n      trackId: ${this.trackId};\n      mid: ${(null==(e=this.transceiver)?void 0:e.mid)||"-"};\n      logIdentifier: ${this.logIdentifier};\n      source: ${this.source};\n      enabled: ${this.enabled};\n      nativeTrack: ${Fe(this.nativeTrack)};\n    }`}},je=((xe=je||{}).AUDIO="audio",xe.VIDEO="video",xe),Be=class extends $e{constructor(e,i,t){if(super(e,i,t),this.type="audio",this.audioElement=null,"audio"!==i.kind)throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?100*this.audioElement.volume:null}setVolume(e){return _(this,null,(function*(){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}))}setAudioElement(e){ye.d("[HMSAudioTrack]",this.logIdentifier,"adding audio element",`${this}`,e),this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return _(this,null,(function*(){var i;if(e){if(!this.audioElement)return ye.d("[HMSAudioTrack]",this.logIdentifier,"no audio element to set output",`${this}`),void(this.outputDevice=e);try{"function"==typeof this.audioElement.setSinkId&&(yield null==(i=this.audioElement)?void 0:i.setSinkId(e.deviceId),this.outputDevice=e)}catch(e){ye.d("[HMSAudioTrack]","error in setSinkId",e)}}else ye.d("[HMSAudioTrack]",this.logIdentifier,"device is null",`${this}`)}))}subscribeToAudio(e){return _(this,null,(function*(){this.stream instanceof qt&&(yield this.stream.setAudio(e,this.trackId,this.logIdentifier))}))}},Ve=new class{constructor(){this.storage=new me("hms-device-selection"),this.remember=!1,this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let r=this.devices[e].find((a=>this.isSame({deviceId:t,groupId:i},a)));if(!r)return void ye.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);let s=this.storage.get()||{};s[e]=r,this.storage.set(s)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},We=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(We||{}),He=(e=>(e.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",e.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",e))(He||{}),qe=class{static failure(e,t){let s=g({plugin_name:e},t.toAnalyticsProperties());return new De({name:"mediaPlugin.failed",level:2,properties:s})}static audioPluginFailure(e,t,i){let a=g({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new De({name:"mediaPlugin.failed",level:2,properties:a})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:r}){return new De({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,sampleRate:r}})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:r,avgProcessingTime:s,inputFrameRate:a,pluginFrameRate:n}){return new De({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:r,avg_processing_time:s,input_frame_rate:a,plugin_frame_rate:n}})}},dt=class{constructor(e){this.eventBus=e,this.TAG="[AudioPluginsAnalytics]",this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(qe.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(qe.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return _(this,null,(function*(){if(this.initTime[e])return void ye.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),ye.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let s=p.MediaPluginErrors.InitFailed("AUDIO_PLUGINS",`failed during initialization of plugin${t.message||t}`);throw ye.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)}))}timeInMs(e){return _(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}},Ke=class{constructor(e,t){this.TAG="[AudioPluginsManager]",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new dt(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return _(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);if(t){if(this.pluginAddInProgress){let e=p.MediaPluginErrors.AddAlreadyInProgress("AUDIO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.added(t,this.audioContext.sampleRate),this.analytics.failure(t,e),ye.w("can't add another plugin when previous add is in progress"),e}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}}else ye.w("no name provided by the plugin")}))}addPluginInternal(e){return _(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);if(this.pluginsMap.get(t))ye.w(this.TAG,`plugin - ${t} already added.`);else{yield this.validateAndThrow(t,e);try{0===this.pluginsMap.size?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(t,this.audioContext.sampleRate),yield this.analytics.initWithTime(t,(()=>_(this,null,(function*(){return e.init()})))),this.pluginsMap.set(t,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(e){throw ye.e(this.TAG,"failed to add plugin",e),e}}}))}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return _(this,null,(function*(){let i=this.validatePlugin(t);if(i.isSupported)ye.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{if(this.analytics.added(e,this.audioContext.sampleRate),"PLATFORM_NOT_SUPPORTED"===i.errType){let t=p.MediaPluginErrors.PlatformNotSupported("AUDIO_PLUGINS","platform not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}if("DEVICE_NOT_SUPPORTED"===i.errType){let t=p.MediaPluginErrors.DeviceNotSupported("AUDIO_PLUGINS","audio device not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}}}))}removePlugin(e){return _(this,null,(function*(){yield this.removePluginInternal(e),0===this.pluginsMap.size?(yield this.cleanup(),ye.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()}))}cleanup(){return _(this,null,(function*(){var e,t,i;for(let e of this.pluginsMap.values())yield this.removePluginInternal(e);yield this.hmsTrack.setProcessedTrack(void 0),null==(e=this.sourceNode)||e.disconnect(),null==(t=this.prevAudioNode)||t.disconnect(),null==(i=this.outputTrack)||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0}))}closeContext(){return _(this,null,(function*(){var e;null==(e=this.audioContext)||e.close(),this.audioContext=void 0}))}reprocessPlugins(){return _(this,null,(function*(){if(0===this.pluginsMap.size||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)}))}initAudioNodes(){return _(this,null,(function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw ye.e(this.TAG,"error in setting processed track",e),e}}}}))}processPlugin(e){return _(this,null,(function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();ye.e(this.TAG,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}}))}connectToDestination(){return _(this,null,(function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){ye.e(this.TAG,"error in connecting to destination node",e)}}))}removePluginInternal(e){return _(this,null,(function*(){var i;let t=null==(i=e.getName)?void 0:i.call(e);this.pluginsMap.get(t)?(ye.i(this.TAG,`removing plugin ${t}`),this.pluginsMap.delete(t),e.stop(),this.analytics.removed(t)):ye.w(this.TAG,`plugin - ${t} not found to remove.`)}))}createAudioContext(){this.audioContext||(-1!==navigator.userAgent.indexOf("Firefox")?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:48e3}))}};function Je(e){return _(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!!e&&e.toConstraints()})).getAudioTracks()[0]}catch(e){throw Ge(e,"audio")}}))}function ze(e){return _(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:!!e&&e.toConstraints()})).getVideoTracks()[0]}catch(e){throw Ge(e,"video")}}))}function Qe(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}var Ye={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){return _(this,null,(function*(){try{return yield this.getAudioContext().resume()}catch(e){ye.e("AudioContext",e)}}))}},Xe=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function Ze(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise((t=>setTimeout(t,e)))}function et(e,t=300){let r;return function(...i){clearTimeout(r),r=void 0;let n=this;r=setTimeout((()=>{e.apply(n,i)}),t)}}var tt,it,st,a,nt=class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new Xe(this.historyInterval/this.interval),this.detectSilence=()=>_(this,null,(function*(){let i=0;for(;this.isMonitored;){if(this.track.enabled){if(!this.isSilentThisInstant())break;if(i++,i>50){this.silenceEvent.publish({track:this.track});break}}yield Ze(20)}}));try{let e=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(e)}catch(e){ye.w(this.TAG,"Unable to initialize AudioContext",e)}}start(){this.stop(),this.isMonitored=!0,ye.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then((()=>ye.d(this.TAG,"Stopping track Monitor",`${this.track}`)))}stop(){this.analyserNode?(this.sendAudioLevel(0),this.isMonitored=!1):ye.d(this.TAG,"AudioContext not initialized")}loop(){return _(this,null,(function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield Ze(this.interval)}))}sendAudioLevel(e=0){if(e=e>35?e:0,Math.abs(this.audioLevel-e)>5){this.audioLevel=e;let i={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(i)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode)return void ye.d(this.TAG,"AudioContext not initialized");let e=this.calculateAudioLevel();return void 0!==e&&this.history.enqueue(e),this.history.aggregate((e=>Math.max(...e)))}calculateAudioLevel(){if(!this.analyserNode)return void ye.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let a of e)i=Math.max(i,(a-128)/128);let r=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(100*r,0),100))}isSilentThisInstant(){if(!this.analyserNode)return void ye.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some((e=>128!==e&&0!==e))}createAnalyserNodeForStream(e){let t=Ye.getAudioContext(),i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}},at=((a=at||{}).RECORDING_STATE_UPDATED="RECORDING_STATE_UPDATED",a.BROWSER_RECORDING_STATE_UPDATED="BROWSER_RECORDING_STATE_UPDATED",a.SERVER_RECORDING_STATE_UPDATED="SERVER_RECORDING_STATE_UPDATED",a.RTMP_STREAMING_STATE_UPDATED="RTMP_STREAMING_STATE_UPDATED",a.HLS_STREAMING_STATE_UPDATED="HLS_STREAMING_STATE_UPDATED",a.ROOM_PEER_COUNT_UPDATED="ROOM_PEER_COUNT_UPDATED",a),ot=((st=ot||{})[st.PEER_JOINED=0]="PEER_JOINED",st[st.PEER_LEFT=1]="PEER_LEFT",st[st.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",st[st.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",st[st.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",st[st.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",st[st.STARTED_SPEAKING=6]="STARTED_SPEAKING",st[st.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",st[st.ROLE_UPDATED=8]="ROLE_UPDATED",st[st.PEER_LIST=9]="PEER_LIST",st[st.NAME_UPDATED=10]="NAME_UPDATED",st[st.METADATA_UPDATED=11]="METADATA_UPDATED",st[st.HAND_RAISE_CHANGED=12]="HAND_RAISE_CHANGED",st[st.PEER_REMOVED=13]="PEER_REMOVED",st[st.PEER_ADDED=14]="PEER_ADDED",st),lt=((it=lt||{})[it.TRACK_ADDED=0]="TRACK_ADDED",it[it.TRACK_REMOVED=1]="TRACK_REMOVED",it[it.TRACK_MUTED=2]="TRACK_MUTED",it[it.TRACK_UNMUTED=3]="TRACK_UNMUTED",it[it.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",it[it.TRACK_DEGRADED=5]="TRACK_DEGRADED",it[it.TRACK_RESTORED=6]="TRACK_RESTORED",it),ct=((tt=ct||{})[tt.POLL_CREATED=0]="POLL_CREATED",tt[tt.POLL_STARTED=1]="POLL_STARTED",tt[tt.POLL_STOPPED=2]="POLL_STOPPED",tt[tt.POLL_STATS_UPDATED=3]="POLL_STATS_UPDATED",tt),ut=(e=>(e.NONE="none",e.LOW="low",e.MEDIUM="medium",e.HIGH="high",e))(ut||{}),ht={f:"high",h:"medium",q:"low"},pt=(i=>(i.VP8="vp8",i.VP9="vp9",i.H264="h264",i))(pt||{}),vt=(e=>(e.OPUS="opus",e))(vt||{}),gt=(e=>(e.USER="user",e.ENVIRONMENT="environment",e.LEFT="left",e.RIGHT="right",e))(gt||{}),mt=(i=>(i.videoInput="videoInput",i.audioInput="audioInput",i.audioOutput="audioOutput",i))(mt||{}),ft=(e=>(e.audio="audio",e.video="video",e))(ft||{}),yt=(e=>(e.SINGLE_CHOICE="single-choice",e.MULTIPLE_CHOICE="multiple-choice",e.SHORT_ANSWER="short-answer",e.LONG_ANSWER="long-answer",e))(yt||{}),kt=class{constructor(){this._volume=1,this._codec="opus",this._maxBitrate=32,this._deviceId="default",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Tt(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},Tt=class{constructor(e,t,i,r,s){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=r,this.advanced=s}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},St=class{constructor(){this._width=320,this._height=180,this._codec="vp8",this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if("number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}facingMode(e){return this._facingMode=e,this}build(){return new bt(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate,this._facingMode)}},bt=class{constructor(e,t,i,r,s,a,n,o){this.width=e,this.height=t,this.codec=i,this.maxFramerate=r,this.maxBitrate=n,this.deviceId=s,this.advanced=a,this.facingMode=o}toConstraints(e){let t="ideal";e&&(t="max");let i=this.improviseConstraintsAspect();return{width:{[t]:i.width},height:{[t]:i.height},frameRate:this.maxFramerate,deviceId:this.deviceId,facingMode:this.facingMode}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec,facingMode:this.facingMode}}improviseConstraintsAspect(){return ue()&&this.height&&this.width&&this.height>this.width?{width:this.height,height:this.width}:{width:this.width,height:this.height}}},Et=class{constructor(){this._video=(new St).build(),this._audio=(new kt).build(),this._screen=(new St).build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(null===this._audio&&null===this._video)throw p.TracksErrors.NothingToReturn("TRACK");if(null===this._video&&this._simulcast)throw p.TracksErrors.InvalidVideoSettings("TRACK","Cannot enable simulcast when no video settings are provided");return new Pt(this._video,this._audio,this._simulcast,this._screen||void 0)}},Pt=class{constructor(e,t,i,r=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=r}toAnalyticsProperties(){let e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=g(g({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=g(g({},this.video.toAnalyticsProperties()),e)),e}};function At(e,t){return function(i){return i in e&&e[i]!==t[i]}}var It=class e extends Be{constructor(e,i,t,s,a=(new kt).build()){super(e,i,t),this.eventBus=s,this.TAG="[HMSLocalAudioTrack]",this.isPublished=!1,this.handleVisibilityChange=()=>_(this,null,(function*(){"visible"===document.visibilityState&&(yield this.replaceTrackWith(this.settings))})),this.handleSettingsChange=e=>_(this,null,(function*(){let i=this.stream,t=At(e,this.settings);t("maxBitrate")&&e.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),t("advanced")&&(yield this.replaceTrackWith(e))})),this.handleDeviceChange=(e,i=!1)=>_(this,null,(function*(){At(e,this.settings)("deviceId")&&(yield this.replaceTrackWith(e),i||Ve.updateSelection("audioInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId}))})),e.tracks.push(this),this.settings=a,a.deviceId!==i.getSettings().deviceId&&!Qe(i)&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new Ke(this,s),this.setFirstTrackId(i.id),he()&&le&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}replaceTrackWith(e){return _(this,null,(function*(){let i=this.nativeTrack;null==i||i.stop();let t=!!this.audioLevelMonitor;try{let s=yield Je(e);s.enabled=this.enabled,ye.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",s);let a=this.stream;yield a.replaceSenderTrack(i,this.processedTrack||s),yield a.replaceStreamTrack(i,s),this.nativeTrack=s,t&&this.initAudioLevelMonitor()}catch(e){throw this.isPublished&&this.eventBus.analytics.publish(Oe.publish({error:e})),e}try{yield this.pluginsManager.reprocessPlugins()}catch(e){this.eventBus.audioPluginFailed.publish(e)}}))}setEnabled(t){return _(this,null,(function*(){t!==this.enabled&&(t&&Qe(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield w(e.prototype,this,"setEnabled").call(this,t),t&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:t,track:this}))}))}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,i=!1){return _(this,null,(function*(){let t=this.buildNewSettings(e);Qe(this.nativeTrack)||(yield this.handleDeviceChange(t,i),yield this.handleSettingsChange(t)),this.settings=t}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return _(this,null,(function*(){return this.pluginsManager.addPlugin(e)}))}removePlugin(e){return _(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return _(this,null,(function*(){if(!e)return this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),void(this.processedTrack=void 0);e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)}))}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),ye.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new nt(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0}cleanup(){return _(this,null,(function*(){var t;w(e.prototype,this,"cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),this.transceiver=void 0,null==(t=this.processedTrack)||t.stop(),this.isPublished=!1,this.destroyAudioLevelMonitor(),he()&&le&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)}))}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:i,codec:t,maxBitrate:s,deviceId:a,advanced:r}=g(g({},this.settings),e);return new Tt(i,t,s,a,r)}},Ct=class e extends Be{setEnabled(t){return _(this,null,(function*(){t!==this.enabled&&(yield w(e.prototype,this,"setEnabled").call(this,t),yield this.subscribeToAudio(t))}))}},Rt=class extends $e{constructor(e,i,t){if(super(e,i,t),this.type="video",this.sinkCount=0,"video"!==i.kind)throw new Error("Expected 'track' kind = 'video'")}setVideoHandler(e){this.videoHandler=e}hasSinks(){return this.sinkCount>0}getSinks(){return this.videoHandler.getVideoElements()||[]}attach(e){this.videoHandler.addVideoElement(e)}detach(e){this.videoHandler.removeVideoElement(e)}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){null!==e.srcObject&&(e.srcObject=null,this.reduceSinkCount())}cleanup(){super.cleanup(),this.videoHandler.cleanup()}addSinkInternal(e,i){let t=e.srcObject;if(null!==t&&t instanceof MediaStream){let s=t.getVideoTracks()[0];if((null==s?void 0:s.id)===i.id){if(!s.muted&&"live"===s.readyState)return;this.reduceSinkCount()}else this.reduceSinkCount()}e.srcObject=new MediaStream([i]),this.sinkCount++}reduceSinkCount(){this.sinkCount>0&&this.sinkCount--}},wt={none:-1,low:0,medium:1,high:2},_t=(e,t)=>{let r="high",i=t.width>t.height?"width":"height",n=[...e].sort(((a,e)=>wt[a.layer]-wt[e.layer])),s=t[i]*((null==window?void 0:window.devicePixelRatio)||1);for(let a=0;a<n.length;a++){let{resolution:e,layer:t}=n[a],o=e[i];if(s<=o){r=t;break}{let u=n[a+1];if((s-o)/((u?u.resolution[i]:Number.POSITIVE_INFINITY)-o)<.5){r=t;break}}}return r},Dt=new class{constructor(){this.TAG="[HMSIntersectionObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t)=>{var i;this.createObserver(),this.unobserve(e),null==(i=this.intersectionObserver)||i.observe(e),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.intersectionObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.intersectionObserver&&(this.intersectionObserver=new IntersectionObserver(this.handleIntersection))},this.handleIntersection=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=le&&void 0!==window.IntersectionObserver;return e||ye.w(this.TAG,"IntersectionObserver is not supported, fallback will be used instead"),e}},Ot=new class{constructor(){this.TAG="[HMSResizeObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t,i={box:"border-box"})=>{var r;this.createObserver(),this.unobserve(e),null==(r=this.resizeObserver)||r.observe(e,i),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.resizeObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(et(this.handleResize,300)))},this.handleResize=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=le&&void 0!==window.ResizeObserver;return e||ye.w(this.TAG,"Resize Observer is not supported"),e}},Mt=class{constructor(e){this.track=e,this.TAG="[VideoElementManager]",this.videoElements=new Set,this.entries=new WeakMap,this.handleIntersection=e=>_(this,null,(function*(){let t="visible"===getComputedStyle(e.target).visibility;this.track.enabled&&(e.isIntersecting&&t||!document.contains(e.target))?(ye.d(this.TAG,"add sink intersection",`${this.track}`,this.id),this.entries.set(e.target,e.boundingClientRect),yield this.selectMaxLayer(),yield this.track.addSink(e.target)):(ye.d(this.TAG,"remove sink intersection",`${this.track}`,this.id),yield this.track.removeSink(e.target))})),this.handleResize=e=>_(this,null,(function*(){!this.track.enabled||!(this.track instanceof Vt)||(this.entries.set(e.target,e.contentRect),yield this.selectMaxLayer())})),this.cleanup=()=>{this.videoElements.forEach((e=>{var t,i;e.srcObject=null,null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e)})),this.videoElements.clear(),this.resizeObserver=void 0,this.intersectionObserver=void 0},this.init(),this.id=Object(l.a)()}updateSinks(e=!1){for(let t of this.videoElements)this.track.enabled?this.track.addSink(t,e):this.track.removeSink(t,e)}addVideoElement(e){return _(this,null,(function*(){var t;this.videoElements.has(e)||(this.init(),ye.d(this.TAG,`Adding video element for ${this.track}`,this.id),this.videoElements.add(e),this.videoElements.size>=10&&ye.w(this.TAG,`${this.track}`,`the track is added to ${this.videoElements.size} video elements, while this may be intentional, it's likely that there is a bug leading to unnecessary creation of video elements in the UI`),null!=(t=this.intersectionObserver)&&t.isSupported()?this.intersectionObserver.observe(e,this.handleIntersection):le&&(this.isElementInViewport(e)?this.track.addSink(e):this.track.removeSink(e)),this.resizeObserver?this.resizeObserver.observe(e,this.handleResize):this.track instanceof Vt&&(yield this.track.setPreferredLayer(this.track.getPreferredLayer())))}))}removeVideoElement(e){var t,i;this.track.removeSink(e),this.videoElements.delete(e),this.entries.delete(e),null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e),ye.d(this.TAG,`Removing video element for ${this.track}`)}getVideoElements(){return Array.from(this.videoElements)}init(){le&&(this.resizeObserver=Ot,this.intersectionObserver=Dt)}isElementInViewport(e){let t=e.offsetTop,i=e.offsetLeft,r=e.offsetWidth,s=e.offsetHeight,{hidden:a}=e,{opacity:n,display:o}=getComputedStyle(e);for(;e.offsetParent;)t+=(e=e.offsetParent).offsetTop,i+=e.offsetLeft;return t<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&t+s>window.pageYOffset&&i+r>window.pageXOffset&&!a&&(""===n||parseFloat(n)>0)&&"none"!==o}selectMaxLayer(){return _(this,null,(function*(){if(!(this.track instanceof Vt)||0===this.videoElements.size)return;let e;for(let t of this.videoElements){let i=this.entries.get(t);if(!i)continue;let{width:r,height:s}=i;if(0===r||0===s)continue;let a=_t(this.track.getSimulcastDefinitions(),{width:r,height:s});e=e?wt[a]>wt[e]?a:e:a}e&&(ye.d(this.TAG,`selecting max layer ${e} for the track`,`${this.track}`),yield this.track.setPreferredLayer(e))}))}},Lt=(e=>(e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE",e))(Lt||{}),Nt=(e=>(e["2D"]="2d",e.WEBGL="webgl",e.WEBGL2="webgl2",e))(Nt||{}),Gt=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},xt=class{constructor(e){this.eventBus=e,this.TAG="[VideoPluginsAnalytics]",this.initTime={},this.preProcessingAvgs=new Gt,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new Gt,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(qe.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(qe.failure(e,t)),this.clean(e))}initWithTime(e,t){return _(this,null,(function*(){if(this.initTime[e])return void ye.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),ye.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let s=p.MediaPluginErrors.InitFailed("VIDEO_PLUGINS",`failed during initialization of plugin${t.message||t}`);throw ye.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)}))}preProcessWithTime(e){return _(this,null,(function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)}))}processWithTime(e,t){return _(this,null,(function*(){var r;let i;try{i=yield this.timeInMs(t)}catch(t){let a=p.MediaPluginErrors.ProcessingFailed("VIDEO_PLUGINS",`Failed during processing of plugin${t.message||t}`);throw ye.e(this.TAG,a),this.failure(e,a),a}i&&(null==(r=this.processingAvgs[e])||r.add(i))}))}timeInMs(e){return _(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}},Ut=320,Ft=240,$t=class{constructor(e,t){this.TAG="[VideoPluginsManager]",this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new xt(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return _(this,null,(function*(){var i;if(this.pluginAddInProgress){let t=null==(i=e.getName)?void 0:i.call(e);if(!t||""===t)return void ye.w("no name provided by the plugin");let s=p.MediaPluginErrors.AddAlreadyInProgress("VIDEO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.failure(t,s),ye.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}}))}addPluginInternal(e,t){return _(this,null,(function*(){var a,r;let i=null==(a=e.getName)?void 0:a.call(e);if(!i||""===i)return void ye.w("no name provided by the plugin");if(this.pluginsMap.has(i))return void ye.w(this.TAG,`plugin - ${e.getName()} already added.`);let n=this.hmsTrack.getMediaTrackSettings().frameRate||24,s=0;t&&t>0?(ye.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<n&&(s=Math.ceil(n/t)-1),this.analytics.added(i,n,t)):(ye.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(i,n)),ye.i(this.TAG,"numFrames to skip processing",s),this.pluginNumFramesToSkip[i]=s,this.pluginNumFramesSkipped[i]=s,this.validateAndThrow(i,e);try{if(yield this.analytics.initWithTime(i,(()=>_(this,null,(function*(){return yield e.init()})))),this.pluginsMap.set(i,e),this.pluginsMap.size+1>this.canvases.length)for(let e=this.canvases.length;e<=this.pluginsMap.size;e++)this.canvases[e]=document.createElement("canvas");yield this.startPluginsLoop(null==(r=e.getContextType)?void 0:r.call(e))}catch(t){throw ye.e(this.TAG,"failed to add plugin",t),yield this.removePlugin(e),t}}))}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)ye.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let t;switch(i.errType){case"PLATFORM_NOT_SUPPORTED":throw t=p.MediaPluginErrors.PlatformNotSupported("VIDEO_PLUGINS","platform not supported, see docs"),this.analytics.failure(e,t),t;case"DEVICE_NOT_SUPPORTED":throw t=p.MediaPluginErrors.DeviceNotSupported("VIDEO_PLUGINS","video device not supported, see docs"),this.analytics.failure(e,t),t}}}removePlugin(e){return _(this,null,(function*(){let t=e.getName();this.pluginsMap.get(t)?(ye.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),0===this.pluginsMap.size&&(ye.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)):ye.w(this.TAG,`plugin - ${t} not found to remove.`)}))}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return _(this,null,(function*(){if(this.pluginsLoopRunning&&"running"!==this.pluginsLoopState)for(;"paused"===this.pluginsLoopState;)yield Ze(100)}))}cleanup(){return _(this,null,(function*(){var e;for(let e of this.pluginsMap.values())yield this.removePlugin(e);null==(e=this.outputTrack)||e.stop()}))}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||"2d");let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return _(this,null,(function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw this.pluginsLoopRunning=!1,ye.e(this.TAG,"error in setting processed track",e),e}this.pluginsLoop().then((()=>{ye.d(this.TAG,"processLoop stopped")}))}}))}stopPluginsLoop(){return _(this,null,(function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),null==(e=this.outputTrack)||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)}))}pluginsLoop(){return _(this,null,(function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||24,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||"ended"===this.hmsTrack.nativeTrack.readyState){"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",yield Ze(t);continue}let i=0;try{yield this.analytics.preProcessWithTime((()=>_(this,null,(function*(){return yield this.doPreProcessing()}))));let e=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-e),i>t&&(i=t)}catch(e){ye.e(this.TAG,"error in plugins loop",e)}this.pluginsLoopState="running",yield Ze(t-i)}}))}doPreProcessing(){return _(this,null,(function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()}))}processFramesThroughPlugins(){return _(this,null,(function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let r=this.checkIfSkipRequired(i);if("TRANSFORM"===t.getPluginType()){let s=(a,e)=>_(this,null,(function*(){try{yield t.processVideoFrame(a,e,r)}catch(e){ye.e(this.TAG,`error in processing plugin ${i}`,e)}}));if(r)e===this.pluginsMap.size-1?yield s(this.canvases[e],this.outputCanvas):yield s(this.canvases[e],this.canvases[e+1]);else{let a=this.canvases[e],t=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,(()=>_(this,null,(function*(){return s(a,this.outputCanvas)})))):yield this.analytics.processWithTime(i,(()=>_(this,null,(function*(){return s(a,t)}))))}}else"ANALYZE"===t.getPluginType()&&!r&&(yield this.analytics.processWithTime(i,(()=>_(this,null,(function*(){return yield t.processVideoFrame(this.inputCanvas)})))))}catch(e){ye.e(this.TAG,`error in processing plugin ${i}`,e),yield this.removePlugin(t)}e++}}}))}addTrackToVideo(){return _(this,null,(function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;null!==t&&t instanceof MediaStream&&(null==(e=t.getVideoTracks()[0])?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())}))}updateInputCanvas(){return _(this,null,(function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=Ut,height:t=Ft}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)}))}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}};function jt(e,t){return function(i){return i in e&&e[i]!==t[i]}}var Bt=class e extends Rt{constructor(e,i,t,s,a=(new St).build()){super(e,i,t),this.eventBus=s,this._layerDefinitions=[],this.TAG="[HMSLocalVideoTrack]",this.isCurrentTab=!1,this.isPublished=!1,this.buildNewSettings=e=>{let{width:i,height:t,codec:s,maxFramerate:a,maxBitrate:r,deviceId:n,advanced:o,facingMode:u}=g(g({},this.settings),e);return new bt(i,t,s,a,n,o,r,u)},this.handleSettingsChange=e=>_(this,null,(function*(){let i=this.stream,t=jt(e,this.settings);if(t("maxBitrate")&&e.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),t("width")||t("height")||t("advanced"))if("video"===this.source){let s=yield this.replaceTrackWith(e);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}else yield this.nativeTrack.applyConstraints(e.toConstraints())})),this.handleDeviceChange=(e,i=!1)=>_(this,null,(function*(){if(jt(e,this.settings)("deviceId")&&"regular"===this.source){if(this.enabled){delete e.facingMode;let s=yield this.replaceTrackWith(e);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}i||Ve.updateSelection("videoInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId})}})),this.removeOrReplaceProcessedTrack=e=>_(this,null,(function*(){e?e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e):(this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0)})),e.tracks.push(this),this.setVideoHandler(new Mt(this)),this.settings=a,a.deviceId!==i.getSettings().deviceId&&i.enabled&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new $t(this,s),this.setFirstTrackId(this.trackId)}setSimulcastDefinitons(e){this._layerDefinitions=e}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(t){return _(this,null,(function*(){var i;if(t!==this.enabled){if("regular"===this.source){let r;r=t?yield this.replaceTrackWith(this.settings):yield this.replaceTrackWithBlank(),yield this.replaceSender(r,t),null==(i=this.nativeTrack)||i.stop(),this.nativeTrack=r,yield w(e.prototype,this,"setEnabled").call(this,t),t&&(yield this.pluginsManager.waitForRestart(),this.settings=this.buildNewSettings({deviceId:r.getSettings().deviceId})),this.videoHandler.updateSinks()}this.eventBus.localVideoEnabled.publish({enabled:t,track:this})}}))}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,i=!1){return _(this,null,(function*(){let t=this.buildNewSettings(e);yield this.handleDeviceChange(t,i),this.enabled&&!Qe(this.nativeTrack)?(yield this.handleSettingsChange(t),this.settings=t):this.settings=t}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,i){return _(this,null,(function*(){return this.pluginsManager.addPlugin(e,i)}))}removePlugin(e){return _(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){return _(this,null,(function*(){var t;w(e.prototype,this,"cleanup").call(this),this.transceiver=void 0,yield this.pluginsManager.cleanup(),null==(t=this.processedTrack)||t.stop(),this.isPublished=!1}))}cropTo(e){return _(this,null,(function*(){if(e&&"screen"===this.source)try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(e))}catch(e){throw ye.e(this.TAG,"failed to crop screenshare capture - ",e),p.TracksErrors.GenericTrack("TRACK","failed to crop screenshare capture")}}))}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(e){return _(this,null,(function*(){this.nativeTrack.enabled?(yield this.removeOrReplaceProcessedTrack(e),this.videoHandler.updateSinks()):this.processedTrack=e}))}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled&&this.processedTrack||this.nativeTrack}switchCamera(){return _(this,null,(function*(){var s;let e=this.getMediaTrackSettings().facingMode;if(!e||"regular"!==this.source)return void ye.d(this.TAG,"facingMode not supported");let i="environment"===e?"user":"environment";null==(s=this.nativeTrack)||s.stop();let t=yield this.replaceTrackWith(this.buildNewSettings({facingMode:i,deviceId:void 0}));yield this.replaceSender(t,this.enabled),this.nativeTrack=t,this.videoHandler.updateSinks(),this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId,facingMode:i}),Ve.updateSelection("videoInput",{deviceId:this.settings.deviceId,groupId:this.nativeTrack.getSettings().groupId})}))}replaceTrackWith(e){return _(this,null,(function*(){let i=this.nativeTrack;null==i||i.stop();try{let t=yield ze(e);return ye.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",t),"default"===this.settings.deviceId&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),t}catch(e){throw this.isPublished&&this.eventBus.analytics.publish(Oe.publish({error:e})),e}}))}replaceTrackWithBlank(){return _(this,null,(function*(){let e=this.nativeTrack,i=ai.getEmptyVideoTrack(e);return null==e||e.stop(),ye.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",e,"newTrack",i),i}))}replaceSender(e,i){return _(this,null,(function*(){let t=this.stream;i?yield t.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield t.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield t.replaceStreamTrack(this.nativeTrack,e)}))}},Vt=class e extends Rt{constructor(e,i,t){super(e,i,t),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new Wt,this.preferredLayer="high",this.setVideoHandler(new Mt(this))}setTrackId(e){this.bizTrackId=e}get trackId(){return this.bizTrackId||super.trackId}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(t){return _(this,null,(function*(){t!==this.enabled&&(w(e.prototype,this,"setEnabled").call(this,t),this.videoHandler.updateSinks(!0))}))}setPreferredLayer(e){return _(this,null,(function*(){if("none"!==e){if(this.preferredLayer=e,this.shouldSendVideoLayer(e,"preferLayer")){if(!this.hasSinks())return void ye.d(`[Remote Track] ${this.logIdentifier}\n        streamId=${this.stream.id} \n        trackId=${this.trackId}\n        saving ${e}, source=${this.source}\n        Track does not have any sink`);yield this.requestLayer(e,"preferLayer"),this.pushInHistory(`uiPreferLayer-${e}`)}}else ye.w("layer none will be ignored")}))}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}replaceTrack(e){this.nativeTrack=e.nativeTrack,e.transceiver&&(this.transceiver=e.transceiver,this.stream.updateId(e.stream.id)),this.videoHandler.updateSinks()}addSink(t,i=!0){return _(this,null,(function*(){Qe(this.nativeTrack)?yield this.requestLayer(this.preferredLayer,"addSink"):(w(e.prototype,this,"addSink").call(this,t),i&&(yield this.updateLayer("addSink"))),this.pushInHistory("uiSetLayer-high")}))}removeSink(t,i=!0){return _(this,null,(function*(){w(e.prototype,this,"removeSink").call(this,t),i&&(yield this.updateLayer("removeSink")),this._degraded=!1,this.pushInHistory("uiSetLayer-none")}))}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e){this._degraded=this.enabled&&(e.publisher_degraded||e.subscriber_degraded)&&"none"===e.current_layer,this._degradedAt=this._degraded?new Date:this._degradedAt;let i=e.current_layer;return ye.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id} \n      trackId=${this.trackId}\n      layer update from sfu\n      currLayer=${e.current_layer}\n      preferredLayer=${e.expected_layer}\n      sub_degraded=${e.subscriber_degraded}\n      pub_degraded=${e.publisher_degraded}\n      isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(i,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${i}`),this._degraded}updateLayer(e){return _(this,null,(function*(){let i=!this.degraded&&this.enabled&&this.hasSinks()?this.preferredLayer:"none";this.shouldSendVideoLayer(i,e)&&(yield this.requestLayer(i,e))}))}pushInHistory(e){}requestLayer(e,i){return _(this,null,(function*(){try{let t=yield this.stream.setVideoLayer(e,this.trackId,this.logIdentifier,i);return ye.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Requested layer ${e}, source=${i}`),t}catch(t){throw ye.d(`[Remote Track] ${this.logIdentifier} \n      streamId=${this.stream.id}\n      trackId=${this.trackId}\n      Failed to set layer ${e}, source=${i}\n      error=${t.message}`),t}}))}shouldSendVideoLayer(e,i){let t=this.getLayer();return!(!this.degraded||"none"!==e)||(t!==e||(ye.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${i}`),!1))}},Wt=class{constructor(){this.history=[]}push(e){e.time=(new Date).toISOString().split("T")[1],this.history.push(e)}},Ht=class extends Ue{constructor(){super(...arguments),this.TAG="[HMSLocalStream]",this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,i){let t=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:this.getTrackEncodings(e,i)});return this.setPreferredCodec(t,e.nativeTrack.kind),e.transceiver=t,t}setMaxBitrateAndFramerate(e){return _(this,null,(function*(){var i;yield null==(i=this.connection)?void 0:i.setMaxBitrateAndFramerate(e)}))}setPreferredCodec(e,i){}replaceStreamTrack(e,i){this.nativeStream.addTrack(i),this.nativeStream.removeTrack(e),ye.d(this.TAG,"Native stream tracks after replace",this.nativeStream.getAudioTracks().map(Fe),`prev Track - ${Fe(e)}`,`new Track - ${Fe(i)}`)}replaceSenderTrack(e,i){return _(this,null,(function*(){if(!this.connection||"closed"===this.connection.connectionState)return void ye.d(this.TAG,"publish connection is not initialised or closed");let t=this.connection.getSenders().find((s=>s.track&&s.track.id===e.id));void 0!==t?yield t.replaceTrack(i):ye.w(this.TAG,`No sender found for trackId=${e.id}`)}))}removeSender(e){var s,a;if(!this.connection||"closed"===this.connection.connectionState)return void ye.d(this.TAG,"publish connection is not initialised or closed");let i=null==(s=e.transceiver)?void 0:s.sender;if(!i)return void ye.w(this.TAG,`No sender found for trackId=${e.trackId}`);null==(a=this.connection)||a.removeTrack(i);let t=this.tracks.indexOf(e);-1!==t?this.tracks.splice(t,1):ye.w(this.TAG,`Cannot find ${e.trackId} in locally stored tracks`)}getTrackEncodings(e,i){let t=[];if(e instanceof Bt)if(i.length>0)ye.d(this.TAG,"Simulcast enabled with layers",i),t.push(...i);else{let s={active:this.nativeStream.active};e.settings.maxBitrate&&!de&&(s.maxBitrate=e.settings.maxBitrate),t.push(s)}return t}},qt=class extends Ue{constructor(e,i){super(e),this.audio=!0,this.video="none",this.connection=i}setAudio(e,i,t){return _(this,null,(function*(){this.audio!==e&&(this.audio=e,ye.d(`[Remote stream] ${t||""} \n    streamId=${this.id}\n    trackId=${i}\n    subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:i},method:"prefer-audio-track-state"}))}))}setVideoLayerLocally(e,i,t){this.video=e,ye.d(`[Remote stream] ${i}\n    streamId=${this.id}\n    source: ${t}\n    Setting layer field to=${e}`)}setVideoLayer(e,i,t,s){return ye.d(`[Remote stream] ${t} \n      streamId=${this.id}\n      trackId=${i} \n      source: ${s} request ${e} layer`),this.setVideoLayerLocally(e,t,s),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:i},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}};var Kt=(e,t,r,i)=>_(void 0,null,(function*(){var a;let n,s={};if(null!=(a=t.transceiver)&&a.sender.track){try{n=yield t.transceiver.sender.getStats();let e={},o={},l={};null==n||n.forEach((u=>{switch(u.type){case"outbound-rtp":o[u.id]=u;break;case"remote-inbound-rtp":l[u.ssrc]=u;break;case"codec":e[u.id]=u.mimeType}})),Object.keys(g({},o)).forEach((u=>{var n;let d,c=null==(n=o[u])?void 0:n.codecId,h=c?e[c]:void 0;h&&(d=h.substring(h.indexOf("/")+1));let v=o[u],m=l[v.ssrc];s[u]=C(g({},v),{bitrate:Xt("bytesSent",v,null==i?void 0:i[u]),packetsLost:null==m?void 0:m.packetsLost,jitter:null==m?void 0:m.jitter,roundTripTime:null==m?void 0:m.roundTripTime,totalRoundTripTime:null==m?void 0:m.totalRoundTripTime,peerName:r,peerID:t.peerId,enabled:t.enabled,codec:d})}))}catch(r){e.analytics.publish(Oe.rtcStatsFailed(p.WebrtcErrors.StatsFailed("TRACK",`Error getting local track stats ${t.trackId} - ${r.message}`))),ye.w("[HMSWebrtcStats]","Error in getting local track stats",t,r,r.name)}return s}})),Jt=(e,t,r,i)=>_(void 0,null,(function*(){var n;let o;try{o=yield null==(n=t.transceiver)?void 0:n.receiver.getStats()}catch(r){e.analytics.publish(Oe.rtcStatsFailed(p.WebrtcErrors.StatsFailed("TRACK",`Error getting remote track stats ${t.trackId} - ${r.message}`))),ye.w("[HMSWebrtcStats]","Error in getting remote track stats",t,r)}let s=zt(o),a=Xt("bytesReceived",s,i),l=li("packetsLost",s,i);return null!=s&&s.remote&&Object.assign(s.remote,{packetsLostRate:li("packetsLost",s.remote,null==i?void 0:i.remote)}),s&&Object.assign(s,{bitrate:a,packetsLostRate:l,peerId:t.peerId,enabled:t.enabled,peerName:r,codec:s.codec})})),zt=e=>{let t,r,i={};null==e||e.forEach((a=>{switch(a.type){case"inbound-rtp":case"outbound-rtp":t=a;break;case"remote-inbound-rtp":r=a;break;case"codec":i[a.id]=a.mimeType}}));let s,n=null!=t&&t.codecId?i[t.codecId]:void 0;return n&&(s=n.substring(n.indexOf("/")+1)),t&&Object.assign(t,{remote:r,codec:s})},Qt=(e,t,r)=>{let i=Yt(t),n=Xt("publish"===e?"bytesSent":"bytesReceived",i,r&&r[e]);return i&&Object.assign(i,{bitrate:n})},Yt=e=>{let t;return null==e||e.forEach((r=>{"transport"===r.type&&(t=null==e?void 0:e.get(r.selectedCandidatePairId))})),t||null==e||e.forEach((e=>{"candidate-pair"===e.type&&e.selected&&(t=e)})),t},Xt=(e,t,r)=>8*li(e,t,r),li=(e,t,r)=>{let i=t&&t[e],n=r?r[e]:null;return[t,r,Pe(i),Pe(n)].every((a=>!!a))?1e3*Zt(i,n,null==t?void 0:t.timestamp,null==r?void 0:r.timestamp):0},Zt=(e,t,r,i)=>Pe(e)&&Pe(t)&&r&&i?(e-t)/(r-i):0,ei=class{constructor(e,t,i){var r;this.getStats=e,this.store=t,this.eventBus=i,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.remoteTrackStats={},this.localTrackStats={},this.getLocalPeerStats=()=>this.peerStats[this.localPeerID],this.getRemoteTrackStats=e=>this.remoteTrackStats[e],this.getLocalTrackStats=()=>this.localTrackStats,this.updateStats=()=>_(this,null,(function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()})),this.updateLocalPeerStats=()=>_(this,null,(function*(){var u,e,t,r,n,o;let l,d=this.getLocalPeerStats();try{l=yield null==(e=(u=this.getStats).publish)?void 0:e.call(u)}catch(e){this.eventBus.analytics.publish(Oe.rtcStatsFailed(p.WebrtcErrors.StatsFailed("PUBLISH",e.message))),ye.w(this.TAG,"Error in getting publish stats",e)}let c,i=l&&Qt("publish",l,d);try{c=yield null==(r=(t=this.getStats).subscribe)?void 0:r.call(t)}catch(e){this.eventBus.analytics.publish(Oe.rtcStatsFailed(p.WebrtcErrors.StatsFailed("SUBSCRIBE",e.message))),ye.w(this.TAG,"Error in getting subscribe stats",e)}let s=c&&Qt("subscribe",c,d),{packetsLost:a,jitter:h}=(e=>{let t={packetsLost:0,jitter:0};return null==e||e.forEach((e=>{e.packetsLost&&(t.packetsLost+=e.packetsLost),e.jitter>t.jitter&&(t.jitter=e.jitter)})),t})(c),v=Zt(a,null==(n=null==d?void 0:d.subscribe)?void 0:n.packetsLost,null==s?void 0:s.timestamp,null==(o=null==d?void 0:d.subscribe)?void 0:o.timestamp),m=s&&Object.assign(s,{packetsLostRate:v,jitter:h,packetsLost:a});this.peerStats[this.localPeerID]={publish:i,subscribe:m}})),this.updateRemoteTrackStats=()=>_(this,null,(function*(){var i;let e=Array.from(this.store.getTracksMap().values()).filter((e=>e instanceof Vt||e instanceof Ct)),t=e.map((e=>e.trackId));Object.keys(this.remoteTrackStats).forEach((e=>{t.includes(e)||delete this.remoteTrackStats[e]}));for(let t of e){let s=t.peerId&&(null==(i=this.store.getPeerById(t.peerId))?void 0:i.name),a=this.getRemoteTrackStats(t.trackId),e=yield Jt(this.eventBus,t,s,a);e&&(this.remoteTrackStats[t.trackId]=e)}})),this.updateLocalTrackStats=()=>_(this,null,(function*(){var i;let e=this.store.getLocalPeerTracks().reduce(((e,s)=>(e[s.getTrackIDBeingSent()]=s,e)),{}),t=((e,t)=>Array.from(new Set(e.concat(t))))(Object.keys(this.localTrackStats),Object.keys(e));for(let r of t){let s=e[r];if(s){let a=null==(i=this.store.getLocalPeer())?void 0:i.name,e=yield Kt(this.eventBus,s,a,this.localTrackStats[r]);e&&(this.localTrackStats[r]=e)}else delete this.localTrackStats[r]}})),this.localPeerID=null==(r=this.store.getLocalPeer())?void 0:r.peerId}},ti=class{constructor(e,t,i,r){this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=r,this.TAG="[HMSWebrtcInternals]",this.interval=1e3,this.isMonitored=!1,this.handleStatsUpdate=()=>_(this,null,(function*(){var e;yield null==(e=this.hmsStats)?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)}))}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,r;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new ei({publish:null==(i=this.publishConnection)?void 0:i.getStats.bind(this.publishConnection),subscribe:null==(r=this.subscribeConnection)?void 0:r.getStats.bind(this.subscribeConnection)},this.store,this.eventBus)}start(){return _(this,null,(function*(){this.isMonitored?ye.d(this.TAG,"Already started"):(this.stop(),this.isMonitored=!0,ye.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then((()=>ye.d(this.TAG,"Stopping Webrtc Stats Monitor"))).catch((e=>{this.eventBus.analytics.publish(Oe.rtcStatsFailed(p.WebrtcErrors.StatsFailed("PUBLISH",e.message))),ye.e(this.TAG,e.message)})))}))}stop(){this.isMonitored=!1}startLoop(){return _(this,null,(function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield Ze(this.interval)}))}cleanup(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}},ii=D().version;ye.d("adapter",`${c.a.browserDetails.browser} v${c.a.browserDetails.version}`),ye.d("sdk version",ii);var si,ri,s,ni={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},ai=class e{constructor(e,t,i,r,s){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=r,this.analyticsTimer=s,this.TAG="[LocalTrackManager]",this.setScreenCaptureHandleConfig()}getTracksToPublish(){return _(this,arguments,(function*(e=ni){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,r=!!t.video,s=[],{videoTrack:a,audioTrack:n}=yield this.updateCurrentLocalTrackSettings(t),o=(null==a?void 0:a.stream)||(null==n?void 0:n.stream),l=!(!a||!this.store.getTrackById(a.trackId)),u=!(!n||!this.store.getTrackById(n.trackId));if(l&&u)return[];let d={audio:i&&!n&&(!e.isAudioMuted||"empty"),video:r&&!a&&(!e.isVideoMuted||"empty")};d.audio&&this.analyticsTimer.start("local_audio_track_time"),d.video&&this.analyticsTimer.start("local_video_track_time");try{ye.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:d}),s=yield this.getLocalTracks(d,t,o)}catch(e){s=yield this.retryGetLocalTracks(e,t,d,o)}return d.audio&&this.analyticsTimer.end("local_audio_track_time"),d.video&&this.analyticsTimer.end("local_video_track_time"),a&&r&&!l&&s.push(a),n&&i&&!u&&s.push(n),s}))}getLocalTracks(){return _(this,arguments,(function*(e={audio:!0,video:!0},t,i){try{let r=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(r,t,i)}catch(e){throw this.eventBus.analytics.publish(Oe.publish({devices:this.deviceManager.getDevices(),error:e,settings:t})),e}}))}getNativeLocalTracks(){return _(this,arguments,(function*(e={audio:!1,video:!1},t){let i=new Pt(!0===e.video?t.video:null,!0===e.audio?t.audio:null,t.simulcast),r=[];return(i.audio||i.video)&&r.push(...yield this.getAVTracks(i)),r.push(...this.getEmptyTracks(e)),r}))}getLocalScreen(e){return _(this,null,(function*(){var t;let s,r=yield this.getOrDefaultScreenshareConfig(e),i=this.getScreenshareSettings(r.videoOnly),n={video:C(g({},null==i?void 0:i.video.toConstraints(!0)),{displaySurface:r.displaySurface}),preferCurrentTab:r.preferCurrentTab,selfBrowserSurface:r.selfBrowserSurface,surfaceSwitching:r.surfaceSwitching,systemAudio:r.systemAudio};if(null!=i&&i.audio){let e=null==(t=null==i?void 0:i.audio)?void 0:t.toConstraints();delete e.advanced,n.audio=C(g({},e),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}try{ye.d("retrieving screenshare with ",{config:r},{constraints:n}),s=yield navigator.mediaDevices.getDisplayMedia(n)}catch(e){ye.w(this.TAG,"error in getting screenshare - ",e);let t=Ge(e,"screen");throw this.eventBus.analytics.publish(Oe.publish({error:t,devices:this.deviceManager.getDevices(),settings:new Pt(null==i?void 0:i.video,null==i?void 0:i.audio,!1)})),t}let a=[],o=new Ht(s),l=s.getVideoTracks()[0],d=new Bt(o,l,"screen",this.eventBus,null==i?void 0:i.video);d.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let e=this.validateCurrentTabCapture(d,r.forceCurrentTab);d.isCurrentTab=e,yield d.cropTo(r.cropTarget)}catch(e){throw s.getTracks().forEach((e=>e.stop())),e}a.push(d);let u=s.getAudioTracks()[0];if(u){let e=new It(o,u,"screen",this.eventBus,null==i?void 0:i.audio);a.push(e)}return ye.v(this.TAG,"getLocalScreen",a),a}))}setScreenCaptureHandleConfig(e){var t;null==(t=navigator.mediaDevices)||!t.setCaptureHandleConfig||this.isInIframe()||(e=e||{},Object.assign(e,{handle:Object(l.a)(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),ye.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),r=!(!this.captureHandleIdentifier||(null==i?void 0:i.handle)!==this.captureHandleIdentifier);if(t&&!r)throw ye.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),p.TracksErrors.CurrentTabNotShared();return r}requestPermissions(){return _(this,null,(function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach((e=>e.stop()))}catch(e){ye.e(this.TAG,e)}}))}static getEmptyVideoTrack(e){var t,r,n;let o=(null==(t=null==e?void 0:e.getSettings())?void 0:t.width)||320,i=(null==(r=null==e?void 0:e.getSettings())?void 0:r.height)||240;si||((si=document.createElement("canvas")).width=o,si.height=i,null==(n=si.getContext("2d"))||n.fillRect(0,0,o,i)),ri||(ri=setInterval((()=>{let u=null==si?void 0:si.getContext("2d");u&&u.fillRect(0,0,1,1)}),1e3));let a=si.captureStream(1).getVideoTracks()[0];return a.enabled=!1,a}static getEmptyAudioTrack(){let e=Ye.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let r=i.stream.getAudioTracks()[0];return r.enabled=!1,r}static cleanup(){clearInterval(ri),ri=void 0,si=void 0}getAVTracks(e){return _(this,null,(function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:!!e.audio&&e.audio.toConstraints(),video:!!e.video&&e.video.toConstraints()});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!(this.deviceManager.hasWebcamPermission||!e.video),r=!(this.deviceManager.hasMicrophonePermission||!e.audio);throw Ge(t,this.getErrorType(i,r))}}))}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return t||i?(new Et).video(i).audio(t).build():null}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,r){return _(this,null,(function*(){if(!(e instanceof Te&&"TRACK"===e.action))return ye.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[];{this.observer.onFailure(e);let s=e.code===ke.TracksErrors.OVER_CONSTRAINED,a=e.message.includes("audio"),n=e.message.includes("video");if(s){let n=(new Et).video(new bt).audio(new Tt).build();ye.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,n,r)}catch(e){let u=e instanceof Te?e.nativeError:e,n=e;if("OverconstrainedError"===(null==u?void 0:u.name)){let e=p.TracksErrors.GenericTrack("TRACK","Overconstrained error after dropping all constraints");e.addNativeError(u),n=e}return yield this.retryGetLocalTracks(n,t,i,r)}}i.audio=a?"empty":i.audio,i.video=n?"empty":i.video,ye.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,r)}catch(e){return ye.w(this.TAG,"Fetch empty tacks failed",e),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(e),yield this.getLocalTracks(i,t,r)}}}))}getErrorType(e,t){return e&&t?"audio, video":e?"video":t?"audio":"unknown(video or audio)"}getEmptyTracks(t){let r=[];return"empty"===t.audio&&r.push(e.getEmptyAudioTrack()),"empty"===t.video&&r.push(e.getEmptyVideoTrack()),r}updateCurrentLocalTrackSettings(e){return _(this,null,(function*(){let t=this.store.getLocalPeerTracks(),i=t.find((e=>"video"===e.type&&"regular"===e.source)),r=t.find((e=>"audio"===e.type&&"regular"===e.source)),s=t.find((e=>"video"===e.type&&"screen"===e.source));null!=e&&e.video&&(yield null==i?void 0:i.setSettings(e.video)),null!=e&&e.audio&&(yield null==r?void 0:r.setSettings(e.audio));let a=this.getScreenshareSettings(!0);return null!=a&&a.video&&(yield null==s?void 0:s.setSettings(null==a?void 0:a.video)),{videoTrack:i,audioTrack:r}}))}getAudioSettings(e){var a;let t=this.store.getPublishParams();if(!t||null==(a=t.allowed)||!a.includes("audio"))return null;let i=this.store.getLocalPeer(),r=null==i?void 0:i.audioTrack,s=(null==r?void 0:r.settings.deviceId)||e.audioInputDeviceId;return(new kt).codec(t.audio.codec).maxBitrate(t.audio.bitRate).deviceId(s||ni.audioInputDeviceId).build()}getVideoSettings(e){var t;let r=this.store.getPublishParams();if(!r||null==(t=r.allowed)||!t.includes("video"))return null;let i=this.store.getLocalPeer(),n=null==i?void 0:i.videoTrack,s=(null==n?void 0:n.settings.deviceId)||e.videoDeviceId,a=r.video;return(new St).codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(a.width).setHeight(a.height).deviceId(s||ni.videoDeviceId).build()}getScreenshareSettings(e=!1){var t;let r=this.store.getPublishParams();if(!r||null==(t=r.allowed)||!t.includes("screen"))return null;let i=r.screen;return{video:(new St).maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(i.width).setHeight(i.height).build(),audio:e?void 0:(new kt).build()}}getOrDefaultScreenshareConfig(e){return _(this,null,(function*(){var i;let t=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return t.forceCurrentTab&&(t.videoOnly=!0,t.preferCurrentTab=!0,t.selfBrowserSurface="include",t.surfaceSwitching="exclude"),t.preferCurrentTab&&(t.selfBrowserSurface="include",t.displaySurface=void 0),t.cropElement&&null!=(i=window.CropTarget)&&i.fromElement&&(t.cropTarget=yield window.CropTarget.fromElement(t.cropElement)),t}))}createHMSLocalTracks(e,t,i){let r=e.find((e=>"video"===e.kind)),s=e.find((e=>"audio"===e.kind));i?e.forEach((e=>null==i?void 0:i.nativeStream.addTrack(e))):i=new Ht(new MediaStream(e));let a=[];if(s&&null!=t&&t.audio){let e=new It(i,s,"regular",this.eventBus,t.audio);a.push(e)}if(r&&null!=t&&t.video){let e=new Bt(i,r,"regular",this.eventBus,t.video);e.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),a.push(e)}return a}},oi=class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="[NetworkTestManager]",this.controller=new AbortController,this.start=e=>_(this,null,(function*(){var t;if(!e)return;let{url:r,timeout:i,scoreMap:n}=e,s=this.controller.signal,a=Date.now(),o=0,l=Ze(i).then((()=>{this.controller.abort()}));try{let e=null==(t=(yield fetch(`${r}?${Date.now()}`,{signal:s})).body)?void 0:t.getReader();if(!e)throw Error("unable to process request");let d=()=>_(this,null,(function*(){if(e)try{let t=!1;for(;!t;){let{value:r,done:l}=yield e.read();t=l,r&&(o+=r.byteLength,this.sendScore({scoreMap:n,downloadedSize:o,startTime:a}))}}catch(e){"AbortError"!==e.name&&ye.d(this.TAG,e)}}));return Promise.race([d(),l]).then((()=>{this.sendScore({scoreMap:n,downloadedSize:o,startTime:a,finished:!0})})).catch((e=>{ye.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(Oe.previewNetworkQuality({error:e.message}))}))}catch(e){"AbortError"!==e.name?(ye.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(Oe.previewNetworkQuality({error:e.message}))):ye.d(this.TAG,e)}})),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:r=!1})=>{let n=t/1024/((Date.now()-i)/1e3)*8,o=-1;for(let t in e){let u=e[t];n>=u.low&&(!u.high||n<=u.high)&&(o=Number(t))}this.updateScoreToListener(o),r&&this.eventBus.analytics.publish(Oe.previewNetworkQuality({score:o,downLink:n.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,null==(i=null==(t=this.listener)?void 0:t.onNetworkQuality)||i.call(t,e))}},di=class{constructor(e,t,i,r,s,a){this.store=e,this.transport=t,this.deviceManager=i,this.publish=r,this.removeAuxiliaryTrack=s,this.listener=a,this.handleLocalPeerRoleUpdate=i=>_(this,[i],(function*({oldRole:e,newRole:t}){var s;let r=this.store.getLocalPeer();r&&(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),null==(s=this.listener)||s.onPeerUpdate(8,r))})),this.diffRolesAndPublishTracks=i=>_(this,[i],(function*({oldRole:e,newRole:t}){var r,n,o,l,d,c,h;let v=new Set(e.publishParams.allowed),s=new Set(t.publishParams.allowed),a=this.removeTrack(v,s,"video"),m=this.removeTrack(v,s,"audio"),f=this.removeTrack(v,s,"screen"),y=this.hasSimulcastDifference(null==(r=e.publishParams.simulcast)?void 0:r.video,null==(n=t.publishParams.simulcast)?void 0:n.video),u=this.hasSimulcastDifference(null==(o=e.publishParams.simulcast)?void 0:o.screen,null==(l=t.publishParams.simulcast)?void 0:l.screen),k=null==(c=null==(d=this.store.getLocalPeer())?void 0:d.videoTrack)?void 0:c.enabled;yield this.removeAudioTrack(m),yield this.removeVideoTracks(a||y),yield this.removeScreenTracks(f||u);let T=(null==(h=this.store.getConfig())?void 0:h.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};y&&(T.isVideoMuted=!k),yield this.publish(T),yield this.syncDevices(T,t)}))}syncDevices(e,t){return _(this,null,(function*(){(!e.isAudioMuted||!e.isVideoMuted)&&t.publishParams.allowed.length>0&&(yield this.deviceManager.init(!0))}))}removeVideoTracks(e){return _(this,null,(function*(){var i;if(!e)return;let t=this.store.getLocalPeer();null!=t&&t.videoTrack&&(t.videoTrack.isPublished?yield this.transport.unpublish([t.videoTrack]):yield t.videoTrack.cleanup(),null==(i=this.listener)||i.onTrackUpdate(1,t.videoTrack,t),t.videoTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"video"===e.type))}))}removeAudioTrack(e){return _(this,null,(function*(){var i;if(!e)return;let t=this.store.getLocalPeer();null!=t&&t.audioTrack&&(t.audioTrack.isPublished?yield this.transport.unpublish([t.audioTrack]):yield t.audioTrack.cleanup(),null==(i=this.listener)||i.onTrackUpdate(1,t.audioTrack,t),t.audioTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"audio"===e.type))}))}removeScreenTracks(e){return _(this,null,(function*(){e&&(yield this.removeAuxTracks((e=>"screen"===e.source)))}))}removeAuxTracks(e){return _(this,null,(function*(){let t=this.store.getLocalPeer();if(null!=t&&t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let t of i)e(t)&&(yield this.removeAuxiliaryTrack(t.trackId))}}))}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,r,s;return!(!e&&!t)&&((null==(i=null==e?void 0:e.layers)?void 0:i.length)!==(null==(r=null==t?void 0:t.layers)?void 0:r.length)||!(null==(s=null==e?void 0:e.layers)||!s.some((a=>{var e;let r=null==(e=null==t?void 0:t.layers)?void 0:e.find((e=>e.rid===a.rid));return(null==r?void 0:r.maxBitrate)!==a.maxBitrate||(null==r?void 0:r.maxFramerate)!==a.maxFramerate}))))}},ci=new class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new me("client-events"),this.isConnected=!0,this.env=null,this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env||!this.websocketURL)return void this.addEventToStorage(e);let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}},i="prod"===this.env?"https://event.100ms.live/v2/client/report":"https://event-nonprod.100ms.live/v2/client/report";fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then((t=>{if(401!==t.status){if(200!==t.status)throw Error(t.statusText);this.removeFromStorage(e)}else this.removeFromStorage(e)})).catch((t=>{ye.v(this.TAG,"Failed to send event",t,e),this.addEventToStorage(e)}))}flushFailedEvents(){let e=this.failedEvents.get();null==e||e.forEach((e=>this.sendEvent(e)))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find((i=>i.timestamp===e.timestamp))||(100===t.length&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex((t=>t.timestamp===e.timestamp));i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},ui=class{constructor(){this.knownRoles={},this.peers={},this.tracks=new Map,this.peerTrackStates={},this.speakers=[],this.roleDetailsArrived=!1,this.env="prod",this.simulcastEnabled=!1,this.userAgent=Re(this.env),this.polls=new Map}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(null==e?void 0:e.asRole)||(null==e?void 0:e.role);return null==t?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getTemplateAppData(){return this.templateAppData}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter((e=>!e.isLocal))}getPeers(){return Object.values(this.peers)}getPeerMap(){return this.peers}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Array.from(this.tracks.values())}getVideoTracks(){return this.getTracks().filter((e=>"video"===e.type))}getRemoteVideoTracks(){return this.getTracks().filter((e=>e instanceof Vt))}getAudioTracks(){return this.getTracks().filter((e=>"audio"===e.type))}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return null!=t&&t.videoTrack&&i.push(t.videoTrack),null!=t&&t.audioTrack&&i.push(t.audioTrack),i.concat((null==t?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}hasTrack(e){return this.tracks.has(e)}getTrackById(e){var t,s;let r=Array.from(this.tracks.values()).find((a=>a.trackId===e));if(r)return r;let i=this.getLocalPeer();if(i){if(null!=(t=i.audioTrack)&&t.isPublishedTrackId(e))return i.audioTrack;if(null!=(s=i.videoTrack)&&s.isPublishedTrackId(e))return i.videoTrack}}getPeerByTrackId(e){let t=Array.from(this.tracks.values()).find((i=>i.trackId===e));return null!=t&&t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map((e=>e.peer))}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=Re(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var i,t;if(this.knownRoles=e.known_roles,this.roleDetailsArrived=!0,this.templateAppData=e.app_data,!this.simulcastEnabled)return;let r=null==(i=this.knownRoles[e.name])?void 0:i.publishParams;this.videoLayers=this.convertSimulcastLayers(null==(t=r.simulcast)?void 0:t.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,r;if(Ve.rememberDevices(!!e.rememberDeviceSelection),e.rememberDeviceSelection){let s=Ve.getSelection();s&&(e.settings||(e.settings={}),null!=(t=s.audioInput)&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||s.audioInput.deviceId),null!=(i=s.audioOutput)&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||s.audioOutput.deviceId),null!=(r=s.videoInput)&&r.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||s.videoInput.deviceId))}e.autoManageVideo=!1!==e.autoManageVideo,e.autoManageWakeLock=!1!==e.autoManageWakeLock,this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks.set(e,e)}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){this.tracks.delete(e)}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return _(this,null,(function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)}))}updateAudioOutputDevice(e){return _(this,null,(function*(){let t=[];this.getAudioTracks().forEach((i=>{i instanceof Ct&&t.push(i.setOutputDevice(e))})),yield Promise.all(t)}))}getSimulcastLayers(e){var t;return this.simulcastEnabled&&["screen","regular"].includes(e)?"screen"===e?[]:(null==(t=this.videoLayers)?void 0:t.layers)||[]:[]}convertSimulcastLayers(e){if(e)return C(g({},e),{layers:(e.layers||[]).map((e=>C(g({},e),{maxBitrate:1e3*e.maxBitrate})))})}getSimulcastDefinitionsForPeer(e,t){var r,n,o;if([!e||!e.role,"screen"===t,!this.simulcastEnabled].some((u=>!!u)))return[];let l,s,a,i=this.getPolicyForRole(e.role.name).publishParams;return"regular"===t?(l=null==(r=i.simulcast)?void 0:r.video,s=i.video.width,a=i.video.height):"screen"===t&&(l=null==(n=i.simulcast)?void 0:n.screen,s=i.screen.width,a=i.screen.height),(null==(o=null==l?void 0:l.layers)?void 0:o.map((u=>({layer:ht[u.rid],resolution:{width:Math.floor(s/u.scaleResolutionDownBy),height:Math.floor(a/u.scaleResolutionDownBy)}}))))||[]}setPoll(e){this.polls.set(e.id,e)}getPoll(e){return this.polls.get(e)}getErrorListener(){return this.errorListener}cleanup(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach((e=>{var t;e.role?e.role=this.getPolicyForRole(e.role.name):null==(t=this.errorListener)||t.onError(p.GenericErrors.InvalidRole("VALIDATION",""))}))}setEnv(){var e;let t=(null==(e=this.config)?void 0:e.initEndpoint).split("https://")[1],i="prod";t.startsWith("prod")?i="prod":t.startsWith("qa")?i="qa":t.startsWith("dev")&&(i="dev"),this.env=i,ci.setEnv(i)}},hi=class{constructor(){this.TAG="[WakeLockManager]",this.wakeLock=null,this.acquireLock=()=>_(this,null,(function*(){yield this.requestWakeLock(),null==document||document.addEventListener("visibilitychange",this.visibilityHandler)})),this.cleanup=()=>_(this,null,(function*(){if(this.wakeLock&&!this.wakeLock.released)try{yield this.wakeLock.release(),ye.d(this.TAG,"Wake lock released")}catch(e){let t=e;ye.w(this.TAG,"Error while releasing wake lock",`name=${t.name}, message=${t.message}`)}this.wakeLock=null})),this.visibilityHandler=()=>_(this,null,(function*(){"visible"===(null==document?void 0:document.visibilityState)&&(!this.wakeLock||this.wakeLock.released)&&(ye.d(this.TAG,"Re-acquiring wake lock due to visibility change"),yield this.requestWakeLock())})),this.requestWakeLock=()=>_(this,null,(function*(){try{if(!("wakeLock"in navigator))return void ye.d(this.TAG,"Wake lock feature not supported");this.wakeLock=yield navigator.wakeLock.request("screen"),ye.d(this.TAG,"Wake lock acquired")}catch(e){let t=e;ye.w(this.TAG,"Error acquiring wake lock",`name=${t.name}, message=${t.message}`)}}))}},pi=class{constructor(e){this.store=e,this.bufferSize=100,this.TAG="[AnalyticsEventsService]",this.transport=null,this.pendingEvents=[],this.level=1}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let e=this.pendingEvents.shift();ye.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",e)}return this}flushFailedClientEvents(){ci.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=null==(e=this.store.getLocalPeer())?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(e){ye.w(this.TAG,"Flush Failed",e)}}sendClientEventOnHTTP(e){var t,s,a,r;let n=this.store.getRoom(),i=this.store.getLocalPeer();e.metadata.token=null==(t=this.store.getConfig())?void 0:t.authToken,e.metadata.peer={session_id:null==n?void 0:n.sessionId,room_id:null==n?void 0:n.id,room_name:null==n?void 0:n.name,template_id:null==n?void 0:n.templateId,joined_at:null==(s=null==n?void 0:n.joinedAt)?void 0:s.getTime(),session_started_at:null==(a=null==n?void 0:n.startedAt)?void 0:a.getTime(),role:null==(r=null==i?void 0:i.role)?void 0:r.name,user_name:null==i?void 0:i.name,user_data:null==i?void 0:i.metadata},ci.sendEvent(e)}},vi={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},gi=class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=g({},vi),this.handleAudioPaused=e=>_(this,null,(function*(){var s;let i=null==(s=e.target.srcObject)?void 0:s.getAudioTracks()[0];if(null==i||!i.enabled)return;ye.d(this.TAG,"Audio Paused",e.target.id);let t=this.store.getTrackById(e.target.id);t&&(ue()?(yield Ze(500),this.playAudioFor(t)):this.autoPausedTracks.add(t))})),this.handleTrackUpdate=({track:e})=>{ye.d(this.TAG,"Track updated",`${e}`)},this.handleTrackAdd=e=>_(this,[e],(function*({track:e,peer:t,callListener:i=!0}){var a,r;let s=document.createElement("audio");s.style.display="none",s.id=e.trackId,s.addEventListener("pause",this.handleAudioPaused),s.onerror=()=>_(this,null,(function*(){var r,u;ye.e(this.TAG,"error on audio element",s.error);let n=p.TracksErrors.AudioPlaybackError(`Audio playback error for track - ${e.trackId} code - ${null==(r=null==s?void 0:s.error)?void 0:r.code}`);this.eventBus.analytics.publish(Oe.audioPlaybackError(n)),(null==(u=null==s?void 0:s.error)?void 0:u.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(s,e),yield Ze(500),yield this.handleTrackAdd({track:e,peer:t,callListener:!1}))})),e.setAudioElement(s),e.setVolume(this.volume),ye.d(this.TAG,"Audio track added",`${e}`),this.init(),null==(a=this.audioSink)||a.append(s),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),s.srcObject=new MediaStream([e.nativeTrack]),i&&(null==(r=this.listener)||r.onTrackUpdate(0,e,t)),yield this.handleAutoplayError(e)})),this.handleAutoplayError=e=>_(this,null,(function*(){void 0===this.state.autoplayFailed&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise((t=>{this.playAudioFor(e).then(t)}))),yield this.state.autoplayCheckPromise),this.state.autoplayFailed?this.autoPausedTracks.add(e):yield this.playAudioFor(e)})),this.handleAudioDeviceChange=e=>{e.error||!e.selection||"video"===e.type||this.unpauseAudioTracks()},this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&0===this.audioSink.childElementCount&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),ye.d(this.TAG,"Audio track removed",`${e}`)},this.unpauseAudioTracks=()=>_(this,null,(function*(){let e=[];this.autoPausedTracks.forEach((t=>{e.push(this.playAudioFor(t))})),yield Promise.all(e)})),this.removeAudioElement=(e,t)=>{e&&(ye.d(this.TAG,"removing audio element",`${t}`),e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))},this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return _(this,null,(function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e}))}unblockAutoplay(){return _(this,null,(function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()}))}init(e){if(this.state.initialized||this.audioSink)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${Object(l.a)()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t,ye.d(this.TAG,"audio sink created",this.audioSink)}cleanup(){var e;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=g({},vi)}playAudioFor(e){return _(this,null,(function*(){let t=e.getAudioElement();if(t)try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),ye.d(this.TAG,"Played track",`${e}`)}catch(r){this.autoPausedTracks.add(e),ye.w(this.TAG,"Failed to play track",`${e}`,r);let t=r;if(!this.state.autoplayFailed&&"NotAllowedError"===t.name){this.state.autoplayFailed=!0;let s=p.TracksErrors.AutoplayBlocked("AUTOPLAY","");s.addNativeError(t),this.eventBus.analytics.publish(Oe.autoplayError()),this.eventBus.autoplayError.publish(s)}}else ye.w(this.TAG,"No audio element found on track",e.trackId)}))}},mi=class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.updateOutputDevice=e=>_(this,null,(function*(){let t=this.audioOutput.find((i=>i.deviceId===e));return t&&(this.outputDevice=t,yield this.store.updateAudioOutputDevice(t),Ve.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t})),this.getCurrentSelection=()=>{var a,e;let t=this.store.getLocalPeer(),r=this.createIdentifier(null==(a=null==t?void 0:t.audioTrack)?void 0:a.getMediaTrackSettings()),i=this.createIdentifier(null==(e=null==t?void 0:t.videoTrack)?void 0:e.getMediaTrackSettings()),n=this.audioInput.find((e=>this.createIdentifier(e)===r)),s=this.videoInput.find((e=>this.createIdentifier(e)===i));return{audioInput:n,videoInput:s,audioOutput:this.outputDevice}},this.computeChange=(e,t)=>e.length!==t.length||t.some((i=>!e.includes(this.createIdentifier(i)))),this.enumerateDevices=()=>_(this,null,(function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach((e=>{"audioinput"===e.kind&&e.label?(this.hasMicrophonePermission=!0,this.audioInput.push(e)):"audiooutput"===e.kind?this.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(this.hasWebcamPermission=!0,this.videoInput.push(e))})),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),Ve.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){ye.e(this.TAG,"Failed enumerating devices",e)}})),this.handleDeviceChange=et((()=>_(this,null,(function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(null==e?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(null==e?void 0:e.videoTrack),this.eventBus.analytics.publish(Oe.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}))),500).bind(this),this.handleAudioInputDeviceChange=e=>_(this,null,(function*(){if(!e)return void ye.d(this.TAG,"No Audio track on local peer");if(!this.audioInputChanged)return void ye.d(this.TAG,"No Change in AudioInput Device");let t=this.getNewAudioInputDevice();if(!t||!t.deviceId)return this.eventBus.analytics.publish(Oe.deviceChange({selection:{audioInput:t},error:p.TracksErrors.SelectedDeviceMissing("audio"),devices:this.getDevices(),type:"audioInput"})),void ye.e(this.TAG,"Audio device not found");let{settings:i}=e,r=(new kt).codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(e){ye.e(this.TAG,"[Audio Device Change]",e),this.eventBus.analytics.publish(Oe.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:e})),this.eventBus.deviceChange.publish({error:e,selection:t,type:"audioInput",devices:this.getDevices()})}})),this.handleVideoInputDeviceChange=e=>_(this,null,(function*(){if(!e)return void ye.d(this.TAG,"No video track on local peer");if(!this.videoInputChanged)return void ye.d(this.TAG,"No Change in VideoInput Device");let t=this.videoInput[0];if(!t||!t.deviceId)return this.eventBus.analytics.publish(Oe.deviceChange({selection:{videoInput:t},error:p.TracksErrors.SelectedDeviceMissing("video"),devices:this.getDevices(),type:"video"})),void ye.e(this.TAG,"Video device not found");let{settings:i}=e,r=(new St).codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(e){ye.e(this.TAG,"[Video Device Change]",e),this.eventBus.analytics.publish(Oe.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:e})),this.eventBus.deviceChange.publish({error:e,type:"video",selection:t,devices:this.getDevices()})}}));let i=({enabled:e,track:s})=>e&&"regular"===s.source;this.eventBus.localVideoEnabled.waitFor(i).then((()=>_(this,null,(function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})))),this.eventBus.localAudioEnabled.waitFor(i).then((()=>_(this,null,(function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))))}init(e=!1){return _(this,null,(function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(Oe.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))}))}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanup(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find((e=>"default"===e.deviceId));return e?this.audioInput.find((i=>"default"!==i.deviceId&&e.label.includes(i.label))):this.audioInput[0]}setOutputDevice(e=!1){return _(this,null,(function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>this.createIdentifier(e)===i)),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>"default"===e.deviceId))||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(Oe.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))}))}getAudioOutputDeviceMatchingInput(e){var t,s;let r=(null==(s=null==(t=this.store.getConfig())?void 0:t.settings)?void 0:s.speakerAutoSelectionBlacklist)||[];if("all"===r)return;let i=(null==e?void 0:e.label.toLowerCase())||"";return!r.some((a=>i.includes(a.toLowerCase())))&&null!=e&&e.groupId?this.audioOutput.find((a=>"default"!==e.deviceId&&a.label===e.label)):void 0}logDevices(e=""){ye.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}},fi=class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return _(this,null,(function*(){yield this.audioSinkManager.unblockAutoplay(),yield Ye.resumeContext()}))}},yi=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=e=>{this.eventEmitter.emit(this.eventName,e)},this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)},this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)},this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)},this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},ki=class{constructor(){this.eventEmitter=new h.EventEmitter2,this.deviceChange=new yi(G,this.eventEmitter),this.localAudioEnabled=new yi(x,this.eventEmitter),this.localVideoEnabled=new yi(U,this.eventEmitter),this.statsUpdate=new yi(F,this.eventEmitter),this.trackDegraded=new yi($,this.eventEmitter),this.trackRestored=new yi(j,this.eventEmitter),this.trackAudioLevelUpdate=new yi(B,this.eventEmitter),this.audioPluginFailed=new yi(H,this.eventEmitter),this.localAudioSilence=new yi(V,this.eventEmitter),this.analytics=new yi(W,this.eventEmitter),this.policyChange=new yi(K,this.eventEmitter),this.localRoleUpdate=new yi(J,this.eventEmitter),this.audioTrackUpdate=new yi(z,this.eventEmitter),this.audioTrackAdded=new yi(Q,this.eventEmitter),this.audioTrackRemoved=new yi(Y,this.eventEmitter),this.autoplayError=new yi(X,this.eventEmitter),this.leave=new yi(Z,this.eventEmitter)}},Ti=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof $e?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}},Si=class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var s,a,t;let r=e["speaker-list"],i=r.map((e=>({audioLevel:e.level,peer:this.store.getPeerById(e.peer_id),track:this.store.getTrackById(e.track_id)})));null==(s=this.audioListener)||s.onAudioLevelUpdate(i),this.store.updateSpeakers(i);let n=r[0];if(n){let e=this.store.getPeerById(n.peer_id);null==(a=this.listener)||a.onPeerUpdate(4,e)}else null==(t=this.listener)||t.onPeerUpdate(5,null)}},bi=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[BroadcastManager]"}handleNotification(e,t){"on-broadcast"===e&&this.handleBroadcast(t)}handleBroadcast(e){var t;let r=e.peer,i=e.info,n=e.roles,s=this.getSender(r),a=e.private?this.store.getLocalPeer():void 0,o=[];if(null!=n&&n.length){let u=this.store.getKnownRoles();for(let e of n)u[e]&&o.push(u[e])}let l=new O(C(g({},i),{sender:s,recipientRoles:o,recipientPeer:a,time:new Date(e.timestamp),id:e.message_id}));ye.d(this.TAG,`Received Message from sender=${null==r?void 0:r.peer_id}: ${l}`),null==(t=this.listener)||t.onMessageReceived(l)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=ne(e,this.store)),t}},Ei=class{constructor(e,t){this.store=e,this.listener=t}handleQualityUpdate(e){var t;let i=e.peers.map((s=>{let a=this.store.getPeerById(s.peer_id);return a&&a.updateNetworkQuality(s.downlink_score),{peerID:s.peer_id,downlinkQuality:s.downlink_score}}));null==(t=this.listener)||t.onConnectionQualityUpdate(i)}},Pi=class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.TAG="[TrackManager]",this.tracksToProcess=new Map,this.handleTrackAdd=e=>{ye.d(this.TAG,"ONTRACKADD",`${e}`),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()},this.handleTrackRemovedPermanently=e=>{ye.d(this.TAG,"ONTRACKREMOVE",e),Object.keys(e.tracks).forEach((i=>{var e;let t=this.store.getTrackState(i);if(!t)return;let s=this.store.getTrackById(i);if(!s)return void ye.d(this.TAG,"Track not found in store");"audio"===s.type&&this.eventBus.audioTrackRemoved.publish(s),this.store.removeTrack(s);let a=this.store.getPeerById(t.peerId);a&&(this.removePeerTracks(a,s),null==(e=this.listener)||e.onTrackUpdate(1,s,a))}))},this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],r=this.store.getTrackById(t);!r||!this.store.getPeerByTrackId(t)||r instanceof Vt&&this.setLayer(r,i)}},this.handleTrackUpdate=(e,t=!0)=>{var s,a;let i=this.store.getPeerById(e.peer.peer_id),r=e.peer;if(i||r){i||(i=ne(r,this.store),this.store.addPeer(i));for(let r in e.tracks){let n=Object.assign({},null==(s=this.store.getTrackState(r))?void 0:s.trackInfo),o=e.tracks[r],u=this.store.getTrackById(r);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:g(g({},n),o)}),!u||this.tracksToProcess.has(r))this.processTrackInfo(o,e.peer.peer_id,t),this.processPendingTracks();else{u.setEnabled(!o.mute);let e=this.processTrackUpdate(u,n,o);e&&(null==(a=this.listener)||a.onTrackUpdate(e,u,i))}}}else ye.d(this.TAG,"Track Update ignored - Peer not added to store")},this.processTrackInfo=(e,t,i)=>{},this.processPendingTracks=()=>{new Map(this.tracksToProcess).forEach((e=>{var s;let i=this.store.getTrackState(e.trackId);if(!i)return void ye.d(this.TAG,"TrackState not added to store",`peerId - ${e.peerId}`,`trackId -${e.trackId}`);let t=this.store.getPeerById(i.peerId);t?(e.source=i.trackInfo.source,e.peerId=t.peerId,e.logIdentifier=t.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(t,e),this.addVideoTrack(t,e),"audio"===e.type?this.eventBus.audioTrackAdded.publish({track:e,peer:t}):null==(s=this.listener)||s.onTrackUpdate(0,e,t),this.tracksToProcess.delete(e.trackId)):ye.d(this.TAG,"Peer not added to store, peerId",i.peerId)}))}}handleTrackMetadataAdd(e){ye.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks){let i=e.tracks[t];this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:i})}this.processPendingTracks()}handleTrackRemove(e,t=!0){var s;ye.d(this.TAG,"ONTRACKREMOVE",`${e}`);let i=this.store.getTrackState(e.trackId);if(i)if(this.store.hasTrack(e)){if(t){this.store.removeTrack(e);let a=this.store.getPeerById(i.peerId);if(!a)return;this.removePeerTracks(a,e),null==(s=this.listener)||s.onTrackUpdate(1,e,a),"audio"===e.type&&this.eventBus.audioTrackRemoved.publish(e)}}else ye.d(this.TAG,"Track not found in store")}setLayer(e,t){var s,a;let i=this.store.getPeerByTrackId(e.trackId);i&&(e.setLayerFromServer(t)?null==(s=this.listener)||s.onTrackUpdate(5,e,i):null==(a=this.listener)||a.onTrackUpdate(6,e,i))}removePeerTracks(e,t){let i=e.auxiliaryTracks.indexOf(t);i>-1?(e.auxiliaryTracks.splice(i,1),ye.d(this.TAG,"auxiliary track removed",`${t}`)):"audio"===t.type&&e.audioTrack===t?(e.audioTrack=void 0,ye.d(this.TAG,"audio track removed",`${t}`)):"video"===t.type&&e.videoTrack===t&&(e.videoTrack=void 0,ye.d(this.TAG,"video track removed",`${t}`))}addAudioTrack(e,t){var i;"audio"===t.type&&("regular"!==t.source||e.audioTrack&&(null==(i=e.audioTrack)?void 0:i.trackId)!==t.trackId?e.auxiliaryTracks.push(t):e.audioTrack=t,this.store.addTrack(t),ye.d(this.TAG,"audio track added",`${t}`))}addVideoTrack(e,t){if("video"!==t.type)return;let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);if(i.setSimulcastDefinitons(r),this.addAsPrimaryVideoTrack(e,i))e.videoTrack?e.videoTrack.replaceTrack(i):e.videoTrack=i,this.store.addTrack(e.videoTrack);else{let s=e.auxiliaryTracks.findIndex((a=>a.trackId===i.trackId));-1===s?(e.auxiliaryTracks.push(i),this.store.addTrack(i)):(e.auxiliaryTracks[s].replaceTrack(i),this.store.addTrack(e.auxiliaryTracks[s]))}ye.d(this.TAG,"video track added",`${t}`)}addAsPrimaryVideoTrack(e,t){var i;return"regular"===t.source&&(!e.videoTrack||(null==(i=e.videoTrack)?void 0:i.trackId)===t.trackId)}processTrackUpdate(e,t,i){let r;return t.mute!==i.mute?(r=i.mute?2:3,"audio"===e.type&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(r=4),r}},Ai=class extends Pi{constructor(e,i,t,s){super(e,i,s),this.transport=t,this.TAG="[OnDemandTrackManager]",this.processTrackInfo=(e,i,t=!0)=>{var r;if("video"!==e.type)return;let s=this.store.getPeerById(i);if(!s||!this.isPeerRoleSubscribed(i))return void ye.d(this.TAG,`no peer in store for peerId: ${i}`);let a=new qt(new MediaStream,this.transport.getSubscribeConnection()),n=ai.getEmptyVideoTrack();n.enabled=!e.mute;let o=new Vt(a,n,e.source);o.setTrackId(e.track_id),o.peerId=s.peerId,o.logIdentifier=s.name,this.addVideoTrack(s,o),t&&(null==(r=this.listener)||r.onTrackUpdate(0,s.videoTrack,s))}}handleTrackMetadataAdd(e){super.handleTrackMetadataAdd(e);for(let i in e.tracks)"video"===e.tracks[i].type&&this.processTrackInfo(e.tracks[i],e.peer.peer_id)}handleTrackRemove(e){let i="video"===e.type&&"regular"===e.source;super.handleTrackRemove(e,!i),i&&this.processTrackInfo({track_id:e.trackId,mute:!e.enabled,type:e.type,source:e.source,stream_id:e.stream.id},e.peerId,!1)}addAsPrimaryVideoTrack(e,i){return"regular"===i.source&&(!e.videoTrack||e.videoTrack.trackId===i.trackId||e.videoTrack.enabled&&Qe(e.videoTrack.nativeTrack))}isPeerRoleSubscribed(e){var s,a,t,r;if(!e)return!0;let i=this.store.getLocalPeer(),n=this.store.getPeerById(e);return n&&(null==(r=null==(a=null==(s=null==i?void 0:i.role)?void 0:s.subscribeParams)?void 0:a.subscribeToRoles)?void 0:r.includes(null==(t=n.role)?void 0:t.name))}},Ii=class{constructor(e,t,i,r){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=r,this.TAG="[PeerListManager]",this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)},this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)},this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;null!=t?(Object.keys(t).forEach((i=>{t[i].tracks={},t[i].is_from_room_state=!0})),this.handleRepeatedPeerList(t)):0===e.peer_count&&this.handleRepeatedPeerList({})},this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),r=t.filter((a=>!e[a.peerId]));r.length>0&&ye.d(this.TAG,`${r}`),r.forEach((a=>{var e;let t={peer_id:a.peerId,role:(null==(e=a.role)?void 0:e.name)||"",info:{name:a.name,data:a.metadata||"",user_id:a.customerUserId||""},tracks:{},groups:[],realtime:a.realtime};this.peerManager.handlePeerLeave(t)}));let s=[];i.forEach((a=>{let e=this.store.getPeerById(a.peer_id),t=Object.values(a.tracks);e&&(this.store.getPeerTracks(e.peerId).forEach((u=>{var t;a.tracks[u.trackId]||(this.removePeerTrack(e,u.trackId),null==(t=this.listener)||t.onTrackUpdate(1,u,e))})),t.forEach((u=>{this.store.getTrackById(u.track_id)||this.store.setTrackState({peerId:e.peerId,trackInfo:u})})),this.trackManager.handleTrackUpdate({peer:a,tracks:a.tracks},!1),this.peerManager.handlePeerUpdate(a)),s.push(a)})),s.length>0&&this.peerManager.handlePeerList(s)}}handleNotification(e,t,i){if("peer-list"===e){let e=t;i?(ye.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(e,null,2)),this.handleReconnectPeerList(e)):(ye.d(this.TAG,"PEER_LIST event",JSON.stringify(e,null,2)),this.handleInitialPeerList(e))}else if("room-state"===e){let e=t;this.handlePreviewRoomState(e)}}removePeerTrack(e,t){var i,r;if(ye.d(this.TAG,`removing track - ${t} from ${e}`),(null==(i=e.audioTrack)?void 0:i.trackId)===t)e.audioTrack=void 0;else if((null==(r=e.videoTrack)?void 0:r.trackId)===t)e.videoTrack=void 0;else{let s=e.auxiliaryTracks.findIndex((a=>a.trackId===t));s>=0&&e.auxiliaryTracks.splice(s,1)}}},b=e=>e?new Date(e):void 0,Ci=class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.TAG="[PeerManager]",this.handlePeerList=e=>{var t,s;if(0===e.length)return void(null==(t=this.listener)||t.onPeerUpdate(9,[]));let r=[],i=new Set(e.map((a=>a.peer_id)));this.store.getRemotePeers().forEach((({peerId:a,fromRoomState:e})=>{!i.has(a)&&e&&this.store.removePeer(a)}));for(let a of e)r.push(this.makePeer(a));null==(s=this.listener)||s.onPeerUpdate(9,r),this.trackManager.processPendingTracks()},this.handlePeerJoin=e=>{var i;let t=this.makePeer(e);null==(i=this.listener)||i.onPeerUpdate(0,t),this.trackManager.processPendingTracks()},this.handlePeerLeave=e=>{var i,t,s,a;let r=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),ye.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),r&&(r.audioTrack&&(null==(i=this.listener)||i.onTrackUpdate(1,r.audioTrack,r)),r.videoTrack&&(null==(t=this.listener)||t.onTrackUpdate(1,r.videoTrack,r)),null==(s=r.auxiliaryTracks)||s.forEach((e=>{var t;null==(t=this.listener)||t.onTrackUpdate(1,e,r)})),null==(a=this.listener)||a.onPeerUpdate(1,r))}}handleNotification(e,t){switch(e){case"on-peer-join":{let i=t;this.handlePeerJoin(i);break}case"on-peer-leave":{let i=t;this.handlePeerLeave(i);break}case"on-peer-update":this.handlePeerUpdate(t)}}handlePeerUpdate(e){var s,a,t,r,n;let o=this.store.getPeerById(e.peer_id);if(!o&&e.realtime)return o=this.makePeer(e),void(null==(s=this.listener)||s.onPeerUpdate(o.isHandRaised?12:14,o));if(o&&!o.isLocal&&!e.realtime)return this.store.removePeer(o.peerId),void(null==(a=this.listener)||a.onPeerUpdate(13,o));if(!o)return void ye.d(this.TAG,`peer ${e.peer_id} not found`);if(o.role&&o.role.name!==e.role){let u=this.store.getPolicyForRole(e.role);o.updateRole(u),this.updateSimulcastLayersForPeer(o),null==(t=this.listener)||t.onPeerUpdate(8,o)}let i=o.isHandRaised;o.updateGroups(e.groups),i!==(null==(r=e.groups)?void 0:r.includes(q))&&(null==(n=this.listener)||n.onPeerUpdate(12,o)),this.handlePeerInfoUpdate(g({peer:o},e.info))}handlePeerInfoUpdate({peer:e,name:t,data:i}){var r,s;e&&(t&&e.name!==t&&(e.updateName(t),null==(r=this.listener)||r.onPeerUpdate(10,e)),i&&e.metadata!==i&&(e.updateMetadata(i),null==(s=this.listener)||s.onPeerUpdate(11,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);t||(t=ne(e,this.store),t.realtime=e.realtime,t.joinedAt=b(e.joined_at),t.fromRoomState=!!e.is_from_room_state,this.store.addPeer(t),ye.d(this.TAG,"adding to the peerList",`${t}`));for(let i in e.tracks){let t=e.tracks[i];this.store.setTrackState({peerId:e.peer_id,trackInfo:t}),"video"===t.type&&this.trackManager.processTrackInfo(t,e.peer_id,!1)}return t}updateSimulcastLayersForPeer(e){this.store.getPeerTracks(e.peerId).forEach((t=>{if("video"===t.type&&["regular","screen"].includes(t.source)){let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(r)}}))}},Ri=class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let r=e.known_roles[e.name];t.updateRole(r)}this.store.setKnownRoles(e);let i=this.store.getRoom();i?i.templateId=e.template_id:ye.w("[PolicyChangeManager]","on policy change - room not present"),this.updateLocalPeerRole(e),this.eventBus.policyChange.publish(e)}updateLocalPeerRole(e){var i;let t=this.store.getLocalPeer();if(null!=t&&t.role&&t.role.name!==e.name){let r=this.store.getPolicyForRole(e.name),s=t.role;t.updateRole(r),r.name===(null==(i=t.asRole)?void 0:i.name)&&delete t.asRole,this.eventBus.localRoleUpdate.publish({oldRole:s,newRole:r})}}},wi=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){switch(e){case"on-poll-start":this.handlePollStart(t);break;case"on-poll-stop":this.handlePollStop(t);break;case"on-poll-stats":this.handlePollStats(t)}}handlePollStart(e){return _(this,null,(function*(){var i;let t=[];for(let r of e.polls){if(this.store.getPoll(r.poll_id))return;let s=yield this.transport.getPollQuestions({poll_id:r.poll_id,index:0,count:50}),a={id:r.poll_id,title:r.title,startedBy:r.started_by,createdBy:r.created_by,anonymous:r.anonymous,type:r.type,duration:r.duration,locked:r.locked,mode:r.mode,visibility:r.visibility,rolesThatCanVote:r.vote||[],rolesThatCanViewResponses:r.responses||[],state:r.state,stoppedBy:r.stopped_by,startedAt:b(r.started_at),stoppedAt:b(r.stopped_at),createdAt:b(r.created_at),questions:s.questions.map((({question:e,options:t,answer:r})=>C(g({},e),{options:t,answer:r})))};t.push(a),this.store.setPoll(a)}null==(i=this.listener)||i.onPollsUpdate(1,t)}))}handlePollStop(e){return _(this,null,(function*(){var i;let t=[];for(let r of e.polls){let s=this.store.getPoll(r.poll_id);if(s){s.state="stopped",s.stoppedAt=b(r.stopped_at),s.stoppedBy=r.stopped_by;let a=yield this.transport.getPollResult({poll_id:r.poll_id});this.updatePollResult(s,a),t.push(s)}}t.length>0&&(null==(i=this.listener)||i.onPollsUpdate(2,t))}))}handlePollStats(e){return _(this,null,(function*(){var i,t;let r=[];for(let s of e.polls){let a=this.store.getPoll(s.poll_id);if(!a)return;this.updatePollResult(a,s),null==(i=(yield this.transport.getPollResponses({poll_id:s.poll_id,index:0,count:50,self:!1})).responses)||i.forEach((({response:e,peer:t,final:u})=>{var r;let n=null==(r=null==a?void 0:a.questions)?void 0:r.find((t=>t.index===e.question));if(!n)return;let o={id:e.response_id,questionIndex:e.question,option:e.option,options:e.options,text:e.text,responseFinal:u,peer:{peerid:t.peerid,userHash:t.hash,userid:t.userid,username:t.username},skipped:e.skipped,type:e.type,update:e.update};Array.isArray(n.responses)&&n.responses.length>0?n.responses.find((({id:e})=>e===o.id))||n.responses.push(o):n.responses=[o]})),r.push(a)}r.length>0&&(null==(t=this.listener)||t.onPollsUpdate(3,r))}))}updatePollResult(e,t){var i;e.result=g({},e.result),e.result.totalUsers=t.user_count,e.result.maxUsers=t.max_user,e.result.totalResponses=t.total_response,null==(i=t.questions)||i.forEach((t=>{var a,r;let s=null==(a=e.questions)?void 0:a.find((e=>e.index===t.question));s&&(s.result=g({},s.result),s.result.correctResponses=t.correct,s.result.skippedCount=t.skipped,s.result.totalResponses=t.total,null==(r=t.options)||r.forEach(((e,t)=>{var r;let u=null==(r=s.options)?void 0:r[t];u&&u.voteCount!==e&&(u.voteCount=e)})))}))}},_i=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case"on-role-change-request":this.handleRoleChangeRequest(t);break;case"on-track-update-request":this.handleTrackUpdateRequest(t);break;case"on-change-track-mute-state-request":this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var i;let t={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};null==(i=this.listener)||i.onRoleChangeRequest(t)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:r}=e,s=t?this.store.getPeerById(t):void 0,a=this.store.getLocalPeerTracks().find((e=>e.publishedTrackId===i));if(!a)return;let n=()=>{var e;null==(e=this.listener)||e.onChangeTrackStateRequest({requestedBy:s,track:a,enabled:!r})};if(r){if(a.enabled===!r)return;a.setEnabled(!r).then(n)}else n()}handleChangeTrackStateRequest(e){var t;let{type:r,source:i,value:n,requested_by:s}=e,a=s?this.store.getPeerById(s):void 0,o=!n,l=this.getTracksToBeUpdated({type:r,source:i,enabled:o});if(0!==l.length)if(o)null==(t=this.listener)||t.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,type:r,source:i,enabled:!0});else{let u=[];for(let e of l)u.push(e.setEnabled(!1));Promise.all(u).then((()=>{var e;null==(e=this.listener)||e.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,enabled:!1})}))}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter((a=>a.type===e))),t&&(s=s.filter((a=>a.source===t))),s.filter((a=>a.enabled!==i))}},Di=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case"peer-list":this.onRoomState(t.room);break;case"on-rtmp-start":this.onRTMPStart(t);break;case"on-rtmp-stop":this.onRTMPStop(t);break;case"on-record-start":this.onRecordingStart(t);break;case"on-record-stop":this.onRecordingStop(t);break;case"room-state":this.handlePreviewRoomState(t);break;case"room-info":this.handleRoomInfo(t);break;case"session-info":this.handleSessionInfo(t);break;default:this.onHLS(e,t)}}handleRoomInfo(e){let t=this.store.getRoom();t?(t.description=e.description,t.large_room_optimization=e.large_room_optimization,t.max_size=e.max_size,t.name=e.name):ye.w(this.TAG,"on session info - room not present")}handleSessionInfo(e){var i;let t=this.store.getRoom();t?(t.sessionId=e.session_id,t.peerCount!==e.peer_count&&(t.peerCount=e.peer_count,null==(i=this.listener)||i.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",t))):ye.w(this.TAG,"on session info - room not present")}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t)}onRoomState(e){var t,r,u;let{recording:n,streaming:i,session_id:o,started_at:s,name:a}=e,l=this.store.getRoom();l?(l.name=a,l.recording.server.running=!(null==n||!n.sfu.enabled),l.recording.browser.running=!(null==n||!n.browser.enabled),l.rtmp.running=!(null==(t=null==i?void 0:i.rtmp)||!t.enabled),l.rtmp.startedAt=b(null==(r=null==i?void 0:i.rtmp)?void 0:r.started_at),l.recording.server.startedAt=b(null==n?void 0:n.sfu.started_at),l.recording.browser.startedAt=b(null==n?void 0:n.browser.started_at),l.recording.hls=this.getPeerListHLSRecording(n),l.hls=this.convertHls(null==i?void 0:i.hls),l.sessionId=o,l.startedAt=b(s),null==(u=this.listener)||u.onRoomUpdate("RECORDING_STATE_UPDATED",l)):ye.w(this.TAG,"on room state - room not present")}onRTMPStart(e){var t;this.setRTMPStatus(!(null!=(t=e.error)&&t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!(null!=(t=e.error)&&t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}onHLS(e,t){var r,s;if(!["on-hls-init","on-hls-start","on-hls-stop"].includes(e))return;let i=this.store.getRoom();i?(t.enabled=["on-hls-init","on-hls-start"].includes(e)&&!(null!=(r=t.error)&&r.code),i.hls=this.convertHls(t),i.recording.hls=this.getHLSRecording(t),null==(s=this.listener)||s.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",i)):ye.w(this.TAG,"on hls - room not present")}convertHls(e){var i;let t={running:!(null==e||!e.enabled),variants:[],error:this.toSdkError(null==e?void 0:e.error)};return null==(i=null==e?void 0:e.variants)||i.forEach((e=>{t.variants.push({meetingURL:e.meeting_url,url:e.url,metadata:e.metadata,startedAt:b(e.started_at)})})),t}getHLSRecording(e){var i,t,s;let r={running:!1};return null!=e&&e.hls_recording&&(r={running:!(null==e||!e.enabled),singleFilePerLayer:!(null==(i=e.hls_recording)||!i.single_file_per_layer),hlsVod:!(null==(t=e.hls_recording)||!t.hls_vod),startedAt:b(null==(s=null==e?void 0:e.variants)?void 0:s[0].started_at),error:this.toSdkError(e.error)}),r}getPeerListHLSRecording(e){var i,t;let r=null==e?void 0:e.hls;return{running:!(null==r||!r.enabled),startedAt:b(null==r?void 0:r.started_at),singleFilePerLayer:!(null==(i=null==r?void 0:r.config)||!i.single_file_per_layer),hlsVod:!(null==(t=null==r?void 0:r.config)||!t.hls_vod)}}setRecordingStatus(e,t){var s;let r,i=this.store.getRoom();i?("sfu"===t.type?(i.recording.server={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},r="SERVER_RECORDING_STATE_UPDATED"):(i.recording.browser={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},r="BROWSER_RECORDING_STATE_UPDATED"),null==(s=this.listener)||s.onRoomUpdate(r,i)):ye.w(this.TAG,`set recording status running=${e} - room not present`)}setRTMPStatus(e,t){var r;let i=this.store.getRoom();i?(i.rtmp={running:e,startedAt:e?b(t.started_at):void 0,error:this.toSdkError(t.error)},null==(r=this.listener)||r.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",i)):ye.w(this.TAG,"on policy change - room not present")}toSdkError(e){if(null==e||!e.code)return;let t=e.message||"error in streaming/recording",i=new Te(e.code,"ServerErrors","NONE",t,t);return ye.e(this.TAG,"error in streaming/recording",i),i}},Oi=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){"on-metadata-change"===e&&this.handleMetadataChange(t)}handleMetadataChange(e){var i;let t=e.values.map((e=>({key:e.key,value:e.data,updatedAt:b(e.updated_at),updatedBy:e.updated_by?this.store.getPeerById(e.updated_by):void 0})));null==(i=this.listener)||i.onSessionStoreUpdate(t)}},Mi=class{constructor(e,t,i,r,s,a){this.store=e,this.transport=i,this.listener=r,this.audioListener=s,this.connectionQualityListener=a,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=e=>{if("peer-list"===e)this.hasConsistentRoomStateArrived=!0;else if("room-state"===e)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)},this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)},this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};let n=this.transport.isFlagEnabled("onDemandTracks");this.trackManager=n?new Ai(this.store,t,this.transport,this.listener):new Pi(this.store,t,this.listener),this.peerManager=new Ci(this.store,this.trackManager,this.listener),this.peerListManager=new Ii(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new bi(this.store,this.listener),this.policyChangeManager=new Ri(this.store,t),this.requestManager=new _i(this.store,this.listener),this.activeSpeakerManager=new Si(this.store,this.listener,this.audioListener),this.connectionQualityManager=new Ei(this.store,this.connectionQualityListener),this.roomUpdateManager=new Di(this.store,this.listener),this.sessionMetadataManager=new Oi(this.store,this.listener),this.pollsManager=new wi(this.store,this.transport,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e,this.sessionMetadataManager.listener=e,this.pollsManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var s,a;let i=e.method,r=e.params;["active-speakers","sfu-stats","on-connection-quality-update",void 0].includes(i)||ye.d(this.TAG,`Received notification - ${i}`,{notification:r}),"sfu-stats"===i&&null!=(s=window.HMS)&&s.ON_SFU_STATS&&"function"==typeof(null==(a=window.HMS)?void 0:a.ON_SFU_STATS)&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(i)&&(this.roomUpdateManager.handleNotification(i,r),this.peerManager.handleNotification(i,r),this.requestManager.handleNotification(i,r),this.peerListManager.handleNotification(i,r,t),this.broadcastManager.handleNotification(i,r),this.sessionMetadataManager.handleNotification(i,r),this.pollsManager.handleNotification(i,r),this.handleIsolatedMethods(i,r))}handleIsolatedMethods(e,t){switch(e){case"on-track-add":this.trackManager.handleTrackMetadataAdd(t);break;case"on-track-update":this.trackManager.handleTrackUpdate(t);break;case"on-track-remove":if(!t.peer)return void ye.d(this.TAG,`Ignoring sfu notification - ${e}`,{notification:t});this.trackManager.handleTrackRemovedPermanently(t);break;case"on-track-layer-update":this.trackManager.handleTrackLayerUpdate(t);break;case"active-speakers":this.activeSpeakerManager.handleActiveSpeakers(t);break;case"on-connection-quality-update":this.connectionQualityManager.handleQualityUpdate(t);break;case"on-policy-change":this.policyChangeManager.handlePolicyChange(t)}}},Li=class{constructor(e){this.TAG="[AudioContextManager]",this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){return _(this,null,(function*(){"suspended"===this.audioContext.state&&(yield this.audioContext.resume(),ye.d(this.TAG,"AudioContext is resumed"))}))}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){"closed"!==this.audioContext.state&&this.audioContext.close().catch((e=>{ye.d(this.TAG,"AudioContext close error",e.message)}))}},Ni=class extends h.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},Gi=class extends Ni{constructor(){super(...arguments),this.audioElement=null,this.TAG="[PlaylistAudioManager]",this.seeked=!1}play(e){return _(this,null,(function*(){return this.audioElement=this.getAudioElement(),new Promise(((i,t)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let s=`Error loading ${e}`;ye.e(this.TAG,s),this.stop(),t(s)},this.audioElement.oncanplaythrough=()=>_(this,null,(function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),i([this.track]));else{yield this.audioElement.play();let s=this.audioContextManager.getAudioTrack();this.track=s,i([s])}}catch(r){ye.e(this.TAG,"Error playing audio",e,r.message),t(r)}})),this.audioElement.onseeked=()=>{this.seeked=!0}}))}))}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement||(this.audioElement=this.getAudioElement()),this.audioElement}stop(){var e,i,t;null==(e=this.audioElement)||e.pause(),null==(i=this.audioElement)||i.removeAttribute("src"),this.audioElement=null,null==(t=this.audioContextManager)||t.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(i=>this.emit("progress",i))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Li(e),e}},xi=class extends Ni{constructor(){super(...arguments),this.TAG="[PlaylistVideoManager]",this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,i,t;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&(null==(t=this.canvasContext)||t.drawImage(this.videoElement,0,0,null==(e=this.canvas)?void 0:e.width,null==(i=this.canvas)?void 0:i.height),this.timer=setTimeout((()=>{this.drawImage()}),1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise(((i,t)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let s=`Error loading ${e}`;ye.e(this.TAG,s),this.stop(),t(s)},this.videoElement.oncanplaythrough=()=>_(this,null,(function*(){var s,a,r;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,0===this.tracks.length){this.clearCanvasAndTracks();let e=this.canvas.captureStream();if(!e)return void ye.e(this.TAG,"Browser does not support captureStream");this.videoElement.onplay=this.drawImage,yield this.audioContextManager.resumeContext(),yield this.videoElement.play();let t=this.audioContextManager.getAudioTrack();e.addTrack(t),e.getTracks().forEach((u=>{this.tracks.push(u)})),i(this.tracks)}else this.seeked?(this.seeked=!1,null==(r=this.canvasContext)||r.drawImage(this.videoElement,0,0,null==(s=this.canvas)?void 0:s.width,null==(a=this.canvas)?void 0:a.height)):(yield this.videoElement.play(),i(this.tracks))}catch(r){ye.e(this.TAG,"Error playing video",e,r.message),t(r)}})),this.videoElement.onseeked=()=>{this.seeked=!0}}))}getTracks(){return this.tracks.map((e=>e.id))}getElement(){return this.videoElement||(this.videoElement=this.getVideoElement()),this.videoElement}stop(){var e,i,t;null==(e=this.videoElement)||e.pause(),null==(i=this.videoElement)||i.removeAttribute("src"),this.videoElement=null,null==(t=this.audioContextManager)||t.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(i=>this.emit("progress",i))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Li(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}},Ui={list:[],currentIndex:-1,isAutoplayOn:!0},Fi={list:[],currentIndex:-1,isAutoplayOn:!0},$i=class extends Ni{constructor(e,i){super(),this.sdk=e,this.eventBus=i,this.state={audio:g({},Ui),video:g({},Fi)},this.TAG="[PlaylistManager]",this.handlePausePlaylist=e=>_(this,[e],(function*({enabled:e,track:i}){var a;if(e)return;let s;"audioplaylist"===i.source&&(s="audio"),"videoplaylist"===i.source&&(s="video"),s&&(null==(a=this.getElement(s))||a.pause())})),this.addTrack=(e,i)=>_(this,null,(function*(){yield this.sdk.addTrack(e,i),ye.d(this.TAG,"Playlist track added",Fe(e))})),this.removeTrack=e=>_(this,null,(function*(){yield this.sdk.removeTrack(e,!0),ye.d(this.TAG,"Playlist track removed",e)})),this.audioManager=new Gi,this.videoManager=new xi,this.addListeners()}getList(e="audio"){return this.state[e].list}setList(e){e&&0!==e.length?e.forEach((i=>{this.state[i.type].list.find((e=>e.id===i.id))||this.state[i.type].list.push(i)})):ye.w(this.TAG,"Please pass in a list of HMSPlaylistItem's")}clearList(e){return _(this,null,(function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]}))}removeItem(e,i){return _(this,null,(function*(){let{list:t,currentIndex:s}=this.state[i],a=t.findIndex((t=>e===t.id));return a>-1&&(s===a&&this.isPlaying(i)&&(yield this.stop(i)),t.splice(a,1),!0)}))}seek(e,i="audio"){let{currentIndex:t}=this.state[i];if(-1===t)throw p.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");let s=this.getElement(i);if(s){let a=Math.max(s.currentTime+e,0);s.currentTime=Math.min(a,s.duration)}}seekTo(e,i="audio"){let{currentIndex:t}=this.state[i];if(-1===t)throw p.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");if(e<0)throw Error("value cannot be negative");let s=this.getElement(i);s&&(s.currentTime=Math.min(e,s.duration))}setVolume(e,i="audio"){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let t=this.getElement(i);t&&(t.volume=.01*e)}getVolume(e="audio"){let i=this.getElement(e);return i?Math.floor(100*i.volume):0}getCurrentTime(e="audio"){let i=this.getElement(e);return(null==i?void 0:i.currentTime)||0}getCurrentIndex(e="audio"){return this.state[e].currentIndex}getCurrentProgress(e="audio"){var t;let{list:i,currentIndex:r}=this.state[e],s=null==(t=i[r])?void 0:t.url,a=this.getElement(e);return s&&a?Math.floor(a.currentTime/a.duration*100):0}getCurrentSelection(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(-1!==t)return i[t]}isPlaying(e="audio"){let i=this.getElement(e);return!!i&&!i.paused}setIsAutoplayOn(e="audio",i){this.state[e].isAutoplayOn=i}getPlaybackRate(e="audio"){let i=this.getElement(e);return i?i.playbackRate:1}setPlaybackRate(e="audio",i){if(i<.25||i>2)throw Error("Please pass a value between 0.25 and 2.0");let t=this.getElement(e);t&&(t.playbackRate=i)}setEnabled(s,a){return _(this,arguments,(function*(e,{id:i,type:t="audio"}){let r=this.state[t].list.findIndex((u=>u.id===i));if(!i||-1===r)return void ye.w(this.TAG,"Pass a valid id");let n=this.state[t].list[r].url;e?yield this.play(n,t):yield this.pause(n,t),this.state[t].currentIndex=r,this.setDuration(t)}))}playNext(){return _(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(t>=i.length-1)throw p.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached end of playlist");yield this.play(i[t+1].url,e),this.state[e].currentIndex=t+1,this.setDuration(e)}))}playPrevious(){return _(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t}=this.state[e];if(t<=0)throw p.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached start of playlist");yield this.play(i[t-1].url,e),this.state[e].currentIndex=t-1,this.setDuration(e)}))}stop(){return _(this,arguments,(function*(e="audio"){var t;let i="audio"===e?this.audioManager:this.videoManager;null==(t=i.getElement())||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1}))}cleanup(){this.state={audio:g({},Ui),video:g({},Fi)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",(()=>{try{e({type:"video",progress:this.getCurrentProgress("video")})}catch(e){ye.e(this.TAG,"Error in onProgress callback")}})),this.audioManager.on("progress",(()=>{try{e({type:"audio",progress:this.getCurrentProgress("audio")})}catch(e){ye.e(this.TAG,"Error in onProgress callback")}}))}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e="audio"){return"audio"===e?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return _(this,arguments,(function*(e="audio"){let t=("audio"===e?this.audioManager:this.videoManager).getTracks();for(let s of t)yield this.removeTrack(s)}))}play(e){return _(this,arguments,(function*(e,i="audio"){let s="audio"===i?this.audioManager:this.videoManager,a=s.getElement();if(this.isItemCurrentlyPlaying(e,i))ye.w(this.TAG,`The ${i} is currently playing`);else if(null!=a&&a.src.includes(e))yield a.play();else{null==a||a.pause();let t=yield s.play(e);for(let e of t)yield this.addTrack(e,"audio"===i?"audioplaylist":"videoplaylist")}}))}isItemCurrentlyPlaying(e,i){let t=this.getElement(i);return!(!t||t.paused||!t.src.includes(e))}setDuration(e="audio"){let i=this.getElement(e),{list:t,currentIndex:s}=this.state[e];t[s]&&(t[s].duration=(null==i?void 0:i.duration)||0),this.emit("newTrackStart",t[s])}pause(e){return _(this,arguments,(function*(e,i="audio"){let s=this.getElement(i);s&&!s.paused&&s.src.includes(e)?(s.pause(),ye.d(this.TAG,"paused url",e)):ye.w(this.TAG,"The passed in url is not currently playing")}))}addListeners(){this.audioManager.on("ended",(()=>this.handleEnded("audio"))),this.videoManager.on("ended",(()=>this.handleEnded("video"))),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return _(this,arguments,(function*(e="audio"){let{list:i,currentIndex:t,isAutoplayOn:s}=this.state[e];t===i.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):s?this.playNext(e):yield this.pause(i[t].url,e),this.emit("currentTrackEnded",i[t])}))}},ji=class{constructor(e){this.transport=e,this.observedKeys=new Set}get(e){return _(this,null,(function*(){let{data:t,updated_at:i}=yield this.transport.getSessionMetadata(e);return{value:t,updatedAt:b(i)}}))}set(e,t){return _(this,null,(function*(){let{data:i,updated_at:r}=yield this.transport.setSessionMetadata({key:e,data:t});return{value:i,updatedAt:b(r)}}))}observe(e){return _(this,null,(function*(){let t=new Set(this.observedKeys);if(e.forEach((i=>this.observedKeys.add(i))),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}}))}unobserve(e){return _(this,null,(function*(){let t=new Set(this.observedKeys);if(this.observedKeys=new Set([...this.observedKeys].filter((i=>!e.includes(i)))),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}}))}},Bi=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i}setListener(e){this.listener=e}createPoll(e){return _(this,null,(function*(){var s,a;let{poll_id:t}=yield this.transport.setPollInfo(C(g({},e),{poll_id:e.id,vote:e.rolesThatCanVote,responses:e.rolesThatCanViewResponses}));e.id||(e.id=t),Array.isArray(e.questions)&&(yield this.addQuestionsToPoll(e.id,e.questions));let i=yield this.transport.getPollQuestions({poll_id:e.id,index:0,count:50}),r={id:e.id,title:e.title,anonymous:e.anonymous,type:e.type,duration:e.duration,locked:e.locked,mode:e.mode,visibility:e.visibility,rolesThatCanVote:e.rolesThatCanVote||[],rolesThatCanViewResponses:e.rolesThatCanViewResponses||[],state:"created",createdBy:null==(s=this.store.getLocalPeer())?void 0:s.peerId,questions:i.questions.map((({question:e,options:t,answer:r})=>C(g({},e),{options:t,answer:r})))};null==(a=this.listener)||a.onPollsUpdate(0,[r])}))}startPoll(e){return _(this,null,(function*(){"string"==typeof e?yield this.transport.startPoll({poll_id:e}):(yield this.createPoll(e),yield this.transport.startPoll({poll_id:e.id}))}))}addQuestionsToPoll(e,t){return _(this,null,(function*(){t.length>0&&(yield this.transport.setPollQuestions({poll_id:e,questions:t.map(((i,e)=>this.createQuestionSetParams(i,e)))}))}))}stopPoll(e){return _(this,null,(function*(){yield this.transport.stopPoll({poll_id:e})}))}addResponsesToPoll(e,t){return _(this,null,(function*(){let i=this.store.getPoll(e);if(!i)throw new Error("Invalid poll ID - Poll not found");let r=t.map((s=>{var e,t;let a=this.getQuestionInPoll(i,s.questionIndex);return"single-choice"===a.type?(s.option=s.option||(null==(e=s.options)?void 0:e[0])||-1,delete s.text,delete s.options):"multiple-choice"===a.type?(null==(t=s.options)||t.sort(),delete s.text,delete s.option):(delete s.option,delete s.options),s.skipped&&(delete s.option,delete s.options,delete s.text),g({duration:0,type:a.type,question:s.questionIndex},s)}));yield this.transport.setPollResponses({poll_id:e,responses:r})}))}getPolls(){return _(this,null,(function*(){let e=yield this.transport.getPollsList({count:50}),t=[];for(let i of e.polls){let e=yield this.transport.getPollQuestions({poll_id:i.poll_id,index:0,count:50}),s={id:i.poll_id,title:i.title,startedBy:i.started_by,createdBy:i.created_by,anonymous:i.anonymous,type:i.type,duration:i.duration,locked:i.locked,mode:i.mode,visibility:i.visibility,rolesThatCanVote:i.vote||[],rolesThatCanViewResponses:i.responses||[],state:i.state,stoppedBy:i.stopped_by,startedAt:b(i.started_at),stoppedAt:b(i.stopped_at),createdAt:b(i.created_at),questions:e.questions.map((({question:a,options:e,answer:t})=>C(g({},a),{options:e,answer:t})))};t.push(s),this.store.setPoll(s)}return t}))}getResponses(e){throw new Error("Method not implemented.")}createQuestionSetParams(e,t){var a;let r,i=C(g({},e),{index:t+1}),s=e.answer||{hidden:!1};return Array.isArray(e.options)&&["single-choice","multiple-choice"].includes(e.type)?(r=null==(a=e.options)?void 0:a.map(((e,t)=>({index:t+1,text:e.text,weight:e.weight}))),null==s||delete s.text,"single-choice"===e.type?s.option=e.options.findIndex((e=>e.isCorrectAnswer))+1||void 0:s.options=e.options.map(((e,t)=>e.isCorrectAnswer?t+1:void 0)).filter((e=>!!e))):(null==s||delete s.options,null==s||delete s.option),{question:i,options:r,answer:s}}getQuestionInPoll(e,t){var r;let i=null==(r=null==e?void 0:e.questions)?void 0:r.find((s=>s.index===t));if(!i)throw new Error("Invalid question index - Question not found in poll");return i}},Vi=class{constructor(e,t,i="",r="",s="https://prod-init.100ms.live/init",a=!1){this.authToken=e,this.peerId=t,this.peerName=i,this.data=r,this.endpoint=s,this.autoSubscribeVideo=a}},Wi=((s=Wi||{})[s.ConnectFailed=0]="ConnectFailed",s[s.SignalDisconnect=1]="SignalDisconnect",s[s.JoinWSMessageFailed=2]="JoinWSMessageFailed",s[s.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",s[s.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed",s),Hi={0:[],1:[],2:[1],3:[1],4:[1]},qi=(e=>(e.Disconnected="Disconnected",e.Connecting="Connecting",e.Joined="Joined",e.Preview="Preview",e.Failed="Failed",e.Reconnecting="Reconnecting",e.Leaving="Leaving",e))(qi||{}),Ki=class{constructor(e){this.promise=new Promise(((t,i)=>{this.resolve=t,this.reject=i,e(t,i)}))}},Ji=class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.TAG="[RetryScheduler]",this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return _(this,arguments,(function*({category:e,error:t,task:i,originalState:r,maxFailedRetries:s=5,changeState:a=!0}){yield this.scheduleTask({category:e,error:t,changeState:a,task:i,originalState:r,maxFailedRetries:s})}))}reset(){this.retryTaskIds.forEach((e=>clearTimeout(e))),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(e){return _(this,arguments,(function*({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a=5,failedRetryCount:n=0}){if(ye.d(this.TAG,"schedule: ",{category:Wi[e],error:t}),0===n){let r=this.inProgress.get(e);if(r)return ye.d(this.TAG,`schedule: Already a task for ${Wi[e]} scheduled, waiting for its completion`),void(yield r.promise);let n=new Ki(((e,t)=>{}));this.inProgress.set(e,n),this.sendEvent(t,e)}let o=!1,u=Hi[e];for(let t in u){let r=u[parseInt(t)];try{let t=this.inProgress.get(r);t&&(ye.d(this.TAG,`schedule: Suspending retry task of ${Wi[e]}, waiting for ${Wi[r]} to recover`),yield t.promise,ye.d(this.TAG,`schedule: Resuming retry task ${Wi[e]} as it's dependency ${Wi[r]} is recovered`))}catch(t){ye.d(this.TAG,`schedule: Stopping retry task of ${Wi[e]} as it's dependency ${Wi[r]} failed to recover`),o=!0;break}}if(n>=a||o){if(t.description+=`. [${Wi[e]}] Could not recover after ${n} tries`,o&&(t.description+=` Could not recover all of it's required dependencies - [${u.map((e=>Wi[e])).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),!i)throw t;return void this.onStateChange("Failed",t)}i&&this.onStateChange("Reconnecting",t);let l,d=this.getDelayForRetryCount(e,n);ye.d(this.TAG,`schedule: [${Wi[e]}] [failedRetryCount=${n}] Scheduling retry task in ${d}ms`);try{l=yield this.setTimeoutPromise(r,d)}catch(t){l=!1,ye.w(this.TAG,`[${Wi[e]}] Un-caught exception ${t.name} in retry-task, initiating retry`,t)}if(l){let t=this.inProgress.get(e);this.inProgress.delete(e),null==t||t.resolve(n),i&&0===this.inProgress.size&&this.onStateChange(s),ye.d(this.TAG,`schedule: [${Wi[e]}] [failedRetryCount=${n}] Recovered `)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a,failedRetryCount:n+1})}))}getBaseDelayForTask(e,t){return 2===e?2:Math.pow(2,t)}getDelayForRetryCount(e,t){let i=this.getBaseDelayForTask(e,t),r=2===e?2*Math.random():Math.random();return Math.round(1e3*Math.min(i+r,60))}setTimeoutPromise(e,t){return _(this,null,(function*(){return new Promise(((i,r)=>{let s=window.setTimeout((()=>_(this,null,(function*(){try{let a=yield e();a&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(s),1),i(a)}catch(e){r(e)}}))),t);this.retryTaskIds.push(s)}))}))}},zi=class{constructor(e,t,i=30,r=300){this.store=e,this.eventBus=t,this.sampleWindowSize=i,this.pushInterval=r,this.shouldSendEvent=!1,this.sequenceNum=1,this.trackAnalytics=new Map,this.stop=()=>{this.shouldSendEvent&&this.sendEvent(),this.eventBus.statsUpdate.unsubscribe(this.handleStatsUpdate),this.shouldSendEvent=!1},this.sendEvent=()=>{this.eventBus.analytics.publish(Oe.publishStats(this.toAnalytics()))},this.handleStatsUpdate=e=>{let t=e.getLocalTrackStats();Object.keys(t).forEach((i=>{let r=t[i],s=this.store.getLocalPeerTracks().find((a=>a.getTrackIDBeingSent()===i));Object.keys(r).forEach((a=>{var t,u,n,o,l;let d=r[a],c=s&&this.getTrackIdentifier(null==s?void 0:s.trackId,d);if(c&&this.trackAnalytics.has(c))null==(n=this.trackAnalytics.get(c))||n.push(C(g({},d),{availableOutgoingBitrate:null==(u=null==(t=e.getLocalPeerStats())?void 0:t.publish)?void 0:u.availableOutgoingBitrate}));else if(s){let t=new Qi({track:s,sampleWindowSize:this.sampleWindowSize,rid:d.rid,ssrc:d.ssrc.toString(),kind:d.kind});t.push(C(g({},d),{availableOutgoingBitrate:null==(l=null==(o=e.getLocalPeerStats())?void 0:o.publish)?void 0:l.availableOutgoingBitrate})),this.trackAnalytics.set(this.getTrackIdentifier(null==s?void 0:s.trackId,d),t)}}))}))},this.start()}start(){this.shouldSendEvent||(this.stop(),this.shouldSendEvent=!0,this.eventBus.statsUpdate.subscribe(this.handleStatsUpdate),this.startLoop().catch((e=>ye.e("[PublishStatsAnalytics]",e.message))))}startLoop(){return _(this,null,(function*(){for(;this.shouldSendEvent;)yield Ze(1e3*this.pushInterval),this.sendEvent()}))}toAnalytics(){var i,e;let t=[],r=[];return this.trackAnalytics.forEach((s=>{"audio"===s.track.type?t.push(s.toAnalytics()):"video"===s.track.type&&r.push(s.toAnalytics())})),{audio:t,video:r,joined_at:null==(e=null==(i=this.store.getRoom())?void 0:i.joinedAt)?void 0:e.getTime(),sequence_num:this.sequenceNum++,max_window_sec:30}}getTrackIdentifier(e,t){return t.rid?`${e}:${t.rid}`:e}},Qi=class{constructor({track:e,ssrc:t,rid:i,kind:r,sampleWindowSize:s}){this.samples=[],this.tempStats=[],this.track=e,this.ssrc=t,this.rid=i,this.kind=r,this.track_id=this.track.trackId,this.source=this.track.source,this.sampleWindowSize=s}push(e){this.tempStats.push(e),this.shouldCreateSample()&&(this.samples.push(this.createSample()),this.tempStats.length=0)}toAnalytics(){return{track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples}}createSample(){let e=this.getLatestStat(),t=e.qualityLimitationDurations,i=t&&{bandwidth_sec:t.bandwidth,cpu_sec:t.cpu,other_sec:t.other},r=e.frameHeight?{height_px:this.getLatestStat().frameHeight,width_px:this.getLatestStat().frameWidth}:void 0,s=this.calculateAverage("jitter",!1),a=s?Math.round(1e3*s):void 0,n=this.calculateAverage("roundTripTime",!1),o=n?Math.round(1e3*n):void 0;return Zi({timestamp:Date.now(),avg_available_outgoing_bitrate_bps:this.calculateAverage("availableOutgoingBitrate"),avg_bitrate_bps:this.calculateAverage("bitrate"),avg_fps:this.calculateAverage("framesPerSecond"),total_packets_lost:this.calculateDifferenceForSample("packetsLost"),total_packets_sent:this.calculateDifferenceForSample("packetsSent"),total_packet_sent_delay_sec:parseFloat(this.calculateDifferenceForSample("totalPacketSendDelay").toFixed(4)),total_fir_count:this.calculateDifferenceForSample("firCount"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_ms:a,avg_round_trip_time_ms:o,total_quality_limitation:i,resolution:r})}getLatestStat(){return this.tempStats[this.tempStats.length-1]}shouldCreateSample(){let e=this.tempStats.length,t=this.tempStats[e-1],i=this.tempStats[e-2];return 30===e||Xi(t,i)||"video"===t.kind&&Yi(t,i)}calculateSum(e){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce(((i,t)=>i+(t[e]||0)),0)}calculateAverage(e,t=!0){let i=this.calculateSum(e),r=void 0!==i?i/this.tempStats.length:void 0;return r?t?Math.round(r):r:void 0}calculateDifferenceForSample(e){let t=Number(this.tempStats[0][e])||0;return(Number(this.getLatestStat()[e])||0)-t}},Yi=(e,t)=>e&&t&&(e.frameWidth!==t.frameWidth||e.frameHeight!==t.frameHeight),Xi=(e,t)=>e&&t&&e.enabled!==t.enabled,Zi=e=>Object.entries(e).filter((([,e])=>void 0!==e)).reduce(((e,[t,i])=>(e[t]=i,e)),{}),es=class extends Xe{constructor(){super(100),this.localStorage=new me("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;null==(e=this.localStorage.get())||e.forEach((i=>{let e=new De(i);super.enqueue(e)}))}},ts=class{constructor(){this.TAG="[AnalyticsTransport]"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(e){ye.w(this.TAG,"sendEvent failed",e)}}flushFailedEvents(e){var t;try{for(ye.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&((null==(t=i.metadata)?void 0:t.peer.peer_id)!==e&&i.metadata.peer.peer_id?ci.sendEvent(i):this.sendSingleEvent(i))}}catch(e){ye.w(this.TAG,"flushFailedEvents failed",e)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),ye.d(this.TAG,"Sent event",e.name,e)}catch(t){throw ye.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}},is=class extends ts{constructor(e){super(),this.transportProvider=e,this.failedEvents=new es}},ss=(e=>(e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe",e))(ss||{});var rs="[HMSConnection]",ns=class{constructor(e,t){this.candidates=new Array,this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return 0===this.role?"PUBLISH":"SUBSCRIBE"}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return _(this,null,(function*(){try{let i=yield this.nativeConnection.createOffer(t);return ye.d(rs,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),function(e){return e.sdp.includes("usedtx=1")?e:{type:e.type,sdp:e.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}(function(e,t){var r;let n=m.parse(e.sdp);if(null==(r=n.origin)||!r.username.startsWith("mozilla"))return e;let i=t?Array.from(t.values()):[];return n.media.forEach((s=>{var e,t,u;let a=null==(e=s.msid)?void 0:e.split(" ")[0],r=null==(t=i.find((e=>e.type===s.type&&e.stream_id===a)))?void 0:t.track_id;r&&(s.msid=null==(u=s.msid)?void 0:u.replace(/\s(.+)/,` ${r}`))})),{type:e.type,sdp:m.write(n)}}(i,e))}catch(e){throw p.WebrtcErrors.CreateOfferFailed(this.action,e.message)}}))}createAnswer(e=void 0){return _(this,null,(function*(){try{let t=yield this.nativeConnection.createAnswer(e);return ye.d(rs,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(e){throw p.WebrtcErrors.CreateAnswerFailed(this.action,e.message)}}))}setLocalDescription(e){return _(this,null,(function*(){try{ye.d(rs,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(e){throw p.WebrtcErrors.SetLocalDescriptionFailed(this.action,e.message)}}))}setRemoteDescription(e){return _(this,null,(function*(){try{ye.d(rs,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(e){throw p.WebrtcErrors.SetRemoteDescriptionFailed(this.action,e.message)}}))}addIceCandidate(e){return _(this,null,(function*(){"closed"!==this.nativeConnection.signalingState?(ye.d(rs,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)):ye.d(rs,`[role=${this.role}] addIceCandidate signalling state closed`)}))}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}logSelectedIceCandidatePairs(){try{(0===this.role?this.getSenders():this.getReceivers()).forEach((e=>{var t;let i=null==(t=e.track)?void 0:t.kind;if(e.transport){let s=e.transport.iceTransport,a=()=>{"function"==typeof s.getSelectedCandidatePair&&(this.selectedCandidatePair=s.getSelectedCandidatePair(),ye.d(rs,`${ss[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2)))};"function"==typeof s.onselectedcandidatepairchange&&(s.onselectedcandidatepairchange=a),a()}}))}catch(e){ye.w(rs,`Error in logging selected ice candidate pair for ${ss[this.role]} connection`,e)}}removeTrack(e){"closed"!==this.nativeConnection.signalingState&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e){return _(this,null,(function*(){let t=e.settings.maxBitrate,i=e instanceof Bt&&e.settings.maxFramerate,r=this.getSenders().find((s=>{var a;return(null==(a=null==s?void 0:s.track)?void 0:a.id)===e.getTrackIDBeingSent()}));if(r){let s=r.getParameters();1===s.encodings.length&&(t&&(s.encodings[0].maxBitrate=1e3*t),i&&(s.encodings[0].maxFramerate=i)),yield r.setParameters(s)}else ye.w(rs,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)}))}getStats(){return _(this,null,(function*(){return yield this.nativeConnection.getStats()}))}close(){return _(this,null,(function*(){this.nativeConnection.close()}))}getReceivers(){return this.nativeConnection.getReceivers()}},as=class extends ns{constructor(e,i,t){super(0,e),this.TAG="[HMSPublishConnection]",this.observer=t,this.nativeConnection=new RTCPeerConnection(i),this.nativeConnection.createDataChannel(rt,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:s})=>{s&&e.trickle(this.role,s)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>_(this,null,(function*(){ye.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()}))}},os=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=e=>{this.observer.onMessage(e.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){ye.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}},ls=class e extends ns{constructor(e,i,t,s){super(1,e),this.isFlagEnabled=t,this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.MAX_RETRIES=3,this.pendingMessageQueue=[],this.eventEmitter=new v.a({maxListeners:60}),this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(ye.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach((e=>this.sendOverApiDataChannel(e))),this.pendingMessageQueue.length=0)},this.sendMessage=(e,i)=>_(this,null,(function*(){var s;let t;"open"!==(null==(s=this.apiChannel)?void 0:s.readyState)&&(yield this.eventEmitter.waitFor("open"));for(let a=0;a<this.MAX_RETRIES;a++){this.apiChannel.send(e),t=yield this.waitForResponse(i);let r=t.error;if(!r)break;{if(404===r.code){ye.d(this.TAG,`Track not found ${i}`,{request:e,try:a+1,error:r});break}if(ye.d(this.TAG,`Failed sending ${i}`,{request:e,try:a+1,error:r}),r.code/100!=5&&429!==r.code)throw Error(`code=${r.code}, message=${r.message}`);let t=1e3*(2+2*Math.random());yield Ze(t)}}return t})),this.waitForResponse=e=>_(this,null,(function*(){let i=yield this.eventEmitter.waitFor("message",(function(s){return s.includes(e)})),t=JSON.parse(i[0]);return ye.d(this.TAG,`response for ${e} -`,JSON.stringify(t,null,2)),t})),this.observer=s,this.nativeConnection=new RTCPeerConnection(i),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===rt&&(this.apiChannel=new os(e.channel,{onMessage:i=>{this.eventEmitter.emit("message",i),this.observer.onApiChannelMessage(i)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{null!==e.candidate&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var t;let i=e.streams[0],r=i.id;if(!this.remoteStreams.has(r)){let u=new qt(i,this);this.remoteStreams.set(r,u)}i.addEventListener("removetrack",(u=>{if(u.track.id!==e.track.id)return;let t=s.tracks.findIndex((t=>{var r;return t.nativeTrack.id===u.track.id&&e.transceiver.mid===(null==(r=t.transceiver)?void 0:r.mid)}));if(t>=0){let e=s.tracks[t];this.observer.onTrackRemove(e),s.tracks.splice(t,1),0===s.tracks.length&&this.remoteStreams.delete(r)}}));let s=this.remoteStreams.get(r),n=new("audio"===e.track.kind?Ct:Vt)(s,e.track);"video"===e.track.kind&&s.setVideoLayerLocally("none","addTrack","subscribeConnection"),n.transceiver=e.transceiver;let o=function(e,t){var s;if(null==e||!e.sdp||!t)return;let i=m.parse(e.sdp).media.find((a=>Pe(a.mid)&&parseInt(a.mid)===parseInt(t)));return null==(s=null==i?void 0:i.msid)?void 0:s.split(" ")[1]}(this.remoteDescription,null==(t=e.transceiver)?void 0:t.mid);o&&n.setSdpTrackId(o),s.tracks.push(n),this.observer.onTrackAdd(n)}}sendOverApiDataChannel(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(ye.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}sendOverApiDataChannelWithResponse(e,i){return _(this,null,(function*(){let t=Object(l.a)();if("prefer-video-track-state"===e.method&&this.isFlagEnabled("disableVideoTrackAutoUnsubscribe")&&"none"===e.params.max_spatial_layer)return ye.d(this.TAG,"video auto unsubscribe is disabled, request is ignored"),{id:t};let s=JSON.stringify(g({id:i||t,jsonrpc:"2.0"},e));return this.sendMessage(s,t)}))}close(){return _(this,null,(function*(){var t;yield w(e.prototype,this,"close").call(this),null==(t=this.apiChannel)||t.close()}))}},ds="[InitService]",cs=class{static handleError(e,t){switch(e.status){case 404:throw p.APIErrors.EndpointUnreachable("INIT",t.message||e.statusText);case 200:break;default:throw p.APIErrors.ServerErrors(t.code||e.status,"INIT",t.message||(null==e?void 0:e.statusText))}}static fetchInitConfig(a){return _(this,arguments,(function*({token:e,peerId:t,userAgent:i,initEndpoint:r="https://prod-init.100ms.live",region:s=""}){ye.d(ds,`fetchInitConfig: initEndpoint=${r} token=${e} peerId=${t} region=${s} `);let n=function(e,t,r,i){try{let n=new URL("/init",e);return i&&i.trim().length>0&&n.searchParams.set("region",i.trim()),n.searchParams.set("peer_id",t),n.searchParams.set("user_agent_v2",r),n.toString()}catch(e){let s=e;throw ye.e(ds,s.name,s.message),s}}(r,t,i,s);try{let t=yield fetch(n,{headers:{Authorization:`Bearer ${e}`}});try{let e=yield t.clone().json();return this.handleError(t,e),ye.d(ds,`config is ${JSON.stringify(e,null,2)}`),function(e){var t;return C(g({},e),{rtcConfiguration:C(g({},e.rtcConfiguration),{iceServers:null==(t=e.rtcConfiguration)?void 0:t.ice_servers})})}(e)}catch(e){let u=yield t.text();throw ye.e(ds,"json error",e.message,u),p.APIErrors.ServerErrors(t.status,"INIT",u)}}catch(e){let t=e;throw["Failed to fetch","NetworkError","ECONNRESET"].some((u=>t.message.includes(u)))?p.APIErrors.EndpointUnreachable("INIT",t.message):t}}))}};var us=class{constructor(e){this.TAG="[SIGNAL]: ",this.pongResponseTimes=new Xe(5),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.onCloseHandler=()=>{},this.resolvePingOnAnyResponse=()=>{this.callbacks.forEach(((e,t)=>{var i;"ping"===(null==(i=e.metadata)?void 0:i.method)&&(e.resolve({timestamp:Date.now()}),this.callbacks.delete(t))}))},this.offlineListener=()=>{ye.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")},this.onlineListener=()=>{ye.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()},this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){ye.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return _(this,null,(function*(){var s;let i=Object(l.a)(),r={method:e,params:t,id:i,jsonrpc:"2.0"};null==(s=this.socket)||s.send(JSON.stringify(r));try{return yield new Promise(((t,r)=>{this.callbacks.set(i,{resolve:t,reject:r,metadata:{method:e}})}))}catch(r){if(r instanceof Te)throw r;let t=r;throw p.WebsocketMethodErrors.ServerErrors(Number(t.code),Se(e),t.message)}}))}notify(e,t){var r,s;let i={method:e,params:t};(null==(r=this.socket)?void 0:r.readyState)===WebSocket.OPEN&&(null==(s=this.socket)||s.send(JSON.stringify(i)))}open(e){return new Promise(((t,i)=>{let r=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let s=()=>{ye.e(this.TAG,"Error from websocket"),r=!0,i(p.WebSocketConnectionErrors.FailedToConnect("JOIN","Error opening websocket connection"))};this.onCloseHandler=e=>{ye.w(`Websocket closed code=${e.code}`),r?this.setIsConnected(!1,`code: ${e.code}${1e3!==e.code?", unexpected websocket close":""}`):(r=!0,i(p.WebSocketConnectionErrors.AbnormalClose("JOIN",`Error opening websocket connection - websocket closed unexpectedly with code=${e.code}`)))},this.socket.addEventListener("error",s);let a=()=>{var e,n;r=!0,t(),this.setIsConnected(!0),this.id++,null==(e=this.socket)||e.removeEventListener("open",a),null==(n=this.socket)||n.removeEventListener("error",s),this.pingPongLoop(this.id)};this.socket.addEventListener("open",a),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)}))}close(){return _(this,null,(function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")}))}join(e,t,i,r,s,a,n){return _(this,null,(function*(){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost("JOIN","Failed to send join over WS connection");let o={name:e,disableVidAutoSub:i,data:t,offer:n,server_sub_degrade:r,simulcast:s,onDemandTracks:a},l=yield this.internalCall("join",o);return this.isJoinCompleted=!0,this.pendingTrickle.forEach((({target:u,candidate:e})=>this.trickle(u,e))),this.pendingTrickle.length=0,ye.d(this.TAG,`join: response=${JSON.stringify(l,null,1)}`),l}))}trickle(e,t){this.isJoinCompleted?this.notify("trickle",{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return _(this,null,(function*(){return yield this.call("offer",{desc:e,tracks:Object.fromEntries(t)})}))}answer(e){this.notify("answer",{desc:e})}trackUpdate(e){this.notify("track-update",{tracks:Object.fromEntries(e)})}broadcast(e){return _(this,null,(function*(){return yield this.call("broadcast",e.toSignalParams())}))}leave(){this.notify("leave",{})}endRoom(e,t){return _(this,null,(function*(){yield this.call("end-room",{lock:e,reason:t})}))}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify("analytics",e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise((s=>{setTimeout((()=>{s(Date.now()-t)}),e+1)})),r=this.internalCall("ping",{timestamp:t}).then((()=>Date.now()-t)).catch((()=>Date.now()-t));return Promise.race([i,r])}requestRoleChange(e){return _(this,null,(function*(){yield this.call("role-change-request",e)}))}requestBulkRoleChange(e){return _(this,null,(function*(){yield this.call("role-change-request",e)}))}acceptRoleChangeRequest(e){return _(this,null,(function*(){yield this.call("role-change",e)}))}requestTrackStateChange(e){return _(this,null,(function*(){yield this.call("track-update-request",e)}))}requestMultiTrackStateChange(e){return _(this,null,(function*(){yield this.call("change-track-mute-state-request",e)}))}removePeer(e){return _(this,null,(function*(){yield this.call("peer-leave-request",e)}))}startRTMPOrRecording(e){return _(this,null,(function*(){yield this.call("rtmp-start",g({},e))}))}stopRTMPAndRecording(){return _(this,null,(function*(){yield this.call("rtmp-stop",{})}))}startHLSStreaming(e){return _(this,null,(function*(){yield this.call("hls-start",g({},e))}))}stopHLSStreaming(e){return _(this,null,(function*(){yield this.call("hls-stop",g({},e))}))}sendHLSTimedMetadata(e){return _(this,null,(function*(){yield this.call("hls-timed-metadata",g({},e))}))}updatePeer(e){return _(this,null,(function*(){yield this.call("peer-update",g({},e))}))}getPeer(e){return _(this,null,(function*(){yield this.call("get-peer",g({},e))}))}joinGroup(e){return _(this,null,(function*(){return yield this.call("group-join",{name:e})}))}leaveGroup(e){return _(this,null,(function*(){return yield this.call("group-leave",{name:e})}))}addToGroup(e,t){return _(this,null,(function*(){yield this.call("group-add",{name:t,peer_id:e})}))}removeFromGroup(e,t){return _(this,null,(function*(){yield this.call("group-leave",{name:t,peer_id:e})}))}peerIterNext(e){return _(this,null,(function*(){return yield this.call("peer-iter-next",e)}))}findPeers(e){return _(this,null,(function*(){return yield this.call("find-peer",e)}))}setSessionMetadata(e){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("set-metadata",g({},e))}listenMetadataChange(e){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to observe session store key due to network disconnection");return this.call("listen-metadata-change",{keys:e})}getSessionMetadata(e){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("get-metadata",{key:e})}setPollInfo(e){return this.valiateConnection(),this.call("poll-info-set",g({},e))}getPollInfo(e){return this.valiateConnection(),this.call("poll-info-get",g({},e))}setPollQuestions(e){return this.valiateConnection(),this.call("poll-questions-set",g({},e))}startPoll(e){return this.valiateConnection(),this.call("poll-start",g({},e))}stopPoll(e){return this.valiateConnection(),this.call("poll-stop",g({},e))}getPollQuestions(e){return this.valiateConnection(),this.call("poll-questions-get",g({},e))}setPollResponses(e){return this.valiateConnection(),this.call("poll-response",g({},e))}getPollResponses(e){return this.valiateConnection(),this.call("poll-responses",g({},e))}getPollsList(e){return this.valiateConnection(),this.call("poll-list",g({},e))}getPollResult(e){return this.valiateConnection(),this.call("poll-result",g({},e))}valiateConnection(){if(!this.isConnected)throw p.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to send message due to network disconnection")}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(this.resolvePingOnAnyResponse(),i.id)this.handleResponseWithId(i);else{if(!i.method)throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`);this.handleResponseWithMethod(i)}}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let e=this.callbacks.get(i);this.callbacks.delete(i),t.result?e.resolve(t.result):e.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case"offer":this.observer.onOffer(e.params);break;case"trickle":this.observer.onTrickle(e.params);break;case"on-error":this.observer.onServerError(p.WebsocketMethodErrors.ServerErrors(Number(e.params.code),"on-error",e.params.message));break;case"on-warning":ye.w(this.TAG,e.params);break;default:this.observer.onNotification(e)}}rejectPendingCalls(e=""){this.callbacks.forEach(((t,i)=>{var r,s,a,n;"ping"!==(null==(r=t.metadata)?void 0:r.method)&&(ye.e(this.TAG,`rejecting pending callback ${null==(s=t.metadata)?void 0:s.method}, id=${i}`),t.reject(p.WebSocketConnectionErrors.WebSocketConnectionLost(null!=(a=t.metadata)&&a.method?Se(null==(n=t.metadata)?void 0:n.method):"RECONNECT_SIGNAL",e)),this.callbacks.delete(i))}))}pingPongLoop(e){return _(this,null,(function*(){var i,t;let r=(null==(i=window.HMS)?void 0:i.PING_TIMEOUT)||12e3;if(this.isConnected){let s=yield this.ping(r);this.pongResponseTimes.enqueue(s),s>r?(ye.d(this.TAG,`Pong timeout ${e}, pageHidden=${"undefined"!=typeof document&&document.hidden}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout((()=>this.pingPongLoop(e)),(null==(t=window.HMS)?void 0:t.PING_INTERVAL)||3e3)}}))}call(e,t){return _(this,null,(function*(){let s,r=p.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);for(s=1;s<=3;s++)try{return ye.d(this.TAG,`Try number ${s} sending ${e}`,t),yield this.internalCall(e,t)}catch(o){if(r=o,ye.e(this.TAG,`Failed sending ${e} try: ${s}`,{method:e,params:t,error:r}),5!==parseInt(""+r.code/100)&&429!==r.code)break;let n=1e3*(2+2*Math.random());yield Ze(n)}throw ye.e(`Sending ${e} over WS failed after ${Math.min(s,3)} retries`,{method:e,params:t,error:r}),r}))}},hs="[HMSTransport]:",ps=class{constructor(e,t,i,r,s,a){var n,o;this.observer=e,this.deviceManager=t,this.store=i,this.eventBus=r,this.analyticsEventsService=s,this.analyticsTimer=a,this.state="Disconnected",this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.joinRetryCount=0,this.callbacks=new Map,this.signalObserver={onOffer:e=>_(this,null,(function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(e),ye.d(hs,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let i of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(i);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),ye.d(hs,"[role=SUBSCRIBE] onOffer renegotiation DONE ")}catch(e){let i;ye.d(hs,"[role=SUBSCRIBE] onOffer renegotiation FAILED ",e),this.state="Failed",i=e instanceof Te?e:p.GenericErrors.Unknown("PUBLISH",e.message),this.observer.onFailure(i),this.eventBus.analytics.publish(Oe.subscribeFail(i))}})),onTrickle:e=>_(this,null,(function*(){let t=0===e.target?this.publishConnection:this.subscribeConnection;null!=t&&t.remoteDescription?yield t.addIceCandidate(e.candidate):null==t||t.candidates.push(e.candidate)})),onNotification:e=>this.observer.onNotification(e),onServerError:e=>_(this,null,(function*(){yield this.observer.onStateChange("Failed",e)})),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:1,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>_(this,null,(function*(){ye.d(hs,"socket offline",qi[this.state]);try{"Leaving"!==this.state&&this.joinParameters&&this.retryScheduler.schedule({category:1,error:p.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL",e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(e){console.error(e)}})),onOnline:()=>{var e;ye.d(hs,"socket online",qi[this.state]),this.analyticsSignalTransport.flushFailedEvents(null==(e=this.store.getLocalPeer())?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new us(this.signalObserver),this.analyticsSignalTransport=new is(this.signal),this.publishConnectionObserver={onRenegotiationNeeded:()=>_(this,null,(function*(){yield this.performPublishRenegotiation()})),onIceConnectionChange:e=>_(this,null,(function*(){("disconnected"===e?ye.w.bind(ye):ye.d.bind(ye))(hs,`Publish ice connection state change: ${e}`)})),onConnectionStateChange:e=>_(this,null,(function*(){var i,t,s,a,r;("disconnected"===e?ye.w.bind(ye):ye.d.bind(ye))(hs,`Publish connection state change: ${e}`),"connected"===e&&(null==(i=this.publishConnection)||i.logSelectedIceCandidatePairs()),"disconnected"===e&&setTimeout((()=>{var e,t,u,r,n;"disconnected"===(null==(e=this.publishConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(0,p.WebrtcErrors.ICEDisconnected("PUBLISH",`local candidate - ${null==(u=null==(t=this.publishConnection)?void 0:t.selectedCandidatePair)?void 0:u.local.candidate}; remote candidate - ${null==(n=null==(r=this.publishConnection)?void 0:r.selectedCandidatePair)?void 0:n.remote.candidate}`))}),5e3),"failed"===e&&(yield this.handleIceConnectionFailure(0,p.WebrtcErrors.ICEFailure("PUBLISH",`local candidate - ${null==(s=null==(t=this.publishConnection)?void 0:t.selectedCandidatePair)?void 0:s.local.candidate}; remote candidate - ${null==(r=null==(a=this.publishConnection)?void 0:a.selectedCandidatePair)?void 0:r.remote.candidate}`)))}))},this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{ye.d(hs,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{ye.d(hs,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>_(this,null,(function*(){if(("disconnected"===e?ye.w.bind(ye):ye.d.bind(ye))(hs,`Subscribe ice connection state change: ${e}`),"connected"===e){let i=this.callbacks.get(N);this.callbacks.delete(N),i&&i.promise.resolve(!0)}})),onConnectionStateChange:e=>_(this,null,(function*(){var i,t,s,a;("disconnected"===e?ye.w.bind(ye):ye.d.bind(ye))(hs,`Subscribe connection state change: ${e}`),"failed"===e&&(yield this.handleIceConnectionFailure(1,p.WebrtcErrors.ICEFailure("SUBSCRIBE",`local candidate - ${null==(t=null==(i=this.subscribeConnection)?void 0:i.selectedCandidatePair)?void 0:t.local.candidate}; remote candidate - ${null==(a=null==(s=this.subscribeConnection)?void 0:s.selectedCandidatePair)?void 0:a.remote.candidate}`))),"disconnected"===e&&setTimeout((()=>{var e,t,r,u,n;"disconnected"===(null==(e=this.subscribeConnection)?void 0:e.connectionState)&&this.handleIceConnectionFailure(1,p.WebrtcErrors.ICEDisconnected("SUBSCRIBE",`local candidate - ${null==(r=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:r.local.candidate}; remote candidate - ${null==(n=null==(u=this.subscribeConnection)?void 0:u.selectedCandidatePair)?void 0:n.remote.candidate}`))}),5e3),"connected"===e&&this.handleSubscribeConnectionConnected()}))},this.handleLocalRoleUpdate=i=>_(this,[i],(function*({oldRole:e,newRole:t}){!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t)&&(ye.d(hs,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation "),this.createPeerConnections(),yield this.negotiateOnFirstPublish())})),this.retryPublishIceFailedTask=()=>_(this,null,(function*(){if(this.publishConnection){let e=new Promise(((e,i)=>{this.callbacks.set(L,{promise:{resolve:e,reject:i},action:"RESTART_ICE",extra:{}})}));yield this.performPublishRenegotiation({iceRestart:"connected"!==this.publishConnection.connectionState}),yield e}return!0})),this.retrySubscribeIceFailedTask=()=>_(this,null,(function*(){if(this.subscribeConnection&&"connected"!==this.subscribeConnection.connectionState){let e=new Promise(((i,e)=>{this.callbacks.set(N,{promise:{resolve:i,reject:e},action:"RESTART_ICE",extra:{}})})),t=new Promise((i=>{setTimeout(i,6e4,!1)}));return Promise.race([e,t])}return!0})),this.retrySignalDisconnectTask=()=>_(this,null,(function*(){var e;ye.d(hs,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),this.signal.isConnected||(yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId));let t=null!=(e=this.store.getRoom())&&e.joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),t})),this.webrtcInternals=new ti(this.store,this.eventBus,null==(n=this.publishConnection)?void 0:n.nativeConnection,null==(o=this.subscribeConnection)?void 0:o.nativeConnection);this.retryScheduler=new Ji(((u,e)=>_(this,null,(function*(){u!==this.state&&(this.state=u,yield this.observer.onStateChange(this.state,e))}))),this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe((u=>{var e,t;let r=(null==(t=null==(e=u.getLocalPeerStats())?void 0:e.subscribe)?void 0:t.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,r)})),this.eventBus.localAudioEnabled.subscribe((({track:u})=>this.trackUpdate(u))),this.eventBus.localVideoEnabled.subscribe((({track:u})=>this.trackUpdate(u)))}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let r=null==(t=this.initConfig)?void 0:t.config;return((null==r?void 0:r.enabledFlags)||[]).includes(e)}preview(e,t,i,r,s=!1){return _(this,null,(function*(){let a=yield this.connect(e,t,i,r,s);return this.state="Preview",this.observer.onStateChange(this.state),a}))}join(e,t,i,r,s=!1){return _(this,null,(function*(){ye.d(hs,"join: started ");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,r,t,i,s)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,s),yield this.initRtcStatsMonitor(),ye.d(hs," join: Negotiated over PUBLISH connection"))}catch(r){ye.e(hs,`join: failed  [token=${e}]`,r),this.state="Failed";let t=r;throw t.isTerminal=t.isTerminal||500===t.code,yield this.observer.onStateChange(this.state,t),t}ye.d(hs," join: successful"),this.state="Joined",this.observer.onStateChange(this.state)}))}connect(e,t,i,r,s=!1){return _(this,null,(function*(){this.setTransportStateForConnect(),this.joinParameters=new Vi(e,i,r.name,r.metaData,t,s);try{return yield this.internalConnect(e,t,i)}catch(r){if(!(r instanceof Te&&([ke.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,ke.WebSocketConnectionErrors.FAILED_TO_CONNECT,ke.WebSocketConnectionErrors.ABNORMAL_CLOSE,ke.APIErrors.ENDPOINT_UNREACHABLE].includes(r.code)||r.code.toString().startsWith("5")||r.code.toString().startsWith("429"))))throw r;{let n=()=>_(this,null,(function*(){return yield this.internalConnect(e,t,i),!(!this.initConfig||!this.initConfig.endpoint)}));yield this.retryScheduler.schedule({category:0,error:r,task:n,originalState:this.state,maxFailedRetries:5,changeState:!1})}}}))}leave(e){return _(this,null,(function*(){var t,i,r,s;this.retryScheduler.reset(),this.joinParameters=void 0,ye.d(hs,"leaving in transport");try{if(this.state="Leaving",null==(t=this.publishStatsAnalytics)||t.stop(),null==(i=this.webrtcInternals)||i.cleanup(),yield null==(r=this.publishConnection)?void 0:r.close(),yield null==(s=this.subscribeConnection)?void 0:s.close(),e)try{this.signal.leave(),ye.d(hs,"signal leave done")}catch(e){ye.w(hs,"failed to send leave on websocket to server",e)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(e){this.eventBus.analytics.publish(Oe.disconnect(e)),ye.e(hs,"leave: FAILED ",e)}finally{this.state="Disconnected",this.observer.onStateChange(this.state)}}))}publish(e){return _(this,null,(function*(){for(let t of e)try{yield this.publishTrack(t)}catch(e){this.eventBus.analytics.publish(Oe.publish({devices:this.deviceManager.getDevices(),error:e}))}}))}unpublish(e){return _(this,null,(function*(){for(let t of e)yield this.unpublishTrack(t)}))}sendMessage(e){return _(this,null,(function*(){return yield this.signal.broadcast(e)}))}trackUpdate(e){let i=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));if(i){let t=new Ti(C(g({},i),{mute:!e.enabled}));this.trackStates.set(i.track_id,t),ye.d(hs,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[i.track_id,t]]))}}changeRole(e,t,i=!1){return _(this,null,(function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeer(e,t,i){return _(this,null,(function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})}))}changeRoleOfPeersWithRoles(e,t){return _(this,null,(function*(){yield this.signal.requestBulkRoleChange({roles:e.map((i=>i.name)),role:t,force:!0})}))}acceptRoleChange(e){return _(this,null,(function*(){var t;yield this.signal.acceptRoleChangeRequest({requested_by:null==(t=e.requestedBy)?void 0:t.peerId,role:e.role.name,token:e.token})}))}endRoom(e,t){return _(this,null,(function*(){yield this.signal.endRoom(e,t)}))}removePeer(e,t){return _(this,null,(function*(){yield this.signal.removePeer({requested_for:e,reason:t})}))}startRTMPOrRecording(e){return _(this,null,(function*(){var i;let t={meeting_url:e.meetingURL,record:e.record};null!=(i=e.rtmpURLs)&&i.length&&(t.rtmp_urls=e.rtmpURLs),e.resolution&&(t.resolution=e.resolution),yield this.signal.startRTMPOrRecording(t)}))}stopRTMPOrRecording(){return _(this,null,(function*(){yield this.signal.stopRTMPAndRecording()}))}startHLSStreaming(e){return _(this,null,(function*(){let t={};e&&e.variants&&e.variants.length>0&&(t.variants=e.variants.map((i=>{let e={meeting_url:i.meetingURL};return i.metadata&&(e.metadata=i.metadata),e}))),null!=e&&e.recording&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)}))}stopHLSStreaming(e){return _(this,null,(function*(){var t;if(e){let i={variants:null==(t=null==e?void 0:e.variants)?void 0:t.map((e=>{let s={meeting_url:e.meetingURL};return e.metadata&&(s.metadata=e.metadata),s}))};yield this.signal.stopHLSStreaming(i)}yield this.signal.stopHLSStreaming()}))}sendHLSTimedMetadata(e){return _(this,null,(function*(){if(e.length>0){let t={metadata_objs:e};yield this.signal.sendHLSTimedMetadata(t)}}))}changeName(e){return _(this,null,(function*(){let t=this.store.getLocalPeer();t&&t.name!==e&&(yield this.signal.updatePeer({name:e}))}))}changeMetadata(e){return _(this,null,(function*(){yield this.signal.updatePeer({data:e})}))}getSessionMetadata(e){return this.signal.getSessionMetadata(e)}setSessionMetadata(e){return this.signal.setSessionMetadata(e)}listenMetadataChange(e){return this.signal.listenMetadataChange(e)}setPollInfo(e){return this.signal.setPollInfo(e)}getPollInfo(e){return this.signal.getPollInfo(e)}setPollQuestions(e){return this.signal.setPollQuestions(e)}getPollQuestions(e){return this.signal.getPollQuestions(e)}startPoll(e){return this.signal.startPoll(e)}stopPoll(e){return this.signal.stopPoll(e)}setPollResponses(e){return this.signal.setPollResponses(e)}getPollResponses(e){return this.signal.getPollResponses(e)}getPollsList(e){return this.signal.getPollsList(e)}getPollResult(e){return this.signal.getPollResult(e)}joinGroup(e){return _(this,null,(function*(){return this.signal.joinGroup(e)}))}leaveGroup(e){return _(this,null,(function*(){return this.signal.leaveGroup(e)}))}addToGroup(e,t){return _(this,null,(function*(){this.signal.addToGroup(e,t)}))}removeFromGroup(e,t){return _(this,null,(function*(){this.signal.removeFromGroup(e,t)}))}findPeers(e){return this.signal.findPeers(e)}peerIterNext(e){return this.signal.peerIterNext(e)}changeTrackState(e){return _(this,null,(function*(){yield this.signal.requestTrackStateChange(e)}))}changeMultiTrackState(e){return _(this,null,(function*(){yield this.signal.requestMultiTrackStateChange(e)}))}publishTrack(e){return _(this,null,(function*(){e.publishedTrackId=e.getTrackIDBeingSent(),ye.d(hs,` publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new Ti(e));let t=new Promise(((s,a)=>{this.callbacks.set(L,{promise:{resolve:s,reject:a},action:"PUBLISH",extra:{}})})),i=e.stream;i.setConnection(this.publishConnection);let r=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,r),ye.time(`publish-${e.trackId}-${e.type}`),yield t,ye.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then((()=>{ye.d(hs,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof Bt?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)})).catch((s=>ye.w(hs,"Failed setting maxBitrate and maxFramerate",s))),e.isPublished=!0,ye.d(hs,` publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)}))}unpublishTrack(e){return _(this,null,(function*(){if(ye.d(hs,` unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let s=Array.from(this.trackStates.values()).find((a=>e.type===a.type&&e.source===a.source));s&&this.trackStates.delete(s.track_id)}let t=new Promise(((e,s)=>{this.callbacks.set(L,{promise:{resolve:e,reject:s},action:"UNPUBLISH",extra:{}})}));e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e),ye.d(hs,` unpublishTrack: trackId=${e.trackId}`,this.callbacks)}))}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise((e=>{this.eventBus.policyChange.subscribeOnce((()=>e()))}))}createConnectionsAndNegotiateJoin(e,t=!1){return _(this,null,(function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start("join_response_time"),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end("join_response_time")}))}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new as(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver)),this.subscribeConnection||(this.subscribeConnection=new ls(this.signal,this.initConfig.rtcConfiguration,this.isFlagEnabled.bind(this),this.subscribeConnectionObserver)))}negotiateJoinWithRetry(s){return _(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}catch(l){ye.e(hs,"Join negotiation failed ",l);let n=l instanceof Te?l:p.WebsocketMethodErrors.ServerErrors(500,"JOIN",`Websocket join error - ${l.message}`),o=5===parseInt(""+n.code/100)||[ke.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,429].includes(n.code);if(410===n.code&&(n.isTerminal=!0),!o)throw l;{this.joinRetryCount=0,n.isTerminal=!1;let o=()=>_(this,null,(function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}));yield this.retryScheduler.schedule({category:2,error:n,task:o,originalState:"Joined",maxFailedRetries:3,changeState:!1})}}}))}negotiateJoin(s){return _(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){return r?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})}))}negotiateJoinWebRTC(e){return _(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){if(ye.d(hs," join: Negotiating over PUBLISH connection"),!this.publishConnection)return ye.e(hs,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let a=this.isFlagEnabled("subscribeDegradation"),r=this.isFlagEnabled("simulcast"),n=this.isFlagEnabled("onDemandTracks"),o=yield this.signal.join(e,t,!i,a,r,n,s);yield this.publishConnection.setRemoteDescription(o);for(let u of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(u);return this.publishConnection.initAfterJoin(),!!o}))}negotiateJoinNonWebRTC(e){return _(this,arguments,(function*({name:e,data:t,autoSubscribeVideo:i}){ye.d(hs," join: Negotiating Non-WebRTC");let s=this.isFlagEnabled("subscribeDegradation"),a=this.isFlagEnabled("simulcast"),r=this.isFlagEnabled("onDemandTracks");return!!(yield this.signal.join(e,t,!i,s,a,r))}))}negotiateOnFirstPublish(){return _(this,null,(function*(){if(ye.d(hs," Negotiating offer over PUBLISH connection"),!this.publishConnection)return ye.e(hs,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t}))}performPublishRenegotiation(e){return _(this,null,(function*(){ye.d(hs," [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(L);if(t){if(!this.publishConnection)return void ye.e(hs,"Publish peer connection not found, cannot renegotiate");try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),ye.time("renegotiation-offer-exchange");let r=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(L),ye.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(r),t.promise.resolve(!0),ye.d(hs,"[role=PUBLISH] onRenegotiationNeeded DONE ")}catch(r){let e;e=r instanceof Te?r:p.GenericErrors.Unknown("PUBLISH",r.message),t.promise.reject(e),ye.d(hs,"[role=PUBLISH] onRenegotiationNeeded FAILED ")}}}))}handleIceConnectionFailure(e,t){return _(this,null,(function*(){this.retryScheduler.isTaskInProgress(4)||(0===e?this.retryScheduler.schedule({category:3,error:t,task:this.retryPublishIceFailedTask,originalState:"Joined"}):this.retryScheduler.schedule({category:4,error:t,task:this.retrySubscribeIceFailedTask,originalState:"Joined",maxFailedRetries:1}))}))}internalConnect(e,t,i){return _(this,null,(function*(){ye.d(hs,"connect: started ");let r=new Date;try{return this.analyticsTimer.start("init_response_time"),this.initConfig=yield cs.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t}),this.analyticsTimer.end("init_response_time"),ci.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.observer.onConnected(),this.store.setSimulcastEnabled(this.isFlagEnabled("simulcast")),ye.d(hs,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(e){throw"Reconnecting"!==this.state&&this.eventBus.analytics.publish(Oe.connect(e,this.getAdditionalAnalyticsProperties(),r,new Date,t)),ye.e(hs," internal connect: failed",e),e}}))}validateNotDisconnected(e){if("Disconnected"===this.state)throw ye.w(hs,"aborting join as transport state is disconnected"),p.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return _(this,null,(function*(){if(!this.initConfig)throw p.APIErrors.InitConfigNotAvailable("INIT","Init Config not found");ye.d(hs," internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),i.searchParams.set("protocol_version","2.5"),i.searchParams.set("protocol_spec","20230919"),this.endpoint=i.toString(),this.analyticsTimer.start("ws_connect_time"),yield this.signal.open(this.endpoint),this.analyticsTimer.end("ws_connect_time"),this.analyticsTimer.start("on_policy_change_time"),this.analyticsTimer.start("room_state_time"),ye.d(hs," internal connect: connected to ws endpoint")}))}initRtcStatsMonitor(){return _(this,null,(function*(){var e,t,i,r,s,a,n,o;null==(i=this.webrtcInternals)||i.setPeerConnections({publish:null==(e=this.publishConnection)?void 0:e.nativeConnection,subscribe:null==(t=this.subscribeConnection)?void 0:t.nativeConnection}),this.isFlagEnabled("publishStats")&&(this.publishStatsAnalytics=new zi(this.store,this.eventBus,null==(s=null==(r=this.initConfig)?void 0:r.config.publishStats)?void 0:s.maxSampleWindowSize,null==(n=null==(a=this.initConfig)?void 0:a.config.publishStats)?void 0:n.maxSamplePushInterval),null==(o=this.getWebrtcInternals())||o.start())}))}doesRoleNeedWebRTC(e){var t,s;if(!this.isFlagEnabled("nonWebRTCDisableOffer"))return!0;let r=!!(e.publishParams.allowed&&(null==(t=e.publishParams.allowed)?void 0:t.length)>0),i=!!(e.subscribeParams.subscribeToRoles&&(null==(s=e.subscribeParams.subscribeToRoles)?void 0:s.length)>0);return r||i}doesLocalPeerNeedWebRTC(){var e;let t=null==(e=this.store.getLocalPeer())?void 0:e.role;return!t||this.doesRoleNeedWebRTC(t)}handleSubscribeConnectionConnected(){var e;null==(e=this.subscribeConnection)||e.logSelectedIceCandidatePairs();let t=this.callbacks.get(N);this.callbacks.delete(N),t&&t.promise.resolve(!0)}setTransportStateForConnect(){if("Failed"===this.state&&(this.state="Disconnected"),"Disconnected"!==this.state&&"Reconnecting"!==this.state)throw p.WebsocketMethodErrors.AlreadyJoined("JOIN",`Cannot join a meeting in ${this.state} state`);"Disconnected"===this.state&&(this.state="Connecting",this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let r,i=this.getAdditionalAnalyticsProperties();switch(t){case 0:r=Oe.connect(e,i);break;case 1:r=Oe.disconnect(e,i);break;case 2:r=Oe.join({error:e,time:this.analyticsTimer.getTimeTaken("join_time"),init_response_time:this.analyticsTimer.getTimeTaken("init_response_time"),ws_connect_time:this.analyticsTimer.getTimeTaken("ws_connect_time"),on_policy_change_time:this.analyticsTimer.getTimeTaken("on_policy_change_time"),local_audio_track_time:this.analyticsTimer.getTimeTaken("local_audio_track_time"),local_video_track_time:this.analyticsTimer.getTimeTaken("local_video_track_time"),retries_join:this.joinRetryCount});break;case 3:r=Oe.publish({error:e});break;case 4:r=Oe.subscribeFail(e)}this.eventBus.analytics.publish(r)}getSubscribeConnection(){return this.subscribeConnection}getAdditionalAnalyticsProperties(){var a,e,t,r,u,n,o,l;let d=(()=>{if(!le||void 0===navigator.connection)return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}})();return{network_info:d,document_hidden:"undefined"!=typeof document&&document.hidden,num_degraded_tracks:this.store.getRemoteVideoTracks().filter((e=>e.degraded)).length,bitrate:{publish:null==(r=null==(t=null==(e=null==(a=this.getWebrtcInternals())?void 0:a.getCurrentStats())?void 0:e.getLocalPeerStats())?void 0:t.publish)?void 0:r.bitrate,subscribe:null==(l=null==(o=null==(n=null==(u=this.getWebrtcInternals())?void 0:u.getCurrentStats())?void 0:n.getLocalPeerStats())?void 0:o.subscribe)?void 0:l.bitrate},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function vs(e){if(!e||0===e.length)throw p.APIErrors.InvalidTokenFormat("INIT","Token cannot be an empty string or undefined or null");let t=e.split(".");if(3!==t.length)throw p.APIErrors.InvalidTokenFormat("INIT","Expected 3 '.' separate fields - header, payload and signature respectively");let r=atob(t[1]);try{let i=JSON.parse(r);return{roomId:i.room_id,userId:i.user_id,role:i.role}}catch(e){throw p.APIErrors.InvalidTokenFormat("INIT",`couldn't parse to json - ${e.message}`)}}var hr={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isPreviewCalled:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},gs=class{constructor(){this.TAG="[HMSSdk]:",this.transportState="Disconnected",this.analyticsTimer=new Le,this.sdkState=g({},hr),this.handleAutoplayError=e=>{var t,i;null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)},this.observer={onNotification:e=>{var t;if("on-peer-leave-request"!==e.method){switch(e.method){case"on-policy-change":this.analyticsTimer.end("on_policy_change_time");break;case"peer-list":this.analyticsTimer.end("peer_list_time"),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled);break;case"room-state":this.analyticsTimer.end("room_state_time")}null==(t=this.notificationManager)||t.handleNotification(e,this.sdkState.isReconnecting)}else this.handlePeerLeaveRequest(e.params)},onConnected:()=>{this.initNotificationManager()},onTrackAdd:e=>{var t;null==(t=this.notificationManager)||t.handleTrackAdd(e)},onTrackRemove:e=>{var t;null==(t=this.notificationManager)||t.handleTrackRemove(e)},onFailure:e=>{var t;null==(t=this.errorListener)||t.onError(e)},onStateChange:(e,t)=>_(this,null,(function*(){var r,s;let i=a=>_(this,null,(function*(){var e,t;yield this.internalLeave(!0,a),!this.sdkState.isPreviewInProgress&&!this.sdkState.isJoinInProgress&&(null==(t=null==(e=this.errorListener)?void 0:e.onError)||t.call(e,a)),this.sdkState.isReconnecting=!1}));switch(e){case"Preview":case"Joined":this.initNotificationManager(),"Reconnecting"===this.transportState&&(null==(r=this.listener)||r.onReconnected());break;case"Failed":yield i(t);break;case"Reconnecting":this.sdkState.isReconnecting=!0,null==(s=this.listener)||s.onReconnecting(t)}this.transportState=e,ye.d(this.TAG,"Transport State Change",this.transportState)}))},this.handlePeerLeaveRequest=e=>{var t;let r=e.requested_by?this.store.getPeerById(e.requested_by):void 0,i={roomEnded:e.room_end,reason:e.reason,requestedBy:r};null==(t=this.listener)||t.onRemovedFromRoom(i),this.internalLeave(!1)},this.handleDeviceChange=e=>{var t,i,r,s,a,n;if(ye.d(this.TAG,"Device Change event",e),null==(i=null==(t=this.deviceChangeListener)?void 0:t.onDeviceChange)||i.call(t,e),e.error&&e.type){let t=e.type.includes("audio")?null==(r=this.localPeer)?void 0:r.audioTrack:null==(s=this.localPeer)?void 0:s.videoTrack;null==(a=this.errorListener)||a.onError(e.error),[ke.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,ke.TracksErrors.DEVICE_IN_USE,ke.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&t&&(t.setEnabled(!1),null==(n=this.listener)||n.onTrackUpdate(2,t,this.localPeer))}},this.handleAudioPluginError=e=>{var t;ye.e(this.TAG,"Audio Plugin Error event",e),null==(t=this.errorListener)||t.onError(e)},this.handleLocalRoleUpdate=i=>_(this,[i],(function*({oldRole:e,newRole:t}){var r;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield null==(r=this.roleChangeManager)?void 0:r.handleLocalPeerRoleUpdate({oldRole:e,newRole:t})})),this.sendAudioPresenceFailed=()=>{let e=p.TracksErrors.NoAudioDetected("PREVIEW");ye.w(this.TAG,"Audio Presence Failure",this.transportState,e)},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(Oe.join(C(g({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("join_time"),is_preview_called:e,retries_join:this.transport.joinRetryCount})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(Oe.preview(C(g({error:e},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("preview_time")})))},this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initNotificationManager(){this.notificationManager||(this.notificationManager=new Mi(this.store,this.eventBus,this.transport,this.listener,this.audioListener))}initStoreAndManagers(){var e;if(this.sdkState.isInitialised)return null==(e=this.notificationManager)||e.setListener(this.listener),this.audioSinkManager.setListener(this.listener),void this.interactivityCenter.setListener(this.listener);this.sdkState.isInitialised=!0,this.store=new ui,this.eventBus=new ki,this.wakeLockManager=new hi,this.networkTestManager=new oi(this.eventBus,this.listener),this.playlistManager=new $i(this,this.eventBus),this.deviceManager=new mi(this.store,this.eventBus),this.audioSinkManager=new gi(this.store,this.deviceManager,this.eventBus),this.audioOutput=new fi(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new ai(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new pi(this.store),this.transport=new ps(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.sessionStore=new ji(this.transport),this.interactivityCenter=new Bi(this.transport,this.store,this.listener),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION",`Not connected - ${e}`)}sendHLSAnalytics(e){this.sendAnalyticsEvent(Oe.hlsPlayerError(e))}refreshDevices(){return _(this,null,(function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)}))}getWebrtcInternals(){var e;return null==(e=this.transport)?void 0:e.getWebrtcInternals()}getSessionStore(){return this.sessionStore}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return null==(e=this.store.getRoom())?void 0:e.recording}getRTMPState(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp}getHLSState(){var e;return null==(e=this.store.getRoom())?void 0:e.hls}getTemplateAppData(){return this.store.getTemplateAppData()}getInteractivityCenter(){return this.interactivityCenter}getPeerListIterator(e){return new ae(this.transport,this.store,e)}get localPeer(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}preview(e,t){return _(this,null,(function*(){if(Ie(),Ae(),this.sdkState.isPreviewInProgress)return Promise.reject(p.GenericErrors.PreviewAlreadyInProgress("PREVIEW","Preview already called"));if(["Joined","Reconnecting"].includes(this.transportState))return this.midCallPreview(e.asRole,e.settings);this.analyticsTimer.start("preview_time"),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then((()=>_(this,null,(function*(){yield this.initDeviceManagers()}))));let i=!1,r=!1,s=setTimeout((()=>{var a,e;(!i||!r)&&(null==(e=null==(a=this.listener)?void 0:a.onNetworkQuality)||e.call(a,-1))}),3e3);return new Promise(((a,n)=>{let o=u=>{var e;this.analyticsTimer.end("preview_time"),u&&(null==(e=this.errorListener)||e.onError(u)),this.sendPreviewAnalyticsEvent(u),this.sdkState.isPreviewInProgress=!1,n(u)};this.eventBus.policyChange.subscribeOnce((()=>_(this,null,(function*(){var r;if(this.localPeer){let t=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=t||this.localPeer.role}let u=yield this.localTrackManager.getTracksToPublish(e.settings);u.forEach((e=>this.setLocalPeerTrack(e))),null!=(r=this.localPeer)&&r.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end("preview_time");let n=this.store.getRoom();n&&t.onPreview(n,u),this.sendPreviewAnalyticsEvent(),a()})))),this.eventBus.leave.subscribeOnce(o),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then((u=>{var t;i=!0,clearTimeout(s),u&&e.captureNetworkQualityInPreview&&this.networkTestManager.start(null==(t=u.config)?void 0:t.networkHealth).then((()=>{r=!0}))})).catch(o)}))}))}midCallPreview(e,t){return _(this,null,(function*(){var s,a;if(!this.localPeer||"Joined"!==this.transportState)throw p.GenericErrors.NotConnected("VALIDATION","Not connected - midCallPreview");let i=e&&this.store.getPolicyForRole(e);if(!i)throw p.GenericErrors.InvalidRole("PREVIEW",`role ${e} does not exist in policy`);this.localPeer.asRole=i;let r=yield this.localTrackManager.getTracksToPublish(t);r.forEach((e=>this.setLocalPeerTrack(e))),null!=(s=this.localPeer)&&s.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),null==(a=this.listener)||a.onPreview(this.store.getRoom(),r)}))}cancelMidCallPreview(){return _(this,null,(function*(){var e,t,i;if((!this.localPeer||!this.localPeer.isInPreview())&&ye.w(this.TAG,"Cannot cancel mid call preview as preview is not in progress"),null!=(e=this.localPeer)&&e.asRole&&this.localPeer.role){let e=this.localPeer.asRole,s=this.localPeer.role;delete this.localPeer.asRole,yield null==(t=this.roleChangeManager)?void 0:t.diffRolesAndPublishTracks({oldRole:e,newRole:s}),null==(i=this.listener)||i.onPeerUpdate(8,this.localPeer)}}))}join(e,t){return _(this,null,(function*(){var r,n,u,o,l,d;if(Ie(),Ae(),this.sdkState.isPreviewInProgress)throw p.GenericErrors.NotReady("JOIN","Preview is in progress, can't join");this.analyticsTimer.start("join_time"),this.sdkState.isJoinInProgress=!0;let{roomId:i,userId:c,role:s}=vs(e.authToken),a=(null==(n=null==(r=this.localPeer)?void 0:r.asRole)?void 0:n.name)||(null==(o=null==(u=this.localPeer)?void 0:u.role)?void 0:o.name);null==(l=this.networkTestManager)||l.stop(),this.listener=t,this.commonSetup(e,i,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),Ye.resumeContext();let h=this.store.getConfig();null!=h&&h.autoManageWakeLock&&this.wakeLockManager.acquireLock(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(s),this.localPeer.customerUserId=c,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,s,c),this.roleChangeManager=new di(this.store,this.transport,this.deviceManager,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),ye.d(this.TAG,` Joining room ${i}`),ye.time(`join-room-${i}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe),ye.d(this.TAG,` Joined room ${i}`),this.analyticsTimer.start("peer_list_time"),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,yield this.publish(e.settings,a)}catch(e){throw this.analyticsTimer.end("join_time"),this.sdkState.isJoinInProgress=!1,null==(d=this.listener)||d.onError(e),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled,e),ye.e(this.TAG,"Unable to join room",e),e}ye.timeEnd(`join-room-${i}`)}))}stringifyMetadata(e){e.metaData&&"string"!=typeof e.metaData?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanup(){var e,t,i;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanup(),Ve.cleanup(),this.playlistManager.cleanup(),null==(e=this.wakeLockManager)||e.cleanup(),ai.cleanup(),this.notificationManager=void 0,ye.cleanup(),this.sdkState=g({},hr),this.localPeer&&(null==(t=this.localPeer.audioTrack)||t.cleanup(),this.localPeer.audioTrack=void 0,null==(i=this.localPeer.videoTrack)||i.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanup(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return _(this,null,(function*(){var r,s,a;let i=null==(r=this.store)?void 0:r.getRoom();if(i){let r=i.id;null==(s=this.networkTestManager)||s.stop(),this.eventBus.leave.publish(t),ye.d(this.TAG,` Leaving room ${r}`),yield null==(a=this.transport)?void 0:a.leave(e),this.cleanup(),ye.d(this.TAG,` Left room ${r}`)}}))}getAuthTokenByRoomCode(e,t){return _(this,null,(function*(){let i=(t||{}).endpoint||"https://auth.100ms.live/v2/token";this.analyticsTimer.start("GET_TOKEN");let r=yield((e,t,r)=>_(void 0,null,(function*(){let n=Error("something went wrong during fetch");for(let s=0;s<4;s++)try{let a=yield fetch(e,t),n=yield a.clone().json();if(r&&r.length&&!a.ok&&r.includes(n.code))throw p.APIErrors.ServerErrors(n.code,"GET_TOKEN",n.message,!1);return a}catch(e){n=e}throw["Failed to fetch","NetworkError"].some((s=>n.message.includes(s)))?p.APIErrors.EndpointUnreachable("GET_TOKEN",n.message):n})))(i,{method:"POST",body:JSON.stringify({code:e.roomCode,user_id:e.userId})},[429,500,501,502,503,504,505,506,507,508,509,510,511]),s=yield r.json();if(this.analyticsTimer.end("GET_TOKEN"),!r.ok)throw p.APIErrors.ServerErrors(s.code,"GET_TOKEN",s.message,!1);let{token:a}=s;if(!a)throw Error(s.message);return a}))}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){return this.store.getPeers()}getPeerMap(){return this.store.getPeerMap()}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return _(this,null,(function*(){return yield this.sendMessageInternal({message:e,type:t})}))}sendGroupMessage(e,t,i){return _(this,null,(function*(){let r=this.store.getKnownRoles();if(0===(t.filter((a=>r[a.name]))||[]).length)throw p.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return _(this,null,(function*(){var s;if(!this.store.getPeerById(t.peerId))throw p.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);if((null==(s=this.localPeer)?void 0:s.peerId)===t.peerId)throw p.GenericErrors.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:i})}))}sendMessageInternal(s){return _(this,arguments,(function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:r}){if(""===r.replace(/\u200b/g," ").trim())throw ye.w(this.TAG,"sendMessage","Ignoring empty message send"),p.GenericErrors.ValidationFailed("Empty message not allowed");let a=new O({sender:this.localPeer,type:i,message:r,recipientPeer:t,recipientRoles:e,time:new Date});ye.d(this.TAG,"Sending Message: ",a);let n=yield this.transport.sendMessage(a);return a.time=new Date(n.timestamp),a.id=n.message_id,a}))}startScreenShare(e,t){return _(this,null,(function*(){var r,n,o;let i=this.store.getPublishParams();if(!i)return;let{allowed:l}=i;if(!l||!l.includes("screen"))return void ye.e(this.TAG,`Role ${null==(r=this.localPeer)?void 0:r.role} cannot share screen`);if(null!=(o=null==(n=this.localPeer)?void 0:n.auxiliaryTracks)&&o.find((u=>"screen"===u.source)))throw Error("Cannot share multiple screens");let a=yield this.getScreenshareTracks(e,t);if(!this.localPeer)return ye.d(this.TAG,"Screenshared when not connected"),void a.forEach((u=>{u.cleanup()}));yield this.transport.publish(a),a.forEach((u=>{var e,t,r;u.peerId=null==(e=this.localPeer)?void 0:e.peerId,null==(t=this.localPeer)||t.auxiliaryTracks.push(u),null==(r=this.listener)||r.onTrackUpdate(0,u,this.localPeer)}))}))}stopEndedScreenshare(e){return _(this,null,(function*(){ye.d(this.TAG," Screenshare ended natively"),yield this.stopScreenShare(),e()}))}stopScreenShare(){return _(this,null,(function*(){var e;ye.d(this.TAG," Screenshare ended from app");let t=null==(e=this.localPeer)?void 0:e.auxiliaryTracks.filter((i=>"screen"===i.source));if(t)for(let i of t)yield this.removeTrack(i.trackId)}))}addTrack(e,t="regular"){return _(this,null,(function*(){var r,u,n,o;if(!e)return void ye.w(this.TAG,"Please pass a valid MediaStreamTrack");if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find((t=>t.trackId===e.id)))return;let l=e.kind,s=new MediaStream([e]),a=new Ht(s),d=new("audio"===l?It:Bt)(a,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:d,source:t}),yield null==(r=this.transport)?void 0:r.publish([d]),d.peerId=null==(u=this.localPeer)?void 0:u.peerId,null==(n=this.localPeer)||n.auxiliaryTracks.push(d),null==(o=this.listener)||o.onTrackUpdate(0,d,this.localPeer)}))}removeTrack(e,t=!1){return _(this,null,(function*(){var r;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex((s=>s.trackId===e));if(i>-1){let s=this.localPeer.auxiliaryTracks[i];s.isPublished?yield this.transport.unpublish([s]):yield s.cleanup(),t||this.stopPlaylist(s),this.localPeer.auxiliaryTracks.splice(i,1),null==(r=this.listener)||r.onTrackUpdate(1,s,this.localPeer)}else ye.w(this.TAG,`No track found for ${e}`)}))}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){ye.level=e}addAudioListener(e){var t;this.audioListener=e,null==(t=this.notificationManager)||t.setAudioListener(e)}addConnectionQualityListener(e){var t;null==(t=this.notificationManager)||t.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return _(this,null,(function*(){var r;yield null==(r=this.transport)?void 0:r.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeer(e,t,i=!1){return _(this,null,(function*(){var r;yield null==(r=this.transport)?void 0:r.changeRoleOfPeer(e,t,i)}))}changeRoleOfPeersWithRoles(e,t){return _(this,null,(function*(){var i;e.length<=0||!t||(yield null==(i=this.transport)?void 0:i.changeRoleOfPeersWithRoles(e,t))}))}acceptChangeRole(e){return _(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.acceptRoleChange(e)}))}endRoom(e,t){return _(this,null,(function*(){var i;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot end room");yield null==(i=this.transport)?void 0:i.endRoom(e,t),yield this.leave()}))}removePeer(e,t){return _(this,null,(function*(){var i;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot remove peer");yield null==(i=this.transport)?void 0:i.removePeer(e,t)}))}startRTMPOrRecording(e){return _(this,null,(function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start streaming or recording");yield null==(t=this.transport)?void 0:t.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return _(this,null,(function*(){var e;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop streaming or recording");yield null==(e=this.transport)?void 0:e.stopRTMPOrRecording()}))}startHLSStreaming(e){return _(this,null,(function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start HLS streaming");yield null==(t=this.transport)?void 0:t.startHLSStreaming(e)}))}stopHLSStreaming(e){return _(this,null,(function*(){var t;if(!this.localPeer)throw p.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop HLS streaming");yield null==(t=this.transport)?void 0:t.stopHLSStreaming(e)}))}sendHLSTimedMetadata(e){return _(this,null,(function*(){var t;this.validateJoined("sendHLSTimedMetadata"),yield null==(t=this.transport)?void 0:t.sendHLSTimedMetadata(e)}))}changeName(e){return _(this,null,(function*(){var t,i;this.validateJoined("changeName"),yield null==(t=this.transport)?void 0:t.changeName(e),null==(i=this.notificationManager)||i.updateLocalPeer({name:e})}))}changeMetadata(e){return _(this,null,(function*(){var t,i;this.validateJoined("changeMetadata"),yield null==(t=this.transport)?void 0:t.changeMetadata(e),null==(i=this.notificationManager)||i.updateLocalPeer({metadata:e})}))}setSessionMetadata(e){return _(this,null,(function*(){yield this.transport.setSessionMetadata({key:"default",data:e})}))}getSessionMetadata(){return _(this,null,(function*(){return(yield this.transport.getSessionMetadata("default")).data}))}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return _(this,null,(function*(){var r;if("video"===e.type&&"regular"!==e.source)return void ye.w(this.TAG,"Muting non-regular video tracks is currently not supported");if(e.enabled===t)return void ye.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);if(!this.store.getTrackById(e.trackId))throw p.GenericErrors.ValidationFailed("No track found for change track state",e);let i=this.store.getPeerByTrackId(e.trackId);if(!i)throw p.GenericErrors.ValidationFailed("No peer found for change track state",e);yield null==(r=this.transport)?void 0:r.changeTrackState({requested_for:i.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})}))}changeMultiTrackState(e){return _(this,null,(function*(){var a;if("boolean"!=typeof e.enabled)throw p.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:t,roles:i,type:r,source:s}=e;yield null==(a=this.transport)?void 0:a.changeMultiTrackState({value:!t,type:r,source:s,roles:null==i?void 0:i.map((e=>null==e?void 0:e.name))})}))}raiseLocalPeerHand(){return _(this,null,(function*(){this.validateJoined("raiseLocalPeerHand"),yield this.transport.joinGroup(q)}))}lowerLocalPeerHand(){return _(this,null,(function*(){this.validateJoined("lowerLocalPeerHand"),yield this.transport.leaveGroup(q)}))}raiseRemotePeerHand(e){return _(this,null,(function*(){yield this.transport.addToGroup(e,q)}))}lowerRemotePeerHand(e){return _(this,null,(function*(){yield this.transport.addToGroup(e,q)}))}setFrameworkInfo(e){this.frameworkInfo=g(g({},this.frameworkInfo),e)}attachVideo(e,t){return _(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.attach(t):yield e.addSink(t)}))}detachVideo(e,t){return _(this,null,(function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.detach(t):yield e.removeSink(t)}))}publish(e,t){return _(this,null,(function*(){var i,r,s;if([this.store.getPublishParams(),!this.sdkState.published,!de].every((a=>!!a))){let a=t&&t!==(null==(r=null==(i=this.localPeer)?void 0:i.role)?void 0:r.name)?()=>{var e;return null==(e=this.roleChangeManager)?void 0:e.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield null==(s=null==a?void 0:a())?void 0:s.catch((e=>{var t;ye.e(this.TAG,"Error in publish",e),null==(t=this.listener)||t.onError(e)}))}}))}getAndPublishTracks(e){return _(this,null,(function*(){var i,t;let r=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(r),null==(t=null==(i=this.localPeer)?void 0:i.audioTrack)||t.initAudioLevelMonitor(),this.sdkState.published=!0}))}setAndPublishTracks(e){return _(this,null,(function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),null==(t=this.listener)||t.onTrackUpdate(0,i,this.localPeer);yield this.initDeviceManagers()}))}setLocalPeerTrack(e){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case"audio":this.localPeer.audioTrack=e;break;case"video":this.localPeer.videoTrack=e}}initDeviceManagers(){return _(this,null,(function*(){var e,t,i,r,s;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice(null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice(null==(r=null==(i=Ve.getSelection())?void 0:i.audioOutput)?void 0:r.deviceId)),this.audioSinkManager.init(null==(s=this.store.getConfig())?void 0:s.audioSinkElementId))}))}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanup(),this.audioSinkManager.cleanup()}initPreviewTrackAudioLevelMonitor(){var e;let t=null==(e=this.localPeer)?void 0:e.audioTrack;null==t||t.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe((i=>{var s;let e=i&&i.track.trackId===(null==t?void 0:t.trackId)?[{audioLevel:i.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(e),null==(s=this.audioListener)||s.onAudioLevelUpdate(e)})),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var i;let e=this.store.getLocalPeer(),t=this.store.getRoom();if(t)return t.joinedAt=new Date,e&&(e.joinedAt=t.joinedAt),null!=e&&e.role?(this.analyticsTimer.end("join_time"),void(null==(i=this.listener)||i.onJoin(t))):new Promise(((e,s)=>{this.eventBus.policyChange.subscribeOnce((()=>{var a;this.analyticsTimer.end("join_time"),null==(a=this.listener)||a.onJoin(t),e()})),this.eventBus.leave.subscribeOnce((a=>{s(a)}))}));ye.w(this.TAG,"notify join - room not present")}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewCalled=!0,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:r,role:s}=vs(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,s,r,e.asRole)}setPlaylistSettings(e){return _(this,arguments,(function*({track:e,hmsTrack:t,source:i}){if("videoplaylist"===i){let s={};if("audio"===e.kind)s.maxBitrate=64;else{s.maxBitrate=1e3;let{width:a,height:t}=e.getSettings();s.width=a,s.height=t}yield t.setSettings(s)}else"audioplaylist"===i&&(yield t.setSettings({maxBitrate:64}))}))}createAndAddLocalPeerToStore(e,t,i,r){let s=this.store.getPolicyForRole(t),a=r?this.store.getPolicyForRole(r):void 0,n=new se({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:s,asRole:a||s});this.store.addPeer(n)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new M(t))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return _(this,null,(function*(){let[i,r]=yield this.localTrackManager.getLocalScreen(t),s=()=>{this.stopEndedScreenshare(e)},a=[];if(null!=t&&t.audioOnly){if(i.nativeTrack.stop(),!r)throw p.TracksErrors.NothingToReturn("TRACK","Select share audio when sharing screen","No audio found");a.push(r),r.nativeTrack.addEventListener("ended",s)}else a.push(i),i.nativeTrack.addEventListener("ended",s),r&&a.push(r);return a}))}stopPlaylist(e){"audioplaylist"===e.source?this.playlistManager.stop("audio"):"videoplaylist"===e.source&&this.playlistManager.stop("video")}}}).call(this,r(263))},449:function(e,t,r){"use strict";function n(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];throw Error("[Immer] minified error nr: "+e+(r.length?" "+r.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function o(e){return!!e&&!!e[W]}function l(e){var t;return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||"function"==typeof r&&Function.toString.call(r)===H}(e)||Array.isArray(e)||!!e[V]||!!(null===(t=e.constructor)||void 0===t?void 0:t[V])||s(e)||v(e))}function i(e,t,r){void 0===r&&(r=!1),0===d(e)?(r?Object.keys:K)(e).forEach((function(n){r&&"symbol"==typeof n||t(n,e[n],e)})):e.forEach((function(r,n){return t(n,r,e)}))}function d(e){var t=e[W];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:s(e)?2:v(e)?3:0}function u(e,t){return 2===d(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function a(e,t){return 2===d(e)?e.get(t):e[t]}function c(e,t,r){var n=d(e);2===n?e.set(t,r):3===n?e.add(r):e[t]=r}function h(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function s(e){return $&&e instanceof Map}function v(e){return q&&e instanceof Set}function p(e){return e.o||e.t}function m(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=J(e);delete t[W];for(var r=K(t),n=0;n<r.length;n++){var i=r[n],o=t[i];!1===o.writable&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(t[i]={configurable:!0,writable:!0,enumerable:o.enumerable,value:e[i]})}return Object.create(Object.getPrototypeOf(e),t)}function f(e,t){return void 0===t&&(t=!1),k(e)||o(e)||!l(e)||(d(e)>1&&(e.set=e.add=e.clear=e.delete=y),Object.freeze(e),t&&i(e,(function(e,t){return f(t,!0)}),!0)),e}function y(){n(2)}function k(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function b(e){var t=z[e];return t||n(18,e),t}function T(){return U}function S(e,t){t&&(b("Patches"),e.u=[],e.s=[],e.v=t)}function g(e){E(e),e.p.forEach(A),e.p=null}function E(e){e===U&&(U=e.l)}function P(e){return U={p:[],l:U,h:e,m:!0,_:0}}function A(e){var t=e[W];0===t.i||1===t.i?t.j():t.g=!0}function I(e,t){t._=t.p.length;var i=t.p[0],r=void 0!==e&&e!==i;return t.h.O||b("ES5").S(t,e,r),r?(i[W].P&&(g(t),n(4)),l(e)&&(e=C(t,e),t.l||w(t,e)),t.u&&b("Patches").M(i[W].t,e,t.u,t.s)):e=C(t,i,[]),g(t),t.u&&t.v(t.u,t.s),e!==B?e:void 0}function C(e,t,r){if(k(t))return t;var n=t[W];if(!n)return i(t,(function(i,o){return R(e,n,t,i,o,r)}),!0),t;if(n.A!==e)return t;if(!n.P)return w(e,n.t,!0),n.t;if(!n.I){n.I=!0,n.A._--;var o=4===n.i||5===n.i?n.o=m(n.k):n.o,u=o,a=!1;3===n.i&&(u=new Set(o),o.clear(),a=!0),i(u,(function(t,i){return R(e,n,o,t,i,r,a)})),w(e,o,!1),r&&e.u&&b("Patches").N(n,r,e.u,e.s)}return n.o}function R(e,i,t,a,r,s,n){if(o(r)){var p=C(e,r,s&&i&&3!==i.i&&!u(i.R,a)?s.concat(a):void 0);if(c(t,a,p),!o(p))return;e.m=!1}else n&&t.add(r);if(l(r)&&!k(r)){if(!e.h.D&&e._<1)return;C(e,r),i&&i.A.l||w(e,r)}}function w(e,t,r){void 0===r&&(r=!1),!e.l&&e.h.D&&e.m&&f(t,r)}function _(e,t){var r=e[W];return(r?p(r):e)[t]}function D(e,t){if(t in e)for(var r=Object.getPrototypeOf(e);r;){var n=Object.getOwnPropertyDescriptor(r,t);if(n)return n;r=Object.getPrototypeOf(r)}}function O(e){e.P||(e.P=!0,e.l&&O(e.l))}function M(e){e.o||(e.o=m(e.t))}function L(e,t,r){var n=s(t)?b("MapSet").F(t,r):v(t)?b("MapSet").T(t,r):e.O?function(e,t){var r=Array.isArray(e),n={i:r?1:0,A:t?t.A:T(),P:!1,I:!1,R:{},l:t,t:e,k:null,o:null,j:null,C:!1},i=n,o=Q;r&&(i=[n],o=Y);var u=Proxy.revocable(i,o),a=u.revoke,l=u.proxy;return n.k=l,n.j=a,l}(t,r):b("ES5").J(t,r);return(r?r.A:T()).p.push(n),n}function N(e){return o(e)||n(22,e),function e(t){if(!l(t))return t;var r,u=t[W],n=d(t);if(u){if(!u.P&&(u.i<4||!b("ES5").K(u)))return u.t;u.I=!0,r=G(t,n),u.I=!1}else r=G(t,n);return i(r,(function(t,n){u&&a(u.t,t)===n||c(r,t,e(n))})),3===n?new Set(r):r}(e)}function G(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return m(e)}r.d(t,"a",(function(){return ee}));var x,U,F="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),$="undefined"!=typeof Map,q="undefined"!=typeof Set,j="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,B=F?Symbol.for("immer-nothing"):((x={})["immer-nothing"]=!0,x),V=F?Symbol.for("immer-draftable"):"__$immer_draftable",W=F?Symbol.for("immer-state"):"__$immer_state",H=("undefined"!=typeof Symbol&&Symbol.iterator,""+Object.prototype.constructor),K="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,J=Object.getOwnPropertyDescriptors||function(e){var t={};return K(e).forEach((function(r){t[r]=Object.getOwnPropertyDescriptor(e,r)})),t},z={},Q={get:function(e,t){if(t===W)return e;var r=p(e);if(!u(r,t))return function(e,t,r){var n,i=D(t,r);return i?"value"in i?i.value:null===(n=i.get)||void 0===n?void 0:n.call(e.k):void 0}(e,r,t);var i=r[t];return e.I||!l(i)?i:i===_(e.t,t)?(M(e),e.o[t]=L(e.A.h,i,e)):i},has:function(e,t){return t in p(e)},ownKeys:function(e){return Reflect.ownKeys(p(e))},set:function(e,t,r){var n=D(p(e),t);if(null==n?void 0:n.set)return n.set.call(e.k,r),!0;if(!e.P){var i=_(p(e),t),o=null==i?void 0:i[W];if(o&&o.t===r)return e.o[t]=r,e.R[t]=!1,!0;if(h(r,i)&&(void 0!==r||u(e.t,t)))return!0;M(e),O(e)}return e.o[t]===r&&(void 0!==r||t in e.o)||Number.isNaN(r)&&Number.isNaN(e.o[t])||(e.o[t]=r,e.R[t]=!0),!0},deleteProperty:function(e,t){return void 0!==_(e.t,t)||t in e.t?(e.R[t]=!1,M(e),O(e)):delete e.R[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var r=p(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:n.enumerable,value:r[t]}:n},defineProperty:function(){n(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){n(12)}},Y={};i(Q,(function(e,t){Y[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),Y.deleteProperty=function(e,t){return Y.set.call(this,e,t,void 0)},Y.set=function(e,t,r){return Q.set.call(this,e[0],t,r,e[0])};var X=function(){function e(e){var t=this;this.O=j,this.D=!0,this.produce=function(e,i,r){if("function"==typeof e&&"function"!=typeof i){var u=i;i=e;var a=t;return function(e){var t=this;void 0===e&&(e=u);for(var r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return a.produce(e,(function(e){var r;return(r=i).call.apply(r,[t,e].concat(n))}))}}var o;if("function"!=typeof i&&n(6),void 0!==r&&"function"!=typeof r&&n(7),l(e)){var d=P(t),s=L(t,e,void 0),c=!0;try{o=i(s),c=!1}finally{c?g(d):E(d)}return"undefined"!=typeof Promise&&o instanceof Promise?o.then((function(e){return S(d,r),I(e,d)}),(function(e){throw g(d),e})):(S(d,r),I(o,d))}if(!e||"object"!=typeof e){if(void 0===(o=i(e))&&(o=e),o===B&&(o=void 0),t.D&&f(o,!0),r){var p=[],h=[];b("Patches").M(e,o,p,h),r(p,h)}return o}n(21,e)},this.produceWithPatches=function(e,r){if("function"==typeof e)return function(r){for(var n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return t.produceWithPatches(r,(function(t){return e.apply(void 0,[t].concat(i))}))};var n,i,o=t.produce(e,r,(function(e,t){n=e,i=t}));return"undefined"!=typeof Promise&&o instanceof Promise?o.then((function(e){return[e,n,i]})):[o,n,i]},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var i=e.prototype;return i.createDraft=function(e){l(e)||n(8),o(e)&&(e=N(e));var i=P(this),t=L(this,e,void 0);return t[W].C=!0,E(i),t},i.finishDraft=function(e,t){var i=(e&&e[W]).A;return S(i,t),I(void 0,i)},i.setAutoFreeze=function(e){this.D=e},i.setUseProxies=function(e){e&&!j&&n(20),this.O=e},i.applyPatches=function(e,t){var r;for(r=t.length-1;r>=0;r--){var i=t[r];if(0===i.path.length&&"replace"===i.op){e=i.value;break}}r>-1&&(t=t.slice(r+1));var n=b("Patches").$;return o(e)?n(e,t):this.produce(e,(function(e){return n(e,t)}))},e}(),Z=new X,ee=Z.produce;Z.produceWithPatches.bind(Z),Z.setAutoFreeze.bind(Z),Z.setUseProxies.bind(Z),Z.applyPatches.bind(Z),Z.createDraft.bind(Z),Z.finishDraft.bind(Z)},664:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t,r=new Set,n=function(e,n){var o="function"==typeof e?e(t):e;if(o!==t){var l=t;t=n?o:Object.assign({},t,o),r.forEach((function(e){return e(t,l)}))}},o=function(){return t},l={setState:n,getState:o,subscribe:function(e,n,l){return n||l?function(e,n,l){void 0===n&&(n=o),void 0===l&&(l=Object.is);var d=n(t);function c(){var r=n(t);if(!l(d,r)){var o=d;e(d=r,o)}}return r.add(c),function(){return r.delete(c)}}(e,n,l):(r.add(e),function(){return r.delete(e)})},destroy:function(){return r.clear()}};return t=e(n,o,l),l}},665:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(var i=0;i<r.length;i++)if(!Object.prototype.hasOwnProperty.call(t,r[i])||!Object.is(e[r[i]],t[r[i]]))return!1;return!0}}}]);